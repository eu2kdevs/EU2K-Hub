<!DOCTYPE html>
<html lang="hu">

<head>
  <meta charset="UTF-8">
  <meta name="description" content="Csatlakoz√°s az esem√©nyhez - Event Hub">

  <title data-translate="pages.event_hub.join.title">Csatlakoz√°s a CSE-HO Naphoz:</title>
  <link rel="stylesheet" href="csehonap2025.css">
  <link rel="stylesheet" href="/EU2K-Hub/event_hub.css">
  <link rel="icon" href="/EU2K-Hub/favicon.ico">
  <script type="importmap">
    {
      "imports": {
        "@material/web/": "https://esm.run/@material/web/"
      }
    }
  </script>
  <script type="module">
    import '@material/web/all.js';
    import { styles as typescaleStyles } from '@material/web/typography/md-typescale-styles.js';

    document.adoptedStyleSheets.push(typescaleStyles.styleSheet);
  </script>
  <script src="/EU2K-Hub/assets/js/permissions.js"></script>
  <script src="/EU2K-Hub/assets/js/translations.js?v=1.1"></script>
  <script src="/EU2K-Hub/assets/js/welcome-screen.js"></script>
  <script src="/EU2K-Hub/assets/js/auth-state.js"></script>
  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-analytics.js";
    import { getFirestore } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
    import { enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
    import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-functions.js";
    import { GoogleGenAI } from "https://cdn.jsdelivr.net/npm/@google-ai/generativelanguage/dist/index.js";

    window.GoogleGenAI = GoogleGenAI;

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBRRVx6BtQtCDKjFYA8yh9qYrcUONmkkwI",
      authDomain: "eu2k-hub.firebaseapp.com",
      projectId: "eu2k-hub",
      storageBucket: "eu2k-hub.firebasestorage.app",
      messagingSenderId: "560244867055",
      appId: "1:560244867055:web:3cd51b85baead94989001a",
      measurementId: "G-2JDPR089WD"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getFirestore(app);
    const functions = getFunctions(app, 'europe-west1');
    window.auth = getAuth(app);

    enableIndexedDbPersistence(db).catch((err) => {
      if (err.code == 'failed-precondition') {
        console.log("T√∂bb tab nyitva, nem lehet offline m√≥dban persist√°lni");
      } else if (err.code == 'unimplemented') {
        console.log("A b√∂ng√©sz≈ë nem t√°mogatja az offline persistenci√°t");
      }
    });

    // Make db, functions, auth and other Firebase objects globally available
    window.db = db;
    window.auth = auth;
    window.functions = functions;
    window.httpsCallable = httpsCallable;
    window.onAuthStateChanged = onAuthStateChanged;
    window.signInAnonymously = signInAnonymously;

    // Parse URL parameters - support hash format: /event_hub/join/eventCode.html#userUID+sessionId
    const urlParams = new URLSearchParams(window.location.search);
    
    let eventCode, userUID, sessionId;
    
    // Parse from URL path and hash
    const pathParts = window.location.pathname.split('/');
    const joinIndex = pathParts.indexOf('join');
    
    if (joinIndex !== -1 && pathParts.length > joinIndex + 1) {
      // Remove .html extension from eventCode
      eventCode = pathParts[joinIndex + 1].replace('.html', '');
      
      // Parse hash for userUID+sessionId
      if (window.location.hash) {
        const hashContent = window.location.hash.substring(1);
        
        if (hashContent && hashContent.includes('+')) {
          const parts = hashContent.split('+');
          userUID = parts[0];
          sessionId = parts[1];
        }
      }
    }
    
    // Validation function
    function validateJoinParameters() {
      // Check if all required parameters are present
      if (!eventCode || !userUID || !sessionId) {
        console.error('Missing join parameters:', { eventCode, userUID, sessionId });
        return false;
      }
      
      // Validate eventCode format (should be alphanumeric)
      if (!/^[a-zA-Z0-9]+$/.test(eventCode)) {
        console.error('Invalid event code format:', eventCode);
        return false;
      }
      
      // Validate userUID format (Firebase UID format)
      if (!/^[a-zA-Z0-9]{20,}$/.test(userUID)) {
        console.error('Invalid user UID format:', userUID);
        return false;
      }
      
      // Validate sessionId format (should be alphanumeric, 10+ chars)
      if (!/^[a-zA-Z0-9]{10,}$/.test(sessionId)) {
        console.error('Invalid session ID format:', sessionId);
        return false;
      }
      
      return true;
    }
    
    // Validate parameters on page load
    if (!validateJoinParameters()) {
      console.log('Invalid parameters, redirecting to event hub...');
      setTimeout(() => {
        window.location.href = '/EU2K-Hub/event_hub.html';
      }, 1000);
    }
    
    // Store parameters globally
    window.joinParams = {
      eventCode: eventCode,
      userUID: userUID,
      sessionId: sessionId
    };
    
    console.log('Join parameters:', window.joinParams);

    // Check authentication state using localStorage (same as auth-state.js)
    function checkAuthState() {
      const isLoggedIn = localStorage.getItem('eu2k-auth-logged-in') === 'true';
      const userUID = localStorage.getItem('eu2k-auth-uid') || 'unknown';
      
      console.log('Auth check - isLoggedIn:', isLoggedIn, 'userUID:', userUID);
      
      if (isLoggedIn && eventCode) {
        // User is signed in - generate session ID and update hash instead of redirect
        const sessionId = Math.random().toString(36).substring(2, 15);
        const newHash = `${userUID}+${sessionId}`;
        
        console.log('User authenticated, updating hash to:', newHash);
        
        // Update URL hash to reflect the user session - same pattern as onboarding
        if (window.location.hash !== '#' + newHash) {
          window.location.hash = '#' + newHash;
        }
        
        // Continue with page initialization instead of redirect
        console.log('‚úÖ Hash updated, continuing with page load...');
        
      } else if (!isLoggedIn) {
        // User is not signed in - redirect to login page with return URL
        const currentUrl = encodeURIComponent(window.location.href);
        
        document.getElementById('auth-message').textContent = 'Bejelentkez√©s sz√ºks√©ges...';
        document.getElementById('auth-message').style.display = 'flex';
        
        setTimeout(() => {
          window.location.href = `/EU2K-Hub/welcome/onboarding_student.html?returnUrl=${currentUrl}`;
        }, 1500);
      } else {
        // Logged in but no event code - show error
        document.getElementById('auth-message').textContent = 'Hi√°nyz√≥ esem√©ny k√≥d!';
        document.getElementById('auth-message').style.display = 'flex';
      }
    }

    // Check auth state immediately and also listen for changes
    checkAuthState();
    
    // Also listen for storage changes in case auth state changes in another tab
    window.addEventListener('storage', function(e) {
      if (e.key === 'eu2k-auth-logged-in') {
        checkAuthState();
      }
    });

    // Load featured event data
    import { doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
    
    async function loadFeaturedEvent() {
       try {
         const docRef = doc(db, 'event_hub', 'featured');
         const docSnap = await getDoc(docRef);
         
         if (docSnap.exists()) {
           const data = docSnap.data();
           
           // Update title
           if (data.title) {
             document.getElementById('featured-title').textContent = data.title;
           }
           
           // Update subtitle with desc
           if (data.desc) {
             let descText = data.desc;
             if (descText.length > 50) {
               // Find the best break point around 50 characters
               let firstLine = descText.substring(0, 50);
               let lastSpaceIndex = firstLine.lastIndexOf(' ');
               
               if (lastSpaceIndex > 30) {
                 firstLine = descText.substring(0, lastSpaceIndex);
                 let secondLine = descText.substring(lastSpaceIndex + 1);
                 
                 if (secondLine.length > 50) {
                   secondLine = secondLine.substring(0, 47) + '...';
                 }
                 
                 descText = firstLine + '\n' + secondLine;
               } else {
                 // If no good break point, just cut at 47 and add ...
                 descText = descText.substring(0, 47) + '...';
               }
             }
             
             document.getElementById('featured-subtitle').innerHTML = descText.replace(/\n/g, '<br>');
           }
           
           // Update image
           if (data.photoURL) {
             document.getElementById('featured-image').src = data.photoURL;
           }
           
           // Store join code for comparison
           window.featuredEventJoinCode = data.joinCode;
         }
       } catch (error) {
         console.error('Error loading featured event:', error);
       }
     }
    
    // Load data when page loads
    document.addEventListener('DOMContentLoaded', loadFeaturedEvent);

    // Import Firestore debug module
    import('/EU2K-Hub/assets/js/firestore-debug.js').catch(err => {
      console.warn('Firestore debug module not loaded:', err);
    });
  </script>
</head>

<body>
  <div class="app-bg">
    <aside class="sidebar">
      <nav class="nav-menu">
        <a class="nav-item" href="/EU2K-Hub/index.html">
          <div class="nav-icon-container">
            <img src="/EU2K-Hub/assets/home_icon.svg" class="nav-icon" alt="Otthon">
          </div>
          <span data-translate="navigation.home">Otthon</span>
        </a>
        <a class="nav-item" href="/EU2K-Hub/qr-code.html">
          <div class="nav-icon-container">
            <img src="/EU2K-Hub/assets/qr_code_icon.svg" class="nav-icon" alt="QR-K√≥d">
          </div>
          <span data-translate="navigation.qr">QR-K√≥d</span>
        </a>
        <a class="nav-item" href="/EU2K-Hub/youhub.html">
          <div class="nav-icon-container">
            <img src="/EU2K-Hub/assets/youhub_icon.svg" class="nav-icon" alt="YouHub">
          </div>
          <span data-translate="navigation.youhub">YouHub</span>
        </a>
        <a class="nav-item active" href="/EU2K-Hub/event_hub.html">
          <div class="nav-icon-container">
            <img src="/EU2K-Hub/assets/event_hub_icon.svg" class="nav-icon" alt="Event Hub">
          </div>
          <span data-translate="navigation.event_hub">Event Hub</span>
        </a>
      </nav>
    </aside>
    <main class="main-area">
      <div class="main-content">
        <header class="header">
          <div class="welcome-container">
            <img src="/EU2K-Hub/assets/event_hub_icon.svg" class="event-hub-icon" alt="Event Hub" style="margin-bottom: 4px;">
            <h1 class="event-hub-text" data-translate="pages.event-hub.join.title" >Csatlakoz√°s - Event Hub</h1>
          </div>
          <div class="header-icons">
            <a href="/EU2K-Hub/system/account.html" class="header-icon-link">
              <img src="/EU2K-Hub/assets/account_icon.svg" class="header-icon" alt="Account">
            </a>
            <a href="/EU2K-Hub/settings/settings.html" class="header-icon-link">
              <img src="/EU2K-Hub/assets/settings_icon.svg" class="header-icon" alt="Settings">
            </a>
          </div>
        </header>
        <!-- Main join page content -->
        <div id="main-join-page" class="join-page-content">
          <!-- Basic Information Section -->
          <div class="info-section">
            <h2 class="section-title" data-translate="pages.event_hub.join.basic_info">Alap inform√°ci√≥k</h2>
            
            <!-- Group Name Input -->
            <div class="input-group">
              <img src="/EU2K-Hub/assets/events/csehonap/group_name.svg" class="input-icon" alt="Csapat n√©v">
              <md-outlined-text-field 
                id="group-name-input" 
                label="Oszt√°ly neve" 
                required
                style="flex: 1;">
              </md-outlined-text-field>
            </div>
            
            <!-- Class Teacher Input -->
            <div class="input-group">
              <img src="/EU2K-Hub/assets/events/csehonap/class_teacher.svg" class="input-icon" alt="Oszt√°lyf≈ën√∂k">
              <md-outlined-text-field 
                id="class-teacher-input" 
                label="Oszt√°lyf≈ën√∂k neve" 
                required
                style="flex: 1;">
              </md-outlined-text-field>
            </div>
            
            <!-- Group Description Input -->
            <div class="input-group">
              <img src="/EU2K-Hub/assets/events/csehonap/group_description.svg" class="input-icon" alt="Le√≠r√°s">
              <md-outlined-text-field 
                id="group-description-input" 
                label="Le√≠r√°s az oszt√°lyr√≥l" 
                type="textarea"
                style="flex: 1;">
              </md-outlined-text-field>
            </div>
          </div>
          
          <!-- What is CSE-HO Day Section -->
          <div class="info-section">
            <h2 class="section-title">K√©pek a CSE-HO Napr√≥l:</h2>
            
            <!-- Main Info Container with Two Columns -->
            <div class="info-container">
              <div class="carousel-column">
                <div class="carousel-container">
                  <img id="carousel-image" src="/EU2K-Hub/assets/placeholder_img.svg" alt="CSE-HO Nap inform√°ci√≥" class="carousel-image">
                </div>
              </div>
            </div>
            <!-- Progress Bar -->
            <div class="progress-container">
              <div class="progress-bar">
                <div class="progress-segment active" id="progress-1"></div>
                <div class="progress-segment" id="progress-2"></div>
                <div class="progress-segment" id="progress-3"></div>
                <div class="progress-segment" id="progress-4"></div>
              </div>
            </div>
          </div>
        </div>
        <!-- Continue Button -->
        <div class="button-container main-join-buttons">
          <md-filled-button id="continue-btn" onclick="navigateToFinishJoin()">
            Csatlakoz√°s
          </md-filled-button>
        </div>
        
        <!-- Finish Join Page (hidden initially) -->
        <div id="finish-join-page" class="join-page-content" style="display: none;">
          <!-- Food Information Section -->
          <div class="info-section">
            <h2 class="section-title">Fog√°s inform√°ci√≥k</h2>
            
            <!-- Food Icon -->
            <div class="input-group">
              <img src="/EU2K-Hub/assets/events/csehonap/food_icon.svg" class="input-icon" alt="√âtel Ikon">
              <md-outlined-text-field 
                id="food-name-input" 
                label="Fog√°s Neve" 
                required
                style="flex: 1;">
              </md-outlined-text-field>
            </div>
            
            <!-- Food List Section -->
            <h3 class="section-title">√âtelek:</h3>
            
            <!-- Question Mark Text -->
            <div class="question-mark-container">
              <div class="question-mark-text">?</div>
              <div class="question-mark-description">
                Fog√°s n√©lk√ºl nem tudjuk fel√©p√≠teni a men√ºt<br>
                (itt be lesz a fog√°sod a napra hogy tov√°bb menj)
              </div>
            </div>
          </div>
          
          <!-- QR Code Section -->
          <div class="qr-section">
            <div class="qr-container">
              <div class="qr-background"></div>
              <img id="qr-code-image" src="/EU2K-Hub/assets/events/csehonap/preset_qrcode.png" alt="QR K√≥d" class="qr-image">
            </div>
            
            <!-- Connected Button Group -->
            <div class="button-group">
              <button class="btn-primary active" id="qr-btn">
                QR-K√≥d
              </button>
              <button class="btn-secondary" id="share-btn">
                Megoszt√°s
              </button>
            </div>
          </div>
        </div>
        <!-- Join Button -->
        <div class="button-container finish-join-buttons">
          <md-filled-button id="back-btn" onclick="navigateBackToMainJoin()" style="display: flex; align-items: center; gap: 8px;">
            <svg slot="icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
            </svg>
            Vissza
          </md-filled-button>
          <md-filled-button id="final-join-btn" onclick="finalizeJoin()">
            Csatlakoz√°s
          </md-filled-button>
        </div>
      </div>
      <div id="site-footer" class="footer" aria-label="Site footer">
        <div class="footer-container">
          <div class="footer-left">
            <img src="/EU2K-Hub/eu2k_hub_logo_hor_dark.png" class="footer-logo-wide" alt="EU2K Hub Log√≥">
          </div>
          <div class="footer-center">
            <a class="footer-privacy" data-translate="pages.index.privacy_policy" href="/EU2K-Hub/privacy_policy.html">Adatkezel√©si T√°j√©koztat√≥</a>
            <a class="footer-privacy" data-translate="pages.index.terms_of_service" href="/EU2K-Hub/terms_of_service.html">Haszn√°lati Felt√©telek</a>
          </div>
          <div class="footer-right">
            <img src="/EU2K-Hub/eu2k_devs_logo_hor_dark.png" class="footer-logo-wide" alt="EU2K Devs Log√≥">
            <img src="/EU2K-Hub/eu2k_dok_logo_hor_dark_smoller_by_width.png" class="footer-logo-wide" alt="EU2K D√ñK Log√≥">
          </div>
        </div>
      </div>
    </main>
  </div>
  <div id="event-mask"></div>

  <script>
    // Singleton API key cache to avoid multiple Firebase Function calls
    let geminiApiKeyCache = null;
    let googleGenAIInstance = null;
    
    // Firebase Auth state tracking to prevent multiple sign-in attempts
    let isAuthenticating = false;
    let authPromise = null;

    // Cached function to get Gemini API key and initialize GoogleGenAI
    async function getGoogleGenAI() {
      // Itt a Firebase Function-b≈ël kapott kulcsot haszn√°lod
      const apiKey = await getGeminiApiKeyCached();
      
      const ai = new GoogleGenAI({ apiKey });
      return ai;
    }

    // Legacy function for backward compatibility
    async function getGeminiApiKeyCached() {
      if (geminiApiKeyCache) return geminiApiKeyCache;
      
      const getGeminiApiKey = httpsCallable(functions, 'getGeminiApiKey');
      const apiKeyResult = await getGeminiApiKey();
      geminiApiKeyCache = apiKeyResult.data.apiKey;
      return geminiApiKeyCache;
    }

    // Singleton Firebase Auth function to prevent multiple sign-in attempts
    // Singleton Firebase Auth function to prevent multiple sign-in attempts
    async function ensureFirebaseAuth() {
      // If already authenticated, return immediately
      if (window.auth.currentUser) {
        return window.auth.currentUser;
      }

      // If authentication is in progress, wait for it
      if (isAuthenticating && authPromise) {
        return await authPromise;
      }

      // Start authentication process
      isAuthenticating = true;
      authPromise = (async () => {
        try {
          console.log('üîê Signing in to Firebase Auth...');
           await window.auth.signInAnonymously();
           console.log('‚úÖ Anonymous sign-in successful');

          // Wait for auth state to be fully loaded
          await new Promise((resolve) => {
            if (window.auth.currentUser) {
              resolve();
            } else {
              const unsubscribe = onAuthStateChanged(window.auth, (user) => {
                if (user) {
                  unsubscribe();
                  resolve();
                }
              });
              setTimeout(() => {
                unsubscribe();
                resolve();
              }, 5000);
            }
          });

          if (!window.auth.currentUser) {
            throw new Error('Authentication timeout');
          }

          return window.auth.currentUser;
        } catch (authError) {
          console.error('‚ùå Firebase Auth sign-in failed:', authError);
          throw authError;
        } finally {
          isAuthenticating = false;
          authPromise = null;
        }
      })();

      return await authPromise;
    }

    // Featured event bet√∂lt√©se Firestore-b√≥l
    async function loadFeaturedEvent() {
      try {
        // Ellen≈ërizz√ºk, hogy a Firebase inicializ√°lva van-e
        if (typeof db === 'undefined') {
          console.warn('Firebase nincs inicializ√°lva, placeholder adatok haszn√°lata');
          return;
        }
        
        const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js");
        
        const featuredDocRef = doc(db, 'event_hub', 'featured');
        const featuredDoc = await getDoc(featuredDocRef);
        
        if (featuredDoc.exists()) {
          const data = featuredDoc.data();
          
          // Adatok friss√≠t√©se
          document.getElementById('featured-title').textContent = data.title || 'Title';
          
          // Apply desc formatting with line breaks
          let descText = data.desc || 'Subtitle';
          if (descText.length > 50) {
            // Find the best break point around 50 characters
            let firstLine = descText.substring(0, 50);
            let lastSpaceIndex = firstLine.lastIndexOf(' ');
            
            if (lastSpaceIndex > 30) {
              firstLine = descText.substring(0, lastSpaceIndex);
              let secondLine = descText.substring(lastSpaceIndex + 1);
              
              if (secondLine.length > 50) {
                secondLine = secondLine.substring(0, 47) + '...';
              }
              
              descText = firstLine + '\n' + secondLine;
            } else {
              // If no good break point, just cut at 47 and add ...
              descText = descText.substring(0, 47) + '...';
            }
          }
          
          document.getElementById('featured-subtitle').innerHTML = descText.replace(/\n/g, '<br>');
          
          if (data.photoURL) {
            document.getElementById('featured-image').src = data.photoURL;
          }
          
          // JoinCode t√°rol√°sa a FAB gombban
          if (data.joinCode) {
            document.getElementById('join-fab').setAttribute('data-join-code', data.joinCode);
          }
        } else {
          console.log('Nincs featured event dokumentum, placeholder adatok haszn√°lata');
        }
      } catch (error) {
        console.error('Hiba a featured event bet√∂lt√©sekor:', error);
        console.log('Placeholder adatok haszn√°lata');
      }
    }
    
    // FAB gomb anim√°ci√≥k
    let fabExpanded = false;
    
    function initializeFAB() {
      const floatingFab = document.getElementById('floating-fab');
      const fabOptions = document.getElementById('fab-options');
      const fabIcon = floatingFab.querySelector('.fab-icon');
      const fabText = floatingFab.querySelector('.fab-text');
      
      floatingFab.addEventListener('click', () => {
        if (!fabExpanded) {
          // Kinyit√°s
          fabExpanded = true;
          floatingFab.classList.add('expanded');
          fabOptions.classList.add('visible');
          fabIcon.textContent = '√ó';
        } else {
          // Bez√°r√°s
          closeFAB();
        }
      });
      
      // Opci√≥k kezel√©se
      const options = document.querySelectorAll('.fab-option');
      options.forEach(option => {
        option.addEventListener('click', (e) => {
          const action = e.currentTarget.getAttribute('data-action');
          console.log('FAB opci√≥ kiv√°lasztva:', action);
          // Itt k√©s≈ëbb hozz√°adhat√≥k a specifikus m≈±veletek
        });
      });
    }
    
    function closeFAB() {
      const floatingFab = document.getElementById('floating-fab');
      const fabOptions = document.getElementById('fab-options');
      const fabIcon = floatingFab.querySelector('.fab-icon');
      
      fabExpanded = false;
      floatingFab.classList.remove('expanded');
      fabOptions.classList.remove('visible');
      fabIcon.textContent = '+';
    }
    
    // Join FAB kezel√©se - m√°r csatlakozott √°llapot
    function initializeJoinFAB() {
      const joinFab = document.getElementById('join-fab');
      joinFab.addEventListener('click', () => {
        // M√°r csatlakozott, nem csin√°l semmit vagy visszajelz√©st ad
        showToast('M√°r csatlakozt√°l ehhez az esem√©nyhez!', 'info');
      });
    }
    
    // Join inform√°ci√≥k megjelen√≠t√©se
    function displayJoinInfo() {
      const params = window.joinParams;
      
      if (params.eventCode) {
        document.getElementById('event-code-display').textContent = params.eventCode;
      }
      if (params.userUID) {
        document.getElementById('user-id-display').textContent = params.userUID;
      }
      if (params.sessionId) {
        document.getElementById('session-id-display').textContent = params.sessionId;
      }
      
      // Jelenlegi id≈ëpont megjelen√≠t√©se
      const now = new Date();
      document.getElementById('join-time-display').textContent = now.toLocaleString('hu-HU');
    }
    
    // Visszat√©r√©s az Event Hub-ra
    function goBackToEventHub() {
      window.location.href = '/EU2K-Hub/event_hub.html';
    }
    
    // Inicializ√°l√°s oldal bet√∂lt√©sekor
    document.addEventListener('DOMContentLoaded', () => {
      loadFeaturedEvent();
      initializeFAB();
      initializeJoinFAB();
      displayJoinInfo();
    });
    
    // Feedback gomb √©s popup kezel√©se
    const feedbackButton = document.querySelector('.feedback-button'); // Changed to querySelector
    const feedbackPopup = document.getElementById('feedbackPopup');

    if (feedbackButton && feedbackPopup) {
      // Feedback popup megnyit√°sa
      feedbackButton.addEventListener('click', () => {
        feedbackPopup.style.display = 'flex';
        feedbackPopup.classList.remove('closing');
      });

      // Popup bez√°r√°sa overlay-re kattint√°skor
      feedbackPopup.addEventListener('click', (e) => {
        if (e.target === feedbackPopup) {
          closeFeedbackPopup();
        }
      });
    }

    // Bez√°r√≥ f√ºggv√©ny anim√°ci√≥val
    function closeFeedbackPopup() {
      const feedbackPopup = document.getElementById('feedbackPopup');
      if (feedbackPopup) {
        feedbackPopup.classList.add('closing');
        setTimeout(() => {
          feedbackPopup.style.display = 'none';
          feedbackPopup.classList.remove('closing');
        }, 300); // 300ms anim√°ci√≥ ut√°n bez√°r√°s
      }
    }

    // Kateg√≥ria gombok kezel√©se
    const feedbackCategoryBtns = document.querySelectorAll('.feedback-category-btn');
    feedbackCategoryBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        // Elt√°vol√≠tjuk az active oszt√°lyt minden gombr√≥l
        feedbackCategoryBtns.forEach(b => b.classList.remove('active'));
        // Hozz√°adjuk az active oszt√°lyt az aktu√°lis gombhoz
        btn.classList.add('active');
      });
    });

    // Feedback bek√ºld√©s f√ºggv√©ny
    async function submitFeedback() {
      try {
        // Form adatok √∂sszegy≈±jt√©se
        const titleInput = document.querySelector('.feedback-title-input');
        const descriptionInput = document.querySelector('.feedback-input');
        const activeCategory = document.querySelector('.feedback-category-btn.active');

        // Valid√°ci√≥
        if (!titleInput.value.trim()) {
          showToast('K√©rlek add meg a c√≠met!', 'error');
          return;
        }
        if (!descriptionInput.value.trim()) {
          showToast('K√©rlek √≠rj le valamit!', 'error');
          return;
        }
        if (!activeCategory) {
          showToast('K√©rlek v√°lassz kateg√≥ri√°t!', 'error');
          return;
        }

        // Kateg√≥ria meghat√°roz√°sa
        const categoryData = activeCategory.getAttribute('data-category');
        const collectionName = categoryData === 'function' ? 'fix_things' : 'new_recommendations';

        // Firestore v9 f√ºggv√©nyek import√°l√°sa
        const { collection, doc, getDocs, setDoc, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js");

        // K√∂vetkez≈ë dokumentum ID meghat√°roz√°sa
        const collectionRef = collection(db, 'homePageData', 'feedback', collectionName);
        const snapshot = await getDocs(collectionRef);

        let nextId = 1;
        if (!snapshot.empty) {
          const docIds = snapshot.docs.map(docSnapshot => parseInt(docSnapshot.id)).filter(id => !isNaN(id));
          if (docIds.length > 0) {
            nextId = Math.max(...docIds) + 1;
          }
        }

        // √öj feedback dokumentum l√©trehoz√°sa
        const feedbackData = {
          title: titleInput.value.trim(),
          description: descriptionInput.value.trim(),
          class: '8.E', // Hardcoded am√≠g nincs Firebase Auth - ut√°na jobDescription lesz
          timestamp: serverTimestamp()
        };

        const newDocRef = doc(collectionRef, nextId.toString());
        await setDoc(newDocRef, feedbackData);

        // Sikeres bek√ºld√©s - toast megjelen√≠t√©se
        showToast('‚úì Sikeresen bek√ºldted a visszajelz√©st!', 'success');

        // Form resetel√©se
        titleInput.value = '';
        descriptionInput.value = '';

        // Popup bez√°r√°sa
        closeFeedbackPopup();

      } catch (error) {
        console.error('Hiba a feedback bek√ºld√©sekor:', error);
        showToast('Hiba t√∂rt√©nt a bek√ºld√©s sor√°n. Pr√≥b√°ld √∫jra!', 'error');
      }
    }

    // √Åltal√°nos toast megjelen√≠t≈ë f√ºggv√©ny
    function showToast(message, type = 'success') {
      // Megl√©v≈ë toast elt√°vol√≠t√°sa
      const existingToast = document.querySelector('.feedback-toast');
      if (existingToast) {
        existingToast.remove();
      }

      // √öj toast l√©trehoz√°sa
      const toast = document.createElement('div');
      toast.className = `feedback-toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);

      // Megjelen√≠t√©s
      setTimeout(() => toast.classList.add('show'), 10);

      // 3 m√°sodperc ut√°n elt≈±nik
      setTimeout(() => {
        toast.classList.remove('show');
        toast.classList.add('hide');

        setTimeout(() => {
          toast.remove();
        }, 300);
      }, 3000);
    }

    // Progress carousel functionality
    let currentSlide = 0;
    const totalSlides = 4;
    let carouselInterval;
    let carouselImages = {};
    
    // Preload images from Firebase
    async function preloadCarouselImages() {
      try {
        // Import Firebase functions
        const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js");
        
        // Get the csehonap2025 document
        const docRef = doc(db, 'events', 'csehonap2025');
        const docSnap = await getDoc(docRef);
        
        if (docSnap.exists()) {
          const data = docSnap.data();
          
          // Preload images for each slide
          for (let i = 1; i <= 4; i++) {
            const imageUrl = data[`pic${i}URL`];
            if (imageUrl) {
              try {
                // Test if image loads successfully
                const img = new Image();
                img.onload = () => {
                  carouselImages[i] = imageUrl;
                  console.log(`‚úÖ Loaded image ${i}:`, imageUrl);
                };
                img.onerror = () => {
                  console.log(`‚ùå Failed to load image ${i}, using placeholder`);
                  carouselImages[i] = '/EU2K-Hub/assets/placeholder_img.svg';
                };
                img.src = imageUrl;
              } catch (error) {
                console.log(`‚ùå Error loading image ${i}:`, error);
                carouselImages[i] = '/EU2K-Hub/assets/placeholder_img.svg';
              }
            } else {
              console.log(`‚ö†Ô∏è No URL found for pic${i}URL, using placeholder`);
              carouselImages[i] = '/EU2K-Hub/assets/placeholder_img.svg';
            }
          }
        } else {
          console.log('‚ùå csehonap2025 document not found, using placeholders');
          for (let i = 1; i <= 4; i++) {
            carouselImages[i] = '/EU2K-Hub/assets/placeholder_img.svg';
          }
        }
      } catch (error) {
        console.error('‚ùå Error preloading carousel images:', error);
        // Fallback to placeholders
        for (let i = 1; i <= 4; i++) {
          carouselImages[i] = '/EU2K-Hub/assets/placeholder_img.svg';
        }
      }
    }
    
    function updateCarouselImage() {
      const imageElement = document.getElementById('carousel-image');
      const imageUrl = carouselImages[currentSlide + 1];
      
      if (imageUrl && imageElement) {
        imageElement.src = imageUrl;
        console.log(`üñºÔ∏è Updated carousel to slide ${currentSlide + 1} with image:`, imageUrl);
      }
    }
    
    function startCarousel() {
      // Set initial slide to 0 (first segment)
      currentSlide = 0;
      
      // Set initial active segment
      document.querySelectorAll('.progress-segment').forEach(segment => segment.classList.remove('active'));
      document.getElementById(`progress-${currentSlide + 1}`).classList.add('active');
      
      // Set initial image
      updateCarouselImage();
      
      carouselInterval = setInterval(() => {
        // Remove current active segment
        document.getElementById(`progress-${currentSlide + 1}`).classList.remove('active');
        
        // Move to next slide (0, 1, 2, 3, 0, 1, 2, 3...)
        currentSlide = (currentSlide + 1) % totalSlides;
        
        // Add active class to new segment
        document.getElementById(`progress-${currentSlide + 1}`).classList.add('active');
        
        // Update image
        updateCarouselImage();
        
        console.log(`üìä Progress bar now on segment ${currentSlide + 1}`);
        
      }, 5000); // 5 seconds for testing, change back to 20000 for production
    }
    
    // Navigation functions
    function navigateToFinishJoin() {
      // Generate group ID based on group name
      const groupNameInput = document.getElementById('group-name-input');
      if (groupNameInput && groupNameInput.value.trim()) {
        window.currentGroupId = generateGroupId(groupNameInput.value.trim());
        console.log(`üÜî Generated Group ID: ${window.currentGroupId}`);
      }
      
      // Generate session ID (placeholder for now)
      const sessionId = 'y3o4bby5re'; // This should be generated dynamically
      const userId = 'CUvAu5ZLjQV4FJcd3JpzeqF8cJu2'; // This should come from auth
      
      window.location.hash = `finish-join#${userId}+${sessionId}`;
    }
    
    function navigateBackToMainJoin() {
      window.location.hash = 'main-join';
    }
    
    // Generate group ID from group name
    function generateGroupId(groupName) {
      // Convert to lowercase and remove special characters like ., /, spaces
      let cleanName = groupName.toLowerCase()
        .replace(/[.\s\/]/g, '') // Remove dots, spaces, slashes
        .replace(/[^\w]/g, ''); // Remove any remaining special characters
      
      // Add current year
      const currentYear = new Date().getFullYear();
      return `${cleanName}${currentYear}`;
    }
    
    // Finalize join process
    async function finalizeJoin() {
      try {
        // Check if user is authenticated
        if (!auth.currentUser) {
          showPopup('‚ùå Hiba', 'Be kell jelentkezned a csatlakoz√°shoz!', 'error');
          return;
        }
        
        const currentUser = auth.currentUser;
        const groupId = window.currentGroupId;
        
        if (!groupId) {
          showPopup('‚ùå Hiba', 'Nincs √©rv√©nyes csoport azonos√≠t√≥!', 'error');
          return;
        }
        
        console.log(`üîç Checking group validation for user ${currentUser.uid} in group ${groupId}`);
        
        // Import Firestore functions
        const { doc, getDoc, setDoc, collection } = await import("https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js");
        
        // Check if user is in the class students list
        const studentsDocRef = doc(db, 'calendar', 'classes', groupId, 'students');
        const studentsDoc = await getDoc(studentsDocRef);
        
        if (!studentsDoc.exists()) {
          showPopup('‚ùå Hiba', `A csoport (${groupId}) nem tal√°lhat√≥ a rendszerben!`, 'error');
          return;
        }
        
        const studentsData = studentsDoc.data();
        const studentsString = studentsData.students || '';
        const studentIds = studentsString.split(',').map(id => id.trim()).filter(id => id.length > 0);
        
        console.log(`üìã Students in group ${groupId}:`, studentIds);
        
        if (!studentIds.includes(currentUser.uid)) {
          showPopup('‚ùå Hiba', 'Nem vagy tagja ennek az oszt√°lynak/csapatnak!', 'error');
          return;
        }
        
        console.log(`‚úÖ User ${currentUser.uid} is authorized for group ${groupId}`);
        
        // Get user display name
        const userName = currentUser.displayName || currentUser.email || 'N√©vtelen felhaszn√°l√≥';
        
        // Create document in groups/events/csehonap2025/{groupId}
        const groupDocRef = doc(db, 'groups', 'events', 'csehonap2025', groupId);
        const groupDoc = await getDoc(groupDocRef);
        
        let existingUsers = [];
        if (groupDoc.exists()) {
          existingUsers = groupDoc.data().users || [];
        }
        
        // Add user if not already in the list
        if (!existingUsers.includes(userName)) {
          existingUsers.push(userName);
          
          await setDoc(groupDocRef, {
            users: existingUsers,
            groupName: document.getElementById('group-name-input').value.trim(),
            classTeacher: document.getElementById('class-teacher-input').value.trim(),
            description: document.getElementById('group-description-input').value.trim(),
            foodName: document.getElementById('food-name-input').value.trim(),
            lastUpdated: new Date().toISOString()
          });
          
          console.log(`üìù Added user ${userName} to group ${groupId}`);
          showPopup('‚úÖ Sikeres csatlakoz√°s!', `Sikeresen csatlakozt√°l a ${groupId} csoporthoz. A jogosults√°gok automatikusan be√°ll√≠t√°sra ker√ºlnek.`, 'success');
        } else {
          console.log(`‚ÑπÔ∏è User ${userName} already in group ${groupId}`);
          showPopup('‚ÑπÔ∏è M√°r tag vagy!', `M√°r tagja vagy a ${groupId} csoportnak.`, 'info');
        }
        
      } catch (error) {
        console.error('‚ùå Error during join process:', error);
        showPopup('‚ùå Hiba', `Hiba t√∂rt√©nt a csatlakoz√°s sor√°n: ${error.message}`, 'error');
      }
    }
    
    // Food item management
    let foodItemCount = 0;
    
    function addFoodItem() {
      foodItemCount++;
      const foodList = document.getElementById('food-items-list');
      
      const foodItem = document.createElement('div');
      foodItem.className = 'food-item';
      foodItem.id = `food-item-${foodItemCount}`;
      
      foodItem.innerHTML = `
        <div class="food-item-container">
          <div class="food-image-container" style="background-color: #272B26;">
            <img src="/EU2K-Hub/assets/placeholder_img.svg" alt="√âtel k√©p" class="food-image">
          </div>
          <div class="food-details">
            <div class="food-input-group">
              <input type="text" class="food-name-input" placeholder="N√©v" />
            </div>
            <div class="food-input-group">
              <input type="text" class="food-description-input" placeholder="R√∂vid le√≠r√°s" />
            </div>
            <button class="save-later-btn" disabled style="background-color: #9CD49F;">
              <img src="/EU2K-Hub/assets/events/csehonap/save.svg" alt="Ment√©s" class="save-icon">
              Ment√©s k√©s≈ëbbre
            </button>
          </div>
        </div>
        <div class="divider"></div>
      `;
      
      foodList.appendChild(foodItem);
      
      // Move FAB button down
      const fab = document.getElementById('add-food-fab');
      fab.style.marginTop = '16px';
    }
    

    
    function showPopup(title, message, type) {
      // Create popup element
      const popup = document.createElement('div');
      popup.className = `popup-notification ${type}`;
      popup.innerHTML = `
        <div class="popup-content">
          <div class="popup-icon">
            ${type === 'success' ? 
              '<svg viewBox="0 0 24 24"><path d="M9,20.42L2.79,14.21L5.62,11.38L9,14.77L18.88,4.88L21.71,7.71L9,20.42Z"/></svg>' : 
              type === 'error' ?
              '<svg viewBox="0 0 24 24"><path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"/></svg>' :
              '<svg viewBox="0 0 24 24"><path d="M13,9H11V7H13M13,17H11V11H13M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z"/></svg>'
            }
          </div>
          <div class="popup-text">
            <div class="popup-title">${title}</div>
            <div class="popup-message">${message}</div>
          </div>
        </div>
      `;
      
      // Add popup to body
      document.body.appendChild(popup);
      
      // Animate in
      setTimeout(() => {
        popup.classList.add('show');
      }, 100);
      
      // Remove after 5 seconds
      setTimeout(() => {
        popup.classList.remove('show');
        setTimeout(() => {
          if (document.body.contains(popup)) {
            document.body.removeChild(popup);
          }
        }, 300);
      }, 5000);
    }

    // Hash change listener - same pattern as onboarding files
    window.addEventListener('hashchange', () => {
      const hashValue = location.hash.substring(1);
      console.log('Hash changed to:', hashValue);
      
      const mainContent = document.querySelector('.main-content');
      
      // Check if hash starts with 'finish-join' (handles both 'finish-join' and 'finish-join#userid+sessionid')
      if (hashValue.startsWith('finish-join')) {
        // Show finish-join page
        document.getElementById('main-join-page').style.display = 'none';
        document.getElementById('finish-join-page').style.display = 'flex';
        
        // Add class to control button visibility
        mainContent.classList.add('finish-join-active');
        
        // Stop carousel when on finish page
        if (carouselInterval) {
          clearInterval(carouselInterval);
        }
        
        // Extract user and session data if present
        if (hashValue.includes('#') && hashValue.includes('+')) {
          const hashParts = hashValue.split('#');
          if (hashParts.length > 1) {
            const [userId, sessionId] = hashParts[1].split('+');
            console.log('üîó Extracted session data - userId:', userId, 'sessionId:', sessionId);
            // Store for later use
            window.currentUserId = userId;
            window.currentSessionId = sessionId;
          }
        }
      } else {
        // Show main join page
        document.getElementById('main-join-page').style.display = 'flex';
        document.getElementById('finish-join-page').style.display = 'none';
        
        // Remove class to show main join buttons
        mainContent.classList.remove('finish-join-active');
        
        // Start carousel on main page
        startCarousel();
      }
    });

    // Add event listeners to textboxes
    function addTextboxListeners() {
      const groupNameInput = document.getElementById('group-name-input');
      const foodNameInput = document.getElementById('food-name-input');
      const classTeacherInput = document.getElementById('class-teacher-input');
      const groupDescriptionInput = document.getElementById('group-description-input');
      
      // Group name input listener
      if (groupNameInput) {
        groupNameInput.addEventListener('input', function() {
          const value = this.value.trim();
          if (value) {
            const groupId = generateGroupId(value);
            console.log(`üÜî Group ID preview: ${groupId}`);
          }
        });
      }
      
      // Food name input blur listener for Gemini API call
      if (foodNameInput) {
        foodNameInput.addEventListener('blur', async function() {
          const value = this.value.trim();
          if (value) {
            console.log(`üçΩÔ∏è Food name entered: ${value}`);
            await callGeminiForFoodBreakdown(value);
          }
        });
      }
      
      // Class teacher input listener
      if (classTeacherInput) {
        classTeacherInput.addEventListener('input', function() {
          console.log(`üë®‚Äçüè´ Class teacher: ${this.value}`);
        });
      }
      
      // Group description input listener
      if (groupDescriptionInput) {
        groupDescriptionInput.addEventListener('input', function() {
          console.log(`üìù Description: ${this.value}`);
        });
      }
    }

    // Gemini API call for food breakdown using GoogleGenAI SDK
    async function callGeminiForFoodBreakdown(foodText) {
      try {
        // Ensure Firebase Auth using singleton function
        try {
          await ensureFirebaseAuth();
        } catch (authError) {
          console.error('‚ùå Firebase Auth failed:', authError);
          showPopup('Hiteles√≠t√©si hiba', 'Nem siker√ºlt bejelentkezni a Firebase rendszerbe', 'error');
          return;
        }

        // Get GoogleGenAI instance
        const ai = await getGoogleGenAI();

        // Build the prompt
        const prompt = `Break down this food description into individual food items: "${foodText}"

    Return a JSON array where each item has:
    - name: the name of the individual food item
    - description: a short 2-3 word description in Hungarian
    - image: a descriptive text for generating an image of this food item

    Example format:
    [
      {
        "name": "S√ºlt Csirke",
        "description": "Ropog√≥s, f≈±szeres csirke",
        "image": "golden roasted chicken with herbs"
      }
    ]

    Only return the JSON array, no other text.`;

        // Call Gemini API using GoogleGenAI SDK
        const response = await ai.models.generateContent({
          model: "gemini-2.5-flash",
          contents: prompt,
          config: {
            thinkingConfig: {
              thinkingBudget: 0, // Disables thinking
            },
          }
        });

        const generatedText = response.text;

        // Safer JSON parsing with try/catch and regex extraction
        let foodItems;
        try {
          // First try direct parsing
          foodItems = JSON.parse(generatedText.trim());
        } catch (parseError) {
          console.error('‚ùå Direct JSON parse failed, trying regex extraction:', parseError);
          
          // Try to extract JSON array using regex
          const jsonMatch = generatedText.match(/\[[\s\S]*\]/);
          if (jsonMatch) {
            try {
              foodItems = JSON.parse(jsonMatch[0]);
            } catch (regexParseError) {
              console.error('‚ùå Regex JSON parse also failed:', regexParseError);
              throw new Error('Unable to parse Gemini response as JSON');
            }
          } else {
            console.error('‚ùå No JSON array found in response:', generatedText);
            throw new Error('No valid JSON array found in Gemini response');
          }
        }

        console.log('üçΩÔ∏è Gemini food breakdown:', foodItems);

        // Build the food list items
        buildFoodListItems(foodItems);

      } catch (error) {
        console.error('‚ùå Error calling Gemini API:', error);
        showPopup('Hiba t√∂rt√©nt az √©tel feldolgoz√°sa sor√°n', 'K√©rj√ºk pr√≥b√°lja √∫jra k√©s≈ëbb', 'error');
      }
    }

    // Build food list items from Gemini response
    function buildFoodListItems(foodItems) {
      // Remove existing food items container if it exists
      const existingContainer = document.querySelector('.food-items-container');
      if (existingContainer) {
        existingContainer.remove();
      }
      
      // Create food items container
      const foodItemsContainer = document.createElement('div');
      foodItemsContainer.className = 'food-items-container';
      
      // Build each food item
      foodItems.forEach((item, index) => {
        const foodItem = document.createElement('div');
        foodItem.className = 'food-item';
        foodItem.innerHTML = `
          <div class="food-item-image">
            <img src="/EU2K-Hub/assets/events/csehonap/food_placeholder.svg" alt="${item.name}" class="food-image" id="food-image-${index}">
          </div>
          <div class="food-item-details">
            <div class="food-item-name">${item.name}</div>
            <div class="food-item-description">${item.description}</div>
          </div>
        `;
        
        foodItemsContainer.appendChild(foodItem);
        
        // Generate image for this food item using Gemini
        generateFoodImage(item.image, index);
      });
      
      // Insert the container before the question mark container
      const infoSection = document.querySelector('.info-section');
      const questionMarkContainer = document.querySelector('.question-mark-container');
      infoSection.insertBefore(foodItemsContainer, questionMarkContainer);
      
      // Show completion message
      showCompletionMessage();
    }

    // Generate food image using GoogleGenAI SDK with Gemini 2.5 Flash Image
    async function generateFoodImage(imagePrompt, itemIndex) {
      try {
        // Ensure Firebase Auth using singleton function
        try {
          await ensureFirebaseAuth();
        } catch (authError) {
          console.error('‚ùå Firebase Auth failed for image generation:', authError);
          return;
        }
        
        // Get GoogleGenAI instance
        const ai = await getGoogleGenAI();
        
        // Generate image using GoogleGenAI SDK
        const prompt = `Generate a high-quality, appetizing, photorealistic image of: ${imagePrompt}. The image should be professional, well-lit, and suitable for a restaurant menu. Make it look delicious and appealing with vibrant colors and good composition.`;
        
        const response = await ai.models.generateContent({
          model: "gemini-2.5-flash-image-preview",
          contents: prompt,
        });

        console.log(`üñºÔ∏è Image generation response:`, response);
        
        // Check if image was generated successfully
        if (response.candidates && response.candidates[0] && response.candidates[0].content && response.candidates[0].content.parts) {
          for (const part of response.candidates[0].content.parts) {
            if (part.inlineData && part.inlineData.data) {
              // Convert base64 to blob and upload to ImgBB
              const imageData = part.inlineData.data;
              await uploadImageToImgBB(imageData, imagePrompt, itemIndex);
              return;
            }
          }
        }
        
        console.log('No image data found in response, using error fallback image');
        // Set error fallback image when no image data is found
        const imageElement = document.getElementById(`food-image-${itemIndex}`);
        if (imageElement) {
          imageElement.src = '/EU2K-Hub/assets/events/csehonap/error_image.svg';
          imageElement.alt = `Error generating image for ${imagePrompt}`;
        }
        
      } catch (error) {
        console.error(`‚ùå Error generating image for ${imagePrompt}:`, error);
        // Set error fallback image on error
        const imageElement = document.getElementById(`food-image-${itemIndex}`);
        if (imageElement) {
          imageElement.src = '/EU2K-Hub/assets/events/csehonap/error_image.svg';
          imageElement.alt = `Error generating image for ${imagePrompt}`;
        }
      }
    }

    // Upload base64 image to ImgBB
    async function uploadImageToImgBB(base64Data, imagePrompt, itemIndex) {
      try {
        const imgbbApiKey = 'your-imgbb-api-key'; // Replace with your ImgBB API key
        
        const formData = new FormData();
        formData.append('image', base64Data);
        formData.append('name', `food-${itemIndex}-${Date.now()}`);
        
        const response = await fetch(`https://api.imgbb.com/1/upload?key=${imgbbApiKey}`, {
          method: 'POST',
          body: formData
        });
        
        if (!response.ok) {
          throw new Error(`ImgBB upload error: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success && data.data && data.data.url) {
          // Update the image src with the uploaded image URL
          const imageElement = document.getElementById(`food-image-${itemIndex}`);
          if (imageElement) {
            imageElement.src = data.data.url;
            imageElement.alt = `Generated image of ${imagePrompt}`;
          }
        }
        
      } catch (error) {
        console.error(`‚ùå Error uploading image to ImgBB:`, error);
        // Set error fallback image on ImgBB upload error
        const imageElement = document.getElementById(`food-image-${itemIndex}`);
        if (imageElement) {
          imageElement.src = '/EU2K-Hub/assets/events/csehonap/error_image.svg';
          imageElement.alt = `Error uploading image for ${imagePrompt}`;
        }
      }
    }

    // Show completion message and refresh button
    function showCompletionMessage() {
      const infoSection = document.querySelector('.info-section');
      
      // Remove existing completion section if it exists
      const existingCompletion = document.querySelector('.completion-section');
      if (existingCompletion) {
        existingCompletion.remove();
      }
      
      // Create completion section
      const completionSection = document.createElement('div');
      completionSection.className = 'completion-section';
      completionSection.innerHTML = `
        <div class="completion-message">
          K√©szen van a men√ºd.
        </div>
        <div class="completion-subtitle">
          Ha nem tetszik vagy valami baj van vele pr√≥b√°lkozz √∫jra!
        </div>
        <button class="refresh-btn" onclick="retryGeminiCall()">
          <svg class="refresh-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
          </svg>
          √öjra
        </button>
      `;
      
      infoSection.appendChild(completionSection);
    }

    // Retry Gemini call
    async function retryGeminiCall() {
      const foodNameInput = document.getElementById('food-name-input');
      const foodText = foodNameInput.value.trim();
      
      if (foodText) {
        // Remove existing completion section
        const existingCompletion = document.querySelector('.completion-section');
        if (existingCompletion) {
          existingCompletion.remove();
        }
        
        await callGeminiForFoodBreakdown(foodText);
      }
    }
    
    // Check initial hash on page load
    window.addEventListener('DOMContentLoaded', async () => {
      console.log('üöÄ CSE-HO 2025 Join page loaded');
      
      // Add textbox listeners
      addTextboxListeners();
      
      // Preload carousel images first
      await preloadCarouselImages();
      
      const initialHash = location.hash.substring(1);
      console.log('Initial hash on load:', initialHash);
      
      // Handle initial hash - trigger hashchange event manually
      if (initialHash) {
        // Manually trigger the hashchange logic
        window.dispatchEvent(new HashChangeEvent('hashchange'));
      } else {
        // Start carousel on page load if no hash (main page)
        startCarousel();
      }
    });
  </script>

</body>

</html>