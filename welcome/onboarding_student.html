<!DOCTYPE html>
<html lang="hu">

<head>
  <meta charset="UTF-8">
  <meta name="description"
    content="Nagyon Ã¶rÃ¼lÃ¼nk hogy itt vagy velÃ¼nk, Ã©s Ã©rdeklÅ‘dsz a Hub irÃ¡nt. KÃ©rlek fejezd be ezt a gyors bemutatÃ³t, Ã©s mÃ¡ris elkezdheted hasznÃ¡lni a Hubot!">
  <title data-translate="pages.onboarding_student.title">ÃœdvÃ¶zlÃ¼nk a Hub-ban!</title>
  <link rel="stylesheet" href="onboarding_student.css">
  <link rel="icon" href="/EU2K-Hub/favicon.ico">
  <script type="importmap">
    {
      "imports": {
        "@material/web/": "https://esm.run/@material/web/"
      }
    }
  </script>
  <script type="module">
    import '@material/web/all.js';
    import { styles as typescaleStyles } from '@material/web/typography/md-typescale-styles.js';

    document.adoptedStyleSheets.push(typescaleStyles.styleSheet);
  </script>
  <script src="/EU2K-Hub/assets/js/permissions.js"></script>
  <script src="/EU2K-Hub/assets/js/translations.js"></script>
  <script src="/EU2K-Hub/assets/js/welcome-screen.js"></script>
  <script src="/EU2K-Hub/assets/js/terms-redirect.js"></script>
  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-analytics.js";
    import { getFirestore } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
    import { getAuth, OAuthProvider, signInWithRedirect, signInWithPopup, getRedirectResult, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
    // Import Google provider
      import { GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBRRVx6BtQtCDKjFYA8yh9qYrcUONmkkwI",
      authDomain: "eu2k-hub.firebaseapp.com",
      projectId: "eu2k-hub",
      storageBucket: "eu2k-hub.firebasestorage.app",
      messagingSenderId: "560244867055",
      appId: "1:560244867055:web:3cd51b85baead94989001a",
      measurementId: "G-2JDPR089WD"
    };
    
    console.log('ğŸ”§ Current domain:', window.location.origin);
    console.log('ğŸ”§ Auth domain:', firebaseConfig.authDomain);
    
    // Check if we're on localhost and warn about domain issues
    if (window.location.hostname === '127.0.0.1' || window.location.hostname === 'localhost') {
      console.warn('âš ï¸ LOCALHOST DETECTED - Firebase auth may not work properly!');
      console.warn('âš ï¸ You need to add this domain to Firebase Authorized Domains:');
      console.warn(`âš ï¸ Add: ${window.location.origin} to Firebase Console > Authentication > Settings > Authorized domains`);
    }
    
    // Persistent logging system
    const persistentLog = {
      add: (message) => {
        try {
          const logs = JSON.parse(localStorage.getItem('eu2k-debug-logs') || '[]');
          logs.push(`${new Date().toISOString()}: ${message}`);
          // Keep only last 20 logs
          if (logs.length > 20) logs.shift();
          localStorage.setItem('eu2k-debug-logs', JSON.stringify(logs));
          console.log(message);
        } catch (e) {
          console.log(message);
        }
      },
      show: () => {
        try {
          const logs = JSON.parse(localStorage.getItem('eu2k-debug-logs') || '[]');
          console.log('ğŸ“‹ Persistent logs:');
          logs.forEach(log => console.log(log));
          return logs;
        } catch (e) {
          console.log('No persistent logs found');
          return [];
        }
      },
      clear: () => {
        localStorage.removeItem('eu2k-debug-logs');
        console.log('ğŸ§¹ Cleared persistent logs');
      }
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Initialize terms redirect handler
    if (window.initializeTermsRedirect) {
      window.initializeTermsRedirect(auth);
    }



    // Import Ã©s inicializÃ¡lÃ¡s az onboarding handler modulbÃ³l
    import { initializeOnboarding } from '../assets/js/onboarding-handler.js';
    
    // InicializÃ¡ljuk az onboarding figyelÃ©st
    initializeOnboarding(auth, db, 'student');

    // Import Firestore debug module
    import('../assets/js/firestore-debug.js').catch(err => {
      console.warn('Firestore debug module not loaded:', err);
    });
    
    // Firebase helper functions
    window.checkExistingUser = async (uid) => {
      try {
        persistentLog.add(`ğŸ” Checking if user exists in Firebase: ${uid}`);
        const userRef = doc(db, 'users', uid);
        const userSnap = await getDoc(userRef);
        
        if (userSnap.exists()) {
          persistentLog.add(`âœ… User found in Firebase: ${uid}`);
          return userSnap.data();
        } else {
          persistentLog.add(`âŒ User not found in Firebase: ${uid}`);
          return null;
        }
      } catch (error) {
        persistentLog.add(`âŒ Error checking existing user: ${error.message}`);
        throw error;
      }
    };

    window.saveUserToFirebase = async (userData) => {
      try {
        persistentLog.add(`ğŸ’¾ Saving user data to Firebase: ${userData.uid}`);
        
        // Check if user already exists
        const existingUser = await checkExistingUser(userData.uid);
        
        const userRef = doc(db, 'users', userData.uid);
        const now = new Date().toISOString();
        
        if (existingUser) {
          // Update existing user
          const updateData = {
            lastLogin: now,
            email: userData.email,
            displayName: userData.displayName,
            photoURL: userData.photoURL
          };
          
          // Only update jobTitle if it's provided and different
          if (userData.jobTitle && userData.jobTitle !== existingUser.jobTitle) {
            updateData.jobTitle = userData.jobTitle;
          }
          
          await updateDoc(userRef, updateData);
          persistentLog.add(`âœ… Updated existing user in Firebase: ${userData.uid}`);
        } else {
          // Create new user with complete data structure
          const newUserData = {
            uid: userData.uid,
            email: userData.email,
            displayName: userData.displayName,
            photoURL: userData.photoURL || '/EU2K-Hub/assets/avatars/magenta.png',
            profilePictureUrl: userData.photoURL || '',
            jobTitle: userData.jobTitle || '',
            accessLevel: 'basic',
            accountType: 'Iskolai FiÃ³k',
            birthDate: '',
            comment: 'General profile document created at the end of onboarding with security layer data.',
            createdAt: now,
            lastUpdated: now,
            onboardingCompleted: true,
            termsAccepted: 'true',
            welcomeScreenVisited: true,
            pfpColor: '',
            selectedAvatar: null,
            useProvidedPfp: true,
            messageSettings: {
              messagePrivacy: 'nobody',
              privateMessages: true
            },
            notificationSettings: {
              notification_0: true,
              notification_1: false,
              notification_2: true,
              notification_3: false,
              notification_4: false,
              notification_5: false,
              notification_6: true,
              notification_7: true,
              notification_8: false
            }
          };
          
          await setDoc(userRef, newUserData);
          persistentLog.add(`âœ… Created new user in Firebase: ${userData.uid}`);
        }
        
        return true;
      } catch (error) {
        persistentLog.add(`âŒ Error saving user to Firebase: ${error.message}`);
        throw error;
      }
    };

    // Global onboarding debug functions
    window.onboardingDebug = {
      skip: () => window.debugAuth.skipOnboarding(),
      reset: () => window.debugAuth.resetOnboarding(),
      status: () => window.debugAuth.showOnboardingStatus(),
      goToApp: () => {
        console.log('ğŸš€ Going directly to main app...');
        window.location.href = '/EU2K-Hub/index.html';
      }
    };
    
    // Debug functions for manual testing
    window.debugAuth = {
      checkCurrentUser: () => {
        console.log('ğŸ” Current user:', auth.currentUser);
        return auth.currentUser;
      },
      forceProfileChooser: () => {
        const user = auth.currentUser;
        if (user) {
          console.log('ğŸš€ Forcing profile chooser with current user');
          proceedToProfileChooser(user);
        } else {
          console.log('âŒ No current user found');
        }
      },
      clearAuth: () => {
        localStorage.removeItem('eu2k-auth-logged-in');
        localStorage.removeItem('eu2k-auth-display-name');
        console.log('ğŸ§¹ Cleared auth localStorage');
      },
      checkRedirectUrl: () => {
        const expectedRedirect = `${window.location.origin}${window.location.pathname}`;
        console.log('ğŸ”— Expected redirect URL:', expectedRedirect);
        console.log('ğŸ”— Current URL:', window.location.href);
        console.log('ğŸ”— Auth domain:', firebaseConfig.authDomain);
        return expectedRedirect;
      },
      testPopupAuth: () => {
        console.log('ğŸªŸ Testing popup auth...');
        signInWithPopup(auth, msProvider)
          .then((result) => {
            console.log('âœ… Popup auth successful:', result);
            proceedToProfileChooser(result.user);
          })
          .catch((error) => {
            console.error('âŒ Popup auth failed:', error);
          });
      },
      showLogs: () => {
        return persistentLog.show();
      },
      clearLogs: () => {
        persistentLog.clear();
      },
      diagnoseAuthIssue: () => {
        console.log('ğŸ” PROBLEM IDENTIFIED FROM LOGS:');
        console.log('âŒ Microsoft redirected back WITHOUT auth code/state parameters');
        console.log('âŒ This means Azure is configured to redirect to localhost directly');
        console.log('âŒ Instead of going through Firebase auth handler first');
        
        console.log('\nğŸ”§ ROOT CAUSE:');
        console.log('Azure App Registration has localhost in redirect URIs');
        console.log('Current domain:', window.location.origin);
        console.log('Firebase auth domain:', firebaseConfig.authDomain);
        console.log('Expected flow: localhost â†’ Microsoft â†’ Firebase â†’ localhost');
        console.log('Actual flow: localhost â†’ Microsoft â†’ localhost (WRONG!)');
        
        console.log('\nğŸ”§ IMMEDIATE FIX:');
        console.log('1. Remove ALL localhost redirect URIs from Azure');
        console.log('2. Only keep: https://eu2k-hub.firebaseapp.com/__/auth/handler');
        console.log('3. Firebase will handle the redirect back to localhost');
        
        console.log('\nğŸ§ª ALTERNATIVE TEST:');
        console.log('Try production URL: window.debugAuth.tryProductionAuth()');
        
        return {
          problem: 'Azure redirecting to localhost instead of Firebase handler',
          currentDomain: window.location.origin,
          authDomain: firebaseConfig.authDomain,
          expectedFlow: 'localhost â†’ Microsoft â†’ Firebase â†’ localhost',
          actualFlow: 'localhost â†’ Microsoft â†’ localhost',
          solution: 'Remove localhost redirect URIs from Azure'
        };
      },
      tryProductionAuth: () => {
        const productionUrl = 'https://eu2k-hub.firebaseapp.com/welcome/onboarding_student.html#step2';
        console.log('ğŸš€ Redirecting to production for auth:', productionUrl);
        window.location.href = productionUrl;
      },
      testDirectFirebaseAuth: () => {
        console.log('ğŸ§ª Testing direct Firebase auth redirect...');
        const testUrl = `https://eu2k-hub.firebaseapp.com/__/auth/handler?apiKey=${firebaseConfig.apiKey}&appName=[DEFAULT]&authType=signInViaRedirect&providerId=microsoft.com`;
        console.log('Test URL:', testUrl);
        console.log('Opening in new tab...');
        window.open(testUrl, '_blank');
      },
      checkAzureConfig: () => {
        console.log('ğŸ” AZURE APP REGISTRATION PROBLEM IDENTIFIED:');
        console.log('âŒ Microsoft is redirecting to localhost instead of Firebase handler!');
        console.log('âŒ This means Azure has the wrong redirect URI configured.');
        console.log('\nğŸ”§ IMMEDIATE FIX NEEDED:');
        console.log('1. Azure Portal > App registrations > Your App');
        console.log('2. Authentication tab');
        console.log('3. Platform configurations > Web');
        console.log('4. REMOVE any localhost redirect URIs like:');
        console.log('   âŒ http://127.0.0.1:5500/...');
        console.log('   âŒ http://localhost:5500/...');
        console.log('5. ONLY keep this redirect URI:');
        console.log('   âœ… https://eu2k-hub.firebaseapp.com/__/auth/handler');
        console.log('\n6. Make sure these are enabled:');
        console.log('   âœ… Access tokens (used for implicit flows)');
        console.log('   âœ… ID tokens (used for implicit and hybrid flows)');
        console.log('\nğŸ’¡ The issue: Azure is redirecting directly to your localhost');
        console.log('   instead of going through Firebase auth handler first!');
      },
      checkFirebaseConfig: () => {
        console.log('ğŸ” FIREBASE CONFIGURATION CHECK:');
        console.log('1. Firebase Console > Authentication > Sign-in method');
        console.log('2. Microsoft provider should be enabled');
        console.log('3. Check these settings:');
        console.log('   - Web SDK configuration');
        console.log('   - Client ID from Azure');
        console.log('   - Client secret from Azure');
        console.log('\n4. Firebase Console > Authentication > Settings > Authorized domains');
        console.log('   Should include:');
        console.log('   âœ… eu2k-hub.firebaseapp.com');
        console.log('   âœ… 127.0.0.1');
        console.log('   âœ… localhost');
        
        // Test Firebase auth configuration
        console.log('\nğŸ§ª Testing Firebase auth config...');
        try {
          const authUrl = `https://identitytoolkit.googleapis.com/v1/accounts:signInWithIdp?key=${firebaseConfig.apiKey}`;
          console.log('Firebase Auth API URL:', authUrl);
          
          // Check if we can reach Firebase auth
          fetch(authUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ returnSecureToken: true })
          }).then(response => {
            console.log('Firebase Auth API response status:', response.status);
            if (response.status === 400) {
              console.log('âœ… Firebase Auth API is reachable (400 = missing params, which is expected)');
            }
          }).catch(error => {
            console.log('âŒ Firebase Auth API error:', error);
          });
        } catch (error) {
          console.log('âŒ Firebase config test error:', error);
        }
      },
      simulateSuccessfulAuth: () => {
        console.log('ğŸ­ Simulating successful auth for testing...');
        // Create a mock user object
        const mockUser = {
          uid: 'test-uid-123',
          email: 'test@example.com',
          displayName: 'Test User',
          photoURL: null
        };
        
        // Set auth flags
        localStorage.setItem('eu2k-auth-logged-in', 'true');
        localStorage.setItem('eu2k-auth-display-name', mockUser.displayName);
        
        console.log('ğŸ­ Mock user created, proceeding to profile chooser...');
        proceedToProfileChooser(mockUser);
      },
      quickFix: () => {
        console.log('ğŸš€ QUICK FIX: Opening production URL...');
        console.log('This will work because production uses the correct Firebase auth flow');
        window.debugAuth.tryProductionAuth();
      },
      skipOnboarding: () => {
        console.log('â­ï¸ SKIPPING ONBOARDING PROCESS...');
        
        // Set all required flags to skip welcome screen
        localStorage.setItem('termsAccepted', 'true');
        localStorage.setItem('eu2k-auth-logged-in', 'true');
        localStorage.setItem('eu2k-auth-display-name', 'Debug User');
        localStorage.setItem('onboardingCompleted', 'true');
        localStorage.setItem('welcomeScreenVisited', 'true');
        
        console.log('âœ… Set termsAccepted = true');
        console.log('âœ… Set auth logged in = true');
        console.log('âœ… Set display name = Debug User');
        console.log('âœ… Set onboarding completed = true');
        console.log('âœ… Set welcome screen visited = true');
        
        // Check if welcome screen manager exists and mark as visited
        if (window.welcomeScreenManager) {
          window.welcomeScreenManager.markAsVisited();
          console.log('âœ… Marked welcome screen as visited via manager');
        }
        
        console.log('ğŸš€ Redirecting to main app...');
        
        // Redirect to main app
        setTimeout(() => {
          window.location.href = '/EU2K-Hub/index.html';
        }, 1000);
      },
      resetOnboarding: () => {
        console.log('ğŸ”„ RESETTING ONBOARDING...');
        
        // Clear all onboarding related flags
        localStorage.removeItem('termsAccepted');
        localStorage.removeItem('eu2k-auth-logged-in');
        localStorage.removeItem('eu2k-auth-display-name');
        localStorage.removeItem('onboardingCompleted');
        localStorage.removeItem('welcomeScreenVisited');
        localStorage.removeItem('eu2k-auth-in-progress');
        localStorage.removeItem('eu2k-auth-start-time');
        
        console.log('âœ… Cleared all onboarding flags');
        console.log('ğŸ”„ Reloading page...');
        
        // Reload to start fresh
        window.location.reload();
      },
      showOnboardingStatus: () => {
        console.log('ğŸ“Š ONBOARDING STATUS:');
        console.log('Terms accepted:', localStorage.getItem('termsAccepted'));
        console.log('Auth logged in:', localStorage.getItem('eu2k-auth-logged-in'));
        console.log('Display name:', localStorage.getItem('eu2k-auth-display-name'));
        console.log('Onboarding completed:', localStorage.getItem('onboardingCompleted'));
        console.log('Welcome screen visited:', localStorage.getItem('welcomeScreenVisited'));
        console.log('Auth in progress:', localStorage.getItem('eu2k-auth-in-progress'));
        
        return {
          termsAccepted: localStorage.getItem('termsAccepted'),
          authLoggedIn: localStorage.getItem('eu2k-auth-logged-in'),
          displayName: localStorage.getItem('eu2k-auth-display-name'),
          onboardingCompleted: localStorage.getItem('onboardingCompleted'),
          welcomeScreenVisited: localStorage.getItem('welcomeScreenVisited'),
          authInProgress: localStorage.getItem('eu2k-auth-in-progress')
        };
      }
    };

    // Microsoft provider and sign-in flow
    const msProvider = new OAuthProvider('microsoft.com');
    
    // Log provider setup
    persistentLog.add('ğŸ”§ Setting up Microsoft OAuth provider...');
    
    // Enforce single-tenant (org-only) login using specific Tenant ID
    msProvider.setCustomParameters({ 
      tenant: 'ecc426dd-3c83-44af-aad4-85099364fb9e',
      prompt: 'select_account'
    });
    
    persistentLog.add('ğŸ”§ Custom parameters set: prompt=select_account');
    
    // Request Graph profile access
    try { 
      msProvider.addScope('User.Read');
      msProvider.addScope('profile');
      msProvider.addScope('email');
      msProvider.addScope('openid');
      persistentLog.add('ğŸ”§ Scopes added: User.Read, profile, email, openid');
    } catch (error) {
      persistentLog.add(`âš ï¸ Could not add scopes: ${error.message}`);
    }
    
    // Log the final provider config
    persistentLog.add(`ğŸ”§ Final provider config: ${JSON.stringify({
      providerId: msProvider.providerId,
      scopes: msProvider.scopes,
      customParameters: msProvider.customParameters
    })}`);

    // Expose start function for the inline navigation script
    window.startMicrosoftSignIn = () => {
      persistentLog.add('ğŸ” Starting Microsoft Sign-In process...');
      persistentLog.add(`Auth provider configured: ${JSON.stringify(msProvider)}`);
      persistentLog.add(`ğŸŒ Current URL: ${window.location.href}`);
      
      // Mark that we're starting auth
      localStorage.setItem('eu2k-auth-in-progress', 'true');
      localStorage.setItem('eu2k-auth-start-time', Date.now().toString());
      
      // Show the auth-in-progress page without changing the hash
      showPage('auth-in-progress');
      
      // Always use popup for authentication
      persistentLog.add('ğŸªŸ Attempting signInWithPopup');
      signInWithPopup(auth, msProvider)
          .then((result) => {
            persistentLog.add('âœ… Popup auth successful');
            localStorage.removeItem('eu2k-auth-in-progress');
            
            // Fetch Microsoft Graph API data immediately after successful popup auth
            try {
              const credential = OAuthProvider.credentialFromResult(result);
              const accessToken = credential && credential.accessToken;
              persistentLog.add(`ğŸ”‘ Access token available: ${!!accessToken}`);
              
              if (accessToken) {
                persistentLog.add('ğŸ“¡ Fetching user data from Microsoft Graph...');
                
                // Fetch user profile data including photo
                Promise.all([
                  fetch('https://graph.microsoft.com/v1.0/me', {
                    headers: { Authorization: `Bearer ${accessToken}` }
                  }).then(r => r.json()),
                  fetch('https://graph.microsoft.com/v1.0/me/photo/$value', {
                    headers: { Authorization: `Bearer ${accessToken}` }
                  }).then(r => {
                    if (r.ok) {
                      return r.blob().then(blob => URL.createObjectURL(blob));
                    }
                    return null;
                  }).catch(() => null)
                ]).then(([userData, photoURL]) => {
                  persistentLog.add(`ğŸ“Š Graph API user data: ${JSON.stringify(userData)}`);
                  persistentLog.add(`ğŸ–¼ï¸ Graph API photo URL: ${photoURL ? 'obtained' : 'not available'}`);
                  
                  // Prepare user data for Firebase
                  const graphUserData = {
                    email: userData.mail || userData.userPrincipalName || result.user.email,
                    displayName: userData.displayName || result.user.displayName,
                    photoURL: photoURL || result.user.photoURL,
                    jobTitle: userData.jobTitle || null,
                    uid: result.user.uid,
                    provider: 'microsoft.com',
                    lastLogin: new Date().toISOString()
                  };
                  
                  persistentLog.add(`ğŸ’¾ Prepared user data for Firebase: ${JSON.stringify(graphUserData)}`);
                  
                  // Save to localStorage for immediate use
                  if (graphUserData.displayName) {
                    localStorage.setItem('eu2k-auth-display-name', graphUserData.displayName);
                    persistentLog.add(`ğŸ’¾ Saved display name: ${graphUserData.displayName}`);
                  }
                  if (graphUserData.email) {
                    localStorage.setItem('eu2k-auth-email', graphUserData.email);
                    persistentLog.add(`ğŸ’¾ Saved email: ${graphUserData.email}`);
                  }
                  if (graphUserData.photoURL) {
                    localStorage.setItem('eu2k-auth-photo-url', graphUserData.photoURL);
                    persistentLog.add(`ğŸ’¾ Saved photo URL: ${graphUserData.photoURL}`);
                  }
                  if (graphUserData.jobTitle) {
                    localStorage.setItem('eu2k-auth-job-title', graphUserData.jobTitle);
                    persistentLog.add(`ğŸ’¾ Saved job title: ${graphUserData.jobTitle}`);
                  }
                  
                  // Save to Firebase (assuming Firebase functions are available)
                  if (typeof saveUserToFirebase === 'function') {
                    saveUserToFirebase(graphUserData).then(() => {
                      persistentLog.add('âœ… User data saved to Firebase successfully');
                    }).catch((error) => {
                      persistentLog.add(`âŒ Firebase save error: ${error.message}`);
                    });
                  } else {
                    persistentLog.add('âš ï¸ saveUserToFirebase function not available, data saved to localStorage only');
                  }
                  
                  // Update result.user with Graph data before proceeding
                  if (graphUserData.photoURL) {
                    result.user.photoURL = graphUserData.photoURL;
                  }
                  if (graphUserData.displayName) {
                    result.user.displayName = graphUserData.displayName;
                  }
                  
                  // Now proceed to profile chooser with updated user data
                  proceedToProfileChooser(result.user);
                  
                }).catch((error) => {
                  persistentLog.add(`âŒ Graph API error: ${error.message}`);
                  // Show onboarding failed for Graph API errors
                  showOnboardingFailed();
                  return;
                });
                
                // Store the access token for later use
                localStorage.setItem('eu2k-ms-access-token', accessToken);
                persistentLog.add('ğŸ’¾ Saved Microsoft access token for later use');
              } else {
                persistentLog.add('âš ï¸ No access token available for Microsoft Graph API calls');
                proceedToProfileChooser(result.user);
              }
            } catch (error) {
              persistentLog.add(`âŒ Credential extraction error: ${error.message}`);
              showOnboardingFailed();
            }
          })
          .catch((error) => {
            persistentLog.add(`âŒ Popup auth failed: ${error?.code || ''} ${error?.message || error}`);
            // Show login failed page
            showPage('login-failed');
            localStorage.removeItem('eu2k-auth-in-progress');
          });
    };

    // Teacher Microsoft sign-in function
    window.startMicrosoftSignInTeacher = () => {
      persistentLog.add('ğŸ‘¨â€ğŸ« Starting Microsoft Sign-In process for teacher...');
      
      // Mark that we're starting auth
      localStorage.setItem('eu2k-auth-in-progress', 'true');
      localStorage.setItem('eu2k-auth-start-time', Date.now().toString());
      
      // Show the auth-in-progress page
      showPage('auth-in-progress');
      
      // Use popup for authentication
      persistentLog.add('Attempting signInWithPopup for teacher');
      signInWithPopup(auth, msProvider)
          .then((result) => {
            persistentLog.add('âœ… Teacher popup auth successful');
            localStorage.removeItem('eu2k-auth-in-progress');
            proceedToTeacherProfileChooser(result.user);
          })
          .catch((error) => {
            persistentLog.add(`âŒ Teacher popup auth failed: ${error?.code || ''} ${error?.message || error}`);
            showPage('login-failed');
            localStorage.removeItem('eu2k-auth-in-progress');
          });
    };

    // Google sign-in for parents
    window.startGoogleSignInParent = () => {
      persistentLog.add('ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Starting Google Sign-In process for parent...');
      
      const googleProvider = new GoogleAuthProvider();
      googleProvider.addScope('profile');
      googleProvider.addScope('email');
      
      // Mark that we're starting auth
      localStorage.setItem('eu2k-auth-in-progress', 'true');
      localStorage.setItem('eu2k-auth-start-time', Date.now().toString());
      
      // Show the auth-in-progress page
      showPage('auth-in-progress');
      
      // Use popup for authentication
      persistentLog.add('Attempting signInWithPopup with Google for parent');
      signInWithPopup(auth, googleProvider)
          .then((result) => {
            persistentLog.add('âœ… Parent Google auth successful');
            localStorage.removeItem('eu2k-auth-in-progress');
            proceedToParentProfileChooser(result.user);
          })
          .catch((error) => {
            persistentLog.add(`âŒ Parent Google auth failed: ${error?.code || ''} ${error?.message || error}`);
            showPage('login-failed');
            localStorage.removeItem('eu2k-auth-in-progress');
          });
    };

    // After redirect, continue to profile chooser and prefill
    const proceedToProfileChooser = async (user) => {
      console.log('âœ… Proceeding to profile chooser with user:', user);
      
      // Check if user data is valid
      if (!user || !user.displayName) {
        console.error('âŒ Invalid user data, showing onboarding failed');
        showOnboardingFailed();
        return;
      }
      
      // Check if user already exists in Firebase
      try {
        const existingUser = await checkExistingUser(user.uid);
        
        if (existingUser && existingUser.onboardingCompleted) {
          console.log('âœ… Existing user found with completed onboarding, redirecting to index.html');
          
          // Set up localStorage with existing user data
          localStorage.setItem('eu2k-auth-logged-in', 'true');
          localStorage.setItem('eu2k-auth-display-name', existingUser.displayName || user.displayName);
          localStorage.setItem('eu2k-auth-email', existingUser.email || user.email);
          localStorage.setItem('onboardingCompleted', 'true');
          localStorage.setItem('termsAccepted', existingUser.termsAccepted || 'true');
          localStorage.setItem('welcomeScreenVisited', 'true');
          
          if (existingUser.photoURL) {
            localStorage.setItem('eu2k-auth-photo-url', existingUser.photoURL);
          }
          if (existingUser.jobTitle) {
            localStorage.setItem('eu2k-auth-job-title', existingUser.jobTitle);
          }
          
          // Update last login in Firebase
          const userRef = doc(db, 'users', user.uid);
          await updateDoc(userRef, {
            lastUpdated: new Date().toISOString()
          });
          
          console.log('ğŸš€ Redirecting to main app...');
          setTimeout(() => {
            window.location.href = '/EU2K-Hub/index.html';
          }, 1000);
          return;
        }
      } catch (error) {
        console.error('âŒ Error checking existing user:', error);
        // Continue with normal onboarding flow if check fails
      }
      
      try {
        console.log('ğŸ‘¤ User data:', {
          displayName: user.displayName,
          email: user.mail,
          photoURL: user.photoURL,
          uid: user.id,
          jobTitle: user.jobTitle
        });
        
        const nameEl = document.querySelector('.main-avatar-name');
        if (nameEl && user.displayName) {
          nameEl.textContent = user.displayName;
          console.log('ğŸ“ Updated name element with:', user.displayName);
        }
        
        const imgEl = document.querySelector('.main-avatar-img');
        if (imgEl && user.photoURL) {
          imgEl.src = user.photoURL;
          console.log('ğŸ–¼ï¸ Updated avatar image with:', user.photoURL);
        }
        
        // Persist minimal auth state
        localStorage.setItem('eu2k-auth-logged-in', 'true');
        if (user.displayName) localStorage.setItem('eu2k-auth-display-name', user.displayName);
        console.log('ğŸ’¾ Saved auth state to localStorage');
      } catch (e) {
        console.error('âŒ Prefill failed:', e);
        showOnboardingFailed();
        return;
      }
      
      try { 
        localStorage.setItem('eu2k-onboarding-target', 'student-profile'); 
        console.log('ğŸ¯ Set onboarding target to student-profile');
      } catch (_) {
        showOnboardingFailed();
        return;
      }
      
      console.log('ğŸ”„ Navigating to student-profile page...');
      location.hash = 'student-profile';
    };

    // After redirect, continue to teacher profile chooser
    const proceedToTeacherProfileChooser = (user) => {
      console.log('âœ… Proceeding to teacher profile chooser with user:', user);
      try {
        if (user) {
          console.log('ğŸ‘¤ Teacher user data:', {
            displayName: user.displayName,
            email: user.email,
            photoURL: user.photoURL,
            uid: user.uid
          });
          
          // Persist minimal auth state
          localStorage.setItem('eu2k-auth-logged-in', 'true');
          if (user.displayName) localStorage.setItem('eu2k-auth-display-name', user.displayName);
          console.log('ğŸ’¾ Saved teacher auth state to localStorage');
        }
      } catch (e) {
        console.error('âŒ Teacher prefill failed:', e);
      }
      try { 
        localStorage.setItem('eu2k-onboarding-target', 'teacher-profile'); 
        console.log('ğŸ¯ Set onboarding target to teacher-profile');
      } catch (_) {}
      
      console.log('ğŸ”„ Navigating to teacher-profile page...');
      location.hash = 'teacher-profile';
    };

    // After redirect, continue to parent profile chooser
    const proceedToParentProfileChooser = (user) => {
      console.log('âœ… Proceeding to parent profile chooser with user:', user);
      try {
        if (user) {
          console.log('ğŸ‘¤ Parent user data:', {
            displayName: user.displayName,
            email: user.email,
            photoURL: user.photoURL,
            uid: user.uid
          });
          
          // Persist minimal auth state
          localStorage.setItem('eu2k-auth-logged-in', 'true');
          if (user.displayName) localStorage.setItem('eu2k-auth-display-name', user.displayName);
          console.log('ğŸ’¾ Saved parent auth state to localStorage');
        }
      } catch (e) {
        console.error('âŒ Parent prefill failed:', e);
      }
      try { 
        localStorage.setItem('eu2k-onboarding-target', 'parent-profile'); 
        console.log('ğŸ¯ Set onboarding target to parent-profile');
      } catch (_) {}
      
      console.log('ğŸ”„ Navigating to parent-profile page...');
      location.hash = 'parent-profile';
    };

    // Handle redirect result when coming back from Microsoft login
    getRedirectResult(auth).then((result) => {
      persistentLog.add(`ğŸ” Checking redirect result: ${result ? 'found' : 'null'}`);
      persistentLog.add(`ğŸ” Full URL: ${window.location.href}`);
      persistentLog.add(`ğŸ” URL search params: ${window.location.search}`);
      persistentLog.add(`ğŸ” URL hash: ${window.location.hash}`);
      
      // Log all URL parameters for debugging
      const urlParams = new URLSearchParams(window.location.search);
      const allParams = {};
      for (const [key, value] of urlParams.entries()) {
        allParams[key] = value;
      }
      persistentLog.add(`ğŸ” All URL params: ${JSON.stringify(allParams)}`);
      
      if (result && result.user) {
        persistentLog.add(`âœ… Redirect result successful! User: ${result.user.email}`);
        
        // Clear auth in progress flag
        localStorage.removeItem('eu2k-auth-in-progress');
        
        // Try to fetch Graph displayName using access token
        try {
          const credential = OAuthProvider.credentialFromResult(result);
          const accessToken = credential && credential.accessToken;
          persistentLog.add(`ğŸ”‘ Access token available: ${!!accessToken}`);
          
          if (accessToken) {
            persistentLog.add('ğŸ“¡ Fetching user data from Microsoft Graph...');
            
            // Fetch user profile data including photo
            Promise.all([
              fetch('https://graph.microsoft.com/v1.0/me', {
                headers: { Authorization: `Bearer ${accessToken}` }
              }).then(r => r.json()),
              fetch('https://graph.microsoft.com/v1.0/me/photo/$value', {
                headers: { Authorization: `Bearer ${accessToken}` }
              }).then(r => {
                if (r.ok) {
                  return r.blob().then(blob => URL.createObjectURL(blob));
                }
                return null;
              }).catch(() => null)
            ]).then(([userData, photoURL]) => {
              persistentLog.add(`ğŸ“Š Graph API user data: ${JSON.stringify(userData)}`);
              persistentLog.add(`ğŸ–¼ï¸ Graph API photo URL: ${photoURL ? 'obtained' : 'not available'}`);
              
              // Prepare user data for Firebase
              const graphUserData = {
                email: userData.mail || userData.userPrincipalName || result.user.email,
                displayName: userData.displayName || result.user.displayName,
                photoURL: photoURL || result.user.photoURL,
                jobTitle: userData.jobTitle || null,
                uid: result.user.uid,
                provider: 'microsoft.com',
                lastLogin: new Date().toISOString()
              };
              
              persistentLog.add(`ğŸ’¾ Prepared user data for Firebase: ${JSON.stringify(graphUserData)}`);
              
              // Save to localStorage for immediate use
              if (graphUserData.displayName) {
                localStorage.setItem('eu2k-auth-display-name', graphUserData.displayName);
                persistentLog.add(`ğŸ’¾ Saved display name: ${graphUserData.displayName}`);
              }
              if (graphUserData.email) {
                localStorage.setItem('eu2k-auth-email', graphUserData.email);
                persistentLog.add(`ğŸ’¾ Saved email: ${graphUserData.email}`);
              }
              if (graphUserData.photoURL) {
                localStorage.setItem('eu2k-auth-photo-url', graphUserData.photoURL);
                persistentLog.add(`ğŸ’¾ Saved photo URL: ${graphUserData.photoURL}`);
              }
              if (graphUserData.jobTitle) {
                localStorage.setItem('eu2k-auth-job-title', graphUserData.jobTitle);
                persistentLog.add(`ğŸ’¾ Saved job title: ${graphUserData.jobTitle}`);
              }
              
              // Save to Firebase (assuming Firebase functions are available)
              if (typeof saveUserToFirebase === 'function') {
                saveUserToFirebase(graphUserData).then(() => {
                  persistentLog.add('âœ… User data saved to Firebase successfully');
                }).catch((error) => {
                  persistentLog.add(`âŒ Firebase save error: ${error.message}`);
                });
              } else {
                persistentLog.add('âš ï¸ saveUserToFirebase function not available, data saved to localStorage only');
              }
              
            }).catch((error) => {
              persistentLog.add(`âŒ Graph API error: ${error.message}`);
              // Fallback to basic user data
              const basicUserData = {
                email: result.user.email,
                displayName: result.user.displayName,
                photoURL: result.user.photoURL,
                uid: result.user.uid,
                provider: 'microsoft.com',
                lastLogin: new Date().toISOString()
              };
              
              if (typeof saveUserToFirebase === 'function') {
                saveUserToFirebase(basicUserData).catch((error) => {
                  persistentLog.add(`âŒ Firebase fallback save error: ${error.message}`);
                });
              }
            });
            
            // Store the access token for later use
            localStorage.setItem('eu2k-ms-access-token', accessToken);
            persistentLog.add('ğŸ’¾ Saved Microsoft access token for later use');
          }
        } catch (error) {
          persistentLog.add(`âŒ Credential extraction error: ${error.message}`);
        }
        
        proceedToProfileChooser(result.user);
      } else {
        persistentLog.add('â„¹ï¸ No redirect result or user found');
        
        // Check if we were in the middle of auth
        const authInProgress = localStorage.getItem('eu2k-auth-in-progress');
        const authStartTime = localStorage.getItem('eu2k-auth-start-time');
        
        if (authInProgress) {
          const timeSinceStart = Date.now() - parseInt(authStartTime || '0');
          persistentLog.add(`â° Auth was in progress, time since start: ${timeSinceStart}ms`);
          
          // Check if Microsoft redirected us back but Firebase didn't catch it
          const urlParams = new URLSearchParams(window.location.search);
          const hasCode = urlParams.has('code');
          const hasState = urlParams.has('state');
          const hasError = urlParams.has('error');
          
          persistentLog.add(`ğŸ” Microsoft OAuth params - code: ${hasCode}, state: ${hasState}, error: ${hasError}`);
          
          if (hasError) {
            const error = urlParams.get('error');
            const errorDescription = urlParams.get('error_description');
            persistentLog.add(`âŒ Microsoft OAuth error: ${error} - ${errorDescription}`);
          }
          
          if (hasCode && hasState) {
            persistentLog.add('ğŸ” Microsoft returned auth code, but Firebase didn\'t process it');
            persistentLog.add('ğŸ”§ This suggests a Firebase configuration issue');
            
            // Try to manually trigger Firebase auth processing
            persistentLog.add('ğŸ”„ Attempting manual Firebase auth processing...');
            setTimeout(() => {
              // Force a page reload to trigger Firebase auth processing
              persistentLog.add('ğŸ”„ Reloading page to trigger Firebase auth...');
              window.location.reload();
            }, 2000);
          }
          
          // If less than 30 seconds, wait for auth state change
          if (timeSinceStart < 30000) {
            persistentLog.add('ğŸ”„ Waiting for auth state change...');
            setTimeout(() => {
              const currentUser = auth.currentUser;
              persistentLog.add(`â° Delayed check - current user: ${currentUser ? currentUser.email : 'none'}`);
              if (currentUser) {
                localStorage.removeItem('eu2k-auth-in-progress');
                proceedToProfileChooser(currentUser);
              } else {
                // If still no user after waiting, show login failed
                persistentLog.add('âŒ No user after waiting, showing login failed');
                localStorage.removeItem('eu2k-auth-in-progress');
                localStorage.removeItem('eu2k-auth-start-time');
                showPage('login-failed');
              }
            }, 3000);
          } else {
            persistentLog.add('â° Auth timeout, clearing flags');
            localStorage.removeItem('eu2k-auth-in-progress');
            localStorage.removeItem('eu2k-auth-start-time');
            showPage('login-failed');
          }
        }
      }
    }).catch((error) => {
      persistentLog.add(`âŒ Microsoft sign-in error: ${error.message}`);
      persistentLog.add(`âŒ Error details: ${JSON.stringify(error)}`);
      localStorage.removeItem('eu2k-auth-in-progress');
      localStorage.removeItem('eu2k-auth-start-time');
      showPage('login-failed');
    });

    // Az onboarding handler mÃ¡r kezeli az auth state vÃ¡ltozÃ¡sokat
    // Itt csak a navigÃ¡ciÃ³s logikÃ¡t tartjuk meg
    let authStateProcessed = false;
    onAuthStateChanged(auth, (user) => {
      persistentLog.add(`ğŸ”„ Auth state changed. User: ${user ? 'logged in' : 'not logged in'}`);
      persistentLog.add(`ğŸ“ Current hash: ${location.hash}`);
      persistentLog.add(`ğŸ”„ Auth state already processed: ${authStateProcessed}`);
      
      if (user && !authStateProcessed) {
        persistentLog.add(`ğŸ‘¤ User details: ${JSON.stringify({
          uid: user.uid,
          email: user.email,
          displayName: user.displayName
        })}`);
        
        // Check if we're coming back from auth
        const authInProgress = localStorage.getItem('eu2k-auth-in-progress');
        
        if (authInProgress) {
          persistentLog.add('ğŸš€ Auth completed, proceeding to profile chooser');
          authStateProcessed = true;
          localStorage.removeItem('eu2k-auth-in-progress');
          proceedToProfileChooser(user);
        }
      }
    });
  </script>

  <script>
    // Welcome onboarding navigation system
    let currentLanguage = 'hu'; // Default language

    // Make showPage function global so it can be used by window.startMicrosoftSignIn
    window.showPage = function(pageId) {
      console.log('ğŸ“„ Showing page:', pageId);
      
      // Security check: prevent navigation to inappropriate pages based on auth state
      const isLoggedIn = localStorage.getItem('eu2k-auth-logged-in') === 'true';
      const userType = localStorage.getItem('eu2k-user-type') || 'student';
      
      // If logged in, only allow appropriate pages for this user type
      if (isLoggedIn) {
        const restrictedPages = ['step1', 'step2', 'step3-teacher', 'step3-parent', 'step3-adult'];
        if (restrictedPages.includes(pageId)) {
          console.log('ğŸ”’ Access denied to', pageId, 'for logged in user type:', userType);
          // Redirect to appropriate profile page based on user type
          if (userType === 'student') {
            pageId = 'student-profile';
          } else if (userType === 'parent') {
            pageId = 'parent-profile';
          } else if (userType === 'teacher') {
            pageId = 'teacher-profile';
          }
          // Update URL hash to reflect the redirect
          if (window.location.hash !== '#' + pageId) {
            window.location.hash = '#' + pageId;
          }
        }
      }

      // First fade out all active pages
      const currentActive = document.querySelector('.welcome-page.active');
      if (currentActive) {
        console.log('ğŸ”„ Hiding current active page:', currentActive.id);
        currentActive.classList.remove('active');
      }

      // Show target page - handle both with and without '-page' suffix
      let targetPage = document.getElementById(pageId + '-page');
      if (!targetPage) {
        targetPage = document.getElementById(pageId);
      }

      if (targetPage) {
        console.log('âœ… Found target page:', targetPage.id);
        // Make sure it's visible but not active first
        targetPage.style.display = 'flex';

        // Small delay to ensure display change is processed
        setTimeout(() => {
          targetPage.classList.add('active');
          console.log('ğŸ¯ Activated page:', targetPage.id);
        }, 10);

        console.log('âœ… Successfully showed page:', targetPage.id);
      } else {
        console.error('âŒ Page not found:', pageId);
        console.log('ğŸ” Available pages:', Array.from(document.querySelectorAll('.welcome-page')).map(p => p.id));
      }

      // Hide non-active pages after transition
      setTimeout(() => {
        document.querySelectorAll('.welcome-page').forEach(page => {
          if (!page.classList.contains('active')) {
            page.style.display = 'none';
          }
        });
      }, 500);
    };
    
    function initializeWelcome() {
      const welcomePages = document.querySelectorAll('.welcome-page');

      // Use the global showPage function defined above
      const showPage = window.showPage;

      function navigate(event, pageId) {
        event.preventDefault();
        location.hash = pageId;
      }

      // Language selection handlers
      const languageButtons = document.querySelectorAll('.language-button');
      languageButtons.forEach(button => {
        button.addEventListener('click', e => {
          const language = button.getAttribute('data-language');
          currentLanguage = language;

          console.log('Language selected:', language);

          // Switch language in translation system
          if (window.translationManager) {
            console.log('Switching language to:', language);
            window.translationManager.switchLanguage(language);
          } else {
            console.log('Translation manager not available, waiting...');
            // Wait for translation manager to load
            setTimeout(() => {
              if (window.translationManager) {
                console.log('Translation manager loaded, switching language to:', language);
                window.translationManager.switchLanguage(language);
              } else {
                console.error('Translation manager still not available');
              }
            }, 500);
          }

          navigate(e, 'step2');
        });
      });

      // Navigation button handlers
      const navButtons = document.querySelectorAll('.nav-button');
      navButtons.forEach(button => {
        button.addEventListener('click', e => {
          const action = button.getAttribute('data-action');

          if (action === 'back-step1') {
            navigate(e, 'step1');
          } else if (action === 'back-step2') {
            // Check if we're in confirmation state
            const profileContent = document.querySelector('.profile-content');
            if (profileContent && profileContent.classList.contains('confirmation-state')) {
              // Revert to avatar selection instead of going back to step2
              e.preventDefault();
              revertAvatarConfirmation();
            } else {
              navigate(e, 'step2');
            }
          } else if (action === 'back-student-profile') {
            // Reset the student profile page to its original state
            resetStudentProfilePage();
            navigate(e, 'student-profile');
          } else if (action === 'back-notifications-setup') {
            navigate(e, 'notifications-setup');
          } else if (action === 'back-messages-setup') {
            navigate(e, 'messages-setup');
          } else if (action === 'logout-and-restart') {
            // Logout functionality for profile picture selection pages
            e.preventDefault();
            console.log('ğŸšª Logout and restart requested');
            
            // Sign out from Firebase
            if (window.auth) {
              window.auth.signOut().then(() => {
                console.log('âœ… Firebase sign out successful');
              }).catch((error) => {
                console.error('âŒ Firebase sign out error:', error);
              });
            }
            
            // Clear all localStorage data
            localStorage.removeItem('eu2k-auth-logged-in');
            localStorage.removeItem('eu2k-user-type');
            localStorage.removeItem('eu2k-access-token');
            localStorage.removeItem('eu2k-display-name');
            localStorage.removeItem('eu2k-job-title');
            localStorage.removeItem('eu2k-school-photo-url');
            localStorage.removeItem('eu2k-auth-in-progress');
            localStorage.removeItem('onboardingCompleted');
            
            console.log('ğŸ§¹ Cleared all localStorage data');
            
            // Navigate back to step1
            navigate(e, 'step1');
          } else if (action === 'student') {
            e.preventDefault();
            console.log('ğŸ“ Student button clicked');
            
            // Check if already logged in
            const isLoggedIn = localStorage.getItem('eu2k-auth-logged-in') === 'true';
            console.log('ğŸ” Already logged in?', isLoggedIn);
            
            if (isLoggedIn) {
              console.log('âœ… User already logged in, going to profile chooser');
              showPage('student-profile');
              return;
            }
            
            console.log('ğŸ” Starting Microsoft sign-in...');
            if (window.startMicrosoftSignIn) {
              window.startMicrosoftSignIn();
              
              // Check login status after a delay
              setTimeout(() => {
                if (!window.checkLoginStatus()) {
                  console.log('âŒ Login failed, showing login-failed page');
                }
              }, 5000); // 5 mÃ¡sodperc vÃ¡rakozÃ¡s a bejelentkezÃ©s ellenÅ‘rzÃ©sÃ©re
            } else {
              console.error('âŒ Microsoft sign-in function not available');
              navigate(e, 'student-profile');
            }
          } else if (action === 'teacher') {
            e.preventDefault();
            console.log('ğŸ‘¨â€ğŸ« Teacher button clicked');
            
            // Check if already logged in
            const isLoggedIn = localStorage.getItem('eu2k-auth-logged-in') === 'true';
            console.log('ğŸ” Already logged in?', isLoggedIn);
            
            if (isLoggedIn) {
              console.log('âœ… User already logged in, going to teacher profile chooser');
              showPage('teacher-profile');
              return;
            }
            
            console.log('ğŸ” Starting Microsoft sign-in for teacher...');
            if (window.startMicrosoftSignInTeacher) {
              window.startMicrosoftSignInTeacher();
              
              // Check login status after a delay
              setTimeout(() => {
                if (!window.checkLoginStatus()) {
                  console.log('âŒ Login failed, showing login-failed page');
                }
              }, 5000);
            } else {
              console.error('âŒ Microsoft sign-in function not available');
              navigate(e, 'teacher-profile');
            }
          } else if (action === 'parent') {
            // ÃtirÃ¡nyÃ­tÃ¡s onboarding_parent.html step2-jÃ©re Ã©s Google popup megnyitÃ¡sa
            window.location.href = '/EU2K-Hub/welcome/onboarding_parent.html#step2';
            // A Google popup automatikusan megnyÃ­lik az onboarding_parent.html-ben
          } else if (action === 'without-account') {
            navigate(e, 'adult');
          }
        });
      });

      // Avatar selection handlers
      const avatarOptions = document.querySelectorAll('.avatar-option');
      const mainAvatarImg = document.querySelector('.main-avatar-img');
      const mainAvatar = document.querySelector('.main-avatar');

      avatarOptions.forEach(option => {
        option.addEventListener('click', () => {
          const avatarImg = option.querySelector('.avatar-img');
          const avatarSrc = avatarImg.src;
          const avatarType = option.getAttribute('data-avatar');

          // Update main avatar
          mainAvatarImg.src = avatarSrc;

          // Color maps for background and border based on actual avatar colors
          const backgroundColorMap = {
            'magenta': '#E8B4E3',
            'green': '#B4E8B4',
            'blue': '#B4D4E8',
            'orange': '#E8D4B4',
            'purple': '#D4B4E8',
            'cyan': '#B4E8E8',
            'red': '#E8B4B4',
            'gray': '#C4C4C4'
          };

          // Updated border colors to match avatar main colors
          const borderColorMap = {
            'magenta': '#D946EF', // Bright magenta/fuchsia
            'green': '#22C55E',   // Bright green
            'blue': '#3B82F6',    // Bright blue
            'orange': '#F97316',  // Bright orange
            'purple': '#A855F7',  // Bright purple
            'cyan': '#06B6D4',    // Bright cyan
            'red': '#EF4444',     // Bright red
            'gray': '#6B7280'     // Medium gray
          };

          // Update main avatar background
          mainAvatar.style.background = backgroundColorMap[avatarType] || '#E8B4E3';

          // Remove active class from all options
          avatarOptions.forEach(opt => {
            opt.classList.remove('active');
            opt.style.border = 'none';
          });

          // Add active class and colored border to selected option
          option.classList.add('active');
          option.style.border = `3px solid ${borderColorMap[avatarType]}`;
        });
      });

      // Hash change listener with security checks
      window.addEventListener('hashchange', () => {
        const page = location.hash.substring(1) || 'step1';
        const isLoggedIn = localStorage.getItem('eu2k-auth-logged-in') === 'true';
        const userType = localStorage.getItem('eu2k-user-type') || 'student';
        
        // Additional security: prevent direct hash manipulation for logged in users
        if (isLoggedIn) {
          const restrictedPages = ['step1', 'step2', 'step3-teacher', 'step3-parent', 'step3-adult'];
          if (restrictedPages.includes(page)) {
            console.log('ğŸ”’ Blocked hash navigation to restricted page:', page);
            let redirectPage = 'student-profile';
            if (userType === 'parent') redirectPage = 'parent-profile';
            else if (userType === 'teacher') redirectPage = 'teacher-profile';
            
            // Prevent infinite loop by checking if we're already redirecting
            if (page !== redirectPage) {
              window.location.hash = '#' + redirectPage;
              return;
            }
          }
        }
        
        // BiztonsÃ¡gi ellenÅ‘rzÃ©s: diÃ¡k felhasznÃ¡lÃ³ ne tudjon szÃ¼lÅ‘/tanÃ¡r onboarding oldalakra menni
        if (userType === 'student' && (page.includes('parent') || page.includes('teacher'))) {
          console.warn('âš ï¸ DiÃ¡k felhasznÃ¡lÃ³ nem fÃ©rhet hozzÃ¡ szÃ¼lÅ‘/tanÃ¡r oldalakhoz');
          window.location.hash = '#student-profile';
          return;
        }
        
        // Hash navigÃ¡ciÃ³ korlÃ¡tozÃ¡sa: csak engedÃ©lyezett oldalakra lehet navigÃ¡lni
        const allowedPages = ['step1', 'step2', 'student-profile', 'notifications-setup', 'message-settings', 'terms-setup', 'final-welcome-page', 'restart-onboarding', 'delete-profile'];
        if (!allowedPages.includes(page) && !isLoggedIn) {
          console.warn('âš ï¸ Nem engedÃ©lyezett oldal elÃ©rÃ©se hash-sel:', page);
          window.location.hash = '#step1';
          return;
        }
        
        showPage(page);
      });

      // Initial page load with auth state check
      const isLoggedIn = localStorage.getItem('eu2k-auth-logged-in') === 'true';
      const userType = localStorage.getItem('eu2k-user-type') || 'student';
      
      if (isLoggedIn) {
        console.log('âœ… User already logged in as:', userType);
        
        // Check if onboarding was interrupted and restore progress
        const onboardingProgress = checkOnboardingProgress();
        if (onboardingProgress.interrupted && userType === 'student') {
          console.log('ğŸ”„ Restoring interrupted onboarding from:', onboardingProgress.lastStep);
          restoreOnboardingData();
          showPage(onboardingProgress.lastStep);
          location.hash = onboardingProgress.lastStep;
          return;
        }
        
        // Redirect to appropriate profile page instead of login screens
        const hash = location.hash.substring(1);
        if (!hash || hash === 'step1' || hash === 'step2' || hash.startsWith('step3-')) {
          let profilePage = 'student-profile';
          if (userType === 'parent') profilePage = 'parent-profile';
          else if (userType === 'teacher') profilePage = 'teacher-profile';
          
          showPage(profilePage);
          location.hash = profilePage;
        } else {
          showPage(hash);
        }
      } else {
        const initialPage = location.hash.substring(1) || 'step1';
        showPage(initialPage);
      }

      // If an onboarding target was requested (e.g., after auth redirect), navigate there
      try {
        const target = localStorage.getItem('eu2k-onboarding-target');
        console.log('ğŸ¯ Checking onboarding target:', target);
        if (target) {
          console.log('ğŸš€ Found onboarding target, navigating to:', target);
          localStorage.removeItem('eu2k-onboarding-target');
          showPage(target);
          location.hash = target;
        }
      } catch (error) {
        console.error('âŒ Error checking onboarding target:', error);
      }

      // Set default avatar selection (magenta)
      setTimeout(() => {
        const defaultAvatar = document.querySelector('.avatar-option[data-avatar="magenta"]');
        if (defaultAvatar) {
          defaultAvatar.click();
        }
      }, 100);

      // Handle "Continue with this" button click
      const continueButton = document.getElementById('continue-with-avatar');
      if (continueButton) {
        continueButton.addEventListener('click', () => {
          // Save avatar selection to localStorage for security
          const selectedAvatar = document.querySelector('.avatar-option.active');
          if (selectedAvatar) {
            const avatarType = selectedAvatar.getAttribute('data-avatar');
            localStorage.setItem('eu2k-onboarding-avatar', avatarType);
            localStorage.setItem('eu2k-onboarding-use-provided-pfp', 'false');
            console.log('ğŸ’¾ Avatar selection saved to localStorage:', avatarType);
          }
          showAvatarConfirmation();
        });
      }

      // Handle "Continue with school profile picture" button click
      const schoolProfileButton = document.getElementById('proceed-with-school-pfp');
      if (schoolProfileButton) {
        console.log('ğŸ¯ School profile button found and event listener attached');
        schoolProfileButton.addEventListener('click', async (e) => {
          e.preventDefault();
          e.stopPropagation();
          console.log('ğŸ« School profile picture button clicked');
          
          // Set to use provided profile picture from school account
          localStorage.setItem('eu2k-onboarding-use-provided-pfp', 'true');
          localStorage.setItem('useSchoolPfp', 'true');
          
          try {
            // Get the current user and access token
            const user = auth.currentUser;
            console.log('ğŸ‘¤ Current user:', user ? user.uid : 'No user');
            
            if (!user) {
              console.error('âŒ No authenticated user found');
              alert('Nincs bejelentkezett felhasznÃ¡lÃ³! KÃ©rlek jelentkezz be elÅ‘szÃ¶r.');
              return;
            }

            // Try to get the access token from localStorage
            const accessToken = localStorage.getItem('eu2k-ms-access-token');
            console.log('ğŸ”‘ Access token found:', accessToken ? 'Yes' : 'No');
            
            if (accessToken) {
              console.log('ğŸ“¡ Fetching profile data from Microsoft Graph...');
              
              // First, fetch user profile data including jobTitle
              const profileResponse = await fetch('https://graph.microsoft.com/v1.0/me', {
                headers: { 
                  'Authorization': `Bearer ${accessToken}`
                }
              });
              
              let jobTitle = '';
              if (profileResponse.ok) {
                const profileData = await profileResponse.json();
                jobTitle = profileData.jobTitle || '';
                console.log('ğŸ‘” Job title from Microsoft:', jobTitle);
                
                // Store job title for Firebase saving
                localStorage.setItem('eu2k-ms-job-title', jobTitle);
              } else {
                console.warn('âš ï¸ Could not fetch profile data from Microsoft Graph');
              }
              
              // Fetch profile picture from Microsoft Graph API
              const photoResponse = await fetch('https://graph.microsoft.com/v1.0/me/photo/$value', {
                headers: { 
                  'Authorization': `Bearer ${accessToken}`
                }
              });
              
              console.log('ğŸ“¸ Photo response status:', photoResponse.status);
              
              if (photoResponse.ok) {
                // Microsoft Graph photo URL hasznÃ¡lata blob helyett
                const photoURL = `https://graph.microsoft.com/v1.0/me/photo/$value`;
                
                console.log('âœ… Successfully fetched profile picture from Microsoft Graph');
                console.log('ğŸ–¼ï¸ Photo URL created (Graph API):', photoURL);
                
                // Update the main avatar image to show the school profile picture
                const mainAvatarImg = document.querySelector('.main-avatar-img');
                const mainAvatar = document.querySelector('.main-avatar');
                
                console.log('ğŸ¯ Main avatar elements found:', {
                  img: mainAvatarImg ? 'Yes' : 'No',
                  container: mainAvatar ? 'Yes' : 'No'
                });
                
                if (mainAvatarImg && mainAvatar) {
                  mainAvatarImg.src = photoURL;
                  // Set a neutral background for the school profile picture
                  mainAvatar.style.background = '#f0f0f0';
                  mainAvatar.style.border = '3px solid #4CAF50';
                  console.log('ğŸ–¼ï¸ Updated main avatar with school profile picture');
                } else {
                  console.error('âŒ Could not find main avatar elements');
                }
                
                // Store the photo URL for later Firebase saving
                localStorage.setItem('eu2k-onboarding-school-photo-url', photoURL);
                localStorage.setItem('eu2k-google-profile-url', photoURL);
                localStorage.setItem('eu2k-profile-picture-url', photoURL);
                
                console.log('ğŸ’¾ Photo URLs saved to localStorage');
                
              } else {
                console.warn('âš ï¸ Could not fetch profile picture from Microsoft Graph, status:', photoResponse.status);
                const errorText = await photoResponse.text();
                console.error('âŒ Error response:', errorText);
                alert('Nem sikerÃ¼lt lekÃ©rni a profilkÃ©pet a Microsoft-tÃ³l. PrÃ³bÃ¡ld Ãºjra!');
                return;
              }
            } else {
              console.warn('âš ï¸ No access token available, cannot fetch profile picture');
              alert('Nincs elÃ©rhetÅ‘ Microsoft access token! KÃ©rlek jelentkezz be Ãºjra.');
              return;
            }
            
          } catch (error) {
            console.error('âŒ Error fetching school profile picture:', error);
            alert('Hiba tÃ¶rtÃ©nt a profilkÃ©p lekÃ©rÃ©se sorÃ¡n: ' + error.message);
            return;
          }
          
          console.log('ğŸ’¾ School profile picture option selected, showing confirmation');
          showAvatarConfirmation();
        });
      } else {
        console.error('âŒ School profile button not found!');
      }

      // Handle parent Google sign-in button
      const parentGoogleBtn = document.getElementById('parent-google-signin');
      if (parentGoogleBtn) {
        parentGoogleBtn.addEventListener('click', () => {
          console.log('ğŸ” Parent Google sign-in clicked');
          if (window.startGoogleSignInParent) {
            window.startGoogleSignInParent();
          } else {
            console.error('âŒ Google sign-in function not available');
          }
        });
      }

      // Handle parent Apple sign-in button (disabled for now)
      const parentAppleBtn = document.getElementById('parent-apple-signin');
      if (parentAppleBtn) {
        parentAppleBtn.addEventListener('click', () => {
          console.log('ğŸ Parent Apple sign-in clicked (disabled)');
          // Apple sign-in will be implemented later
        });
      }
      
      // Login failed tracking
      window.loginFailedCounter = 0;
      window.checkLoginStatus = function() {
        const user = auth.currentUser;
        if (!user) {
          window.loginFailedCounter++;
          if (window.loginFailedCounter === 1) {
            // Check if onboarding is already completed or skipped
            const onboardingCompleted = localStorage.getItem('onboardingCompleted') === 'true';
            const firstVisitDone = localStorage.getItem('eu2k-first-visit') === 'false';
            const termsAccepted = localStorage.getItem('termsAccepted') === 'true';
            
            if (onboardingCompleted || firstVisitDone || termsAccepted) {
              // Show restart onboarding page instead of login failed
              location.hash = 'restart-onboarding';
            } else {
              // Show login failed page only on first failure
              location.hash = 'login-failed';
            }
          }
          console.log('Login failed, counter:', window.loginFailedCounter);
          return false;
        }
        return true;
      }
      
      // Check onboarding progress for interrupted sessions
      function checkOnboardingProgress() {
        const isLoggedIn = localStorage.getItem('eu2k-auth-logged-in') === 'true';
        const termsAccepted = localStorage.getItem('eu2k-onboarding-terms-accepted') === 'true';
        const profileConfirmed = localStorage.getItem('eu2k-onboarding-profile-confirmed') === 'true';
        const avatarSelected = localStorage.getItem('eu2k-onboarding-avatar');
        const notificationSettings = localStorage.getItem('eu2k-onboarding-notifications');
        const messageSettings = localStorage.getItem('eu2k-onboarding-messages');
        
        // If user is logged in but hasn't completed onboarding
        if (isLoggedIn && !termsAccepted) {
          let lastStep = 'student-profile';
          
          if (messageSettings) {
            lastStep = 'terms-setup';
          } else if (notificationSettings) {
            lastStep = 'messages-setup';
          } else if (profileConfirmed) {
            lastStep = 'notifications-setup';
          } else if (avatarSelected) {
            lastStep = 'student-profile';
          }
          
          return {
            interrupted: true,
            lastStep: lastStep
          };
        }
        
        return {
          interrupted: false,
          lastStep: null
        };
      }
      
      // Restore onboarding data from localStorage
      function restoreOnboardingData() {
        console.log('ğŸ”„ Restoring onboarding data from localStorage...');
        
        // Restore avatar selection
        const savedAvatar = localStorage.getItem('eu2k-onboarding-avatar');
        if (savedAvatar) {
          setTimeout(() => {
            const avatarOption = document.querySelector(`.avatar-option[data-avatar="${savedAvatar}"]`);
            if (avatarOption) {
              avatarOption.click();
              console.log('âœ… Restored avatar selection:', savedAvatar);
            }
          }, 100);
        }
        
        // Restore notification settings
        const savedNotifications = localStorage.getItem('eu2k-onboarding-notifications');
        if (savedNotifications) {
          try {
            const notificationSettings = JSON.parse(savedNotifications);
            setTimeout(() => {
              const notificationSwitches = document.querySelectorAll('#notifications-setup-page md-switch');
              notificationSwitches.forEach((switchEl, index) => {
                const shouldBeChecked = notificationSettings[`notification_${index}`];
                if (shouldBeChecked) {
                  switchEl.setAttribute('selected', '');
                } else {
                  switchEl.removeAttribute('selected');
                }
              });
              console.log('âœ… Restored notification settings:', notificationSettings);
            }, 100);
          } catch (error) {
            console.error('âŒ Error restoring notification settings:', error);
          }
        }
        
        // Restore message settings
        const savedMessages = localStorage.getItem('eu2k-onboarding-messages');
        if (savedMessages) {
          try {
            const messageSettings = JSON.parse(savedMessages);
            setTimeout(() => {
              const privateMessagesSwitch = document.querySelector('#messages-setup-page .card-top md-switch');
              const messageRadios = document.querySelectorAll('#messages-setup-page md-radio[name="message-privacy"]');
              
              if (privateMessagesSwitch) {
                if (messageSettings.privateMessages) {
                  privateMessagesSwitch.setAttribute('selected', '');
                } else {
                  privateMessagesSwitch.removeAttribute('selected');
                }
              }
              
              messageRadios.forEach(radio => {
                if (radio.value === messageSettings.messagePrivacy) {
                  radio.setAttribute('checked', '');
                } else {
                  radio.removeAttribute('checked');
                }
              });
              
              console.log('âœ… Restored message settings:', messageSettings);
            }, 100);
          } catch (error) {
            console.error('âŒ Error restoring message settings:', error);
          }
        }
        
        // Restore terms acceptance
        const termsAccepted = localStorage.getItem('eu2k-onboarding-terms-accepted') === 'true';
        if (termsAccepted) {
          setTimeout(() => {
            const termsCheckbox = document.getElementById('terms-checkbox');
            const continueTermsButton = document.getElementById('continue-terms');
            if (termsCheckbox) {
              termsCheckbox.checked = true;
              if (continueTermsButton) {
                continueTermsButton.disabled = false;
              }
            }
            console.log('âœ… Restored terms acceptance');
          }, 100);
        }
      }
      
      // Skip welcome screen function
      window.skipWelcomeScreen = function() {
        // Mark first visit as false
        localStorage.setItem('eu2k-first-visit', 'false');
        
      // Handle restart onboarding confirmation
      const confirmRestartBtn = document.getElementById('confirm-restart');
      if (confirmRestartBtn) {
        confirmRestartBtn.addEventListener('click', () => {
          // Clear local storage data
          localStorage.removeItem('eu2k-first-visit');
          localStorage.removeItem('eu2k-terms-accepted');
          localStorage.removeItem('eu2k-selected-avatar');
          localStorage.removeItem('eu2k-selected-theme');
          
          // Reload the page to restart onboarding
          window.location.reload();
        });
      }
      
      // Handle delete profile confirmation
      const confirmDeleteProfileBtn = document.getElementById('confirm-delete-profile');
      if (confirmDeleteProfileBtn) {
        confirmDeleteProfileBtn.addEventListener('click', () => {
          // TODO: Implement profile deletion logic
          // This should be connected to the account.html delete profile button
          console.log('Profile deletion confirmed');
          
          // Clear local storage data
          localStorage.clear();
          
          // Sign out the user
          auth.signOut().then(() => {
            // Reload the page to restart onboarding
            window.location.reload();
          });
        });
      }
        
        // Mark terms as accepted
        localStorage.setItem('termsAccepted', 'true');
        
        console.log('âœ… Welcome screen skipped: first visit marked as false, terms accepted marked as true');
        
        // Redirect to main page if needed
        if (window.welcomeScreenManager && typeof window.welcomeScreenManager.returnFromWelcomeScreen === 'function') {
          window.welcomeScreenManager.returnFromWelcomeScreen();
        } else {
          // Fallback redirect
          window.location.href = '/EU2K-Hub/index.html';
        }
      }

      // Handle "Looks good" button click
      const looksGoodButton = document.getElementById('looks-good-button');
      if (looksGoodButton) {
        looksGoodButton.addEventListener('click', () => {
          // Save profile confirmation to localStorage for security
          localStorage.setItem('eu2k-onboarding-profile-confirmed', 'true');
          console.log('ğŸ’¾ Profile confirmation saved to localStorage');
          showSuccessAnimation();
        });
      }

      // Handle "Continue notifications" button click
      const continueNotificationsButton = document.getElementById('continue-notifications');
      if (continueNotificationsButton) {
        continueNotificationsButton.addEventListener('click', () => {
          // Save notification settings to localStorage for security
          const notificationSwitches = document.querySelectorAll('#notifications-setup-page md-switch');
          const notificationSettings = {};
          notificationSwitches.forEach((switchEl, index) => {
            const isChecked = switchEl.hasAttribute('selected');
            notificationSettings[`notification_${index}`] = isChecked;
          });
          localStorage.setItem('eu2k-onboarding-notifications', JSON.stringify(notificationSettings));
          console.log('ğŸ’¾ Notification settings saved to localStorage:', notificationSettings);
          navigate(event, 'messages-setup');
        });
      }

      // Handle "Continue messages" button click
      const continueMessagesButton = document.getElementById('continue-messages');
      if (continueMessagesButton) {
        continueMessagesButton.addEventListener('click', () => {
          // Save message settings to localStorage for security
          const messageRadios = document.querySelectorAll('#messages-setup-page md-radio[name="message-privacy"]');
          const privateMessagesSwitch = document.querySelector('#messages-setup-page .card-top md-switch');
          
          let selectedMessagePrivacy = 'everyone'; // default
          messageRadios.forEach(radio => {
            if (radio.hasAttribute('checked')) {
              selectedMessagePrivacy = radio.value;
            }
          });
          
          const messageSettings = {
            privateMessages: privateMessagesSwitch ? privateMessagesSwitch.hasAttribute('selected') : false,
            messagePrivacy: selectedMessagePrivacy
          };
          
          localStorage.setItem('eu2k-onboarding-messages', JSON.stringify(messageSettings));
          console.log('ğŸ’¾ Message settings saved to localStorage:', messageSettings);
          showPage('terms-setup');
        });
      }

      // Handle terms checkbox
      const termsCheckbox = document.getElementById('terms-checkbox');
      const continueTermsButton = document.getElementById('continue-terms');

      if (termsCheckbox && continueTermsButton) {
        termsCheckbox.addEventListener('change', (event) => {
          continueTermsButton.disabled = !event.target.checked;
        });
      }

      // Handle "Continue terms" button click
      if (continueTermsButton) {
        continueTermsButton.addEventListener('click', async () => {
          const checkbox = document.getElementById('terms-checkbox');
          if (checkbox && checkbox.checked) {
            // Store acceptance in localStorage for security
            localStorage.setItem('termsAccepted', 'true');
            localStorage.setItem('eu2k-onboarding-terms-accepted', 'true');
            console.log('ğŸ’¾ Terms acceptance saved to localStorage');
            
            // Save terms acceptance to Firebase if user is authenticated
            if (auth.currentUser) {
              try {
                const userRef = doc(db, 'users', auth.currentUser.uid);
                const now = new Date().toISOString();
                
                await updateDoc(userRef, {
                  'general_data.termsAccepted': now,
                  'general_data.termsAcceptedVersion': '1.0'
                });
                
                persistentLog.add(`âœ… Terms acceptance saved to Firebase: ${auth.currentUser.uid}`);
              } catch (error) {
                persistentLog.add(`âŒ Error saving terms acceptance to Firebase: ${error.message}`);
                console.error('Terms acceptance Firebase save error:', error);
              }
            }
            
            showPage('final-welcome-page');
          } else {
            alert('KÃ©rlek fogadd el a hasznÃ¡lati feltÃ©teleket a folytatÃ¡shoz!');
          }
        });
      }

      // Handle private messages switch toggle
      const privateMessagesSwitch = document.querySelector('#messages-setup-page .card-top md-switch');
      const messageRadios = document.querySelectorAll('#messages-setup-page md-radio[name="message-privacy"]');

      if (privateMessagesSwitch) {
        privateMessagesSwitch.addEventListener('change', (event) => {
          const isEnabled = event.target.selected;
          messageRadios.forEach(radio => {
            radio.disabled = !isEnabled;
          });
        });
      }
    }

    function showAvatarConfirmation() {
      const profileContent = document.querySelector('.profile-content');
      const welcomeDescription = document.querySelector('.welcome-description-header');
      const avatarSelection = document.querySelector('.avatar-selection');
      const profileActions = document.querySelector('.profile-actions');
      const confirmationActions = document.querySelector('.profile-actions-confirmation');
      const mainAvatarContainer = document.querySelector('.main-avatar-container');
      const profileDivider = document.querySelector('.profile-divider');

      // Add confirmation state class to profile content for avatar enlargement
      profileContent.classList.add('confirmation-state');

      // Update description text with translation support
      if (welcomeDescription) {
        welcomeDescription.setAttribute('data-translate', 'profile.looks_good_description');
        // Update text based on current language
        if (window.translationManager) {
          const translatedText = window.translationManager.getTranslation('profile.looks_good_description');
          welcomeDescription.textContent = translatedText;
        } else {
          welcomeDescription.textContent = currentLanguage === 'en' ? 'Does this look good?' : 'Ez Ã­gy jÃ³l nÃ©z ki?';
        }
      }

      // Hide avatar selection and original buttons with smooth transition
      if (avatarSelection) {
        avatarSelection.style.transition = 'opacity 0.4s ease, transform 0.4s ease';
        avatarSelection.style.opacity = '0';
        avatarSelection.style.transform = 'translateY(-20px)';
        setTimeout(() => {
          avatarSelection.style.display = 'none';
        }, 400);
      }

      if (profileActions) {
        profileActions.style.transition = 'opacity 0.4s ease, transform 0.4s ease';
        profileActions.style.opacity = '0';
        profileActions.style.transform = 'translateY(-20px)';
        setTimeout(() => {
          profileActions.style.display = 'none';
        }, 400);
      }

      if (profileDivider) {
        profileDivider.style.transition = 'opacity 0.4s ease';
        profileDivider.style.opacity = '0';
        setTimeout(() => {
          profileDivider.style.display = 'none';
        }, 400);
      }

      // Show confirmation button with smooth entrance transition
      setTimeout(() => {
        if (confirmationActions) {
          confirmationActions.style.display = 'flex';
          confirmationActions.style.opacity = '0';
          confirmationActions.style.transform = 'translateY(20px)';
          confirmationActions.style.transition = 'opacity 0.4s ease, transform 0.4s ease';

          setTimeout(() => {
            confirmationActions.style.opacity = '1';
            confirmationActions.style.transform = 'translateY(0)';
          }, 50);
        }
      }, 400);
    }

    function revertAvatarConfirmation() {
      const profileContent = document.querySelector('.profile-content');
      const welcomeDescription = document.querySelector('.welcome-description-header');
      const avatarSelection = document.querySelector('.avatar-selection');
      const profileActions = document.querySelector('.profile-actions');
      const confirmationActions = document.querySelector('.profile-actions-confirmation');
      const profileDivider = document.querySelector('.profile-divider');

      // Remove confirmation state class
      profileContent.classList.remove('confirmation-state');

      // Revert description text
      if (welcomeDescription) {
        welcomeDescription.setAttribute('data-translate', 'pages.onboarding_student.create_account_description');
        if (window.translationManager) {
          const translatedText = window.translationManager.getTranslation('pages.onboarding_student.create_account_description');
          welcomeDescription.textContent = translatedText;
        } else {
          welcomeDescription.textContent = currentLanguage === 'en' ? 'Please choose an avatar or use the one provided by your school account!' : 'KÃ©rlek vÃ¡lassz egy avatÃ¡rt, vagy hasznÃ¡ld az iskolai fiÃ³kod Ã¡ltal biztosÃ­tottat!';
        }
      }

      // Hide confirmation actions
      if (confirmationActions) {
        confirmationActions.style.transition = 'opacity 0.4s ease, transform 0.4s ease';
        confirmationActions.style.opacity = '0';
        confirmationActions.style.transform = 'translateY(20px)';
        setTimeout(() => {
          confirmationActions.style.display = 'none';
        }, 400);
      }

      // Show avatar selection and original buttons
      setTimeout(() => {
        if (avatarSelection) {
          avatarSelection.style.display = 'block';
          avatarSelection.style.opacity = '0';
          avatarSelection.style.transform = 'translateY(-20px)';
          avatarSelection.style.transition = 'opacity 0.4s ease, transform 0.4s ease';
          setTimeout(() => {
            avatarSelection.style.opacity = '1';
            avatarSelection.style.transform = 'translateY(0)';
          }, 50);
        }

        if (profileActions) {
          profileActions.style.display = 'flex';
          profileActions.style.opacity = '0';
          profileActions.style.transform = 'translateY(-20px)';
          profileActions.style.transition = 'opacity 0.4s ease, transform 0.4s ease';
          setTimeout(() => {
            profileActions.style.opacity = '1';
            profileActions.style.transform = 'translateY(0)';
          }, 50);
        }

        if (profileDivider) {
          profileDivider.style.display = 'block';
          profileDivider.style.opacity = '0';
          profileDivider.style.transition = 'opacity 0.4s ease';
          setTimeout(() => {
            profileDivider.style.opacity = '1';
          }, 50);
        }
      }, 400);
    }

    function resetStudentProfilePage() {
      // Reset the publish layout visibility
      const publishLayout = document.querySelector('.publish-layout');
      if (publishLayout) {
        publishLayout.style.opacity = '1';
        publishLayout.style.transition = '';
      }

      // Reset profile content to avatar selection state
      const profileContent = document.querySelector('.profile-content');
      const welcomeDescription = document.querySelector('.welcome-description-header');
      const avatarSelection = document.querySelector('.avatar-selection');
      const profileActions = document.querySelector('.profile-actions');
      const confirmationActions = document.querySelector('.profile-actions-confirmation');
      const profileDivider = document.querySelector('.profile-divider');

      // Remove confirmation state
      if (profileContent) {
        profileContent.classList.remove('confirmation-state');
      }

      // Reset description text
      if (welcomeDescription) {
        welcomeDescription.setAttribute('data-translate', 'pages.onboarding_student.create_account_description');
        if (window.translationManager) {
          const translatedText = window.translationManager.getTranslation('pages.onboarding_student.create_account_description');
          welcomeDescription.textContent = translatedText;
        } else {
          welcomeDescription.textContent = currentLanguage === 'en' ? 'Please choose an avatar or use the one provided by your school account!' : 'KÃ©rlek vÃ¡lassz egy avatÃ¡rt, vagy hasznÃ¡ld az iskolai fiÃ³kod Ã¡ltal biztosÃ­tottat!';
        }
      }

      // Show all original elements
      if (avatarSelection) {
        avatarSelection.style.display = 'block';
        avatarSelection.style.opacity = '1';
        avatarSelection.style.transform = 'translateY(0)';
        avatarSelection.style.transition = '';
      }

      if (profileActions) {
        profileActions.style.display = 'flex';
        profileActions.style.opacity = '1';
        profileActions.style.transform = 'translateY(0)';
        profileActions.style.transition = '';
      }

      if (profileDivider) {
        profileDivider.style.display = 'block';
        profileDivider.style.opacity = '1';
        profileDivider.style.transition = '';
      }

      // Hide confirmation actions
      if (confirmationActions) {
        confirmationActions.style.display = 'none';
        confirmationActions.style.opacity = '0';
        confirmationActions.style.transform = 'translateY(20px)';
        confirmationActions.style.transition = '';
      }
    }

    function showSuccessAnimation() {
      // Hide the publish layout
      const publishLayout = document.querySelector('.publish-layout');
      if (publishLayout) {
        publishLayout.style.opacity = '0';
        publishLayout.style.transition = 'opacity 0.3s ease';
      }

      // Create success animation overlay that covers the whole screen
      const overlay = document.createElement('div');
      overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        pointer-events: none;
      `;

      // Create the success text element
      const successText = document.createElement('div');
      successText.textContent = window.translationManager ? window.translationManager.getTranslation('profile.super') || 'Szuper!' : 'Szuper!';
      successText.style.cssText = `
        font-size: 3rem;
        font-weight: 700;
        color: #1976d2;
        opacity: 0;
        transform: translateY(50px);
        transition: all 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      `;

      overlay.appendChild(successText);
      document.body.appendChild(overlay);

      // Animate text to center
      setTimeout(() => {
        successText.style.opacity = '1';
        successText.style.transform = 'translateY(0)';
      }, 100);

      // Gravity fall animation and navigate
      setTimeout(() => {
        successText.style.transition = 'all 0.8s cubic-bezier(0.55, 0.085, 0.68, 0.53)';
        successText.style.transform = 'translateY(200px)';
        successText.style.opacity = '0';

        setTimeout(() => {
          document.body.removeChild(overlay);
          // Navigate to notifications setup page
          location.hash = 'notifications-setup';
        }, 800);
      }, 1500);
    }

    // Check terms acceptance and redirect
    async function checkTermsAndRedirect() {
      const termsAccepted = localStorage.getItem('termsAccepted');
      if (termsAccepted === 'true') {
        try {
          // JelÃ¶ljÃ¼k az onboarding befejezÃ©sÃ©t lokÃ¡lisan
          localStorage.setItem('onboardingCompleted', 'true');

          // Firestore mentÃ©s (lusta import, hogy ne kelljen globÃ¡lis importot mÃ³dosÃ­tani)
          // Onboarding befejezÃ©se az Ãºj handler modullal
          if (typeof auth !== 'undefined' && typeof db !== 'undefined') {
            const { completeOnboarding } = await import('../assets/js/onboarding-handler.js');
            
            // A handler mÃ¡r gyÅ±jtÃ¶tte az adatokat, most finalizÃ¡ljuk
            console.log('ğŸš€ Finalizing onboarding with collected data...');
            
            // Get additional data from localStorage for school profile picture
            const jobTitle = localStorage.getItem('eu2k-ms-job-title') || '';
            const schoolPhotoURL = localStorage.getItem('eu2k-onboarding-school-photo-url') || 
                                   localStorage.getItem('eu2k-google-profile-url') || 
                                   localStorage.getItem('eu2k-profile-picture-url') || '';
            
            console.log('ğŸ“Š Additional data for Firebase save:', {
              jobTitle: jobTitle,
              schoolPhotoURL: schoolPhotoURL ? 'Yes' : 'No'
            });
            
            // Pass additional data to the handler
            const additionalData = {
              jobTitle: jobTitle,
              photoURL: schoolPhotoURL
            };
            
            const success = await completeOnboarding(auth, db, additionalData);
            
            if (!success) {
              console.error('âŒ Onboarding befejezÃ©se sikertelen!');
              return;
            }
            localStorage.removeItem('eu2k-onboarding-terms-accepted');
            console.log('ğŸ§¹ Cleared onboarding security data from localStorage');
            
            // TODO: MÃ©g meg kell csinÃ¡lni a settings kollekciÃ³t is a userid doksiban
            // Ezt a kommentet itt hagyjuk, hogy emlÃ©keztessen a settings kollekciÃ³ lÃ©trehozÃ¡sÃ¡ra
            
          } else {
            console.warn('â„¹ï¸ Skipping Firestore write because user or db is not available.');
          }
        } catch (e) {
          console.error('âš ï¸ Failed to save general profile document:', e);
        }

        // MegjelÃ¶ljÃ¼k, hogy a felhasznÃ¡lÃ³ mÃ¡r lÃ¡togatta az oldalt
        if (window.welcomeScreenManager) {
          window.welcomeScreenManager.markAsVisited();
          // VisszatÃ©rÃ©s az eredeti oldalra
          window.welcomeScreenManager.returnFromWelcomeScreen();
        } else {
          // Fallback ha nincs welcome screen manager
          window.location.href = '/EU2K-Hub/index.html';
        }
      } else {
        alert('KÃ©rlek fejezd be az onboarding folyamatot Ã©s fogadd el a hasznÃ¡lati feltÃ©teleket!');
        showPage('terms-setup-page');
      }
    }

    // Initialize on DOM load
    document.addEventListener('DOMContentLoaded', () => {
      // Wait a bit for translation manager to load
      setTimeout(() => {
        initializeWelcome();

        // Check if translation manager is available
        if (window.translationManager) {
          console.log('Translation manager is available');
        } else {
          console.log('Translation manager not yet available');
        }
      }, 100);
    });
  </script>
</head>

<body>
  <div class="app-bg">
    <main class="main-area">
      <div class="main-content">

        <!-- Step 1: Language Selection -->
        <div id="step1-page" class="welcome-page active">
          <div class="welcome-container">
            <!-- KÃ©z ikon -->
            <img src="/EU2K-Hub/assets/welcome_hand_icon.svg" class="welcome-hand-icon" alt="Waving Hand">

            <!-- ÃœdvÃ¶zlÅ‘ SzÃ¶veg -->
            <h1 class="welcome-title" data-translate="pages.onboarding_student.welcome-title">ÃœdvÃ¶zÃ¶llek a Hub-ban!</h1>

            <!-- Nyelvgombok -->
            <div class="welcome-description">
              <button class="welcome-button language-button" data-language="hu">
                <img src="/EU2K-Hub/assets/settings_icons/general_page/hungarian.png" class="welcome-icon"
                  alt="HU-Flag">
                <span class="welcome-text" data-translate="settings.language_hungarian">Magyar</span>
              </button>
              <button class="welcome-button-secondary language-button" data-language="en">
                <img src="/EU2K-Hub/assets/settings_icons/general_page/english.png" class="welcome-icon" alt="EN-Flag">
                <span class="welcome-text" data-translate="settings.language_english">English</span>
              </button>
            </div>
          </div>
        </div>

        <!-- Step 2: User Type Selection -->
        <div id="step2-page" class="welcome-page">
          <div class="welcome-container">
            <!-- KÃ©z ikon -->
            <img src="/EU2K-Hub/assets/welcome_hand_icon.svg" class="welcome-hand-icon" alt="Waving Hand">

            <!-- ÃœdvÃ¶zlÅ‘ SzÃ¶veg -->
            <h1 class="welcome-title" data-translate="pages.onboarding_student.welcome-title">ÃœdvÃ¶zÃ¶llek a Hub-ban!</h1>

            <!-- Navigation buttons -->
            <div class="welcome-navigation">
              <button class="welcome-nav-button nav-button" data-action="back-step1">
                <img src="/EU2K-Hub/assets/welcome_icons/back.svg" class="welcome-nav-icon" alt="Back">
                <span class="welcome-nav-text" data-translate="navigation.back">Vissza</span>
              </button>

              <button class="welcome-nav-button-primary nav-button" data-action="student">
                <img src="/EU2K-Hub/assets/welcome_icons/student.svg" class="welcome-nav-icon" alt="Student">
                <span class="welcome-nav-text" data-translate="onboarding.continue_as_student">TovÃ¡bb diÃ¡kkÃ©nt</span>
              </button>

              <button class="welcome-nav-button-primary nav-button" data-action="teacher">
                <img src="/EU2K-Hub/assets/welcome_icons/teacher.svg" class="welcome-nav-icon" alt="Teacher">
                <span class="welcome-nav-text" data-translate="onboarding.continue_as_teacher">TovÃ¡bb tanÃ¡rkÃ©nt</span>
              </button>

              <button class="welcome-nav-button-primary nav-button" data-action="parent">
                <img src="/EU2K-Hub/assets/welcome_icons/without_account.svg" class="welcome-nav-icon" alt="Parent">
                <span class="welcome-nav-text" data-translate="onboarding.continue_as_parent">TovÃ¡bb szÃ¼lÅ‘kÃ©nt</span>
              </button>

              <button class="welcome-nav-button-last nav-button" data-action="without-account">
                <img src="/EU2K-Hub/assets/welcome_icons/without_account.svg" class="welcome-nav-icon"
                  alt="Without Account">
                <span class="welcome-nav-text" data-translate="onboarding.continue_without_account">TovÃ¡bb
                  felnÅ‘ttkÃ©nt</span>
              </button>
            </div>
          </div>
        </div>

        <!-- Step 3: Teacher Page -->
        <div id="teacher-page" class="welcome-page">
          <div class="welcome-container">
            <!-- KÃ©z ikon -->
            <img src="/EU2K-Hub/assets/welcome_hand_icon.svg" class="welcome-hand-icon" alt="Waving Hand">

            <!-- ÃœdvÃ¶zlÅ‘ SzÃ¶veg -->
            <h1 class="welcome-title" data-translate="pages.onboarding_student.welcome_hub">ÃœdvÃ¶zlÃ¼nk a Hub-ban!</h1>

            <!-- LeÃ­rÃ¡s -->
            <p class="welcome-description-text" data-translate="pages.onboarding_student.teacher_description">
              Ãšgy lÃ¡tszik, tanÃ¡r vagy! Nagyra Ã©rtÃ©keljÃ¼k hogy megprÃ³bÃ¡lod felfedezni a Hub Ã¡ltal nyÃºjtott
              vÃ©gtelen lehetÅ‘sÃ©geket (na jÃ³ azÃ©rt nem ğŸ˜Š), de a Hub a bÃ©ta szakasz elejÃ©n van.
              TanÃ¡roknak is nemsokÃ¡ra elÃ©rhetÅ‘ lesz!
            </p>

            <!-- Vissza gomb -->
            <div class="welcome-back-button-container">
              <button class="welcome-back-button nav-button" data-action="back-step2">
                <img src="/EU2K-Hub/assets/welcome_icons/back.svg" class="welcome-back-icon" alt="Back">
                <span class="welcome-back-text" data-translate="navigation.back">Vissza</span>
              </button>
            </div>
          </div>
        </div>

        <!-- Step 3: Parent Page -->
        <div id="parent-page" class="welcome-page">
          <div class="welcome-container">
            <!-- KÃ©z ikon -->
            <img src="/EU2K-Hub/assets/welcome_hand_icon.svg" class="welcome-hand-icon" alt="Waving Hand">

            <!-- ÃœdvÃ¶zlÅ‘ SzÃ¶veg -->
            <h1 class="welcome-title" data-translate="pages.onboarding_student.welcome_hub">ÃœdvÃ¶zlÃ¼nk a Hub-ban!</h1>

            <!-- LeÃ­rÃ¡s -->
            <p class="welcome-description-text" data-translate="pages.onboarding_student.parent_description">
              SzÃ¼lÅ‘kÃ©nt szeretnÃ©l bejelentkezni a Hub-ba. VÃ¡laszd ki a bejelentkezÃ©si mÃ³dot:
            </p>

            <!-- BejelentkezÃ©si gombok -->
            <div class="welcome-navigation" style="margin-top: 40px;">
              <button class="welcome-nav-button nav-button" id="parent-apple-signin" disabled>
                <img src="/EU2K-Hub/assets/welcome_icons/apple.svg" class="welcome-nav-icon" alt="Apple">
                <span class="welcome-nav-text" data-translate="onboarding.signin_with_apple">BejelentkezÃ©s Apple-lel</span>
              </button>

              <button class="welcome-nav-button-last nav-button" id="parent-google-signin">
                <img src="/EU2K-Hub/assets/welcome_icons/google.svg" class="welcome-nav-icon" alt="Google">
                <span class="welcome-nav-text" data-translate="onboarding.signin_with_google">BejelentkezÃ©s Google-lel</span>
              </button>
            </div>

            <!-- Vissza gomb -->
            <div class="welcome-back-button-container">
              <button class="welcome-back-button nav-button" data-action="back-step2">
                <img src="/EU2K-Hub/assets/welcome_icons/back.svg" class="welcome-back-icon" alt="Back">
                <span class="welcome-back-text" data-translate="navigation.back">Vissza</span>
              </button>
            </div>
          </div>
        </div>

        <!-- Step 3: Adult Page -->
        <div id="adult-page" class="welcome-page">
          <div class="welcome-container">
            <!-- KÃ©z ikon -->
            <img src="/EU2K-Hub/assets/welcome_hand_icon.svg" class="welcome-hand-icon" alt="Waving Hand">

            <!-- ÃœdvÃ¶zlÅ‘ SzÃ¶veg -->
            <h1 class="welcome-title" data-translate="pages.onboarding_student.welcome_hub">ÃœdvÃ¶zlÃ¼nk a Hub-ban!</h1>

            <!-- LeÃ­rÃ¡s -->
            <p class="welcome-description-text" data-translate="pages.onboarding_student.adult_description">
              Ãšgy lÃ¡tszik, felnÅ‘tt vagy! Nagyra Ã©rtÃ©keljÃ¼k hogy megprÃ³bÃ¡lod felfedezni a Hub Ã¡ltal nyÃºjtott
              vÃ©gtelen lehetÅ‘sÃ©geket (na jÃ³ azÃ©rt nem ğŸ˜Š), de a Hub a bÃ©ta szakasz elejÃ©n van.
              FelnÅ‘tteknek is nemsokÃ¡ra elÃ©rhetÅ‘ lesz!
            </p>

            <!-- Vissza gomb -->
            <div class="welcome-back-button-container">
              <button class="welcome-back-button nav-button" data-action="back-step2">
                <img src="/EU2K-Hub/assets/welcome_icons/back.svg" class="welcome-back-icon" alt="Back">
                <span class="welcome-back-text" data-translate="navigation.back">Vissza</span>
              </button>
            </div>
          </div>
        </div>

        <!-- Step 3: Student Profile Setup -->
        <div id="student-profile-page" class="welcome-page">
          <div class="publish-layout">
            <div class="publish-content">
              <div class="publish-content-header">
                <button class="back-arrow-btn nav-button" onclick="localStorage.clear(); location.hash = 'step1';" id="student-logout-back-btn">
                  <img src="/EU2K-Hub/assets/welcome_icons/back.svg" alt="Vissza" class="arrow-img">
                </button>
                <div class="welcome-container-header">
                  <img src="/EU2K-Hub/assets/welcome_hand_icon.svg" class="welcome-icon-header" alt="Welcome">
                  <h1 class="welcome-text-header" data-translate="pages.onboarding_student.welcome_hub">ÃœdvÃ¶zlÃ¼nk a
                    Hub-ban!</h1>
                  <p class="welcome-description-header"
                    data-translate="pages.onboarding_student.create_account_description">KÃ©rlek vÃ¡lassz egy avatÃ¡rt,
                    vagy
                    hasznÃ¡ld az iskolai fiÃ³kod Ã¡ltal biztosÃ­tottat!</p>
                </div>
              </div>
            </div>

            <!-- Profile Setup Content - Right Column -->
            <div class="profile-content">
              <!-- Main Avatar -->
              <div class="main-avatar-container">
                <div class="main-avatar">
                  <img src="/EU2K-Hub/assets/avatars/magenta.png" class="main-avatar-img" alt="Avatar">
                </div>
                <div class="main-avatar-name" data-translate="profile.student_name">TurÃ³czi ÃdÃ¡m - 8.E</div>
              </div>

              <!-- Divider -->
              <div class="profile-divider"></div>

              <!-- Avatar Selection -->
              <div class="avatar-selection">
                <div class="avatar-row">
                  <div class="avatar-option" data-avatar="magenta">
                    <img src="/EU2K-Hub/assets/avatars/magenta.png" class="avatar-img" alt="Avatar 1">
                  </div>
                  <div class="avatar-option" data-avatar="green">
                    <img src="/EU2K-Hub/assets/avatars/green.png" class="avatar-img" alt="Avatar 2">
                  </div>
                  <div class="avatar-option" data-avatar="blue">
                    <img src="/EU2K-Hub/assets/avatars/blue.png" class="avatar-img" alt="Avatar 3">
                  </div>
                  <div class="avatar-option" data-avatar="orange">
                    <img src="/EU2K-Hub/assets/avatars/orange.png" class="avatar-img" alt="Avatar 4">
                  </div>
                  <div class="avatar-option" data-avatar="purple">
                    <img src="/EU2K-Hub/assets/avatars/purple.png" class="avatar-img" alt="Avatar 5">
                  </div>
                </div>
                <div class="avatar-row">
                  <div class="avatar-option" data-avatar="cyan">
                    <img src="/EU2K-Hub/assets/avatars/light_blue.png" class="avatar-img" alt="Avatar 6">
                  </div>
                  <div class="avatar-option" data-avatar="red">
                    <img src="/EU2K-Hub/assets/avatars/red.png" class="avatar-img" alt="Avatar 7">
                  </div>
                  <div class="avatar-option" data-avatar="gray">
                    <img src="/EU2K-Hub/assets/avatars/black.png" class="avatar-img" alt="Avatar 8">
                  </div>
                </div>
              </div>

              <!-- Action Buttons -->
              <div class="profile-actions">
                <button class="profile-button-secondary" id="proceed-with-school-pfp">
                  <img src="/EU2K-Hub/assets/welcome_icons/student.svg" class="profile-button-icon"
                    alt="School Account">
                  <span class="profile-button-text" data-translate="profile.use_school_account">TovÃ¡bb az iskolai
                    profilkÃ©ppel</span>
                </button>
                <button class="profile-button-primary" id="continue-with-avatar">
                  <img src="/EU2K-Hub/assets/welcome_icons/arrow_right.svg" class="profile-button-icon" alt="Continue">
                  <span class="profile-button-text" data-translate="profile.continue">TovÃ¡bb ezzel</span>
                </button>
              </div>

              <!-- Confirmation State (initially hidden) -->
              <div class="profile-actions profile-actions-confirmation" style="display: none;">
                <button class="profile-button-primary profile-button-confirmation" id="looks-good-button">
                  <img src="/EU2K-Hub/assets/welcome_icons/smiley.svg" class="profile-button-icon" alt="Looks Good">
                  <span class="profile-button-text" data-translate="profile.looks_good">JÃ³l nÃ©zek ki!</span>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Teacher Profile Setup -->
        <div id="teacher-profile-page" class="welcome-page">
          <div class="publish-layout">
            <div class="publish-content">
              <div class="publish-content-header">
                <button class="back-arrow-btn nav-button" onclick="localStorage.clear(); location.hash = 'step1';" id="teacher-logout-back-btn">
                  <img src="/EU2K-Hub/assets/welcome_icons/back.svg" alt="Vissza" class="arrow-img">
                </button>
                <div class="welcome-container-header">
                  <img src="/EU2K-Hub/assets/welcome_hand_icon.svg" class="welcome-icon-header" alt="Welcome">
                  <h1 class="welcome-text-header" data-translate="pages.onboarding_student.welcome_hub">ÃœdvÃ¶zlÃ¼nk a
                    Hub-ban!</h1>
                  <p class="welcome-description-header"
                    data-translate="pages.onboarding_student.create_account_description">KÃ©rlek vÃ¡lassz egy avatÃ¡rt,
                    vagy
                    hasznÃ¡ld az iskolai fiÃ³kod Ã¡ltal biztosÃ­tottat!</p>
                </div>
              </div>
            </div>

            <!-- Profile Setup Content - Right Column -->
            <div class="profile-content">
              <!-- Main Avatar -->
              <div class="main-avatar-container">
                <div class="main-avatar">
                  <img src="/EU2K-Hub/assets/avatars/magenta.png" class="main-avatar-img" alt="Avatar">
                </div>
                <div class="main-avatar-name" data-translate="profile.student_name">TurÃ³czi ÃdÃ¡m - 8.E</div>
              </div>

              <!-- Divider -->
              <div class="profile-divider"></div>

              <!-- Avatar Selection -->
              <div class="avatar-selection">
                <div class="avatar-row">
                  <div class="avatar-option" data-avatar="magenta">
                    <img src="/EU2K-Hub/assets/avatars/magenta.png" class="avatar-img" alt="Avatar 1">
                  </div>
                  <div class="avatar-option" data-avatar="green">
                    <img src="/EU2K-Hub/assets/avatars/green.png" class="avatar-img" alt="Avatar 2">
                  </div>
                  <div class="avatar-option" data-avatar="blue">
                    <img src="/EU2K-Hub/assets/avatars/blue.png" class="avatar-img" alt="Avatar 3">
                  </div>
                  <div class="avatar-option" data-avatar="orange">
                    <img src="/EU2K-Hub/assets/avatars/orange.png" class="avatar-img" alt="Avatar 4">
                  </div>
                  <div class="avatar-option" data-avatar="purple">
                    <img src="/EU2K-Hub/assets/avatars/purple.png" class="avatar-img" alt="Avatar 5">
                  </div>
                </div>
                <div class="avatar-row">
                  <div class="avatar-option" data-avatar="cyan">
                    <img src="/EU2K-Hub/assets/avatars/light_blue.png" class="avatar-img" alt="Avatar 6">
                  </div>
                  <div class="avatar-option" data-avatar="red">
                    <img src="/EU2K-Hub/assets/avatars/red.png" class="avatar-img" alt="Avatar 7">
                  </div>
                  <div class="avatar-option" data-avatar="gray">
                    <img src="/EU2K-Hub/assets/avatars/black.png" class="avatar-img" alt="Avatar 8">
                  </div>
                </div>
              </div>

              <!-- Action Buttons -->
              <div class="profile-actions">
                <button class="profile-button-secondary">
                  <img src="/EU2K-Hub/assets/welcome_icons/student.svg" class="profile-button-icon"
                    alt="School Account">
                  <span class="profile-button-text" data-translate="profile.use_school_account">TovÃ¡bb az iskolai
                    profilkÃ©ppel</span>
                </button>
                <button class="profile-button-primary" id="continue-with-avatar">
                  <img src="/EU2K-Hub/assets/welcome_icons/arrow_right.svg" class="profile-button-icon" alt="Continue">
                  <span class="profile-button-text" data-translate="profile.continue">TovÃ¡bb ezzel</span>
                </button>
              </div>

              <!-- Confirmation State (initially hidden) -->
              <div class="profile-actions profile-actions-confirmation" style="display: none;">
                <button class="profile-button-primary profile-button-confirmation" id="looks-good-button">
                  <img src="/EU2K-Hub/assets/welcome_icons/smiley.svg" class="profile-button-icon" alt="Looks Good">
                  <span class="profile-button-text" data-translate="profile.looks_good">JÃ³l nÃ©zek ki!</span>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Parent Profile Setup -->
        <div id="parent-profile-page" class="welcome-page">
          <div class="publish-layout">
            <div class="publish-content">
              <div class="publish-content-header">
                <button class="back-arrow-btn nav-button" data-action="logout-and-restart" id="parent-logout-back-btn">
                  <img src="/EU2K-Hub/assets/welcome_icons/back.svg" alt="Vissza" class="arrow-img">
                </button>
                <div class="welcome-container-header">
                  <img src="/EU2K-Hub/assets/welcome_hand_icon.svg" class="welcome-icon-header" alt="Welcome">
                  <h1 class="welcome-text-header" data-translate="pages.onboarding_student.welcome_hub">ÃœdvÃ¶zlÃ¼nk a
                    Hub-ban!</h1>
                  <p class="welcome-description-header"
                    data-translate="pages.onboarding_student.create_account_description">KÃ©rlek vÃ¡lassz egy avatÃ¡rt,
                    vagy
                    hasznÃ¡ld az iskolai fiÃ³kod Ã¡ltal biztosÃ­tottat!</p>
                </div>
              </div>
            </div>

            <!-- Profile Setup Content - Right Column -->
            <div class="profile-content">
              <!-- Main Avatar -->
              <div class="main-avatar-container">
                <div class="main-avatar">
                  <img src="/EU2K-Hub/assets/avatars/magenta.png" class="main-avatar-img" alt="Avatar">
                </div>
                <div class="main-avatar-name" data-translate="profile.student_name">TurÃ³czi ÃdÃ¡m - 8.E</div>
              </div>

              <!-- Divider -->
              <div class="profile-divider"></div>

              <!-- Avatar Selection -->
              <div class="avatar-selection">
                <div class="avatar-row">
                  <div class="avatar-option" data-avatar="magenta">
                    <img src="/EU2K-Hub/assets/avatars/magenta.png" class="avatar-img" alt="Avatar 1">
                  </div>
                  <div class="avatar-option" data-avatar="green">
                    <img src="/EU2K-Hub/assets/avatars/green.png" class="avatar-img" alt="Avatar 2">
                  </div>
                  <div class="avatar-option" data-avatar="blue">
                    <img src="/EU2K-Hub/assets/avatars/blue.png" class="avatar-img" alt="Avatar 3">
                  </div>
                  <div class="avatar-option" data-avatar="orange">
                    <img src="/EU2K-Hub/assets/avatars/orange.png" class="avatar-img" alt="Avatar 4">
                  </div>
                  <div class="avatar-option" data-avatar="purple">
                    <img src="/EU2K-Hub/assets/avatars/purple.png" class="avatar-img" alt="Avatar 5">
                  </div>
                </div>
                <div class="avatar-row">
                  <div class="avatar-option" data-avatar="cyan">
                    <img src="/EU2K-Hub/assets/avatars/light_blue.png" class="avatar-img" alt="Avatar 6">
                  </div>
                  <div class="avatar-option" data-avatar="red">
                    <img src="/EU2K-Hub/assets/avatars/red.png" class="avatar-img" alt="Avatar 7">
                  </div>
                  <div class="avatar-option" data-avatar="gray">
                    <img src="/EU2K-Hub/assets/avatars/black.png" class="avatar-img" alt="Avatar 8">
                  </div>
                </div>
              </div>

              <!-- Action Buttons -->
              <div class="profile-actions">
                <button class="profile-button-secondary">
                  <img src="/EU2K-Hub/assets/welcome_icons/student.svg" class="profile-button-icon"
                    alt="School Account">
                  <span class="profile-button-text" data-translate="profile.use_school_account">TovÃ¡bb az iskolai
                    profilkÃ©ppel</span>
                </button>
                <button class="profile-button-primary" id="continue-with-avatar">
                  <img src="/EU2K-Hub/assets/welcome_icons/arrow_right.svg" class="profile-button-icon" alt="Continue">
                  <span class="profile-button-text" data-translate="profile.continue">TovÃ¡bb ezzel</span>
                </button>
              </div>

              <!-- Confirmation State (initially hidden) -->
              <div class="profile-actions profile-actions-confirmation" style="display: none;">
                <button class="profile-button-primary profile-button-confirmation" id="looks-good-button">
                  <img src="/EU2K-Hub/assets/welcome_icons/smiley.svg" class="profile-button-icon" alt="Looks Good">
                  <span class="profile-button-text" data-translate="profile.looks_good">JÃ³l nÃ©zek ki!</span>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Step 4: Notifications Setup -->
        <div id="notifications-setup-page" class="welcome-page">
          <div class="publish-layout">
            <div class="publish-content">
              <div class="publish-content-header">
                <button class="back-arrow-btn nav-button" data-action="back-student-profile">
                  <img src="/EU2K-Hub/assets/welcome_icons/back.svg" alt="Vissza" class="arrow-img">
                </button>
                <div class="welcome-container-header">
                  <img src="/EU2K-Hub/assets/welcome_hand_icon.svg" class="welcome-icon-header" alt="Welcome">
                  <h1 class="welcome-text-header" data-translate="pages.onboarding_student.notifications_title">
                    Ã‰rtesÃ­tÃ©sek beÃ¡llÃ­tÃ¡sa</h1>
                  <p class="welcome-description-header"
                    data-translate="pages.onboarding_student.notifications_description">VÃ¡laszd ki, milyen Ã©rtesÃ­tÃ©seket
                    szeretnÃ©l kapni!</p>
                </div>
              </div>
            </div>

            <!-- Vertical Divider -->
            <div class="notifications-vertical-divider"></div>

            <!-- Notifications Content - Right Column -->
            <div class="profile-content notifications-content">
              <!-- Notice kÃ¡rtya -->
              <div class="notifications-notice">
                <img src="/EU2K-Hub/assets/settings_icons/notifications_page/info.svg" class="notice-icon" alt="Info">
                <span class="notice-text" data-translate="settings.notifications_notice">AmÃ­g az iskolÃ¡ban vagy, csendes
                  Ã©rtesÃ­tÃ©seket fogsz kapni.</span>
              </div>

              <!-- KategÃ³riÃ¡k kÃ¡rtya -->
              <div class="notifications-categories-card">
                <div class="categories-title" data-translate="settings.categories">KategÃ³riÃ¡k</div>

                <div class="category-items">
                  <!-- HÃ­rek -->
                  <div class="category-item first">
                    <img src="/EU2K-Hub/assets/settings_icons/notifications_page/news.svg" class="category-icon"
                      alt="HÃ­rek">
                    <span class="category-text" data-translate="settings.news">HÃ­rek</span>
                    <md-switch icons selected></md-switch>
                  </div>

                  <!-- Kurzusok -->
                  <div class="category-item middle">
                    <img src="/EU2K-Hub/assets/settings_icons/notifications_page/courses.svg" class="category-icon"
                      alt="Kurzusok">
                    <span class="category-text" data-translate="settings.courses">Kurzusok</span>
                    <md-switch icons disabled></md-switch>
                  </div>

                  <!-- EsemÃ©nyek -->
                  <div class="category-item middle">
                    <img src="/EU2K-Hub/assets/settings_icons/notifications_page/events.svg" class="category-icon"
                      alt="EsemÃ©nyek">
                    <span class="category-text" data-translate="settings.events">EsemÃ©nyek</span>
                    <md-switch icons selected></md-switch>
                  </div>

                  <!-- Ãœzenetek -->
                  <div class="category-item middle">
                    <img src="/EU2K-Hub/assets/settings_icons/notifications_page/messages.svg" class="category-icon"
                      alt="Ãœzenetek">
                    <span class="category-text" data-translate="settings.messages">Ãœzenetek</span>
                    <md-switch icons disabled></md-switch>
                  </div>

                  <!-- Posztok -->
                  <div class="category-item middle">
                    <img src="/EU2K-Hub/assets/settings_icons/notifications_page/posts.svg" class="category-icon"
                      alt="Posztok">
                    <span class="category-text" data-translate="settings.posts">Posztok</span>
                    <md-switch icons disabled></md-switch>
                  </div>

                  <!-- MeghÃ­vÃ³k -->
                  <div class="category-item middle">
                    <img src="/EU2K-Hub/assets/settings_icons/notifications_page/invites.svg" class="category-icon"
                      alt="MeghÃ­vÃ³k">
                    <span class="category-text" data-translate="settings.invites">MeghÃ­vÃ³k</span>
                    <md-switch icons disabled></md-switch>
                  </div>

                  <!-- BÃ©taverziÃ³ -->
                  <div class="category-item middle">
                    <img src="/EU2K-Hub/assets/settings_icons/notifications_page/beta_version.svg" class="category-icon"
                      alt="BÃ©taverziÃ³">
                    <span class="category-text" data-translate="settings.beta_version">BÃ©taverziÃ³</span>
                    <md-switch icons disabled selected></md-switch>
                  </div>

                  <!-- ÃšjdonsÃ¡gok -->
                  <div class="category-item middle">
                    <img src="/EU2K-Hub/assets/settings_icons/notifications_page/new_things.svg" class="category-icon"
                      alt="ÃšjdonsÃ¡gok">
                    <span class="category-text" data-translate="settings.new_things">ÃšjdonsÃ¡gok</span>
                    <md-switch icons disabled selected></md-switch>
                  </div>

                  <!-- CsengÅ‘ -->
                  <div class="category-item last">
                    <img src="/EU2K-Hub/assets/settings_icons/notifications_page/bell.svg" class="category-icon"
                      alt="CsengÅ‘">
                    <span class="category-text" data-translate="settings.bell">CsengÅ‘</span>
                    <md-switch icons disabled></md-switch>
                  </div>
                </div>

                <!-- Continue Button - Inside categories card -->
                <div class="notifications-actions">
                  <button class="notifications-continue-button" id="continue-notifications">
                    <img src="/EU2K-Hub/assets/arrow_forward.svg" class="profile-button-icon" alt="Next">
                    <span class="notifications-continue-text" data-translate="navigation.continue">TovÃ¡bb</span>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Step 5: Messages Setup -->
        <div id="messages-setup-page" class="welcome-page">
          <div class="publish-layout">
            <div class="publish-content">
              <div class="publish-content-header">
                <button class="back-arrow-btn nav-button" data-action="back-notifications-setup">
                  <img src="/EU2K-Hub/assets/welcome_icons/back.svg" alt="Vissza" class="arrow-img">
                </button>
                <div class="welcome-container-header">
                  <img src="/EU2K-Hub/assets/welcome_hand_icon.svg" class="welcome-icon-header" alt="Welcome">
                  <h1 class="welcome-text-header" data-translate="pages.onboarding_student.messages_title">
                    Ãœzenetek beÃ¡llÃ­tÃ¡sa</h1>
                  <p class="welcome-description-header" data-translate="pages.onboarding_student.messages_description">
                    DÃ¶ntsd el, hogy nyitott vagy-e a privÃ¡t Ã¼zenetekre!</p>
                </div>
              </div>
            </div>

            <!-- Vertical Divider -->
            <div class="notifications-vertical-divider"></div>

            <!-- Messages Content - Right Column -->
            <div class="profile-content messages-content">
              <div class="card card-top">
                <span data-translate="pages.account.private_messages">PrivÃ¡t Ãœzenetek</span>
                <md-switch icons selected></md-switch>
              </div>

              <div class="card card-bottom">
                <span data-translate="pages.account.who_can_message">Ki kÃ¼ldhet neked Ã¼zeneteket?</span>
                <div class="notice">
                  <img src="/EU2K-Hub/assets/warning.svg" class="notice-icon" alt="Info">
                  <span data-translate="pages.account.message_notice">Ezt a beÃ¡llÃ­tÃ¡st csak te tudod mÃ³dosÃ­tani.</span>
                </div>
                <div class="radio-group">
                  <div class="radio-item">
                    <span data-translate="pages.account.everyone">Mindenki</span>
                    <md-radio name="message-privacy" value="everyone"></md-radio>
                  </div>
                  <div class="radio-item">
                    <span data-translate="pages.account.nobody">Senki</span>
                    <md-radio name="message-privacy" value="nobody" checked></md-radio>
                  </div>
                  <div class="radio-item">
                    <span data-translate="pages.account.classmates_only">Csak osztÃ¡lytÃ¡rsak</span>
                    <md-radio name="message-privacy" value="classmates"></md-radio>
                  </div>
                </div>
              </div>

              <!-- Continue Button -->
              <div class="messages-actions">
                <button class="messages-continue-button" id="continue-messages">
                  <img src="/EU2K-Hub/assets/arrow_forward.svg" class="profile-button-icon" alt="Next">
                  <span class="notifications-continue-text" data-translate="navigation.continue">TovÃ¡bb</span>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Login Failed Page -->
        <div id="login-failed-page" class="welcome-page">
          <div class="welcome-container">
            <!-- Hiba ikon -->
            <img src="/EU2K-Hub/assets/warning.svg" class="welcome-hand-icon" alt="Error">

            <!-- HibaÃ¼zenet -->
            <h1 class="welcome-title" data-translate="pages.onboarding_student.login_failed_title">BejelentkezÃ©si hiba</h1>

            <!-- LeÃ­rÃ¡s -->
            <p class="welcome-description-text" data-translate="pages.onboarding_student.login_failed_description">
              A bejelentkezÃ©s sikertelen volt. KÃ©rjÃ¼k, prÃ³bÃ¡ld Ãºjra!
            </p>

            <!-- ÃšjraprÃ³bÃ¡lkozÃ¡s gomb -->
            <div class="welcome-navigation">
              <button class="welcome-nav-button-primary nav-button" onclick="localStorage.clear(); location.hash = 'step1';">
                <img src="/EU2K-Hub/assets/welcome_icons/student.svg" class="welcome-nav-icon" alt="Student">
                <span class="welcome-nav-text" data-translate="onboarding.try_again">ÃšjraprÃ³bÃ¡lkozÃ¡s</span>
              </button>
            </div>
          </div>
        </div>
        
        <!-- Auth In Progress Page -->
        <div id="auth-in-progress-page" class="welcome-page">
          <div class="welcome-container">
            <img src="/EU2K-Hub/assets/clock.svg" class="welcome-hand-icon" alt="Wait">

            <!-- Ãœzenet -->
            <h1 class="welcome-title" data-translate="pages.onboarding_student.auth_in_progress_title">BejelentkeztetÃ©s folyamatban</h1>

            <!-- LeÃ­rÃ¡s -->
            <p class="welcome-description-text" data-translate="pages.onboarding_student.auth_in_progress_description">
              KÃ©rlek vÃ¡rj...
            </p>
          </div>
        </div>
        
        <!-- Restart Onboarding Page -->
        <div id="restart-onboarding-page" class="welcome-page">
          <div class="welcome-container">
            <!-- FigyelmeztetÅ‘ ikon -->
            <img src="/EU2K-Hub/assets/welcome_icons/belwarning.svg" class="welcome-hand-icon" alt="Warning">

            <!-- Ãœzenet -->
            <h1 class="welcome-title" data-translate="pages.onboarding_student.restart_title">Biztos Ãºjra szeretnÃ©d kezdeni?</h1>

            <!-- LeÃ­rÃ¡s -->
            <p class="welcome-description-text" data-translate="pages.onboarding_student.restart_description">
              Ezzel el fogja a Hub felejteni a mostani fiÃ³kod ezen a gÃ©pen, elvesznek a preferenciÃ¡id, Ã©s az Ã¼zeneteid, ha mÃ¡st Ã¡llÃ­tasz be Ãºjra, mint amit alapbÃ³l beÃ¡llÃ­tottÃ¡l. Biztos folytatod?
            </p>

            <!-- Biztos gomb -->
            <div class="welcome-navigation">
              <button class="welcome-nav-button-primary nav-button" id="confirm-restart">
                <img src="/EU2K-Hub/assets/arrow_next.svg" class="welcome-nav-icon" alt="Im Sure">
                <span class="welcome-nav-text" data-translate="onboarding.confirm">Biztos</span>
              </button>
            </div>
          </div>
        </div>
        
        <!-- Delete Profile Page -->
        <div id="delete-profile-page" class="welcome-page">
          <div class="welcome-container">
            <!-- FigyelmeztetÅ‘ ikon -->
            <img src="/EU2K-Hub/assets/warning.svg" class="welcome-hand-icon" alt="Warning">

            <!-- Ãœzenet -->
            <h1 class="welcome-title" data-translate="pages.onboarding_student.delete_profile_title">Biztos ki szeretnÃ©d tÃ¶rÃ¶lni a profilod?</h1>

            <!-- LeÃ­rÃ¡s -->
            <p class="welcome-description-text" data-translate="pages.onboarding_student.delete_profile_description">
              Ezt nem vonhatod vissza, minden adatod amit a Hubban tartottÃ¡l elveszik Ã¶rÃ¶kre. Biztos vagy ebben?
            </p>

            <!-- Biztos gomb -->
            <div class="welcome-navigation">
              <button class="welcome-nav-button-primary nav-button" id="confirm-delete-profile">
                <img src="/EU2K-Hub/assets/arrow_next.svg" class="welcome-nav-icon" alt="Im Sure">
                <span class="welcome-nav-text" data-translate="onboarding.confirm">Biztos</span>
              </button>
            </div>
          </div>
        </div>
        
        <!-- Step 6: Terms of Service -->
        <div id="terms-setup-page" class="welcome-page">
          <div class="publish-layout">
            <div class="publish-content">
              <div class="publish-content-header">
                <button class="back-arrow-btn nav-button" data-action="back-messages-setup">
                  <img src="/EU2K-Hub/assets/welcome_icons/back.svg" alt="Vissza" class="arrow-img">
                </button>
                <div class="welcome-container-header">
                  <img src="/EU2K-Hub/assets/welcome_icons/terms_of_service.svg" class="welcome-icon-header"
                    alt="Terms of Service">
                  <h1 class="welcome-text-header" data-translate="pages.onboarding_student.terms_title">
                    Fogadd el kÃ©rlek a hasznÃ¡lati feltÃ©teleket!</h1>
                  <p class="welcome-description-header" data-translate="pages.onboarding_student.terms_description">
                    Olvasd vÃ©gig, vagy tudj meg tÃ¶bbet, Ã©s fogadd el a tÃ¡jÃ©koztatÃ³t, Ã©s be is fejeztÃ¼k!</p>
                </div>
              </div>
            </div>

            <!-- Vertical Divider -->
            <div class="terms-vertical-divider"></div>

            <!-- Terms Content - Right Column -->
            <div class="profile-content terms-content">
              <div class="terms-scroll-area">
                <div class="terms-section terms-section-first">
                  <h3>
                    <img src="/EU2K-Hub/assets/welcome_icons/message.svg" class="terms-icon" alt="Messages">
                    <span data-translate="pages.onboarding_student.terms_messaging_title">ÃœzenetkÃ¼ldÃ©s Ã©s
                      felÃ¼gyelet</span>
                  </h3>
                  <ul>
                    <li data-translate="pages.onboarding_student.terms_messaging_1">A Hub lehetÅ‘sÃ©get biztosÃ­t kÃ¶zÃ¶ssÃ©gi Ã©s kurzuson belÃ¼li kommunikÃ¡ciÃ³ra.</li>
                    <li data-translate="pages.onboarding_student.terms_messaging_2">A felÃ¼gyelet rÃ©szleges lehet, kÃ¼lÃ¶nÃ¶sen a bÃ©ta idÅ‘szakban. KÃ©rÃ¼nk, viselkedj tiszteletteljesen!</li>
                  </ul>
                </div>

                <div class="terms-section terms-section-middle">
                  <h3>
                    <img src="/EU2K-Hub/assets/welcome_icons/account_protection.svg" class="terms-icon"
                      alt="Account Protection">
                    <span data-translate="pages.onboarding_student.terms_accounts_title">FelhasznÃ¡lÃ³i fiÃ³kok Ã©s
                      jogosultsÃ¡gok</span>
                  </h3>
                  <ul>
                    <li data-translate="pages.onboarding_student.terms_accounts_1">A Hub egy kÃ¶zponti, iskolai rendszer, amelyet tanÃ¡rok, diÃ¡kok Ã©s szÃ¼lÅ‘k hasznÃ¡lhatnak.</li>
                    <li data-translate="pages.onboarding_student.terms_accounts_2">A diÃ¡kok szÃ¡mÃ¡ra elkÃ¼lÃ¶nÃ­tett rÃ©szhez kizÃ¡rÃ³lag iskolai fiÃ³kkal lehet hozzÃ¡fÃ©rni.</li>
                    <li data-translate="pages.onboarding_student.terms_accounts_3">KÃ¼lsÅ‘s e-mail cÃ­mek csak szÃ¼lÅ‘i fiÃ³k lÃ©trehozÃ¡sÃ¡ra hasznÃ¡lhatÃ³k.</li>
                    <li data-translate="pages.onboarding_student.terms_accounts_4">Ha visszaÃ©lÃ©s tÃ¶rtÃ©nik (pl. szÃ¼lÅ‘i fiÃ³kot hasznÃ¡lÃ³ diÃ¡k), fenntartjuk a jogot a fiÃ³k tÃ­pusÃ¡nak mÃ³dosÃ­tÃ¡sÃ¡ra, Ã©rtesÃ­tÃ©s kÃ¼ldÃ©sÃ©re, Ã©s funkciÃ³k korlÃ¡tozÃ¡sÃ¡ra.</li>
                    <li data-translate="pages.onboarding_student.terms_accounts_5">A rendszer bÃ¡rmilyen jogosulatlan kihasznÃ¡lÃ¡sa szankciÃ³t von maga utÃ¡n.</li>
                  </ul>
                </div>

                <div class="terms-section terms-section-middle">
                  <h3>
                    <img src="/EU2K-Hub/assets/welcome_icons/supervision.svg" class="terms-icon" alt="Supervision">
                    <span data-translate="pages.onboarding_student.terms_responsibility_title">FelelÅ‘ssÃ©g</span>
                  </h3>
                  <ul>
                    <li data-translate="pages.onboarding_student.terms_responsibility_1">A Hubban elÃ©rhetÅ‘ kurzusokat kÃ¼lsÅ‘ vagy belsÅ‘ szervezÅ‘k (hostok) mÅ±kÃ¶dtetik.</li>
                    <li data-translate="pages.onboarding_student.terms_responsibility_2">A kurzusokÃ©rt kizÃ¡rÃ³lag a kurzus hostja felel.</li>
                    <li data-translate="pages.onboarding_student.terms_responsibility_3">A Hub, az iskola Ã©s a platform fejlesztÅ‘i nem vÃ¡llalnak felelÅ‘ssÃ©get a kurzusok tartalmÃ¡Ã©rt, idÅ‘pontjÃ¡Ã©rt vagy technikai hibÃ¡kÃ©rt.</li>
                    <li data-translate="pages.onboarding_student.terms_responsibility_4">A bÃ©ta szakaszban moderÃ¡ciÃ³s rendszer nem feltÃ©tlenÃ¼l Ã¡ll rendelkezÃ©sre, emiatt a kÃ¶zÃ¶ssÃ©gi funkciÃ³k korlÃ¡tozottak vagy hiÃ¡nyozhatnak.</li>
                  </ul>
                </div>

                <div class="terms-section terms-section-middle">
                  <h3>
                    <img src="/EU2K-Hub/assets/welcome_icons/feedback.svg" class="terms-icon" alt="Feedback">
                    <span data-translate="pages.onboarding_student.terms_feedback_title">VisszajelzÃ©sek Ã©s bÃ©ta
                      funkciÃ³k</span>
                  </h3>
                  <ul>
                    <li data-translate="pages.onboarding_student.terms_feedback_1">Nagyra Ã©rtÃ©keljÃ¼k a visszajelzÃ©seidet â€“ ezek segÃ­tik a Hub fejlÅ‘dÃ©sÃ©t!</li>
                    <li data-translate="pages.onboarding_student.terms_feedback_2">A visszajelzÅ‘ Ã©s hibabejelentÅ‘ funkciÃ³kat tiszteletteljesen Ã©s jÃ³ szÃ¡ndÃ©kkal kell hasznÃ¡lni.</li>
                    <li data-translate="pages.onboarding_student.terms_feedback_3">VisszaÃ©lÃ©sek (pl. spamelÃ©s, hamis jelentÃ©sek, sÃ©rtÅ‘ hangnem) esetÃ©n a visszajelzÃ©si lehetÅ‘sÃ©gek korlÃ¡tozhatÃ³k.</li>
                    <li data-translate="pages.onboarding_student.terms_feedback_4">BÃ©ta verziÃ³ban sÃºlyos szabÃ¡lysÃ©rtÃ©s azonnali kizÃ¡rÃ¡ssal jÃ¡rhat.</li>
                  </ul>
                </div>

                <div class="terms-section terms-section-middle">
                  <h3>
                    <img src="/EU2K-Hub/assets/privacy_policy.svg" class="terms-icon" alt="Privacy">
                    <span data-translate="pages.onboarding_student.terms_privacy_title">AdatvÃ©delem Ã©s sÃ¼tik</span>
                  </h3>
                  <ul>
                    <li data-translate="pages.onboarding_student.terms_privacy_1">A Hub az iskolai fiÃ³khoz kapcsolÃ³dÃ³ alapadatokat (nÃ©v, e-mail, szerepkÃ¶r) hasznÃ¡lja.</li>
                    <li data-translate="pages.onboarding_student.terms_privacy_2">A sÃ¼tiket kizÃ¡rÃ³lag technikai mÅ±kÃ¶dÃ©shez (pl. bejelentkezÃ©s megjegyzÃ©se) alkalmazzuk.</li>
                    <li data-translate="pages.onboarding_student.terms_privacy_3">Az adatkezelÃ©srÅ‘l rÃ©szletesebb informÃ¡ciÃ³ az <a href="/EU2K-Hub/privacy.html">AdatvÃ©delmi tÃ¡jÃ©koztatÃ³ban</a> talÃ¡lhatÃ³.</li>
                  </ul>
                </div>

                <div class="terms-section terms-section-last">
                  <h3>
                    <img src="/EU2K-Hub/assets/settings_icon.svg" class="terms-icon" alt="Technical Terms">
                    <span data-translate="pages.onboarding_student.terms_technical_title">Technikai feltÃ©telek</span>
                  </h3>
                  <ul>
                    <li data-translate="pages.onboarding_student.terms_technical_1">A Hub modern bÃ¶ngÃ©szÅ‘kre optimalizÃ¡lt. RÃ©gebbi bÃ¶ngÃ©szÅ‘kben elÅ‘fordulhatnak hibÃ¡k.</li>
                    <li data-translate="pages.onboarding_student.terms_technical_2">A szolgÃ¡ltatÃ¡s elÅ‘-bÃ©ta szakaszban mÅ±kÃ¶dik, Ã­gy idÅ‘nkÃ©nt instabilitÃ¡s, hibÃ¡k vagy funkciÃ³hiÃ¡ny elÅ‘fordulhat.</li>
                  </ul>
                </div>

                <p class="terms-last-update" data-translate="pages.onboarding_student.terms_last_update">UtolsÃ³ frissÃ­tÃ©s dÃ¡tuma: 2025. szeptember 13.</p>
              </div>

              <!-- Terms Acceptance -->
              <div class="terms-acceptance">
                <label class="terms-acceptance-label">
                  <md-checkbox id="terms-checkbox"></md-checkbox>
                  <span class="terms-acceptance-text"
                    data-translate="pages.onboarding_student.terms_acceptance_text">Elfogadom a hasznÃ¡lati feltÃ©teleket
                    Ã©s az adatkezelÃ©si
                    tÃ¡jÃ©koztatÃ³t</span>
                </label>
              </div>

              <!-- Continue Button - Fixed at bottom -->
              <div class="terms-actions">
                <button class="terms-continue-button" id="continue-terms" disabled>
                  <img src="/EU2K-Hub/assets/arrow_forward.svg" class="profile-button-icon" alt="Next">
                  <span class="terms-continue-text" data-translate="pages.onboarding_student.accept">Elfogadom</span>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Step 7: Final Welcome -->
        <div id="final-welcome-page" class="welcome-page">
          <div class="final-welcome-container">
            <img src="/EU2K-Hub/assets/welcome_icons/smiley_animated.gif" class="final-welcome-gif" alt="Welcome">
            <h1 class="final-welcome-title" data-translate="pages.onboarding_student.final_welcome_title">KÃ©sz is
              vagyunk!</h1>
            <button class="final-welcome-button" onclick="window.checkTermsAndRedirect()">
              <img src="/EU2K-Hub/assets/welcome_icons/wave.svg" class="final-welcome-icon" alt="Wave">
              <span data-translate="pages.onboarding_student.final_welcome_start">KezdÃ©s</span>
            </button>
          </div>
        </div>
        <!-- Login Failed Page (hash: #login-failed) -->
        <div id="login-failed-page" class="welcome-page" style="display:none;">
          <div class="final-welcome-container" style="gap: 12px;">
            <img src="/EU2K-Hub/assets/welcome_icons/warning.svg" class="final-welcome-gif" alt="Hiba" style="width:160px;height:160px;object-fit:contain;filter:invert(1) grayscale(1) contrast(20);">
            <h1 class="final-welcome-title" style="margin-top: 0; color:#C4C8C3;">Nem sikerÃ¼lt a bejelentkezÃ©s.</h1>
            <p style="margin:0; color:#C4C8C3; opacity:0.9;">KÃ©rlek prÃ³bÃ¡ld Ãºjra, vagy prÃ³bÃ¡lkozz kÃ©sÅ‘bb.</p>
            <div class="welcome-back-button-container" style="margin-top: 18px;">
              <button class="welcome-back-button nav-button" data-action="back-step2" aria-label="Vissza a bejelentkezÃ©shez">
                <img src="/EU2K-Hub/assets/arrow_back.svg" class="welcome-back-icon" alt="Back">
                <span class="welcome-back-text">Vissza a bejelentkezÃ©shez</span>
              </button>
            </div>
          </div>
        </div>
        
        <!-- Onboarding Failed Page (hash: #onboarding-failed) -->
        <div id="onboarding-failed-page" class="welcome-page" style="display:none;">
          <div class="final-welcome-container" style="gap: 12px;">
            <img src="/EU2K-Hub/assets/welcome_icons/warning.svg" class="final-welcome-gif" alt="Hiba" style="width:160px;height:160px;object-fit:contain;filter:invert(1) grayscale(1) contrast(20);">
            <h1 class="final-welcome-title" style="margin-top: 0; color:#C4C8C3;">Nem sikerÃ¼lt az onboarding.</h1>
            <p style="margin:0; color:#C4C8C3; opacity:0.9;">KÃ©rlek prÃ³bÃ¡ld Ãºjra, vagy prÃ³bÃ¡lkozz kÃ©sÅ‘bb.</p>
            <div class="welcome-back-button-container" style="margin-top: 18px;">
              <button class="welcome-back-button" onclick="window.retryOnboarding()" aria-label="ÃšjraprÃ³bÃ¡lkozÃ¡s">
                <img src="/EU2K-Hub/assets/arrow_back.svg" class="welcome-back-icon" alt="Back">
                <span class="welcome-back-text">ÃšjraprÃ³bÃ¡lkozÃ¡s</span>
              </button>
            </div>
          </div>
        </div>
      </div>

  </div>
  </main>
  </div>
</body>

</html>