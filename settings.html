<!DOCTYPE html>
<html lang="hu">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="EU2K Hub Beállítások">
  <title data-translate="pages.settings.title" data-translate-fallback="Beállítások">Beállítások</title>
  <link rel="stylesheet" href="settings.css">
  <link rel="stylesheet" href="assets/css/consent-banner.css">
  <link rel="stylesheet" href="assets/components/language-dropdown.css">
  <link rel="icon" href="favicon.ico">
  <script type="importmap">
    {
      "imports": {
        "@material/web/": "https://esm.run/@material/web/"
      }
    }
  </script>
  <script type="module">
    import '@material/web/all.js';
    import { styles as typescaleStyles } from '@material/web/typography/md-typescale-styles.js';

    document.adoptedStyleSheets.push(typescaleStyles.styleSheet);
  </script>
  <script>
    (function(){
      if (!document.getElementById('eu2k-page-overlay')) {
        var o = document.createElement('div');
        o.id = 'eu2k-page-overlay';
        o.style.cssText = 'position:fixed;inset:0;z-index:9999;background:#000000;border-radius:32px;opacity:1;transition:opacity 300ms ease-in-out;';
        var inner = document.createElement('div');
        inner.style.cssText = 'position:relative;width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:#000000;border-radius:32px;';
        var m = document.createElement('div');
        m.id = 'eu2k-overlay-mount';
        m.style.cssText = 'position:relative;width:100%;height:100%';
        inner.appendChild(m);
        o.appendChild(inner);
        document.documentElement.appendChild(o);
      }
    })();
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto:ital,wght@0,100..900;1,100..900&display=swap');
    body, * {
      font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
  </style>
  <script src="assets/js/page-overlay-loader.js"></script>
  <script>
    window.addEventListener('load', function() {
      try {
        var o = document.getElementById('eu2k-page-overlay');
        if (o) {
          o.style.opacity = '0';
          o.style.pointerEvents = 'none';
          setTimeout(function(){ try { o.remove(); } catch(e){} }, 300);
        }
      } catch (e) { /* no-op */ }
    });
  </script>
  <script src="assets/js/permissions.js"></script>
  <script src="assets/js/translations.js"></script>
  <script src="assets/js/account-tooltip.js"></script>
  <script>
    // Globális init, hogy minden render után biztosan legyen fordítás
    document.addEventListener('DOMContentLoaded', async () => {
      if (window.translationManager) {
        try {
          await window.translationManager.init?.();
          window.translationManager.applyTranslations?.();
        } catch (e) {
          console.error('[Settings] translation init/apply error', e);
        }
      }
    });
    // Nyelvváltás storage eseményre is
    window.addEventListener('storage', async (evt) => {
      if (evt.key === 'eu2k_language' && window.translationManager) {
        try {
          await window.translationManager.switchLanguage(evt.newValue || 'hu');
          window.translationManager.applyTranslations?.();
        } catch (e) {
          console.error('[Settings] storage translation error', e);
        }
      }
    });
  </script>
  <script src="assets/js/auth-state.js"></script>
  <script src="assets/js/test_firebase.js" type="module"></script>
  <script src="assets/js/firebase-performance.js" type="module"></script>
  <script src="assets/js/youhub-notification-toaster.js" type="module"></script>
  <script src="assets/js/first-input-delay.js"></script>
  <script src="assets/components/language-dropdown.js" defer></script>
  <script src="assets/global/hub-maintenance-overlay.js"></script>
  <script>
    // Indításkor fordítási rendszer bekapcsolása
    document.addEventListener('DOMContentLoaded', async () => {
      if (window.translationManager) {
        try {
          if (!window.translationManager.isInitialized && window.translationManager.init) {
            await window.translationManager.init();
          }
          if (window.translationManager.applyTranslations) {
            window.translationManager.applyTranslations();
          }
        } catch (e) {
          console.error('[Settings] translationManager init/apply error', e);
        }
      }
    });
  </script>
  <script type="text/javascript" data-gdpr-required>
    (function (c, l, a, r, i, t, y) {
      c[a] = c[a] || function () { (c[a].q = c[a].q || []).push(arguments) };
      t = l.createElement(r); t.async = 1; t.src = "https://www.clarity.ms/tag/" + i;
      y = l.getElementsByTagName(r)[0]; y.parentNode.insertBefore(t, y);
    })(window, document, "clarity", "script", "s6n7qpfkv4");
  </script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-analytics.js";
    import { getFirestore } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
    import { getStorage } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-storage.js";
    import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-functions.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBRRVx6BtQtCDKjFYA8yh9qYrcUONmkkwI",
      authDomain: "eu2k-hub.firebaseapp.com",
      projectId: "eu2k-hub",
      storageBucket: "eu2k-hub.firebasestorage.app",
      messagingSenderId: "560244867055",
      appId: "1:560244867055:web:3cd51b85baead94989001a",
      measurementId: "G-2JDPR089WD"
    };

    const app = initializeApp(firebaseConfig);
    let analytics = null;
    if (window.eu2kGDPR && window.eu2kGDPR.hasConsent()) {
      analytics = getAnalytics(app);
    } else {
      window.addEventListener('eu2k-gdpr-scripts-loaded', () => {
        if (!analytics) {
          analytics = getAnalytics(app);
        }
      });
    }
    const db = getFirestore(app);
    const storage = getStorage(app);
    const functions = getFunctions(app, 'europe-west1');

    window.db = db;
    window.functions = functions;
    window.createHttpsCallable = (name) => httpsCallable(functions, name);
    window.storage = storage;
  </script>
  <script type="module">
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";

    function updateHeaderIcons(loggedIn) {
      const accountWrapper = document.getElementById('headerAccountWrapper');
      const loginBtn = document.getElementById('headerLoginBtn');
      if (!accountWrapper || !loginBtn) return;

      if (loggedIn) {
        accountWrapper.style.display = 'flex';
        loginBtn.style.display = 'none';
        } else {
        accountWrapper.style.display = 'none';
        loginBtn.style.display = 'flex';
      }
    }

    try {
      const auth = getAuth();
      onAuthStateChanged(auth, (user) => {
        updateHeaderIcons(!!user);
      });
    } catch (e) {
      updateHeaderIcons(localStorage.getItem('eu2k-auth-logged-in') === 'true');
    }
    
    // Bejelentkezés gomb kattintás
    document.addEventListener('DOMContentLoaded', () => {
      const loginBtnEl = document.getElementById('headerLoginBtn');
      if (loginBtnEl) {
        loginBtnEl.addEventListener('click', () => {
          window.location.href = 'onboarding.html';
        });
      }
    });
  </script>
</head>

<body>
  <div class="app-bg">
    <!-- Sidebar / Navigation Rail (left) -->
    <aside class="sidebar" role="navigation" aria-label="Settings navigáció">
      <div class="nav-frame">
        <div class="nav-shell">
          <nav class="nav-rail">
            <a class="rail-item nav-btn is-active" href="#general" data-page="general">
          <div class="rail-icon">
                <img src="assets/navbar/filled/general.svg" alt="Általános" />
          </div>
              <span class="rail-label" data-translate="pages.settings.general">Általános</span>
        </a>
            <a class="rail-item nav-btn" href="#notifications" data-page="notifications">
          <div class="rail-icon">
                <img src="assets/navbar/notifications.svg" alt="Értesítések &amp; Hang" />
          </div>
              <span class="rail-label" data-translate="pages.settings.notifications">Értesítések &amp; Hang</span>
        </a>
            <a class="rail-item nav-btn" href="#functions" data-page="functions">
          <div class="rail-icon">
                <img src="assets/navbar/functions.svg" alt="Funkciók" />
          </div>
              <span class="rail-label" data-translate="pages.settings.functions" data-translate-fallback="Funkciók">Funkciók</span>
        </a>
            <a class="rail-item nav-btn" href="#pages" data-page="pages">
            <div class="rail-icon">
                <img src="assets/navbar/pages.svg" alt="Lapok" />
          </div>
              <span class="rail-label" data-translate="pages.settings.pages" data-translate-fallback="Lapok">Lapok</span>
          </a>
            <!-- <a class="rail-item nav-btn" href="#chat" data-page="chat">
          <div class="rail-icon">
                <img src="assets/navbar/messages.svg" alt="Csevegés" />
          </div>
              <span class="rail-label" data-translate="pages.settings.chat">Csevegés</span>
          </a> -->
            <!-- <a class="rail-item nav-btn" href="#credits" data-page="credits">
            <div class="rail-icon">
                <img src="assets/navbar/credits.svg" alt="Kreditek és Jogi Infók" />
            </div>
              <span class="rail-label" data-translate="pages.settings.credits">Kreditek és Jogi Infók</span>
          </a> -->
      </nav>
        </div>
      </div>
    </aside>

    <main class="main-area">
      <div class="main-scroll-area">
          <!-- Header -->
          <header class="header">
            <div class="header-content">
            <div class="welcome-container">
              <img id="settingsPageIcon" src="assets/navbar/general.svg" class="welcome-icon" alt="Settings">
              <!-- A cím szöveget mindig a showPage() állítja be: "Beállítások - {Aktuális lap}" többnyelvűen -->
              <span class="welcome-text" id="settingsPageTitle">Beállítások</span>
            </div>
              <div class="header-icon-container">
                <div class="header-icon-gradient">
                  <div class="header-icon-wrapper" id="headerAccountWrapper" style="display: none;">
                    <a href="system/account.html" class="header-icon-btn" id="headerAccountBtn">
                      <img src="assets/general/account.svg" alt="Account">
              </a>
            </div>
                  <button class="header-login-btn" id="headerLoginBtn" data-translate="pages.general.login" style="display: none;">
                    Bejelentkezés
                  </button>
                <!-- Alkalmazás gomb (nyelvváltás megerősítésére) -->
                <button class="header-edit-mode-btn" id="settingsApplyBtn" style="opacity: 0.5; pointer-events: none;">
                  <img class="header-edit-mode-icon" src="assets/youhub/suggestions/check_dark.svg" alt="Alkalmazás">
                  <span class="header-edit-mode-text" id="settingsApplyBtnText" data-translate="pages.settings.apply" data-translate-fallback="Alkalmazás">Alkalmazás</span>
                </button>
                <!-- Vissza gomb (YouHub szerkesztés gomb stílusával) -->
                <button class="header-edit-mode-btn" id="settingsBackBtn">
                  <img class="header-edit-mode-icon" src="assets/onboarding/back_arrow.svg" alt="Vissza">
                  <span class="header-edit-mode-text" id="settingsBackBtnText">Vissza</span>
                  </button>
            </div>
                </div>
                    </div>
        </header>

        <div class="main-content">
          <!-- Általános lap -->
          <div id="general-page" class="settings-page active">
            <section class="settings-container" aria-label="Általános beállítások">
              <div class="notifications-banner-stack">
                <section class="info-banner" aria-label="Információ">
                  <div class="info-banner-icon-container">
                    <img class="info-banner-icon" src="assets/general/banners/info.svg" alt="Info" />
                  </div>
                  <div class="banner-content">
                    <div class="banner-texts">
                      <span class="info-banner-title" data-translate="youhub.banners.info.title" data-translate-fallback="Ez az új dizájn.">Ez az új dizájn.</span>
                      <span class="info-banner-desc" data-translate="youhub.banners.info.description" data-translate-fallback="Reméljük neked is tetszik az Európa Dizájn Rendszer. Ha bármi kétséged van, jelezz vissza, akár innen is.">Reméljük neked is tetszik az Európa Dizájn Rendszer. Ha bármi kétséged van, jelezz vissza, akár innen is.</span>
                    </div>
                    <div class="banner-actions-wrapper">
                      <div class="banner-actions">
                        <button class="banner-btn secondary" type="button" data-translate="youhub.banners.info.feedback" data-translate-fallback="Visszajelzés">Visszajelzés</button>
                        <button class="banner-btn primary" type="button" data-translate="youhub.banners.info.close" data-translate-fallback="Bezárás">Bezárás</button>
                      </div>
                    </div>
                  </div>
                </section>
              </div>
              <div class="settings-items-container">
                <!-- Kiadás kártya -->
                <div class="settings-item">
                  <div class="settings-card-content">
                    <div class="settings-card-text">
                      <h2 data-translate="pages.settings.edition_title">Kiadás</h2>
                      <p data-translate="pages.settings.edition_desc">Válaszd ki melyik kiadását szeretnéd a Hubnak használni!</p>
                    </div>
                    <div class="settings-card-control">
                      <div class="language-dropdown" id="editionDropdown"></div>
                  </div>
                  </div>
                </div>

                <!-- Nyelv kártya -->
                <div class="settings-item">
                  <div class="settings-card-content">
                    <div class="settings-card-text">
                      <h2 data-translate="pages.settings.language_title">Nyelv</h2>
                    </div>
                    <div class="settings-card-control">
                      <div class="language-dropdown" id="languageDropdown"></div>
                    </div>
                  </div>
                </div>

                <!-- Színséma kártya -->
                <div class="settings-item">
                  <div class="settings-card-content">
                    <div class="settings-card-text">
                      <h2 data-translate="pages.settings.theme_title">Színséma</h2>
                      <p data-translate="pages.settings.theme_desc">8 alap színből tudsz választani plusz világos és sötét módból.</p>
                    </div>
                    <div class="settings-card-control">
                      <div class="settings-control-row">
                        <div class="settings-control-item">
                          <span class="settings-control-label" data-translate="pages.settings.theme_color_scheme_label">Színséma</span>
                          <div class="language-dropdown" id="colorSchemeDropdown"></div>
                        </div>
                        <div class="settings-control-item">
                          <span class="settings-control-label" data-translate="pages.settings.theme_theme_label">Téma</span>
                          <div class="language-dropdown" id="themeDropdown"></div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Névjegy kártya -->
                <div class="settings-item about-card">
                  <!-- Text konténer - cím és leírás (felülre) -->
                  <div class="about-card-text">
                    <h2 class="about-title" data-translate="pages.settings.about.title">Névjegy</h2>
                    <p class="about-description" data-translate="pages.settings.about.description">Itt láthatod a Hub verziószámát, és további érdekes, akár hasznos információkat a te Hubodról.</p>
                  </div>
                  
                  <div class="about-card-row">
                    <div class="about-card-content">
                      <div class="about-card-columns">
                        <!-- Bal oszlop - Logó kártya -->
                        <div class="about-column-left">
                          <div class="about-logo-container">
                            <img src="assets/general/eu2kHubLogo.png" alt="EU2K Hub Logo" class="about-logo">
                          </div>
                        </div>
                        
                        <!-- Középső oszlop - töltse ki a helyet -->
                        <div class="about-column-middle">
                          <div class="about-info-item">
                            <span class="about-info-label" data-translate="pages.settings.about.version_label">Verzió:</span>
                            <span class="about-info-value" id="aboutVersion">-</span>
                          </div>
                          <div class="about-info-item">
                            <span class="about-info-label" data-translate="pages.settings.about.edition_label">Kiadás:</span>
                            <span class="about-info-value" id="aboutEdition">-</span>
                          </div>
                          <div class="about-info-item">
                            <span class="about-info-label" data-translate="pages.settings.about.created_by_label">Készítette:</span>
                            <span class="about-info-value" id="aboutCreatedBy">-</span>
                          </div>
                          <div class="about-info-item">
                            <span class="about-info-label" data-translate="pages.settings.about.published_by_label">Kiadja:</span>
                            <span class="about-info-value" id="aboutPublishedBy">-</span>
                          </div>
                          <div class="about-info-item">
                            <span class="about-info-label" data-translate="pages.settings.about.maintained_by_label">Karbantartja:</span>
                            <span class="about-info-value" id="aboutMaintainedBy">-</span>
                          </div>
                        </div>
                        
                        <!-- Jobb oszlop - Haladó információk -->
                    <div class="about-column-advanced">
                      <div class="about-advanced-title" data-translate="pages.settings.about.advanced_info">Haladó információk:</div>
                      <div class="about-advanced-item">
                            <div class="about-advanced-label-wrapper">
                        <span class="about-advanced-label" data-translate="pages.settings.about.ui_name_label">Felhasználói Kezelőfelület (UI):</span>
                            </div>
                        <span class="about-advanced-value" id="aboutUIName">-</span>
                      </div>
                      <div class="about-advanced-item">
                            <div class="about-advanced-label-wrapper">
                        <span class="about-advanced-label" data-translate="pages.settings.about.ui_version_label">Felhasználói Kezelőfelület (UI) verziója:</span>
                            </div>
                        <span class="about-advanced-value" id="aboutUIVersion">-</span>
                      </div>
                      <div class="about-advanced-item">
                            <div class="about-advanced-label-wrapper">
                        <span class="about-advanced-label" data-translate="pages.settings.about.kernel_version_label">Kernel-verzió:</span>
                            </div>
                        <span class="about-advanced-value" id="aboutKernelVersion">-</span>
                      </div>
                      <div class="about-advanced-item">
                            <div class="about-advanced-label-wrapper">
                        <span class="about-advanced-label" data-translate="pages.settings.about.yhc_version_label">YouHub komponens verziója:</span>
                            </div>
                        <span class="about-advanced-value" id="aboutYHCVersion">-</span>
                      </div>
                      <div class="about-advanced-item">
                            <div class="about-advanced-label-wrapper">
                        <span class="about-advanced-label" data-translate="pages.settings.about.chc_version_label">Class Hub komponens verziója:</span>
                            </div>
                        <span class="about-advanced-value" id="aboutCHCVersion">-</span>
                      </div>
                      <div class="about-advanced-item">
                            <div class="about-advanced-label-wrapper">
                        <span class="about-advanced-label" data-translate="pages.settings.about.fihc_version_label">Fitness Hub komponens verziója:</span>
                            </div>
                        <span class="about-advanced-value" id="aboutFIHCVersion">-</span>
                      </div>
                      <div class="about-advanced-item">
                            <div class="about-advanced-label-wrapper">
                        <span class="about-advanced-label" data-translate="pages.settings.about.fohc_version_label">Food Hub komponens verziója:</span>
                            </div>
                        <span class="about-advanced-value" id="aboutFOHCVersion">-</span>
                      </div>
                      <div class="about-advanced-item">
                            <div class="about-advanced-label-wrapper">
                        <span class="about-advanced-label" data-translate="pages.settings.about.ehc_version_label">Event Hub komponens verziója:</span>
                            </div>
                        <span class="about-advanced-value" id="aboutEHCVersion">-</span>
                      </div>
                      <div class="about-advanced-item">
                            <div class="about-advanced-label-wrapper">
                        <span class="about-advanced-label" data-translate="pages.settings.about.eu2k_suite_label">EU2K Suite</span>
                            </div>
                        <span class="about-advanced-value" id="aboutEU2KSuite">-</span>
                      </div>
                    </div>
                  </div>
                    </div>
                  </div>
                </div>
                </div>
          </section>
          </div>

          <!-- Értesítések & Hang lap -->
          <div id="notifications-page" class="settings-page" style="display: none;">
            <section class="settings-container" aria-label="Értesítések és hang beállítások">
              <!-- Felső bannerek -->
              <div class="notifications-banner-stack">
                <section class="info-banner" aria-label="Információ">
                  <div class="info-banner-icon-container">
                    <img class="info-banner-icon" src="assets/general/banners/info.svg" alt="Info" />
                  </div>
                  <div class="banner-content">
                    <div class="banner-texts">
                      <span class="info-banner-title" data-translate="youhub.banners.info.title" data-translate-fallback="Ez az új dizájn.">Ez az új dizájn.</span>
                      <span class="info-banner-desc" data-translate="youhub.banners.info.description" data-translate-fallback="Reméljük neked is tetszik az Európa Dizájn Rendszer. Ha bármi kétséged van, jelezz vissza, akár innen is.">Reméljük neked is tetszik az Európa Dizájn Rendszer. Ha bármi kétséged van, jelezz vissza, akár innen is.</span>
                    </div>
                    <div class="banner-actions-wrapper">
                      <div class="banner-actions">
                        <button class="banner-btn secondary" type="button" data-translate="youhub.banners.info.feedback" data-translate-fallback="Visszajelzés">Visszajelzés</button>
                        <button class="banner-btn primary" type="button" data-translate="youhub.banners.info.close" data-translate-fallback="Bezárás">Bezárás</button>
                      </div>
                    </div>
                  </div>
                </section>

                <!-- Csendes mód banner  -->
                  <section class="info-banner notifications-silent-banner is-hidden" aria-label="Csendes mód">
                    <div class="info-banner-icon-container">
                      <img class="info-banner-icon" src="assets/general/banners/info.svg" alt="Info" />
                    </div>
                    <div class="banner-content">
                      <div class="banner-texts">
                        <span class="info-banner-title" data-translate="silent_mode_title" data-translate-fallback="Csendes mód">Csendes mód</span>
                        <span class="info-banner-desc" data-translate="silent_mode_desc" data-translate-fallback="Ameddig a suliban vagy nem fogja hang követni az értesítéseket.">Ameddig a suliban vagy nem fogja hang követni az értesítéseket.</span>
                      </div>
                      <div class="banner-actions-wrapper">
                        <div class="banner-actions">
                          <button class="banner-btn secondary" id="notificationsSilentEnableSoundBtn" type="button" data-translate="turn_on_sound" data-translate-fallback="Hang bekapcsolása">Hang bekapcsolása</button>
                          <button class="banner-btn primary" id="notificationsSilentCloseBtn" type="button" data-translate="youhub.banners.info.close" data-translate-fallback="Bezárás">Bezárás</button>
                        </div>
                      </div>
                    </div>
                  </section>
              </div>

              <!-- Kártyák konténer -->
              <div class="settings-items-container notifications-settings-stack">
                <!-- Hangok + Értesítő hang konténer -->
                <div class="notifications-group">
                  <!-- Hangok kártya -->
                  <div class="settings-item notifications-card">
                    <div class="settings-card-content">
                      <div class="settings-card-text">
                        <h2 data-translate="sounds_title" data-translate-fallback="Hangok">Hangok</h2>
                      </div>
                      <div class="settings-card-control">
                        <md-switch class="settings-switch" icons id="notificationsSoundsSwitch" aria-label="Hangok"></md-switch>
                      </div>
                    </div>
                  </div>

                  <!-- Helyzetalapú némítás kártya -->
                  <div class="settings-item notifications-card">
                    <div class="settings-card-content">
                      <div class="settings-card-text">
                        <h2 data-translate="location_mute_title" data-translate-fallback="Helyzetalapú némítás">Helyzetalapú némítás</h2>
                      </div>
                      <div class="settings-card-control">
                        <md-switch class="settings-switch" icons id="notificationsLocationMuteSwitch" aria-label="Helyzetalapú némítás"></md-switch>
                      </div>
                    </div>
                  </div>

                  <!-- Értesítő hang kártya -->
                  <div class="settings-item notifications-card">
                    <div class="settings-card-content">
                      <div class="settings-card-text">
                        <h2 data-translate="notification_sound_title"
                            data-translate-fallback="Értesítő hang">
                          Értesítő hang
                        </h2>
                      </div>
                      <div class="settings-card-control">
                        <div class="language-dropdown" id="notificationSoundDropdown"></div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Push értesítések – egy nagy kártya -->
                <div class="settings-item notifications-card-big">
                  <div class="settings-card-content notifications-sort-card">
                    <div class="settings-card-text">
                      <h2 data-translate="push_notifications_title"
                          data-translate-fallback="Push Értesítések">
                        Push Értesítések
                      </h2>
                      <p data-translate="push_notifications_desc"
                         data-translate-fallback="A Push Értesítések a képernyőd jobb sarkában megjelenő, gyors, nyomásszerű értesítések.">
                        A Push Értesítések a képernyőd jobb sarkában megjelenő, gyors, nyomásszerű értesítések.
                      </p>
                    </div>
                    <div class="settings-card-control notifications-sort-control">
                      <div class="notifications-sort-control-column">
                        <div class="notifications-sort-row">
                          <span class="notifications-sort-label"
                                data-translate="sort_label"
                                data-translate-fallback="Rendezés">
                            Rendezés
                          </span>
                          <div class="language-dropdown" id="pushSortDropdown"></div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Push értesítési csatornák listája ugyanebben a kártyában -->
                  <div class="notifications-channels-card">
                    <div class="notifications-channels-list" id="pushNotificationsChannels">
                      <div class="notifications-toggle-row" data-channel-key="news">
                        <span class="notifications-toggle-label"
                              data-translate="news_label"
                              data-translate-fallback="Hírek">
                          Hírek
                        </span>
                        <md-switch class="settings-switch" icons id="notifNewsSwitch" aria-label="Hírek"></md-switch>
                      </div>
                      <div class="notifications-toggle-row" data-channel-key="events">
                        <span class="notifications-toggle-label"
                              data-translate="events_label"
                              data-translate-fallback="Események &amp; Event Hub">
                          Események &amp; Event Hub
                        </span>
                        <md-switch class="settings-switch" icons id="notifEventsSwitch" aria-label="Események &amp; Event Hub"></md-switch>
                      </div>
                      <div class="notifications-toggle-row" data-channel-key="messages">
                        <span class="notifications-toggle-label"
                              data-translate="messages_label"
                              data-translate-fallback="Üzenetek">
                          Üzenetek
                        </span>
                        <md-switch class="settings-switch" icons id="notifMessagesSwitch" aria-label="Üzenetek" disabled></md-switch>
                      </div>
                      <div class="notifications-toggle-row" data-channel-key="posts">
                        <span class="notifications-toggle-label"
                              data-translate="posts_label"
                              data-translate-fallback="Posztok">
                          Posztok
                        </span>
                        <md-switch class="settings-switch" icons id="notifPostsSwitch" aria-label="Posztok" disabled></md-switch>
                      </div>
                      <div class="notifications-toggle-row" data-channel-key="invites">
                        <span class="notifications-toggle-label"
                              data-translate="invites_label"
                              data-translate-fallback="Meghívók">
                          Meghívók
                        </span>
                        <md-switch class="settings-switch" icons id="notifInvitesSwitch" aria-label="Meghívók" disabled></md-switch>
                      </div>
                      <div class="notifications-toggle-row" data-channel-key="new-things">
                        <span class="notifications-toggle-label"
                              data-translate="new_things_label"
                              data-translate-fallback="Újdonságok">
                          Újdonságok
                        </span>
                        <md-switch class="settings-switch" icons id="notifNewThingsSwitch" aria-label="Újdonságok"></md-switch>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Felugró értesítések – egy nagy kártya -->
                <div class="settings-item notifications-card-big">
                  <div class="settings-card-content notifications-sort-card">
                    <div class="settings-card-text">
                      <h2 data-translate="popup_notifications_title"
                          data-translate-fallback="Felugró értesítések">
                        Felugró értesítések
                      </h2>
                    </div>
                    <div class="settings-card-control notifications-sort-control">
                      <div class="notifications-sort-control-column">
                        <div class="notifications-sort-row">
                          <span class="notifications-sort-label"
                                data-translate="sort_label"
                                data-translate-fallback="Rendezés">
                            Rendezés
                          </span>
                          <div class="language-dropdown" id="popupSortDropdown"></div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Felugró értesítési csatornák listája ugyanebben a kártyában -->
                  <div class="notifications-channels-card">
                    <div class="notifications-channels-list" id="popupNotificationsChannels">
                      <div class="notifications-toggle-row" data-channel-key="event-hub-popup">
                        <span class="notifications-toggle-label"
                              data-translate="event_hub_popup_label"
                              data-translate-fallback="Event Hub">
                          Event Hub
                        </span>
                        <md-switch class="settings-switch" icons id="notifEventHubPopupSwitch" aria-label="Event Hub" disabled></md-switch>
                      </div>
                      <div class="notifications-toggle-row" data-channel-key="new-things-popup">
                        <span class="notifications-toggle-label"
                              data-translate="new_things_popup_label"
                              data-translate-fallback="Újdonságok">
                          Újdonságok
                        </span>
                        <md-switch class="settings-switch" icons id="notifNewThingsPopupSwitch" aria-label="Újdonságok"></md-switch>
                      </div>
                      <div class="notifications-toggle-row" data-channel-key="beta-popup">
                        <span class="notifications-toggle-label"
                              data-translate="beta_popup_label"
                              data-translate-fallback="Bétaverzió">
                          Bétaverzió
                        </span>
                        <md-switch class="settings-switch" icons id="notifBetaPopupSwitch" aria-label="Bétaverzió"></md-switch>
                      </div>
                      <div class="notifications-toggle-row" data-channel-key="popups-popup">
                        <span class="notifications-toggle-label"
                              data-translate="popups_popup_label"
                              data-translate-fallback="Felugró Ablakok">
                          Felugró Ablakok
                        </span>
                        <md-switch class="settings-switch" icons id="notifPopupsPopupSwitch" aria-label="Felugró Ablakok"></md-switch>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </section>
            </div>

          <!-- Funkciók lap -->
          <div id="functions-page" class="settings-page" style="display: none;">
            <section class="settings-container">
              <div class="notifications-banner-stack">
                <section class="info-banner" aria-label="Információ">
                  <div class="info-banner-icon-container">
                    <img class="info-banner-icon" src="assets/general/banners/info.svg" alt="Info" />
                  </div>
                  <div class="banner-content">
                    <div class="banner-texts">
                      <span class="info-banner-title" data-translate="youhub.banners.info.title" data-translate-fallback="Ez az új dizájn.">Ez az új dizájn.</span>
                      <span class="info-banner-desc" data-translate="youhub.banners.info.description" data-translate-fallback="Reméljük neked is tetszik az Európa Dizájn Rendszer. Ha bármi kétséged van, jelezz vissza, akár innen is.">Reméljük neked is tetszik az Európa Dizájn Rendszer. Ha bármi kétséged van, jelezz vissza, akár innen is.</span>
                    </div>
                    <div class="banner-actions-wrapper">
                      <div class="banner-actions">
                        <button class="banner-btn secondary" type="button" data-translate="youhub.banners.info.feedback" data-translate-fallback="Visszajelzés">Visszajelzés</button>
                        <button class="banner-btn primary" type="button" data-translate="youhub.banners.info.close" data-translate-fallback="Bezárás">Bezárás</button>
                      </div>
                    </div>
                  </div>
                </section>
              </div>
              <div class="settings-item notifications-card">
                <div class="settings-card-content">
                  <div class="settings-card-text">
                    <h2 data-translate="pages.settings.functions.descriptive_texts_title" data-translate-fallback="Leíró szövegek">Leíró szövegek</h2>
                  </div>
                  <div class="settings-card-control">
                    <div class="language-dropdown" id="descriptiveTextsDropdown" data-dropdown-disabled="true">
                      <button class="language-dropdown-trigger single-item" type="button" aria-haspopup="true" aria-expanded="false" style="opacity: 0.65; pointer-events: none;">
                        <span class="language-dropdown-text" data-translate="pages.settings.functions.descriptive_texts_default" data-translate-fallback="Alapértelmezett">Alapértelmezett</span>
                        <img class="language-dropdown-icon" src="assets/general/components/arrow_down.svg" alt="Dropdown">
                      </button>
                      <div class="language-dropdown-menu" role="menu">
                        <div class="language-dropdown-menu-wrapper">
                          <button class="language-dropdown-item" role="menuitem" data-index="0">
                            <div class="language-dropdown-item-content" data-translate="pages.settings.functions.descriptive_texts_default" data-translate-fallback="Alapértelmezett">Alapértelmezett</div>
                          </button>
                          <button class="language-dropdown-item" role="menuitem" data-index="1">
                            <div class="language-dropdown-item-content" data-translate="pages.settings.functions.descriptive_texts_reduced" data-translate-fallback="Csökkentett">Csökkentett</div>
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </section>
          </div>

          <!-- Lapok lap -->
          <div id="pages-page" class="settings-page" style="display: none;">
            <section class="settings-container">
              <div class="notifications-banner-stack">
                <section class="info-banner" aria-label="Információ">
                  <div class="info-banner-icon-container">
                    <img class="info-banner-icon" src="assets/general/banners/info.svg" alt="Info" />
                  </div>
                  <div class="banner-content">
                    <div class="banner-texts">
                      <span class="info-banner-title" data-translate="youhub.banners.info.title" data-translate-fallback="Ez az új dizájn.">Ez az új dizájn.</span>
                      <span class="info-banner-desc" data-translate="youhub.banners.info.description" data-translate-fallback="Reméljük neked is tetszik az Európa Dizájn Rendszer. Ha bármi kétséged van, jelezz vissza, akár innen is.">Reméljük neked is tetszik az Európa Dizájn Rendszer. Ha bármi kétséged van, jelezz vissza, akár innen is.</span>
                    </div>
                    <div class="banner-actions-wrapper">
                      <div class="banner-actions">
                        <button class="banner-btn secondary" type="button" data-translate="youhub.banners.info.feedback" data-translate-fallback="Visszajelzés">Visszajelzés</button>
                        <button class="banner-btn primary" type="button" data-translate="youhub.banners.info.close" data-translate-fallback="Bezárás">Bezárás</button>
                      </div>
                    </div>
                  </div>
                </section>
              </div>
              <!-- Pages konténerek wrapper -->
              <div class="pages-containers-wrapper">
                <!-- Otthon konténer -->
                <div class="pages-container">
                  <h2 class="pages-container-title" data-translate="pages.settings.pages.home_title" data-translate-fallback="Otthon">Otthon</h2>
                  <div class="settings-item notifications-card">
                    <div class="settings-card-content">
                      <div class="settings-card-text">
                        <h2 data-translate="pages.settings.pages.layout_title" data-translate-fallback="Elrendezés">Elrendezés</h2>
                      </div>
                      <div class="settings-card-control">
                        <div class="language-dropdown" id="homeLayoutDropdown">
                          <button class="language-dropdown-trigger single-item" type="button" aria-haspopup="true" aria-expanded="false" style="opacity: 0.5; pointer-events: none;">
                            <span class="language-dropdown-text" data-translate="pages.settings.pages.layout_default" data-translate-fallback="Alapértelmezett">Alapértelmezett</span>
                            <img class="language-dropdown-icon" src="assets/general/components/arrow_down.svg" alt="Dropdown">
                          </button>
                          <div class="language-dropdown-menu" role="menu">
                            <div class="language-dropdown-menu-wrapper">
                              <button class="language-dropdown-item" role="menuitem" data-index="0">
                                <div class="language-dropdown-item-content" data-translate="pages.settings.pages.layout_default" data-translate-fallback="Alapértelmezett">Alapértelmezett</div>
                              </button>
                              <button class="language-dropdown-item" role="menuitem" data-index="1">
                                <div class="language-dropdown-item-content" data-translate="pages.settings.pages.layout_custom" data-translate-fallback="Egyéni">Egyéni</div>
                              </button>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- YouHub konténer -->
                <div class="pages-container pages-container-with-border">
                  <h2 class="pages-container-title" data-translate="pages.settings.pages.youhub_title" data-translate-fallback="YouHub">YouHub</h2>
                  <!-- YouHub kártyák konténer -->
                  <div class="youhub-cards-container">
                    <!-- Elrendezés visszaállítása -->
                    <div class="settings-item notifications-card">
                      <div class="settings-card-content">
                        <div class="settings-card-text">
                          <h2 data-translate="pages.settings.pages.reset_layout_title" data-translate-fallback="Elrendezés visszaállítása">Elrendezés visszaállítása</h2>
                        </div>
                        <div class="settings-card-control">
                          <button class="youhub-revert-btn" id="settingsRevertBtn" type="button">
                            <span class="youhub-revert-text" data-translate="pages.settings.pages.reset_button" data-translate-fallback="Visszaállítás">Visszaállítás</span>
                          </button>
                        </div>
                      </div>
                    </div>
                    <!-- Egyéni kártyák -->
                    <div class="settings-item notifications-card">
                      <div class="settings-card-content">
                        <div class="settings-card-text">
                          <h2 data-translate="pages.settings.pages.custom_cards_title" data-translate-fallback="Egyéni kártyák">Egyéni kártyák</h2>
                        </div>
                        <div class="settings-card-control">
                          <button class="youhub-revert-btn" id="settingsCustomCardsBtn" type="button" disabled>
                            <span class="youhub-revert-text" data-translate="pages.settings.pages.view_button" data-translate-fallback="Megtekintés">Megtekintés</span>
                          </button>
                        </div>
                      </div>
                    </div>
                    <!-- Dátumformátum -->
                    <div class="settings-item notifications-card">
                      <div class="settings-card-content">
                        <div class="settings-card-text">
                          <h2 data-translate="pages.settings.pages.date_format_title" data-translate-fallback="Dátumformátum">Dátumformátum</h2>
                        </div>
                        <div class="settings-card-control">
                          <div class="language-dropdown" id="dateFormatDropdown">
                            <button class="language-dropdown-trigger single-item" type="button" aria-haspopup="true" aria-expanded="false" style="opacity: 0.5; pointer-events: none;">
                              <span class="language-dropdown-text" data-translate="pages.settings.pages.date_format_yyyy_mm_dd" data-translate-fallback="éééé.hh.nn">éééé.hh.nn</span>
                              <img class="language-dropdown-icon" src="assets/general/components/arrow_down.svg" alt="Dropdown">
                            </button>
                            <div class="language-dropdown-menu" role="menu">
                              <div class="language-dropdown-menu-wrapper">
                                <button class="language-dropdown-item" role="menuitem" data-index="0">
                                  <div class="language-dropdown-item-content" data-translate="pages.settings.pages.date_format_yyyy_mm_dd" data-translate-fallback="éééé.hh.nn">éééé.hh.nn</div>
                                </button>
                                <button class="language-dropdown-item" role="menuitem" data-index="1">
                                  <div class="language-dropdown-item-content" data-translate="pages.settings.pages.date_format_yyyy_dd_mm" data-translate-fallback="éééé.nn.hh">éééé.nn.hh</div>
                                </button>
                                <button class="language-dropdown-item" role="menuitem" data-index="2">
                                  <div class="language-dropdown-item-content" data-translate="pages.settings.pages.date_format_mm_yyyy_dd" data-translate-fallback="hh.éééé.nn">hh.éééé.nn</div>
                                </button>
                                <button class="language-dropdown-item" role="menuitem" data-index="3">
                                  <div class="language-dropdown-item-content" data-translate="pages.settings.pages.date_format_mm_dd_yyyy" data-translate-fallback="hh.nn.éééé">hh.nn.éééé</div>
                                </button>
                                <button class="language-dropdown-item" role="menuitem" data-index="4">
                                  <div class="language-dropdown-item-content" data-translate="pages.settings.pages.date_format_dd_mm_yyyy" data-translate-fallback="nn.hh.éééé">nn.hh.éééé</div>
                                </button>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </section>
          </div>

          <!-- Csevegés lap -->
          <div id="chat-page" class="settings-page" style="display: none;">
            <section class="settings-container">
              <div class="notifications-banner-stack">
                <section class="info-banner" aria-label="Információ">
                  <div class="info-banner-icon-container">
                    <img class="info-banner-icon" src="assets/general/banners/info.svg" alt="Info" />
                  </div>
                  <div class="banner-content">
                    <div class="banner-texts">
                      <span class="info-banner-title" data-translate="youhub.banners.info.title" data-translate-fallback="Ez az új dizájn.">Ez az új dizájn.</span>
                      <span class="info-banner-desc" data-translate="youhub.banners.info.description" data-translate-fallback="Reméljük neked is tetszik az Európa Dizájn Rendszer. Ha bármi kétséged van, jelezz vissza, akár innen is.">Reméljük neked is tetszik az Európa Dizájn Rendszer. Ha bármi kétséged van, jelezz vissza, akár innen is.</span>
                    </div>
                    <div class="banner-actions-wrapper">
                      <div class="banner-actions">
                        <button class="banner-btn secondary" type="button" data-translate="youhub.banners.info.feedback" data-translate-fallback="Visszajelzés">Visszajelzés</button>
                        <button class="banner-btn primary" type="button" data-translate="youhub.banners.info.close" data-translate-fallback="Bezárás">Bezárás</button>
                      </div>
                    </div>
                  </div>
                </section>
              </div>
              <p data-translate="pages.settings.chat">Csevegés beállítások (később)</p>
            </section>
          </div>

          <!-- Kreditek és Jogi Infók lap -->
          <div id="credits-page" class="settings-page" style="display: none;">
            <section class="settings-container">
              <div class="notifications-banner-stack">
                <section class="info-banner" aria-label="Információ">
                  <div class="info-banner-icon-container">
                    <img class="info-banner-icon" src="assets/general/banners/info.svg" alt="Info" />
                  </div>
                  <div class="banner-content">
                    <div class="banner-texts">
                      <span class="info-banner-title" data-translate="youhub.banners.info.title" data-translate-fallback="Ez az új dizájn.">Ez az új dizájn.</span>
                      <span class="info-banner-desc" data-translate="youhub.banners.info.description" data-translate-fallback="Reméljük neked is tetszik az Európa Dizájn Rendszer. Ha bármi kétséged van, jelezz vissza, akár innen is.">Reméljük neked is tetszik az Európa Dizájn Rendszer. Ha bármi kétséged van, jelezz vissza, akár innen is.</span>
                    </div>
                    <div class="banner-actions-wrapper">
                      <div class="banner-actions">
                        <button class="banner-btn secondary" type="button" data-translate="youhub.banners.info.feedback" data-translate-fallback="Visszajelzés">Visszajelzés</button>
                        <button class="banner-btn primary" type="button" data-translate="youhub.banners.info.close" data-translate-fallback="Bezárás">Bezárás</button>
                      </div>
                    </div>
                  </div>
                </section>
              </div>
              <p data-translate="pages.settings.credits">Kreditek és Jogi Infók (később)</p>
            </section>
          </div>

          <!-- Csendes mód warning popup -->
          <div id="silentModeWarningPopup" class="permission-overlay-scroll-area" style="display: none;">
            <div class="permission-container">
              <button class="permission-close-btn" id="silentModeWarningCloseBtn">
                <img src="assets/general/close.svg" alt="Bezárás">
              </button>
              <div class="permission-content">
                <img src="assets/general/warning.svg" class="permission-icon-large" alt="Figyelmeztetés">
                <h2 class="permission-title" data-translate="silent_mode_popup_title" data-translate-fallback="Csendes mód">Csendes mód</h2>
                <p class="permission-text" data-translate="silent_mode_popup_desc" data-translate-fallback="Ezzel a gombbal kikapcsolhatod a csendes módot mára.\n\nÚgy tűnik, iskolai időben vagy, ezért az értesítések zavaróak lehetnek.\n\nHa mégis kikapcsolod, érdemes az eszközt lenémítani az órák alatt.">
                  Ezzel a gombbal kikapcsolhatod a csendes módot mára.

                  Úgy tűnik, iskolai időben vagy, ezért az értesítések zavaróak lehetnek.

                  Ha mégis kikapcsolod, érdemes az eszközt lenémítani az órák alatt.
                </p>
                <button class="permission-ok-btn" id="silentModeWarningConfirmBtn" data-translate="silent_mode_popup_confirm" data-translate-fallback="Csendes mód kikapcsolása mára">Csendes mód kikapcsolása mára</button>
              </div>
            </div>
          </div>

          <!-- Revert Popup -->
          <div id="revertPopup" class="permission-overlay-scroll-area" style="display: none;">
            <div class="permission-container">
              <button class="permission-close-btn" onclick="closeRevertPopup()">
                <img src="assets/general/close.svg" alt="Bezárás">
              </button>
              <div class="permission-content">
                <img src="assets/youhub/calendar/nothing_seems_to_be_here.svg" class="permission-icon-large" alt="Visszaállítás">
                <h2 class="permission-title" data-translate="youhub.revert.title" data-translate-fallback="Biztos visszaállítod a sorrendet?">Biztos visszaállítod a sorrendet?</h2>
                <p class="permission-text" data-translate="youhub.revert.text" data-translate-fallback="Ezzel a mostani elrendezésed elveszik, vissza kell állítanod manuálisan!">Ezzel a mostani elrendezésed elveszik, vissza kell állítanod manuálisan!</p>
                <button class="permission-ok-btn" onclick="confirmRevert()" data-translate="youhub.revert.button" data-translate-fallback="Visszaállítás">Visszaállítás</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Footer -->
        <footer class="site-footer">
          <div class="footer-left">
            <div class="footer-logo-container">
              <img src="assets/general/footer/eu2k_hub.png" alt="EU2K Hub">
              <span class="footer-participated-text" data-translate="footer.participated">Részt vett még:</span>
              <div class="footer-participated-logos">
                <img src="assets/general/footer/eu2k.png" alt="EU2K">
                <img src="assets/general/footer/eu2k_devs.png" alt="EU2K Devs">
                <img src="assets/general/footer/eu2k_dok.png" alt="EU2K Dok">
                <img src="assets/general/footer/eu2k_ujsag.png" alt="EU2K Újság">
              </div>
            </div>
            <div class="footer-copyright" data-translate="footer.copyright">
              © 2025 EU2K Devs és Európa 2000 Gimnázium. Minden jog fenntartva.
            </div>
            <div class="footer-social">
              <img src="assets/general/footer/eu2k_ujsag.svg" alt="EU2K Újság" onclick="window.open('https://sites.google.com/view/eu2k-ujsag', '_blank')">
              <img src="assets/general/footer/x.svg" alt="X (Twitter)" onclick="window.open('https://x.com/eu2kdevs', '_blank')">
              <img src="assets/general/footer/instagram.svg" alt="Instagram" onclick="window.open('https://instagram.com/eu2k.devs', '_blank')">
              <img src="assets/general/footer/yt.svg" alt="YouTube" onclick="window.open('https://youtube.com/@eu2kdevs', '_blank')">
            </div>
          </div>
          <div class="footer-right">
            <div class="footer-section-first">
              <div class="footer-section-title" data-translate="footer.legal.title">Jogi Nyilatkozatok</div>
              <div class="footer-section-items">
                <a href="privacy-policy.html" class="footer-item" data-translate="footer.legal.privacy">Adatvédelmi&nbsp;Tájékoztató</a>
                <a href="terms-of-service.html" class="footer-item" data-translate="footer.legal.terms">Használati&nbsp;Feltételek</a>
              </div>
            </div>
            <div class="footer-section">
              <div class="footer-section-title" data-translate="footer.hubs.title">Hubok</div>
              <div class="footer-section-items">
                <a href="youhub.html" class="footer-item">YouHub</a>
                <div class="footer-item">Class&nbsp;Hub<span class="beta-badge" data-translate="footer.hubs.soon" data-translate-fallback="SOON">SOON</span></div>
                <div class="footer-item">Food&nbsp;Hub<span class="beta-badge" data-translate="footer.hubs.soon" data-translate-fallback="SOON">SOON</span></div>
                <div class="footer-item">Event&nbsp;Hub<span class="beta-badge" data-translate="footer.hubs.soon" data-translate-fallback="SOON">SOON</span></div>
                <div class="footer-item">Fitness&nbsp;Hub<span class="beta-badge" data-translate="footer.hubs.soon" data-translate-fallback="SOON">SOON</span></div>
              </div>
            </div>
          </div>
        </footer>
      </div>
    </main>
  </div>

  <script src="assets/js/navigation-state.js"></script>
  <script src="assets/js/footer.js"></script>
  <script src="assets/js/consent-banner.js"></script>
  <script>
    // Indítjuk a fordítási rendszert, ha még nem fut
    document.addEventListener('DOMContentLoaded', () => {
      if (window.translationManager && !window.translationManager.isInitialized) {
        try {
          window.translationManager.init?.();
        } catch (e) {
          console.error('[Settings] translationManager.init hiba:', e);
        }
      }
      // Biztonsági alkalmazás induláskor
      if (window.translationManager && window.translationManager.applyTranslations) {
        try {
          window.translationManager.applyTranslations();
          // Külön ellenőrizzük a navbar elemeket, hogy biztosan leforduljanak
          setTimeout(() => {
            const functionsLabel = document.querySelector('[data-translate="pages.settings.functions"]');
            const pagesLabel = document.querySelector('[data-translate="pages.settings.pages"]');
            if (functionsLabel && window.translationManager) {
              const functionsText = window.translationManager.getTranslation('pages.settings.functions');
              if (functionsText) functionsLabel.textContent = functionsText;
            }
            if (pagesLabel && window.translationManager) {
              const pagesText = window.translationManager.getTranslation('pages.settings.pages');
              if (pagesText) pagesLabel.textContent = pagesText;
            }
          }, 50);
        } catch (e) {
          console.error('[Settings] applyTranslations hiba induláskor:', e);
        }
      }
    });

    // Settings navigáció és funkcionalitás
    document.addEventListener('DOMContentLoaded', () => {
      // Hash-alapú navigáció
      function showPage(pageId) {
        // Elrejtjük az összes lapot
        document.querySelectorAll('.settings-page').forEach(page => {
          page.style.display = 'none';
          page.classList.remove('active');
        });
        
        // Megjelenítjük a kiválasztott lapot
        const targetPage = document.getElementById(pageId + '-page');
        if (targetPage) {
          targetPage.style.display = 'block';
          targetPage.classList.add('active');
          
          // Újra alkalmazzuk a fordításokat az új oldal elemeire
          if (window.translationManager && window.translationManager.applyTranslations) {
            // Kicsit késleltetjük, hogy biztosan látható legyen az oldal
            setTimeout(() => {
              try {
                // Csak az aktuális oldal elemeire alkalmazzuk
                targetPage.querySelectorAll('[data-translate]').forEach(element => {
                  const key = element.getAttribute('data-translate');
                  const fallback = element.getAttribute('data-translate-fallback') || element.textContent;
                  const translation = window.translationManager.getTranslation(key);
                  
                  if (translation) {
                    element.textContent = translation;
                  } else if (fallback) {
                    element.textContent = fallback;
                  }
                });
                
                // HTML-t tartalmazó elemek
                targetPage.querySelectorAll('[data-translate-html]').forEach(element => {
                  const key = element.getAttribute('data-translate-html');
                  const fallback = element.getAttribute('data-translate-fallback') || element.innerHTML;
                  const translation = window.translationManager.getTranslation(key);
                  
                  if (translation) {
                    element.innerHTML = translation;
                  } else if (fallback) {
                    element.innerHTML = fallback;
                  }
                });
              } catch (e) {
                console.error('[Settings] Error applying translations to page:', e);
              }
            }, 50);
          }
        }
        
        // Frissítjük a header ikont és szövegét a lap alapján
        const pageIconMap = {
          'general': 'assets/navbar/general.svg',
          'notifications': 'assets/navbar/notifications.svg',
          'functions': 'assets/navbar/functions.svg',
          'pages': 'assets/navbar/pages.svg',
          'chat': 'assets/navbar/messages.svg',
          'credits': 'assets/navbar/credits.svg'
        };
        const pageNameMap = {
          'general': 'Általános',
          'notifications': 'Értesítések & Hang',
          'functions': 'Funkciók',
          'pages': 'Lapok',
          'chat': 'Csevegés',
          'credits': 'Kreditek és Jogi Infók'
        };
        const pageIcon = document.getElementById('settingsPageIcon');
        const pageTitle = document.getElementById('settingsPageTitle');
        if (pageIcon && pageIconMap[pageId]) {
          pageIcon.src = pageIconMap[pageId];
        }
        if (pageTitle && pageNameMap[pageId]) {
          // Minden nyelven: "Beállítások - Általános" / "Settings - General" stb.
          const updatePageTitle = () => {
            const title = window.translationManager?.getTranslation('pages.settings.title') || 'Beállítások';
            const pageName = window.translationManager?.getTranslation(`pages.settings.${pageId}`) || pageNameMap[pageId];
            pageTitle.textContent = `${title} - ${pageName}`;
          };
          updatePageTitle();
          // Frissítjük nyelvváltáskor is
          if (window.translationManager) {
            const originalOnLanguageChange = window.translationManager.onLanguageChange;
            window.translationManager.onLanguageChange = () => {
              if (originalOnLanguageChange) originalOnLanguageChange();
              updatePageTitle();
            };
          }
        }
        
        // Frissítjük a navigációs elemeket
        document.querySelectorAll('.nav-btn').forEach(btn => {
          btn.classList.remove('is-active');
          const icon = btn.querySelector('.rail-icon img');
          if (icon) {
            const baseName = icon.src.split('/').pop().replace('.svg', '');
            icon.src = `assets/navbar/${baseName}.svg`;
          }
        });
        
        const activeBtn = document.querySelector(`[data-page="${pageId}"]`);
        if (activeBtn) {
          activeBtn.classList.add('is-active');
          const icon = activeBtn.querySelector('.rail-icon img');
          if (icon) {
            const baseName = icon.src.split('/').pop().replace('.svg', '');
            icon.src = `assets/navbar/filled/${baseName}.svg`;
          }
        }
      }
      
      // Hash változás kezelése
      function handleHashChange() {
        const hash = window.location.hash.substring(1) || 'general';
        showPage(hash);
      }
      
      window.addEventListener('hashchange', handleHashChange);
      handleHashChange();
      
      // Navigációs gombok
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          const pageId = btn.getAttribute('data-page');
          window.location.hash = pageId;
        });
      });
      
      // Vissza gomb
      const backBtn = document.getElementById('settingsBackBtn');
      const backBtnText = document.getElementById('settingsBackBtnText');
      
      function updateBackButton() {
        console.log('[Settings] 🔄 updateBackButton called');
        // Először próbáljuk meg a NavigationState-ből (sessionStorage)
        let referrerPath = null;
        
        // Próbáljuk meg sessionStorage-ból közvetlenül (navigation-state.js nélkül is működjön)
        try {
          const storedPath = sessionStorage.getItem('eu2k_navigation_from');
          console.log('[Settings] 📦 Stored path from sessionStorage:', storedPath);
          if (storedPath) {
            referrerPath = storedPath;
          }
        } catch (e) {
          console.warn('[Settings] Could not read from sessionStorage:', e);
        }
        
        if (window.NavigationState) {
          console.log('[Settings] 🧭 NavigationState available, getting state...');
          referrerPath = window.NavigationState.get();
          console.log('[Settings] 🧭 NavigationState returned:', referrerPath);
        } else {
          console.warn('[Settings] ⚠️ NavigationState not available!');
        }
        
        // Ha nincs sessionStorage-ban, próbáljuk az URL paraméterből
        if (!referrerPath) {
          const urlParams = new URLSearchParams(window.location.search);
          const fromParam = urlParams.get('from');
          console.log('[Settings] 🔗 From URL param:', fromParam);
          referrerPath = fromParam;
        }
        
        // Ha nincs from paraméter, próbáljuk a referrer-t
        if (!referrerPath) {
          const referrer = document.referrer;
          console.log('[Settings] 🔗 Document referrer:', referrer);
          if (referrer) {
            try {
              const referrerUrl = new URL(referrer);
              referrerPath = referrerUrl.pathname;
              console.log('[Settings] 🔗 Referrer pathname:', referrerPath);
              // Ha a referrer a settings.html-re mutat, akkor valószínűleg nyelvváltoztatás után vagyunk
              // Ilyenkor ne használjuk, hanem a sessionStorage-ból kell jönnie
              if (referrerPath.includes('settings.html')) {
                console.log('[Settings] ⚠️ Referrer is settings.html, ignoring');
                referrerPath = null;
              }
            } catch (e) {
              referrerPath = referrer;
              console.log('[Settings] 🔗 Referrer (raw):', referrerPath);
            }
          }
        }
        
        // Ha még mindig nincs, akkor a főoldalról jöttünk
        if (!referrerPath || referrerPath === '' || referrerPath === '/' || referrerPath === '/index' || referrerPath === '/index.html') {
          referrerPath = '/index.html';
          console.log('[Settings] 🏠 Defaulting to index.html');
        }
        
        // Normalizáljuk a path-ot - eltávolítjuk az /EU2K-Hub/ prefixet ha van
        referrerPath = referrerPath.replace(/^\/EU2K-Hub/, '').replace(/^\/+/, '/').replace(/\/+$/, '');
        if (referrerPath === '/' || referrerPath === '') {
          referrerPath = '/index.html';
        }
        
        console.log('[Settings] ✅ Final referrerPath:', referrerPath);
        
        // Elmentjük a sessionStorage-ba, hogy nyelvváltoztatás után is elérhető legyen
        try {
          if (referrerPath !== '/index.html') {
            console.log('[Settings] 💾 Saving to sessionStorage:', referrerPath);
            sessionStorage.setItem('eu2k_navigation_from', referrerPath);
            sessionStorage.setItem('eu2k_navigation_timestamp', Date.now().toString());
          }
        } catch (e) {
          console.warn('[Settings] Could not save to sessionStorage:', e);
        }
        
        if (window.NavigationState && referrerPath !== '/index.html') {
          console.log('[Settings] 💾 Saving to NavigationState...');
          window.NavigationState.save();
        }
        
        const pageMap = {
          '/index.html': { nameKey: 'pages.settings.back_to_home', path: 'index.html' },
          '/index': { nameKey: 'pages.settings.back_to_home', path: 'index.html' },
          '/': { nameKey: 'pages.settings.back_to_home', path: 'index.html' },
          '/EU2K-Hub/index.html': { nameKey: 'pages.settings.back_to_home', path: 'index.html' },
          '/EU2K-Hub/index': { nameKey: 'pages.settings.back_to_home', path: 'index.html' },
          '/EU2K-Hub/': { nameKey: 'pages.settings.back_to_home', path: 'index.html' },
          '/youhub.html': { nameKey: 'pages.settings.back_to_youhub', path: 'youhub.html' },
          '/youhub': { nameKey: 'pages.settings.back_to_youhub', path: 'youhub.html' },
          '/EU2K-Hub/youhub.html': { nameKey: 'pages.settings.back_to_youhub', path: 'youhub.html' },
          '/EU2K-Hub/youhub': { nameKey: 'pages.settings.back_to_youhub', path: 'youhub.html' },
          '/event_hub.html': { nameKey: 'pages.settings.back_to_event_hub', path: 'event_hub.html' },
          '/event_hub': { nameKey: 'pages.settings.back_to_event_hub', path: 'event_hub.html' },
          '/EU2K-Hub/event_hub.html': { nameKey: 'pages.settings.back_to_event_hub', path: 'event_hub.html' },
          '/EU2K-Hub/event_hub': { nameKey: 'pages.settings.back_to_event_hub', path: 'event_hub.html' },
          '/food_hub.html': { nameKey: 'pages.settings.back_to_food_hub', path: 'food_hub.html' },
          '/food_hub': { nameKey: 'pages.settings.back_to_food_hub', path: 'food_hub.html' },
          '/EU2K-Hub/food_hub.html': { nameKey: 'pages.settings.back_to_food_hub', path: 'food_hub.html' },
          '/EU2K-Hub/food_hub': { nameKey: 'pages.settings.back_to_food_hub', path: 'food_hub.html' },
          '/fitness_hub.html': { nameKey: 'pages.settings.back_to_fitness_hub', path: 'fitness_hub.html' },
          '/fitness_hub': { nameKey: 'pages.settings.back_to_fitness_hub', path: 'fitness_hub.html' },
          '/EU2K-Hub/fitness_hub.html': { nameKey: 'pages.settings.back_to_fitness_hub', path: 'fitness_hub.html' },
          '/EU2K-Hub/fitness_hub': { nameKey: 'pages.settings.back_to_fitness_hub', path: 'fitness_hub.html' },
          '/class_hub.html': { nameKey: 'pages.settings.back_to_class_hub', path: 'class_hub.html' },
          '/class_hub': { nameKey: 'pages.settings.back_to_class_hub', path: 'class_hub.html' },
          '/EU2K-Hub/class_hub.html': { nameKey: 'pages.settings.back_to_class_hub', path: 'class_hub.html' },
          '/EU2K-Hub/class_hub': { nameKey: 'pages.settings.back_to_class_hub', path: 'class_hub.html' },
          '/qr-code.html': { nameKey: 'pages.settings.back_to_qr', path: 'qr-code.html' },
          '/qr-code': { nameKey: 'pages.settings.back_to_qr', path: 'qr-code.html' },
          '/qr': { nameKey: 'pages.settings.back_to_qr', path: 'qr-code.html' },
          '/EU2K-Hub/qr-code.html': { nameKey: 'pages.settings.back_to_qr', path: 'qr-code.html' },
          '/EU2K-Hub/qr-code': { nameKey: 'pages.settings.back_to_qr', path: 'qr-code.html' },
          '/EU2K-Hub/qr': { nameKey: 'pages.settings.back_to_qr', path: 'qr-code.html' },
          '/system/account.html': { nameKey: 'pages.settings.back_to_account', path: 'system/account.html' },
          '/account.html': { nameKey: 'pages.settings.back_to_account', path: 'system/account.html' },
          '/account': { nameKey: 'pages.settings.back_to_account', path: 'system/account.html' },
          '/EU2K-Hub/system/account.html': { nameKey: 'pages.settings.back_to_account', path: 'system/account.html' },
          '/EU2K-Hub/account.html': { nameKey: 'pages.settings.back_to_account', path: 'system/account.html' },
          '/EU2K-Hub/account': { nameKey: 'pages.settings.back_to_account', path: 'system/account.html' },
          '/privacy-policy.html': { nameKey: 'pages.settings.back_to_privacy', path: 'privacy-policy.html' },
          '/privacy-policy': { nameKey: 'pages.settings.back_to_privacy', path: 'privacy-policy.html' },
          '/EU2K-Hub/privacy-policy.html': { nameKey: 'pages.settings.back_to_privacy', path: 'privacy-policy.html' },
          '/EU2K-Hub/privacy-policy': { nameKey: 'pages.settings.back_to_privacy', path: 'privacy-policy.html' },
          '/terms_of_service.html': { nameKey: 'pages.settings.back_to_terms', path: 'terms-of-service.html' },
          '/terms_of_service': { nameKey: 'pages.settings.back_to_terms', path: 'terms-of-service.html' },
          '/EU2K-Hub/terms_of_service.html': { nameKey: 'pages.settings.back_to_terms', path: 'terms-of-service.html' },
          '/EU2K-Hub/terms_of_service': { nameKey: 'pages.settings.back_to_terms', path: 'terms-of-service.html' },
          '/onboarding.html': { nameKey: 'pages.settings.back_to_onboarding', path: 'onboarding.html' },
          '/onboarding': { nameKey: 'pages.settings.back_to_onboarding', path: 'onboarding.html' },
          '/EU2K-Hub/onboarding.html': { nameKey: 'pages.settings.back_to_onboarding', path: 'onboarding.html' },
          '/EU2K-Hub/onboarding': { nameKey: 'pages.settings.back_to_onboarding', path: 'onboarding.html' }
        };
        
        console.log('[Settings] 🔍 Looking for referrerPath in pageMap:', referrerPath);
        console.log('[Settings] 📋 Available pageMap keys:', Object.keys(pageMap));
        let found = pageMap[referrerPath];
        console.log('[Settings] 🎯 Direct match found:', found);
        
        if (!found) {
          // Próbáljuk meg találni részleges egyezéssel
          console.log('[Settings] 🔍 No direct match, trying partial match...');
          for (const [key, value] of Object.entries(pageMap)) {
            if (referrerPath.includes(key) || key.includes(referrerPath)) {
              console.log('[Settings] ✅ Partial match found:', key, '->', value);
              found = value;
              break;
            }
          }
        }
        
        // Ha nem találtunk semmit, akkor a főoldalra
        if (!found) {
          console.log('[Settings] 🏠 No match found, defaulting to index.html');
          found = pageMap['/index.html'];
        }
        
        console.log('[Settings] ✅ Final found page:', found);
        
        const updateBackButtonText = () => {
          console.log('[Settings] 📝 updateBackButtonText called, found:', found);
          // Várunk a translationManager betöltésére
          if (!window.translationManager || !window.translationManager.translations) {
            console.log('[Settings] ⏳ TranslationManager not ready, waiting...');
            setTimeout(updateBackButtonText, 100);
            return;
          }
          
          if (found) {
            console.log('[Settings] 🔍 Found page:', found);
            console.log('[Settings] 🔑 Looking for translation key:', found.nameKey);
            console.log('[Settings] 📚 Current translations object:', window.translationManager.translations);
            console.log('[Settings] 📚 Pages object:', window.translationManager.translations?.pages);
            console.log('[Settings] 📚 Settings object:', window.translationManager.translations?.pages?.settings);
            // Próbáljuk meg közvetlenül is elérni a kulcsot
            const keyName = found.nameKey.replace('pages.settings.', '');
            const directAccess = window.translationManager.translations?.pages?.settings?.[keyName];
            console.log('[Settings] 🔍 Direct access test (key:', keyName, '):', directAccess);
            
            // Próbáljuk meg a getTranslation-t is
            const translatedName = window.translationManager.getTranslation(found.nameKey);
            console.log('[Settings] 🌐 Translated name (getTranslation):', translatedName);
            
            // Ha a getTranslation nem működik, próbáljuk meg közvetlenül
            const finalTranslatedName = translatedName || directAccess;
            console.log('[Settings] ✅ Final translated name:', finalTranslatedName);
            
            // Back text is közvetlenül
            const backTextDirect = window.translationManager.translations?.pages?.settings?.back;
            const backText = window.translationManager.getTranslation('pages.settings.back') || backTextDirect || 'Vissza a';
            console.log('[Settings] 🔙 Back text:', backText);
            
            // Ha a fordítást találta és nem a kulcs maga
            if (finalTranslatedName && finalTranslatedName !== found.nameKey) {
              // Összefűzzük a backText-tel, mint minden más nyelvnél
              const finalText = `${backText} ${finalTranslatedName}`;
              console.log('[Settings] ✅ Setting button text to:', finalText);
              backBtnText.textContent = finalText;
            } else {
              // Ha még nincs betöltve a fordítás, várunk még egy kicsit
              console.log('[Settings] ⏳ Translation not found or is key, waiting... (translatedName:', translatedName, ', directAccess:', directAccess, ')');
              setTimeout(updateBackButtonText, 100);
              return;
            }
          } else {
            // Ha nem találtunk semmit, csak a "Vissza" szöveget írjuk ki
            const backText = window.translationManager.getTranslation('pages.settings.back') || 'Vissza';
            console.log('[Settings] 🏠 No page found, using default back text:', backText);
            backBtnText.textContent = backText;
          }
        };
        
        if (found) {
          // Várunk a translationManager betöltésére
          const initBackButton = () => {
            if (window.translationManager && window.translationManager.translations) {
              updateBackButtonText();
              backBtn.onclick = () => window.location.href = found.path;
            } else {
              setTimeout(initBackButton, 100);
            }
          };
          initBackButton();
        } else {
          backBtnText.textContent = window.translationManager?.getTranslation('pages.settings.back') || 'Vissza';
          backBtn.onclick = () => window.history.back();
        }
        
        // Frissítjük a szöveget nyelvváltáskor - de csak akkor, ha van found
        if (window.translationManager && found) {
          const originalOnLanguageChange = window.translationManager.onLanguageChange;
          window.translationManager.onLanguageChange = () => {
            if (originalOnLanguageChange) originalOnLanguageChange();
            // Újra kell keresnünk a found-ot, mert lehet, hogy változott
            updateBackButtonText();
          };
        }
        
        // Megakadályozzuk, hogy az applyTranslations felülírja a gomb szövegét
        if (window.translationManager && window.translationManager.applyTranslations && found) {
          const originalApplyTranslations = window.translationManager.applyTranslations;
          window.translationManager.applyTranslations = function() {
            const result = originalApplyTranslations.call(this);
            // Ha van found, akkor frissítjük a gomb szövegét az applyTranslations után
            if (found && backBtnText) {
              setTimeout(() => {
                updateBackButtonText();
              }, 50);
            }
            return result;
          };
        }
        
        // Töröljük a sessionStorage-t, amikor elhagyjuk az oldalt (pl. navigáció, bezárás)
        window.addEventListener('beforeunload', () => {
          if (window.NavigationState) {
            window.NavigationState.clear();
          }
          try {
            sessionStorage.removeItem('eu2k_navigation_from');
            sessionStorage.removeItem('eu2k_navigation_timestamp');
            console.log('[Settings] 🗑️ Cleared navigation state on page unload');
          } catch (e) {
            console.warn('[Settings] Could not clear sessionStorage on unload:', e);
          }
        });
      }
      
      // Várunk a translationManager betöltésére, mielőtt inicializálnánk
      const initBackButton = () => {
        if (window.translationManager && window.translationManager.translations) {
          updateBackButton();
        } else {
          setTimeout(initBackButton, 100);
        }
      };
      initBackButton();
      
      // Nyelv dropdown inicializálása
      const languageCodes = ['hu', 'en', 'de', 'es', 'fr', 'zh', 'ja', 'sv', 'ru'];
      const getLanguageNames = () => {
        const names = [];
        // Mindig a jelenlegi nyelv szerint adjuk vissza a nyelvneveket
        const currentLang = window.translationManager?.currentLanguage || localStorage.getItem('eu2k_language') || 'hu';
        
        // Ha van translationManager és betöltődött, használjuk
        if (window.translationManager && window.translationManager.translations) {
          languageCodes.forEach(code => {
            // Próbáljuk meg a jelenlegi nyelv szerinti fordítást
            const name = window.translationManager.getTranslation(`onboarding.languages.${code}`);
            // Ha nincs fordítás vagy a kulcs maga jön vissza, használjuk a fallback neveket
            if (!name || name === `onboarding.languages.${code}`) {
              // Fallback nevek a jelenlegi nyelv szerint
              const defaultNames = {
                'hu': ['Magyar', 'English', 'Német', 'Spanyol', 'Francia', 'Kínai', 'Japán', 'Svéd', 'Orosz'],
                'en': ['Hungarian', 'English', 'German', 'Spanish', 'French', 'Chinese', 'Japanese', 'Swedish', 'Russian'],
                'de': ['Ungarisch', 'Englisch', 'Deutsch', 'Spanisch', 'Französisch', 'Chinesisch', 'Japanisch', 'Schwedisch', 'Russisch'],
                'es': ['Húngaro', 'Inglés', 'Alemán', 'Español', 'Francés', 'Chino', 'Japonés', 'Sueco', 'Ruso'],
                'fr': ['Hongrois', 'Anglais', 'Allemand', 'Espagnol', 'Français', 'Chinois', 'Japonais', 'Suédois', 'Russe'],
                'zh': ['匈牙利语', '英语', '德语', '西班牙语', '法语', '中文', '日语', '瑞典语', '俄语'],
                'ja': ['ハンガリー語', '英語', 'ドイツ語', 'スペイン語', 'フランス語', '中国語', '日本語', 'スウェーデン語', 'ロシア語'],
                'sv': ['Ungerska', 'Engelska', 'Tyska', 'Spanska', 'Franska', 'Kinesiska', 'Japanska', 'Svenska', 'Ryska'],
                'ru': ['Венгерский', 'Английский', 'Немецкий', 'Испанский', 'Французский', 'Китайский', 'Японский', 'Шведский', 'Русский']
              };
              const fallbackNames = defaultNames[currentLang] || defaultNames['hu'];
              names.push(fallbackNames[languageCodes.indexOf(code)] || code);
            } else {
              names.push(name);
            }
          });
        } else {
          // Fallback: ha nincs translationManager, használjuk a localStorage-ból a nyelvet
          const defaultNames = {
            'hu': ['Magyar', 'English', 'Német', 'Spanyol', 'Francia', 'Kínai', 'Japán', 'Svéd', 'Orosz'],
            'en': ['Hungarian', 'English', 'German', 'Spanish', 'French', 'Chinese', 'Japanese', 'Swedish', 'Russian'],
            'de': ['Ungarisch', 'Englisch', 'Deutsch', 'Spanisch', 'Französisch', 'Chinesisch', 'Japanisch', 'Schwedisch', 'Russisch'],
            'es': ['Húngaro', 'Inglés', 'Alemán', 'Español', 'Francés', 'Chino', 'Japonés', 'Sueco', 'Ruso'],
            'fr': ['Hongrois', 'Anglais', 'Allemand', 'Espagnol', 'Français', 'Chinois', 'Japonais', 'Suédois', 'Russe'],
            'zh': ['匈牙利语', '英语', '德语', '西班牙语', '法语', '中文', '日语', '瑞典语', '俄语'],
            'ja': ['ハンガリー語', '英語', 'ドイツ語', 'スペイン語', 'フランス語', '中国語', '日本語', 'スウェーデン語', 'ロシア語'],
            'sv': ['Ungerska', 'Engelska', 'Tyska', 'Spanska', 'Franska', 'Kinesiska', 'Japanska', 'Svenska', 'Ryska'],
            'ru': ['Венгерский', 'Английский', 'Немецкий', 'Испанский', 'Французский', 'Китайский', 'Японский', 'Шведский', 'Русский']
          };
          names.push(...(defaultNames[currentLang] || defaultNames['hu']));
        }
        return names;
      };
      
      let languageDropdown = null;
      let editionDropdown = null;
      let colorSchemeDropdown = null;
      let themeDropdown = null;
      let pendingLanguage = null;
      const applyBtn = document.getElementById('settingsApplyBtn');
      const applyBtnText = document.getElementById('settingsApplyBtnText');
      const applyBtnIcon = document.querySelector('#settingsApplyBtn .header-edit-mode-icon');

      const setApplyEnabled = (enabled) => {
        if (!applyBtn) return;
        if (enabled) {
          applyBtn.style.opacity = '1';
          applyBtn.style.pointerEvents = 'auto';
        } else {
          applyBtn.style.opacity = '0.5';
          applyBtn.style.pointerEvents = 'none';
        }
      };
      // Globális elérhetőség más scripteknek (például értesítések)
      window.setApplyEnabled = setApplyEnabled;
      
      // Update dropdown options
      const updateDropdownOptions = () => {
        if (!languageDropdown) return;
        try {
          // Várunk egy kicsit, hogy a translationManager biztosan frissült
          setTimeout(() => {
            const newOptions = getLanguageNames();
            // Frissítjük az opciókat - ez rebuildeli a menüt is
            languageDropdown.options = newOptions;
            // Frissítjük a kijelölt indexet az új nyelv szerint
            const currentLang = pendingLanguage || window.translationManager?.currentLanguage || localStorage.getItem('eu2k_language') || 'hu';
            const newSelectedIndex = languageCodes.indexOf(currentLang);
            if (newSelectedIndex >= 0) {
              languageDropdown.setSelected(newSelectedIndex);
            }
            languageDropdown.updateDisplay();
            languageDropdown.restoreOrder();
          }, 100);
        } catch (error) {
          console.error('[Settings] Error updating dropdown options:', error);
        }
      };
      
      // Update disabled dropdowns (edition, color scheme, theme)
      const updateDisabledDropdowns = () => {
        // Várunk egy kicsit, hogy a translationManager biztosan frissült
        setTimeout(() => {
          const currentLang = window.translationManager?.currentLanguage || localStorage.getItem('eu2k_language') || 'hu';
          
          // Edition dropdown
          if (editionDropdown) {
            const getEditionOptions = () => {
              if (window.translationManager && window.translationManager.translations) {
                const general = window.translationManager.getTranslation('pages.settings.edition_options.general_public');
                const betaPublic = window.translationManager.getTranslation('pages.settings.edition_options.beta_public');
                const betaClosed = window.translationManager.getTranslation('pages.settings.edition_options.beta_closed');
                if (general && general !== 'pages.settings.edition_options.general_public' &&
                    betaPublic && betaPublic !== 'pages.settings.edition_options.beta_public' &&
                    betaClosed && betaClosed !== 'pages.settings.edition_options.beta_closed') {
                  return [general, betaPublic, betaClosed];
                }
              }
              const fallbackOptions = {
                'hu': ['Általános - Nyilvános', 'Béta - Nyilvános', 'Béta - Zárt'],
                'en': ['General - Public', 'Beta - Public', 'Beta - Closed'],
                'de': ['Allgemein - Öffentlich', 'Beta - Öffentlich', 'Beta - Geschlossen'],
                'es': ['General - Público', 'Beta - Público', 'Beta - Cerrado'],
                'fr': ['Général - Public', 'Bêta - Public', 'Bêta - Fermé'],
                'zh': ['通用 - 公开', '测试版 - 公开', '测试版 - 封闭'],
                'ja': ['一般 - 公開', 'ベータ - 公開', 'ベータ - 非公開'],
                'sv': ['Allmän - Offentlig', 'Beta - Offentlig', 'Beta - Stängd'],
                'ru': ['Общий - Публичный', 'Бета - Публичный', 'Бета - Закрытый']
              };
              return fallbackOptions[currentLang] || fallbackOptions['hu'];
            };
            const options = getEditionOptions();
            if (options && !options.some(opt => opt && opt.includes('pages.settings.edition_options'))) {
              editionDropdown.options = options;
              editionDropdown.updateDisplay();
            }
          }
          
          // Color scheme dropdown
          if (colorSchemeDropdown) {
            const getColorSchemeOptions = () => {
              if (window.translationManager && window.translationManager.translations) {
                const green = window.translationManager.getTranslation('pages.settings.theme_color_options.green');
                const purple = window.translationManager.getTranslation('pages.settings.theme_color_options.purple');
                const red = window.translationManager.getTranslation('pages.settings.theme_color_options.red');
                const orange = window.translationManager.getTranslation('pages.settings.theme_color_options.orange');
                const lightBlue = window.translationManager.getTranslation('pages.settings.theme_color_options.light_blue');
                const black = window.translationManager.getTranslation('pages.settings.theme_color_options.black');
                const pink = window.translationManager.getTranslation('pages.settings.theme_color_options.pink');
                const darkBlue = window.translationManager.getTranslation('pages.settings.theme_color_options.dark_blue');
                if (green && green !== 'pages.settings.theme_color_options.green' &&
                    purple && purple !== 'pages.settings.theme_color_options.purple') {
                  return [green, purple, red, orange, lightBlue, black, pink, darkBlue].filter(Boolean);
                }
              }
              const fallbackOptions = {
                'hu': ['Zöld (Alapértelmezett)', 'Lila', 'Piros', 'Narancssárga', 'Világoskék', 'Fekete', 'Rózsaszín', 'Sötétkék'],
                'en': ['Green (Default)', 'Purple', 'Red', 'Orange', 'Light Blue', 'Black', 'Pink', 'Dark Blue'],
                'de': ['Grün (Standard)', 'Lila', 'Rot', 'Orange', 'Hellblau', 'Schwarz', 'Rosa', 'Dunkelblau'],
                'es': ['Verde (Predeterminado)', 'Morado', 'Rojo', 'Naranja', 'Azul Claro', 'Negro', 'Rosa', 'Azul Oscuro'],
                'fr': ['Vert (Par défaut)', 'Violet', 'Rouge', 'Orange', 'Bleu Clair', 'Noir', 'Rose', 'Bleu Foncé'],
                'zh': ['绿色（默认）', '紫色', '红色', '橙色', '浅蓝色', '黑色', '粉色', '深蓝色'],
                'ja': ['緑（デフォルト）', '紫', '赤', 'オレンジ', 'ライトブルー', '黒', 'ピンク', 'ダークブルー'],
                'sv': ['Grön (Standard)', 'Lila', 'Röd', 'Orange', 'Ljusblå', 'Svart', 'Rosa', 'Mörkblå'],
                'ru': ['Зеленый (По умолчанию)', 'Фиолетовый', 'Красный', 'Оранжевый', 'Светло-синий', 'Черный', 'Розовый', 'Темно-синий']
              };
              return fallbackOptions[currentLang] || fallbackOptions['hu'];
            };
            const options = getColorSchemeOptions();
            if (options && !options.some(opt => opt && opt.includes('pages.settings.theme_color_options'))) {
              colorSchemeDropdown.options = options;
              colorSchemeDropdown.updateDisplay();
            }
          }
          
          // Theme dropdown
          if (themeDropdown) {
            const getThemeOptions = () => {
              if (window.translationManager && window.translationManager.translations) {
                const dark = window.translationManager.getTranslation('pages.settings.theme_theme_options.dark');
                const light = window.translationManager.getTranslation('pages.settings.theme_theme_options.light');
                const system = window.translationManager.getTranslation('pages.settings.theme_theme_options.system');
                if (dark && dark !== 'pages.settings.theme_theme_options.dark' &&
                    light && light !== 'pages.settings.theme_theme_options.light') {
                  return [dark, light, system].filter(Boolean);
                }
              }
              const fallbackOptions = {
                'hu': ['Sötét', 'Világos', 'Rendszertéma'],
                'en': ['Dark', 'Light', 'System Theme'],
                'de': ['Dunkel', 'Hell', 'Systemtema'],
                'es': ['Oscuro', 'Claro', 'Tema del Sistema'],
                'fr': ['Sombre', 'Clair', 'Thème Système'],
                'zh': ['深色', '浅色', '系统主题'],
                'ja': ['ダーク', 'ライト', 'システムテーマ'],
                'sv': ['Mörk', 'Ljus', 'Systemtema'],
                'ru': ['Темный', 'Светлый', 'Системная тема']
              };
              return fallbackOptions[currentLang] || fallbackOptions['hu'];
            };
            const options = getThemeOptions();
            if (options && !options.some(opt => opt && opt.includes('pages.settings.theme_theme_options'))) {
              themeDropdown.options = options;
              themeDropdown.updateDisplay();
            }
          }
          // Biztonsági fordítás-alkalmazás
          if (window.translationManager && window.translationManager.applyTranslations) {
            try { window.translationManager.applyTranslations(); } catch(e){}
          }
        }, 100);
      };
      
      const initLanguageDropdown = () => {
        const container = document.getElementById('languageDropdown');
        console.log('[Settings] initLanguageDropdown called, container:', container, 'LanguageDropdown:', !!window.LanguageDropdown);
        if (!container) {
          console.error('[Settings] Language dropdown container not found!');
              return;
        }
        if (!window.LanguageDropdown) {
          console.error('[Settings] LanguageDropdown class not available!');
              return;
        }
        
        // Get current language from translation manager or localStorage
        let currentLang = 'hu'; // default
        if (window.translationManager && window.translationManager.currentLanguage) {
          currentLang = window.translationManager.currentLanguage;
        } else {
          const savedLang = localStorage.getItem('eu2k_language');
          const validLanguages = ['hu', 'en', 'de', 'es', 'fr', 'zh', 'ja', 'sv', 'ru'];
          if (savedLang && validLanguages.includes(savedLang)) {
            currentLang = savedLang;
          }
        }
        
        // Get selected index based on current language
        const selectedIndex = languageCodes.indexOf(currentLang);
        
        // Várunk a translationManager-re, hogy biztosan betöltődött
        const initDropdown = () => {
          const options = getLanguageNames();
          console.log('[Settings] Creating LanguageDropdown with options:', options, 'selectedIndex:', selectedIndex);
          
          // Ha a nyelvkódok jelennek meg, várunk még
          if (options.some(opt => languageCodes.includes(opt))) {
            console.log('[Settings] Language codes still showing, waiting for translationManager...');
            setTimeout(initDropdown, 100);
              return;
          }
          
          try {
            languageDropdown = new LanguageDropdown(container, {
              options: options,
              selectedIndex: selectedIndex >= 0 ? selectedIndex : 0,
              onChange: (selected, index) => {
                // Csak kiválasztjuk a nyelvet, alkalmazás gombbal váltunk
                const langCode = languageCodes[index];
                pendingLanguage = langCode;
                setApplyEnabled(true);
                // Megjelenítjük az új kijelölést a dropdownban
                if (languageDropdown) {
                  languageDropdown.setSelected(index);
                  languageDropdown.updateDisplay();
                }
              }
            });
            console.log('[Settings] LanguageDropdown created successfully:', languageDropdown);
          } catch (error) {
            console.error('[Settings] Error creating LanguageDropdown:', error);
          }
        };
        
        // Próbáljuk meg inicializálni
        if (window.translationManager && window.translationManager.translations) {
          initDropdown();
        } else {
          // Ha nincs még betöltve, várunk
          setTimeout(() => {
            if (window.translationManager && window.translationManager.translations) {
              initDropdown();
            } else {
              // Ha még mindig nincs, fallback opciókkal inicializálunk
              const fallbackOptions = getLanguageNames();
              try {
                languageDropdown = new LanguageDropdown(container, {
                  options: fallbackOptions,
                  selectedIndex: selectedIndex >= 0 ? selectedIndex : 0,
                  onChange: (selected, index) => {
                    const langCode = languageCodes[index];
                    pendingLanguage = langCode;
                    setApplyEnabled(true);
                    if (languageDropdown) {
                      languageDropdown.setSelected(index);
                      languageDropdown.updateDisplay();
                    }
                  }
                });
                console.log('[Settings] LanguageDropdown created with fallback options:', languageDropdown);
              } catch (error) {
                console.error('[Settings] Error creating LanguageDropdown with fallback:', error);
              }
            }
          }, 200);
        }
      };
      
      // Ne módosítsuk a switchLanguage-t, csak a dropdown onChange-ben frissítsünk
      
      // Várunk a translation manager-re és LanguageDropdown-ra (onboarding módszer)
      const waitForTranslations = () => {
        console.log('[Settings] Checking dependencies:', {
          translationManager: !!window.translationManager,
          isInitialized: window.translationManager?.isInitialized,
          translations: !!window.translationManager?.translations,
          LanguageDropdown: !!window.LanguageDropdown
        });
        
        if (window.translationManager && window.translationManager.translations && window.LanguageDropdown) {
          // Ha még nem inicializált, most inicializáljuk és alkalmazzuk
          if (!window.translationManager.isInitialized && window.translationManager.init) {
            try {
              window.translationManager.init();
            } catch (e) {
              console.error('[Settings] translationManager.init hiba:', e);
            }
          }
          if (window.translationManager.applyTranslations) {
            try {
              window.translationManager.applyTranslations();
            } catch (e) {
              console.error('[Settings] applyTranslations hiba:', e);
            }
          }
          console.log('[Settings] All dependencies ready, initializing dropdowns');
          initLanguageDropdown();
          initEditionDropdown();
          initThemeDropdowns();
          
          // Várunk a fordítások betöltésére a pages/functions dropdownokhoz
          setTimeout(() => {
            initDescriptiveTextsDropdown();
            initHomeLayoutDropdown();
            initDateFormatDropdown();
            initRevertButton();
          }, 200);
        } else {
          // Wait a bit more for dependencies to load
          setTimeout(waitForTranslations, 100);
        }
      };
      
      // Start waiting after a short delay to ensure scripts are loaded
      setTimeout(waitForTranslations, 50);

      // Alkalmazás gomb logika
      const applyPendingLanguage = async () => {
        if (!pendingLanguage || !window.translationManager) return;
        try {
          // Elmentjük a navigation state-et mielőtt reload-olunk
          if (window.NavigationState) {
            window.NavigationState.save();
          }
          // Váltás az új nyelvre és teljes oldal újratöltés
          await window.translationManager.switchLanguage(pendingLanguage, true);
          // Full reload hogy minden biztosan frissüljön
          window.location.reload();
        } catch (e) {
          console.error('[Settings] applyPendingLanguage error:', e);
          setApplyEnabled(true);
        }
      };

      if (applyBtn) {
        applyBtn.addEventListener('click', async () => {
          try {
            setApplyEnabled(false);
            if (window.saveNotificationSettings) {
              await window.saveNotificationSettings();
            }
          } catch (e) {
            console.error('[Settings] saveNotificationSettings error:', e);
          } finally {
            await applyPendingLanguage();
          }
        });
      }
      
      // Kiadás dropdown
      function initEditionDropdown() {
        const container = document.getElementById('editionDropdown');
        console.log('[Settings] initEditionDropdown called, container:', container, 'LanguageDropdown:', !!window.LanguageDropdown);
        if (!container) {
          console.error('[Settings] Edition dropdown container not found!');
              return;
          }
        if (!window.LanguageDropdown) {
          console.error('[Settings] LanguageDropdown class not available!');
              return;
          }
        
        // Fordított opciók - várunk a translationManager betöltésére
        const getEditionOptions = () => {
          if (window.translationManager && window.translationManager.translations) {
            const general = window.translationManager.getTranslation('pages.settings.edition_options.general_public');
            const betaPublic = window.translationManager.getTranslation('pages.settings.edition_options.beta_public');
            const betaClosed = window.translationManager.getTranslation('pages.settings.edition_options.beta_closed');
            // Ha mindhárom fordítás elérhető, használjuk
            if (general && general !== 'pages.settings.edition_options.general_public' &&
                betaPublic && betaPublic !== 'pages.settings.edition_options.beta_public' &&
                betaClosed && betaClosed !== 'pages.settings.edition_options.beta_closed') {
              return [general, betaPublic, betaClosed];
            }
          }
          // Fallback: jelenlegi nyelv szerint
          const currentLang = window.translationManager?.currentLanguage || localStorage.getItem('eu2k_language') || 'hu';
          const fallbackOptions = {
            'hu': ['Általános - Nyilvános', 'Béta - Nyilvános', 'Béta - Zárt'],
            'en': ['General - Public', 'Beta - Public', 'Beta - Closed'],
            'de': ['Allgemein - Öffentlich', 'Beta - Öffentlich', 'Beta - Geschlossen'],
            'es': ['General - Público', 'Beta - Público', 'Beta - Cerrado'],
            'fr': ['Général - Public', 'Bêta - Public', 'Bêta - Fermé'],
            'zh': ['通用 - 公开', '测试版 - 公开', '测试版 - 封闭'],
            'ja': ['一般 - 公開', 'ベータ - 公開', 'ベータ - 非公開'],
            'sv': ['Allmän - Offentlig', 'Beta - Offentlig', 'Beta - Stängd'],
            'ru': ['Общий - Публичный', 'Бета - Публичный', 'Бета - Закрытый']
          };
          return fallbackOptions[currentLang] || fallbackOptions['hu'];
        };
        
        const savedEdition = localStorage.getItem('eu2k_edition') || 'beta-closed';
        const editionMap = {
          'general-public': 0,
          'beta-public': 1,
          'beta-closed': 2
        };
        const selectedIndex = editionMap[savedEdition] || 2;
        
        // Várunk a translationManager betöltésére
        const initEditionDropdownWithOptions = () => {
          const options = getEditionOptions();
          // Ha még nincs betöltve, várunk
          if (options.some(opt => opt && opt.includes('pages.settings.edition_options'))) {
            setTimeout(initEditionDropdownWithOptions, 100);
            return;
          }
          
          console.log('[Settings] Creating EditionDropdown with options:', options, 'selectedIndex:', selectedIndex);
          
          try {
            editionDropdown = new LanguageDropdown(container, {
              options: options,
              selectedIndex: selectedIndex,
              onChange: (selected, index) => {
                const keys = ['general-public', 'beta-public', 'beta-closed'];
                localStorage.setItem('eu2k_edition', keys[index]);
              }
            });
            console.log('[Settings] EditionDropdown created successfully:', editionDropdown);
            
            // Kiadás dropdown mindig disabled
            setTimeout(() => {
              const trigger = container.querySelector('.language-dropdown-trigger');
              if (trigger) {
                trigger.style.opacity = '0.5';
                trigger.style.pointerEvents = 'none';
                console.log('[Settings] Edition dropdown disabled');
              }
            }, 200);
      } catch (error) {
            console.error('[Settings] Error creating EditionDropdown:', error);
          }
        };
        
        // Próbáljuk meg inicializálni
        if (window.translationManager && window.translationManager.translations) {
          initEditionDropdownWithOptions();
        } else {
          setTimeout(() => {
            if (window.translationManager && window.translationManager.translations) {
              initEditionDropdownWithOptions();
            } else {
              // Ha még mindig nincs, fallback opciókkal inicializálunk
              const fallbackOptions = getEditionOptions();
              try {
                editionDropdown = new LanguageDropdown(container, {
                  options: fallbackOptions,
                  selectedIndex: selectedIndex,
                  onChange: (selected, index) => {
                    const keys = ['general-public', 'beta-public', 'beta-closed'];
                    localStorage.setItem('eu2k_edition', keys[index]);
                  }
                });
                setTimeout(() => {
                  const trigger = container.querySelector('.language-dropdown-trigger');
                  if (trigger) {
                    trigger.style.opacity = '0.5';
                    trigger.style.pointerEvents = 'none';
                  }
                }, 200);
              } catch (error) {
                console.error('[Settings] Error creating EditionDropdown with fallback:', error);
              }
            }
          }, 200);
        }
      }
      
      // Színséma és Téma dropdownok (disabled)
      function initThemeDropdowns() {
        console.log('[Settings] initThemeDropdowns called, LanguageDropdown:', !!window.LanguageDropdown);
        if (!window.LanguageDropdown) {
          console.error('[Settings] LanguageDropdown class not available!');
          return;
        }
        
        // Fordított opciók - várunk a translationManager betöltésére
        const getColorSchemeOptions = () => {
          if (window.translationManager && window.translationManager.translations) {
            const green = window.translationManager.getTranslation('pages.settings.theme_color_options.green');
            const purple = window.translationManager.getTranslation('pages.settings.theme_color_options.purple');
            const red = window.translationManager.getTranslation('pages.settings.theme_color_options.red');
            const orange = window.translationManager.getTranslation('pages.settings.theme_color_options.orange');
            const lightBlue = window.translationManager.getTranslation('pages.settings.theme_color_options.light_blue');
            const black = window.translationManager.getTranslation('pages.settings.theme_color_options.black');
            const pink = window.translationManager.getTranslation('pages.settings.theme_color_options.pink');
            const darkBlue = window.translationManager.getTranslation('pages.settings.theme_color_options.dark_blue');
            // Ha minden fordítás elérhető, használjuk
            if (green && green !== 'pages.settings.theme_color_options.green' &&
                purple && purple !== 'pages.settings.theme_color_options.purple') {
              return [green, purple, red, orange, lightBlue, black, pink, darkBlue].filter(Boolean);
            }
          }
          // Fallback: jelenlegi nyelv szerint
          const currentLang = window.translationManager?.currentLanguage || localStorage.getItem('eu2k_language') || 'hu';
          const fallbackOptions = {
            'hu': ['Zöld (Alapértelmezett)', 'Lila', 'Piros', 'Narancssárga', 'Világoskék', 'Fekete', 'Rózsaszín', 'Sötétkék'],
            'en': ['Green (Default)', 'Purple', 'Red', 'Orange', 'Light Blue', 'Black', 'Pink', 'Dark Blue'],
            'de': ['Grün (Standard)', 'Lila', 'Rot', 'Orange', 'Hellblau', 'Schwarz', 'Rosa', 'Dunkelblau'],
            'es': ['Verde (Predeterminado)', 'Morado', 'Rojo', 'Naranja', 'Azul Claro', 'Negro', 'Rosa', 'Azul Oscuro'],
            'fr': ['Vert (Par défaut)', 'Violet', 'Rouge', 'Orange', 'Bleu Clair', 'Noir', 'Rose', 'Bleu Foncé'],
            'zh': ['绿色（默认）', '紫色', '红色', '橙色', '浅蓝色', '黑色', '粉色', '深蓝色'],
            'ja': ['緑（デフォルト）', '紫', '赤', 'オレンジ', 'ライトブルー', '黒', 'ピンク', 'ダークブルー'],
            'sv': ['Grön (Standard)', 'Lila', 'Röd', 'Orange', 'Ljusblå', 'Svart', 'Rosa', 'Mörkblå'],
            'ru': ['Зеленый (По умолчанию)', 'Фиолетовый', 'Красный', 'Оранжевый', 'Светло-синий', 'Черный', 'Розовый', 'Темно-синий']
          };
          return fallbackOptions[currentLang] || fallbackOptions['hu'];
        };
        const getThemeOptions = () => {
          if (window.translationManager && window.translationManager.translations) {
            const dark = window.translationManager.getTranslation('pages.settings.theme_theme_options.dark');
            const light = window.translationManager.getTranslation('pages.settings.theme_theme_options.light');
            const system = window.translationManager.getTranslation('pages.settings.theme_theme_options.system');
            // Ha minden fordítás elérhető, használjuk
            if (dark && dark !== 'pages.settings.theme_theme_options.dark' &&
                light && light !== 'pages.settings.theme_theme_options.light') {
              return [dark, light, system].filter(Boolean);
            }
          }
          // Fallback: jelenlegi nyelv szerint
          const currentLang = window.translationManager?.currentLanguage || localStorage.getItem('eu2k_language') || 'hu';
          const fallbackOptions = {
            'hu': ['Sötét', 'Világos', 'Rendszertéma'],
            'en': ['Dark', 'Light', 'System Theme'],
            'de': ['Dunkel', 'Hell', 'Systemtema'],
            'es': ['Oscuro', 'Claro', 'Tema del Sistema'],
            'fr': ['Sombre', 'Clair', 'Thème Système'],
            'zh': ['深色', '浅色', '系统主题'],
            'ja': ['ダーク', 'ライト', 'システムテーマ'],
            'sv': ['Mörk', 'Ljus', 'Systemtema'],
            'ru': ['Темный', 'Светлый', 'Системная тема']
          };
          return fallbackOptions[currentLang] || fallbackOptions['hu'];
        };
        
        // Várunk a translationManager betöltésére
        const initThemeDropdownsWithOptions = () => {
          const colorSchemeOptions = getColorSchemeOptions();
          const themeOptions = getThemeOptions();
          
          // Ha még nincs betöltve, várunk
          if (colorSchemeOptions.some(opt => opt && opt.includes('pages.settings.theme_color_options')) ||
              themeOptions.some(opt => opt && opt.includes('pages.settings.theme_theme_options'))) {
            setTimeout(initThemeDropdownsWithOptions, 100);
            return;
          }
        
          const colorSchemeContainer = document.getElementById('colorSchemeDropdown');
          const themeContainer = document.getElementById('themeDropdown');
          
          console.log('[Settings] Theme containers:', { colorSchemeContainer, themeContainer });
          
          if (colorSchemeContainer) {
            try {
              console.log('[Settings] Creating ColorSchemeDropdown');
              colorSchemeDropdown = new LanguageDropdown(colorSchemeContainer, {
                options: colorSchemeOptions,
                selectedIndex: 0,
                onChange: () => {} // Disabled
              });
              console.log('[Settings] ColorSchemeDropdown created:', colorSchemeDropdown);
              setTimeout(() => {
                const trigger = colorSchemeContainer.querySelector('.language-dropdown-trigger');
                if (trigger) {
                  trigger.style.opacity = '0.5';
                  trigger.style.pointerEvents = 'none';
                  console.log('[Settings] ColorScheme dropdown disabled');
                }
              }, 200);
            } catch (error) {
              console.error('[Settings] Error creating ColorSchemeDropdown:', error);
            }
          }
          
          if (themeContainer) {
            try {
              console.log('[Settings] Creating ThemeDropdown');
              themeDropdown = new LanguageDropdown(themeContainer, {
                options: themeOptions,
                selectedIndex: 0,
                onChange: () => {} // Disabled
              });
              console.log('[Settings] ThemeDropdown created:', themeDropdown);
              setTimeout(() => {
                const trigger = themeContainer.querySelector('.language-dropdown-trigger');
                if (trigger) {
                  trigger.style.opacity = '0.5';
                  trigger.style.pointerEvents = 'none';
                  console.log('[Settings] Theme dropdown disabled');
                }
              }, 200);
            } catch (error) {
              console.error('[Settings] Error creating ThemeDropdown:', error);
            }
          }
        };
        
        // Próbáljuk meg inicializálni
        if (window.translationManager && window.translationManager.translations) {
          initThemeDropdownsWithOptions();
        } else {
          setTimeout(() => {
            if (window.translationManager && window.translationManager.translations) {
              initThemeDropdownsWithOptions();
            } else {
              // Ha még mindig nincs, fallback opciókkal inicializálunk
              const fallbackColorOptions = getColorSchemeOptions();
              const fallbackThemeOptions = getThemeOptions();
              const colorSchemeContainer = document.getElementById('colorSchemeDropdown');
              const themeContainer = document.getElementById('themeDropdown');
              
              if (colorSchemeContainer) {
                try {
                  colorSchemeDropdown = new LanguageDropdown(colorSchemeContainer, {
                    options: fallbackColorOptions,
                    selectedIndex: 0,
                    onChange: () => {}
                  });
                  setTimeout(() => {
                    const trigger = colorSchemeContainer.querySelector('.language-dropdown-trigger');
                    if (trigger) {
                      trigger.style.opacity = '0.5';
                      trigger.style.pointerEvents = 'none';
                    }
                  }, 200);
                } catch (error) {
                  console.error('[Settings] Error creating ColorSchemeDropdown with fallback:', error);
                }
              }
              
              if (themeContainer) {
                try {
                  themeDropdown = new LanguageDropdown(themeContainer, {
                    options: fallbackThemeOptions,
                    selectedIndex: 0,
                    onChange: () => {}
                  });
                  setTimeout(() => {
                    const trigger = themeContainer.querySelector('.language-dropdown-trigger');
                    if (trigger) {
                      trigger.style.opacity = '0.5';
                      trigger.style.pointerEvents = 'none';
                    }
                  }, 200);
                } catch (error) {
                  console.error('[Settings] Error creating ThemeDropdown with fallback:', error);
                }
              }
            }
          }, 200);
        }
      }

      // Leíró szövegek dropdown (disabled)
      function initDescriptiveTextsDropdown() {
        const container = document.getElementById('descriptiveTextsDropdown');
        if (!container) return;
        
        // A HTML-ben már van teljes struktúra, csak frissítjük a szövegeket és állapotot
        setTimeout(() => {
          const button = container.querySelector('.language-dropdown-trigger');
          if (button) {
            button.disabled = true;
            button.style.opacity = '0.65';
            button.style.pointerEvents = 'none';
          }
        }, 200);
      }

      // Otthon elrendezés dropdown
      function initHomeLayoutDropdown() {
        const container = document.getElementById('homeLayoutDropdown');
        if (!container || !window.LanguageDropdown) return;
        
        // A HTML-ben már van teljes struktúra, inicializáljuk a LanguageDropdown-t a meglévő struktúrával
        const savedLayout = localStorage.getItem('eu2k_home_layout') || 'default';
        const selectedIndex = savedLayout === 'custom' ? 1 : 0;
        
        try {
          // Először töröljük a container tartalmát, hogy ne legyen duplikáció
          container.innerHTML = '';
          
          const getOptions = () => {
            if (window.translationManager && window.translationManager.translations) {
              const defaultOpt = window.translationManager.getTranslation('pages.settings.pages.layout_default');
              const customOpt = window.translationManager.getTranslation('pages.settings.pages.layout_custom');
              if (defaultOpt && defaultOpt !== 'pages.settings.pages.layout_default') {
                return [defaultOpt, customOpt].filter(Boolean);
              }
            }
            const currentLang = window.translationManager?.currentLanguage || localStorage.getItem('eu2k_language') || 'hu';
            const fallbackOptions = {
              'hu': ['Alapértelmezett', 'Egyéni'],
              'en': ['Default', 'Custom'],
              'de': ['Standard', 'Benutzerdefiniert'],
              'es': ['Predeterminado', 'Personalizado'],
              'fr': ['Par défaut', 'Personnalisé'],
              'zh': ['默认', '自定义'],
              'ja': ['デフォルト', 'カスタム'],
              'sv': ['Standard', 'Anpassad'],
              'ru': ['По умолчанию', 'Пользовательский']
            };
            return fallbackOptions[currentLang] || fallbackOptions['hu'];
          };
          
          const options = getOptions();
          const dropdown = new LanguageDropdown(container, {
            options: options,
            selectedIndex: selectedIndex,
            onChange: (selected, index) => {
              const keys = ['default', 'custom'];
              localStorage.setItem('eu2k_home_layout', keys[index]);
            }
          });
          setTimeout(() => {
            const button = container.querySelector('.language-dropdown-trigger');
            if (button) {
              button.style.opacity = '0.5';
              button.style.pointerEvents = 'none';
            }
          }, 200);
        } catch (error) {
          console.error('[Settings] Error creating HomeLayoutDropdown:', error);
        }
      }

      // Dátumformátum dropdown
      function initDateFormatDropdown() {
        const container = document.getElementById('dateFormatDropdown');
        if (!container || !window.LanguageDropdown) return;
        
        // A HTML-ben már van teljes struktúra, inicializáljuk a LanguageDropdown-t a meglévő struktúrával
        const savedFormat = localStorage.getItem('eu2k_date_format') || 'yyyy.mm.dd';
        const formatMap = {
          'yyyy.mm.dd': 0,
          'yyyy.dd.mm': 1,
          'mm.yyyy.dd': 2,
          'mm.dd.yyyy': 3,
          'dd.mm.yyyy': 4
        };
        const selectedIndex = formatMap[savedFormat] !== undefined ? formatMap[savedFormat] : 0;
        
        try {
          // Először töröljük a container tartalmát, hogy ne legyen duplikáció
          container.innerHTML = '';
          
          const getOptions = () => {
            if (window.translationManager && window.translationManager.translations) {
              const yyyy_mm_dd = window.translationManager.getTranslation('pages.settings.pages.date_format_yyyy_mm_dd');
              const yyyy_dd_mm = window.translationManager.getTranslation('pages.settings.pages.date_format_yyyy_dd_mm');
              const mm_yyyy_dd = window.translationManager.getTranslation('pages.settings.pages.date_format_mm_yyyy_dd');
              const mm_dd_yyyy = window.translationManager.getTranslation('pages.settings.pages.date_format_mm_dd_yyyy');
              const dd_mm_yyyy = window.translationManager.getTranslation('pages.settings.pages.date_format_dd_mm_yyyy');
              if (yyyy_mm_dd && yyyy_mm_dd !== 'pages.settings.pages.date_format_yyyy_mm_dd') {
                return [yyyy_mm_dd, yyyy_dd_mm, mm_yyyy_dd, mm_dd_yyyy, dd_mm_yyyy].filter(Boolean);
              }
            }
          const currentLang = window.translationManager?.currentLanguage || localStorage.getItem('eu2k_language') || 'hu';
          const fallbackOptions = {
            'hu': ['éééé.hh.nn', 'éééé.nn.hh', 'hh.éééé.nn', 'hh.nn.éééé', 'nn.hh.éééé'],
            'en': ['yyyy.mm.dd', 'yyyy.dd.mm', 'mm.yyyy.dd', 'mm.dd.yyyy', 'dd.mm.yyyy'],
            'de': ['jjjj.mm.tt', 'jjjj.tt.mm', 'mm.jjjj.tt', 'mm.tt.jjjj', 'tt.mm.jjjj'],
            'es': ['aaaa.mm.dd', 'aaaa.dd.mm', 'mm.aaaa.dd', 'mm.dd.aaaa', 'dd.mm.aaaa'],
            'fr': ['aaaa.mm.jj', 'aaaa.jj.mm', 'mm.aaaa.jj', 'mm.jj.aaaa', 'jj.mm.aaaa'],
            'zh': ['年年年.月月.日日', '年年年.日日.月月', '月月.年年年.日日', '月月.日日.年年年', '日日.月月.年年年'],
            'ja': ['年年年.月月.日日', '年年年.日日.月月', '月月.年年年.日日', '月月.日日.年年年', '日日.月月.年年年'],
            'sv': ['åååå.mm.dd', 'åååå.dd.mm', 'mm.åååå.dd', 'mm.dd.åååå', 'dd.mm.åååå'],
            'ru': ['гггг.мм.дд', 'гггг.дд.мм', 'мм.гггг.дд', 'мм.дд.гггг', 'дд.мм.гггг']
          };
          return fallbackOptions[currentLang] || fallbackOptions['hu'];
        };
        
        const options = getOptions();
        const dropdown = new LanguageDropdown(container, {
          options: options,
          selectedIndex: selectedIndex,
          onChange: (selected, index) => {
            const keys = ['yyyy.mm.dd', 'yyyy.dd.mm', 'mm.yyyy.dd', 'mm.dd.yyyy', 'dd.mm.yyyy'];
            localStorage.setItem('eu2k_date_format', keys[index]);
          }
        });
        setTimeout(() => {
          const button = container.querySelector('.language-dropdown-trigger');
          if (button) {
            button.style.opacity = '0.5';
            button.style.pointerEvents = 'none';
          }
        }, 200);
      } catch (error) {
        console.error('[Settings] Error creating DateFormatDropdown:', error);
      }
    }

      // Revert gomb inicializálása
      function initRevertButton() {
        const revertBtn = document.getElementById('settingsRevertBtn');
        if (!revertBtn) return;
        
        revertBtn.addEventListener('click', () => {
          showRevertPopup();
        });
      }

      // Revert popup megjelenítése
      function showRevertPopup() {
        const openPopup = () => {
          const scrollArea = document.querySelector('.main-scroll-area');
          if (scrollArea) {
            scrollArea.scrollTop = 0;
            scrollArea.classList.add('no-scroll');
            scrollArea.classList.add('popup-active');
          }
          setTimeout(() => {
            const popup = document.getElementById('revertPopup');
            if (popup) {
              popup.style.display = 'flex';
            }
          }, 50);
        };
        
        if (window.tryOpenPopup) {
          window.tryOpenPopup(openPopup);
        } else {
          openPopup();
        }
      }

      // Revert popup bezárása
      window.closeRevertPopup = function() {
        const popup = document.getElementById('revertPopup');
        if (popup) {
          popup.style.display = 'none';
        }
        const scrollArea = document.querySelector('.main-scroll-area');
        if (scrollArea) {
          scrollArea.classList.remove('no-scroll');
          scrollArea.classList.remove('popup-active');
        }
      };

      // Revert megerősítése
      window.confirmRevert = function() {
        // Itt kell implementálni a YouHub elrendezés visszaállítását
        // Jelenleg csak bezárjuk a popupot
        console.log('[Settings] Revert confirmed - YouHub layout reset');
        closeRevertPopup();
      };
    });
  </script>
  <script type="module">
    import { getApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc,
      updateDoc
    } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
    import {
      getAuth,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";

    // A LanguageDropdown magasságának globális limite ezen az oldalon
    // (assets/components/language-dropdown.js az window.languageDropdownMaxHeight értékét olvassa ki)
    window.languageDropdownMaxHeight = 260;

    const NOTIFS_LOCAL_STORAGE_KEY = 'eu2k_notifs_settings';
    const DEFAULT_NOTIF_SETTINGS = {
      sounds: true,
      'sounds-outside-school': true, // Felhasználó alap hang-beállítása iskolai időn kívül
      'location-mute': false,        // Helyzetalapú némítás (iskolai időben)
      'notif-sound': 'notification1',
      news: true,
      events: true,
      messages: false,
      posts: false,
      invites: false,
      'new-things': true,
      'event-hub-popup': false,
      'new-things-popup': true,
      'beta-popup': true,
      'popups-popup': true,
      'push-sort': 'categories',
      'popup-sort': 'categories'
    };

    const PUSH_CATEGORY_ORDER = ['news', 'events', 'messages', 'posts', 'invites', 'new-things'];
    const POPUP_CATEGORY_ORDER = ['event-hub-popup', 'new-things-popup', 'beta-popup', 'popups-popup'];

    let notifSettings = { ...DEFAULT_NOTIF_SETTINGS };
    let currentUser = null;
    let notifDb = null;
    let notifAuth = null;

    const getTranslationOr = (key, fallback) => {
      try {
        if (window.translationManager) {
          const t = window.translationManager.getTranslation(key);
          if (t && t !== key) return t;
        }
      } catch (e) {
        console.warn('[Settings][Notifs] Translation error for key', key, e);
      }
      return fallback;
    };

    function readLocalNotifSettings() {
      try {
        const raw = localStorage.getItem(NOTIFS_LOCAL_STORAGE_KEY);
        if (!raw) return { ...DEFAULT_NOTIF_SETTINGS };
        const parsed = JSON.parse(raw);
        return { ...DEFAULT_NOTIF_SETTINGS, ...parsed };
      } catch (e) {
        console.warn('[Settings][Notifs] Failed to read local settings:', e);
        return { ...DEFAULT_NOTIF_SETTINGS };
      }
    }

    function writeLocalNotifSettings(settings) {
      try {
        localStorage.setItem(NOTIFS_LOCAL_STORAGE_KEY, JSON.stringify(settings));
      } catch (e) {
        console.warn('[Settings][Notifs] Failed to write local settings:', e);
      }
    }

    function applyBetaLimits(settings) {
      // Ezek mindig false és kikapcsolt állapotban maradnak bétában
      settings.messages = false;
      settings.posts = false;
      settings.invites = false;
      settings['event-hub-popup'] = false;
      return settings;
    }

    function getChannelElementMap() {
      const pushContainer = document.getElementById('pushNotificationsChannels');
      const popupContainer = document.getElementById('popupNotificationsChannels');
      return {
        push: pushContainer ? Array.from(pushContainer.querySelectorAll('.notifications-toggle-row')) : [],
        popup: popupContainer ? Array.from(popupContainer.querySelectorAll('.notifications-toggle-row')) : []
      };
    }

    function applySort(container, mode, categoryOrder) {
      if (!container) return;
      const rows = Array.from(container.querySelectorAll('.notifications-toggle-row'));
      if (!rows.length) return;

      let sorted = [];
      if (mode === 'categories') {
        const orderMap = new Map();
        categoryOrder.forEach((key, index) => orderMap.set(key, index));
        sorted = rows.slice().sort((a, b) => {
          const ka = a.getAttribute('data-channel-key');
          const kb = b.getAttribute('data-channel-key');
          const ia = orderMap.has(ka) ? orderMap.get(ka) : Number.MAX_SAFE_INTEGER;
          const ib = orderMap.has(kb) ? orderMap.get(kb) : Number.MAX_SAFE_INTEGER;
          return ia - ib;
        });
      } else {
        // ABC sorrend
        sorted = rows.slice().sort((a, b) => {
          const la = a.querySelector('.notifications-toggle-label')?.textContent?.trim() || '';
          const lb = b.querySelector('.notifications-toggle-label')?.textContent?.trim() || '';
          return la.localeCompare(lb, undefined, { sensitivity: 'base' });
        });
      }

      sorted.forEach(row => container.appendChild(row));
    }

    function isInSchoolTime(date = new Date()) {
      // Július, augusztus: nincs iskolai idő
      const month = date.getMonth(); // 0 = január
      if (month === 6 || month === 7) return false;

      // Hétfő–péntek (1–5)
      const day = date.getDay();
      if (day < 1 || day > 5) return false;

      const hours = date.getHours();
      const minutes = date.getMinutes();
      const totalMinutes = hours * 60 + minutes;
      const startMinutes = 8 * 60 + 15;   // 08:15
      const endMinutes = 15 * 60 + 5;     // 15:05
      const inSchool = totalMinutes >= startMinutes && totalMinutes <= endMinutes;

      // Debug log – hogy lásd az aktuális időt + státuszt
      console.log('[Settings][Notifs][isInSchoolTime]', {
        now: date.toString(),
        month,
        day,
        hours,
        minutes,
        totalMinutes,
        inSchool
      });

      return inSchool;
    }

    function applyLocationMuteRule() {
      const soundsSwitch = document.getElementById('notificationsSoundsSwitch');
      const locationMuteSwitch = document.getElementById('notificationsLocationMuteSwitch');
      const silentBanner = document.querySelector('.notifications-silent-banner');

      const locationMute = !!notifSettings['location-mute'];

      // Alap érték kitöltése, ha hiányzik
      if (typeof notifSettings['sounds-outside-school'] !== 'boolean') {
        notifSettings['sounds-outside-school'] = !!notifSettings.sounds;
      }

      if (locationMute) {
        const inSchool = isInSchoolTime();
        console.log('[Settings][Notifs][applyLocationMuteRule]', {
          locationMute,
          sounds: notifSettings.sounds,
          soundsOutsideSchool: notifSettings['sounds-outside-school'],
          inSchool,
          bannerHidden: !!silentBanner?.classList.contains('is-hidden')
        });
        // Iskolai időben mindig némítunk, azon kívül az alap beállítást használjuk
        const effectiveSounds = !inSchool && !!notifSettings['sounds-outside-school'];
        notifSettings.sounds = effectiveSounds;

        if (soundsSwitch) {
          soundsSwitch.selected = effectiveSounds;
          soundsSwitch.disabled = true;
        }

        // Csendes mód banner csak aktív iskolai időben látszódjon
        if (silentBanner) {
          if (inSchool) {
            silentBanner.classList.remove('is-hidden');
          } else {
            silentBanner.classList.add('is-hidden');
          }
        }
      } else {
        // Helyzetalapú némítás kikapcsolva: visszaállunk a felhasználói alap beállításra
        const base = typeof notifSettings['sounds-outside-school'] === 'boolean'
          ? notifSettings['sounds-outside-school']
          : !!notifSettings.sounds;
        notifSettings.sounds = base;

        if (soundsSwitch) {
          soundsSwitch.selected = base;
          soundsSwitch.disabled = false;
        }

        if (silentBanner) {
          silentBanner.classList.add('is-hidden');
        }

        console.log('[Settings][Notifs][applyLocationMuteRule]', {
          locationMute,
          sounds: notifSettings.sounds,
          soundsOutsideSchool: notifSettings['sounds-outside-school'],
          inSchool: false,
          bannerHidden: !!silentBanner?.classList.contains('is-hidden')
        });
      }

      if (locationMuteSwitch) {
        locationMuteSwitch.selected = locationMute;
      }
    }

    function applySettingsToUI() {
      // Hangok + helyzetalapú némítás szabály alkalmazása
      applyLocationMuteRule();

      // Értesítő hang dropdown
      const soundDropdownContainer = document.getElementById('notificationSoundDropdown');
      if (soundDropdownContainer && window.LanguageDropdown) {
        // Töröljük az esetleges korábbi dropdown tartalmat, hogy ne duplikálódjon
        soundDropdownContainer.innerHTML = '';
        const bubble1 = getTranslationOr('bubble1', 'Bubble 1');
        const bubble2 = getTranslationOr('bubble2', 'Bubble 2');
        const bubble3 = getTranslationOr('bubble3', 'Bubble 3');
        const options = [bubble1, bubble2, bubble3];

        const value = notifSettings['notif-sound'] || 'notification1';
        const valueToIndex = { 'notification1': 0, 'notification2': 1, 'notification3': 2 };
        let selectedIndex = valueToIndex[value];
        if (typeof selectedIndex !== 'number') selectedIndex = 0;

        try {
          const dropdown = new window.LanguageDropdown(soundDropdownContainer, {
            options,
            selectedIndex,
            onChange: (selected, index) => {
              const indexToValue = ['notification1', 'notification2', 'notification3'];
              const mapped = indexToValue[index] || 'notification1';
              notifSettings['notif-sound'] = mapped;
              // Kattintáskor játsszuk le a megfelelő hangot (preview)
              const file = `${mapped}.wav`;
              try {
                const audio = new Audio(`assets/sounds/${file}`);
                audio.volume = 0.5;
                audio.play().catch(() => {});
              } catch (e) {
                console.warn('[Settings][Notifs] Preview sound error:', e);
              }
              // Apply gomb engedélyezése
              if (window.setApplyEnabled) {
                window.setApplyEnabled(true);
              }
            }
          });
          // UI re-init után is megtartjuk az értéket
          dropdown.setSelected(selectedIndex);
          dropdown.updateDisplay();
        } catch (e) {
          console.error('[Settings][Notifs] Failed to create notificationSoundDropdown:', e);
        }
      }

      // Push / Popup rendezés dropdownok
      const pushSortContainer = document.getElementById('pushSortDropdown');
      const popupSortContainer = document.getElementById('popupSortDropdown');
      const sortLabelCategories = getTranslationOr('categories_option', 'Kategóriák');
      const sortLabelAbc = getTranslationOr('abc_order_option', 'ABC Sorrend');
      const sortOptions = [sortLabelCategories, sortLabelAbc];

      const initSortDropdown = (container, key, applyFn) => {
        if (!container || !window.LanguageDropdown) return;
        // Töröljük az esetleges korábbi dropdown tartalmat, hogy ne duplikálódjon
        container.innerHTML = '';
        const current = notifSettings[key] === 'abc' ? 'abc' : 'categories';
        const selectedIndex = current === 'abc' ? 1 : 0;
        try {
          const dropdown = new window.LanguageDropdown(container, {
            options: sortOptions,
            selectedIndex,
            onChange: (selected, index) => {
              const mode = index === 1 ? 'abc' : 'categories';
              notifSettings[key] = mode;
              applyFn(mode);
              if (window.setApplyEnabled) {
                window.setApplyEnabled(true);
              }
            }
          });
          dropdown.setSelected(selectedIndex);
          dropdown.updateDisplay();
          applyFn(current);
        } catch (e) {
          console.error('[Settings][Notifs] Failed to create sort dropdown for', key, e);
        }
      };

      const pushContainer = document.getElementById('pushNotificationsChannels');
      const popupContainer = document.getElementById('popupNotificationsChannels');

      initSortDropdown(pushSortContainer, 'push-sort', (mode) => {
        applySort(pushContainer, mode, PUSH_CATEGORY_ORDER);
      });
      initSortDropdown(popupSortContainer, 'popup-sort', (mode) => {
        applySort(popupContainer, mode, POPUP_CATEGORY_ORDER);
      });

      // Csatorna kapcsolók
      const setSwitch = (id, value, forceDisabled = false) => {
        const el = document.getElementById(id);
        if (!el) return;
        if (forceDisabled) {
          el.selected = false;
          el.disabled = true;
        } else {
          el.selected = !!value;
        }
      };

      setSwitch('notifNewsSwitch', notifSettings.news);
      setSwitch('notifEventsSwitch', notifSettings.events);
      setSwitch('notifMessagesSwitch', notifSettings.messages, true);
      setSwitch('notifPostsSwitch', notifSettings.posts, true);
      setSwitch('notifInvitesSwitch', notifSettings.invites, true);
      setSwitch('notifNewThingsSwitch', notifSettings['new-things']);

      setSwitch('notifEventHubPopupSwitch', notifSettings['event-hub-popup'], true);
      setSwitch('notifNewThingsPopupSwitch', notifSettings['new-things-popup']);
      setSwitch('notifBetaPopupSwitch', notifSettings['beta-popup']);
      setSwitch('notifPopupsPopupSwitch', notifSettings['popups-popup']);

      // Nincs top-level Push / Popup kapcsoló – csak a csatorna kapcsolók állapotát tükrözzük
    }

    function attachNotificationEventHandlers() {
      const soundsSwitch = document.getElementById('notificationsSoundsSwitch');
      if (soundsSwitch) {
        soundsSwitch.addEventListener('click', () => {
          // Ha helyzetalapú némítás aktív, a rendszer kezeli – a felhasználó nem állíthatja
          if (notifSettings['location-mute']) {
            applyLocationMuteRule();
            return;
          }

          const newValue = !notifSettings.sounds;
          notifSettings.sounds = newValue;
          // Alap (iskolán kívüli) hang beállítás is frissül
          notifSettings['sounds-outside-school'] = newValue;
          soundsSwitch.selected = !!newValue;
          if (window.setApplyEnabled) window.setApplyEnabled(true);
        });
      }

      const locationMuteSwitch = document.getElementById('notificationsLocationMuteSwitch');
      if (locationMuteSwitch) {
        locationMuteSwitch.addEventListener('click', () => {
          notifSettings['location-mute'] = !notifSettings['location-mute'];
          locationMuteSwitch.selected = !!notifSettings['location-mute'];
          applyLocationMuteRule();
          if (window.setApplyEnabled) window.setApplyEnabled(true);
        });
      }

      const toggleHandler = (id, key, forceDisabled = false) => {
        const el = document.getElementById(id);
        if (!el) return;
        el.addEventListener('click', () => {
          if (forceDisabled) {
            el.selected = false;
            return;
          }
          notifSettings[key] = !notifSettings[key];
          el.selected = !!notifSettings[key];
          if (window.setApplyEnabled) window.setApplyEnabled(true);
        });
      };

      toggleHandler('notifNewsSwitch', 'news');
      toggleHandler('notifEventsSwitch', 'events');
      toggleHandler('notifMessagesSwitch', 'messages', true);
      toggleHandler('notifPostsSwitch', 'posts', true);
      toggleHandler('notifInvitesSwitch', 'invites', true);
      toggleHandler('notifNewThingsSwitch', 'new-things');

      toggleHandler('notifEventHubPopupSwitch', 'event-hub-popup', true);
      toggleHandler('notifNewThingsPopupSwitch', 'new-things-popup');
      toggleHandler('notifBetaPopupSwitch', 'beta-popup');
      toggleHandler('notifPopupsPopupSwitch', 'popups-popup');

      // Nincs globális push/popup switch – csak egyedi csatorna kapcsolók vannak

      // Csendes mód banner gombok
      const silentCloseBtn = document.getElementById('notificationsSilentCloseBtn');
      if (silentCloseBtn) {
        silentCloseBtn.addEventListener('click', () => {
          const banner = document.querySelector('.notifications-silent-banner');
          if (banner) banner.classList.add('is-hidden');
        });
      }
      const silentEnableSoundBtn = document.getElementById('notificationsSilentEnableSoundBtn');
      if (silentEnableSoundBtn) {
        silentEnableSoundBtn.addEventListener('click', () => {
          const openPopup = () => {
            const popup = document.getElementById('silentModeWarningPopup');
            const mainScroll = document.querySelector('.main-scroll-area');
            if (popup && mainScroll) {
              popup.style.display = 'flex';
              mainScroll.classList.add('popup-active');
            }
          };

          if (window.tryOpenPopup) {
            window.tryOpenPopup(openPopup);
          } else {
            openPopup();
          }
        });
      }

      // Csendes mód warning popup eventek
      const silentPopup = document.getElementById('silentModeWarningPopup');
      const silentPopupCloseBtn = document.getElementById('silentModeWarningCloseBtn');
      const silentPopupConfirmBtn = document.getElementById('silentModeWarningConfirmBtn');

      const closeSilentPopup = () => {
        const mainScroll = document.querySelector('.main-scroll-area');
        if (silentPopup) silentPopup.style.display = 'none';
        if (mainScroll) mainScroll.classList.remove('popup-active');
      };

      if (silentPopupCloseBtn) {
        silentPopupCloseBtn.addEventListener('click', () => {
          // Bezárás: semmi extra logika
          closeSilentPopup();
        });
      }

      if (silentPopupConfirmBtn) {
        silentPopupConfirmBtn.addEventListener('click', () => {
          // Csendes mód kikapcsolása mára: helyzetalapú némítás kikapcs, hang kontroll visszaadva
          notifSettings['location-mute'] = false;
          notifSettings.sounds = true;
          notifSettings['sounds-outside-school'] = true;
          applyLocationMuteRule();
          if (window.setApplyEnabled) window.setApplyEnabled(true);
          closeSilentPopup();
        });
      }
    }

    async function initFirebaseInstances() {
      try {
        const app = getApp();
        notifDb = window.db || getFirestore(app);
        notifAuth = window.auth || getAuth(app);
      } catch (e) {
        console.error('[Settings][Notifs] Failed to resolve Firebase app:', e);
        return;
      }

      onAuthStateChanged(notifAuth, async (user) => {
        currentUser = user;
        if (!user) {
          notifSettings = applyBetaLimits(readLocalNotifSettings());
          applySettingsToUI();
          return;
        }

        try {
          const ref = doc(notifDb, `users/${user.uid}/settings/notifs`);
          const snap = await getDoc(ref);
          if (snap.exists()) {
            const data = snap.data() || {};
            notifSettings = applyBetaLimits({ ...DEFAULT_NOTIF_SETTINGS, ...data });
          } else {
            notifSettings = applyBetaLimits({ ...DEFAULT_NOTIF_SETTINGS });
          }
        } catch (e) {
          console.error('[Settings][Notifs] Failed to load Firestore settings:', e);
          notifSettings = applyBetaLimits(readLocalNotifSettings());
        }
        applySettingsToUI();
      });
    }

    // Timetable folyamatos frissítése: percenként újraszámoljuk a csendes mód szabályt
    setInterval(() => {
      try {
        applyLocationMuteRule();
      } catch (e) {
        console.warn('[Settings][Notifs] Failed to apply location mute rule on interval:', e);
      }
    }, 60 * 1000);

    // Betöltéskor is azonnal lefuttatjuk a timetable szabályt
    try {
      applyLocationMuteRule();
    } catch (e) {
      console.warn('[Settings][Notifs] Failed to apply location mute rule on load:', e);
    }

    window.saveNotificationSettings = async () => {
      try {
        notifSettings = applyBetaLimits({ ...notifSettings });
        writeLocalNotifSettings(notifSettings);

        if (!notifDb || !notifAuth) {
          console.warn('[Settings][Notifs] Firebase not ready, only localStorage updated');
          return;
        }
        if (!currentUser) {
          console.warn('[Settings][Notifs] No user, skipping Firestore write');
          return;
        }

        const ref = doc(notifDb, `users/${currentUser.uid}/settings/notifs`);
        const payload = { ...notifSettings };
        try {
          const snap = await getDoc(ref);
          if (snap.exists()) {
            await updateDoc(ref, payload);
          } else {
            await setDoc(ref, payload);
          }
        } catch (e) {
          console.error('[Settings][Notifs] Error writing Firestore doc:', e);
        }
      } catch (e) {
        console.error('[Settings][Notifs] saveNotificationSettings fatal error:', e);
      }
    };

    document.addEventListener('DOMContentLoaded', () => {
      notifSettings = applyBetaLimits(readLocalNotifSettings());
      applySettingsToUI();
      attachNotificationEventHandlers();
      initFirebaseInstances();
    });
  </script>
  <script type="module">
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
    import { doc, getDoc } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

    // Edition dekódolás
    function decodeEdition(edition) {
      if (!edition || edition.length !== 3) return { type: '', status: '' };
      
      const second = edition[1];
      const third = edition[2];
      
      let type = '';
      let status = '';
      
      // Második betű: b = Béta, r = Általános (Release)
      if (second === 'b') {
        type = 'Béta';
      } else if (second === 'r') {
        type = 'Általános';
      }
      
      // Harmadik betű: c = Zárt (Closed), o = Nyílt (Open)
      if (third === 'c') {
        status = 'Zárt';
      } else if (third === 'o') {
        status = 'Nyílt';
      }
      
      // Magyar nyelv miatt: Zárt előbb, aztán a típus
      return { type, status };
    }

    // Fordítások
    const translations = {
      'hu': {
        'Béta': 'Béta',
        'Általános': 'Általános',
        'Zárt': 'Zárt',
        'Nyílt': 'Nyílt',
        'van': 'van',
        'nincs': 'nincs'
      },
      'en': {
        'Béta': 'Beta',
        'Általános': 'General',
        'Zárt': 'Closed',
        'Nyílt': 'Open',
        'van': 'Yes',
        'nincs': 'No'
      },
      'de': {
        'Béta': 'Beta',
        'Általános': 'Allgemein',
        'Zárt': 'Geschlossen',
        'Nyílt': 'Offen',
        'van': 'Ja',
        'nincs': 'Nein'
      },
      'es': {
        'Béta': 'Beta',
        'Általános': 'General',
        'Zárt': 'Cerrado',
        'Nyílt': 'Abierto',
        'van': 'Sí',
        'nincs': 'No'
      },
      'fr': {
        'Béta': 'Bêta',
        'Általános': 'Général',
        'Zárt': 'Fermé',
        'Nyílt': 'Ouvert',
        'van': 'Oui',
        'nincs': 'Non'
      },
      'zh': {
        'Béta': '测试版',
        'Általános': '通用',
        'Zárt': '封闭',
        'Nyílt': '开放',
        'van': '是',
        'nincs': '否'
      },
      'ja': {
        'Béta': 'ベータ',
        'Általános': '一般',
        'Zárt': '閉鎖',
        'Nyílt': '開放',
        'van': 'はい',
        'nincs': 'いいえ'
      },
      'sv': {
        'Béta': 'Beta',
        'Általános': 'Allmän',
        'Zárt': 'Stängd',
        'Nyílt': 'Öppen',
        'van': 'Ja',
        'nincs': 'Nej'
      },
      'ru': {
        'Béta': 'Бета',
        'Általános': 'Общий',
        'Zárt': 'Закрытый',
        'Nyílt': 'Открытый',
        'van': 'Да',
        'nincs': 'Нет'
      }
    };

    function translate(text, lang) {
      const langTranslations = translations[lang] || translations['hu'];
      return langTranslations[text] || text;
    }

    async function loadAboutData() {
      try {
        const auth = getAuth();
        const currentLang = window.translationManager?.currentLanguage || localStorage.getItem('eu2k_language') || 'hu';
        
        onAuthStateChanged(auth, async (user) => {
          if (!user) {
            // Ha nincs bejelentkezve, próbáljuk localStorage-ból
            const localVersion = localStorage.getItem('eu2k_version');
            const localEdition = localStorage.getItem('eu2k_edition');
            
            if (localVersion) {
              document.getElementById('aboutVersion').textContent = localVersion;
            }
            
            if (localEdition) {
              const decoded = decodeEdition(localEdition);
              const editionText = decoded.status && decoded.type 
                ? `${translate(decoded.status, currentLang)} ${translate(decoded.type, currentLang)}`
                : localEdition;
              document.getElementById('aboutEdition').textContent = editionText;
            }
            
            return;
          }

          const userId = user.uid;
          
          // Webinfo betöltése
          try {
            const webinfoRef = doc(window.db, `users/${userId}/webinfo/webinfo`);
            const webinfoSnap = await getDoc(webinfoRef);
            
            if (webinfoSnap.exists()) {
              const webinfo = webinfoSnap.data();
              const version = webinfo.version || '-';
              const edition = webinfo.edition || '-';
              
              // Verzió megjelenítése
              document.getElementById('aboutVersion').textContent = version;
              
              // Edition dekódolás és megjelenítés
              if (edition && edition !== '-') {
                const decoded = decodeEdition(edition);
                if (decoded.status && decoded.type) {
                  const editionText = `${translate(decoded.status, currentLang)} ${translate(decoded.type, currentLang)}`;
                  document.getElementById('aboutEdition').textContent = editionText;
                } else {
                  document.getElementById('aboutEdition').textContent = edition;
                }
              } else {
                document.getElementById('aboutEdition').textContent = '-';
              }
              
              // localStorage-ba mentés
              localStorage.setItem('eu2k_version', version);
              localStorage.setItem('eu2k_edition', edition);
            }
          } catch (error) {
            console.error('Error loading webinfo:', error);
          }
          
          // Version kollekció betöltése
          try {
            // Maintainer
            const maintainerRef = doc(window.db, 'version/maintainer');
            const maintainerSnap = await getDoc(maintainerRef);
            if (maintainerSnap.exists()) {
              const maintainer = maintainerSnap.data();
              document.getElementById('aboutMaintainedBy').textContent = maintainer.name || '-';
            }
            
            // Publisher
            const publisherRef = doc(window.db, 'version/publisher');
            const publisherSnap = await getDoc(publisherRef);
            if (publisherSnap.exists()) {
              const publisher = publisherSnap.data();
              document.getElementById('aboutPublishedBy').textContent = publisher.name || '-';
            }
            
            // Owner
            const ownerRef = doc(window.db, 'version/owner');
            const ownerSnap = await getDoc(ownerRef);
            if (ownerSnap.exists()) {
              const owner = ownerSnap.data();
              document.getElementById('aboutCreatedBy').textContent = owner.name || '-';
            }
            
            // Info
            const infoRef = doc(window.db, 'version/info');
            const infoSnap = await getDoc(infoRef);
            if (infoSnap.exists()) {
              const info = infoSnap.data();
              
              // UI név és verzió
              if (info['ui-name']) {
                document.getElementById('aboutUIName').textContent = info['ui-name'] === '-' ? '-' : info['ui-name'];
              }
              if (info['ui-version']) {
                document.getElementById('aboutUIVersion').textContent = info['ui-version'] === '-' ? '-' : info['ui-version'];
              }
              
              // Kernel verzió
              if (info['kernel-version']) {
                document.getElementById('aboutKernelVersion').textContent = info['kernel-version'] === '-' ? '-' : info['kernel-version'];
              }
              
              // Komponens verziók
              if (info['yhc-version']) {
                document.getElementById('aboutYHCVersion').textContent = info['yhc-version'] === '-' ? '-' : info['yhc-version'];
              }
              if (info['chc-version']) {
                document.getElementById('aboutCHCVersion').textContent = info['chc-version'] === '-' ? '-' : info['chc-version'];
              }
              if (info['fihc-version']) {
                document.getElementById('aboutFIHCVersion').textContent = info['fihc-version'] === '-' ? '-' : info['fihc-version'];
              }
              if (info['fohc-version']) {
                document.getElementById('aboutFOHCVersion').textContent = info['fohc-version'] === '-' ? '-' : info['fohc-version'];
              }
              if (info['ehc-version']) {
                document.getElementById('aboutEHCVersion').textContent = info['ehc-version'] === '-' ? '-' : info['ehc-version'];
              }
              
              // EU2K Suite
              if (info.eu2ksuite !== undefined) {
                const suiteText = info.eu2ksuite ? translate('van', currentLang) : translate('nincs', currentLang);
                document.getElementById('aboutEU2KSuite').textContent = suiteText;
              }
            }
          } catch (error) {
            console.error('Error loading version data:', error);
          }
        });
      } catch (error) {
        console.error('Error in loadAboutData:', error);
      }
    }

    // Betöltés oldal betöltésekor
    document.addEventListener('DOMContentLoaded', () => {
      loadAboutData();
      
      // Nyelvváltáskor is frissítjük
      if (window.translationManager) {
        const originalOnLanguageChange = window.translationManager.onLanguageChange;
        window.translationManager.onLanguageChange = () => {
          if (originalOnLanguageChange) originalOnLanguageChange();
          loadAboutData();
        };
      }
    });
  </script>

  <!-- Developer Mode Popup -->
  <div id="devModePopup" class="permission-overlay-scroll-area" style="display: none;">
    <div class="permission-container">
      <button class="permission-close-btn" onclick="closeDevModePopup()">
        <img src="assets/general/close.svg" alt="Bezárás">
      </button>
      <div class="permission-content">
        <h2 class="permission-title" data-translate="youhub.dev_mode.title" data-translate-fallback="Developer Mód">Developer Mód</h2>
        <p class="permission-text" data-translate="youhub.dev_mode.text" data-translate-fallback="Jelszó megadása:">Jelszó megadása:</p>
        <input type="password" id="devModePassword" class="dev-mode-input" data-translate-placeholder="youhub.dev_mode.password_placeholder" placeholder="Jelszó">
        <button class="permission-ok-btn" onclick="checkDevModePassword()" data-translate="youhub.dev_mode.login_button" data-translate-fallback="Bejelentkezés">Bejelentkezés</button>
      </div>
    </div>
  </div>

  <script src="assets/js/developer-mode.js"></script>
  <script src="assets/js/account-tooltip.js"></script>
</body>
</html>
