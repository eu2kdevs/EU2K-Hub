<!DOCTYPE html>
<html lang="hu">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description"
    content="Találd mg osztályod teljesítményét, értesítéseid, javasolj ötletetket, promprokat másoknak, órarend, csengetési rend, dolgozatok és még sok más!">
  <title data-translate="pages.youhub.title" data-translate-fallback="YouHub">YouHub</title>
  <link rel="stylesheet" href="youhub.css">
  <link rel="stylesheet" href="assets/css/consent-banner.css">
  <link rel="icon" href="favicon.ico">
  <script>
    (function () {
      if (!document.getElementById('eu2k-page-overlay')) {
        var o = document.createElement('div');
        o.id = 'eu2k-page-overlay';
        o.style.cssText = 'position:fixed;inset:0;z-index:9999;background:#000000;border-radius:32px;opacity:1;transition:opacity 300ms ease-in-out;';
        var inner = document.createElement('div');
        inner.style.cssText = 'position:relative;width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:#000000;border-radius:32px;';
        var m = document.createElement('div');
        m.id = 'eu2k-overlay-mount';
        m.style.cssText = 'position:relative;width:100%;height:100%';
        inner.appendChild(m);
        o.appendChild(inner);
        document.documentElement.appendChild(o);
      }
    })();
  </script>
  <script type="importmap">
    {
      "imports": {
        "@material/web/": "https://esm.run/@material/web/"
      }
    }
  </script>
  <script type="module">
    import '@material/web/all.js';
    import { styles as typescaleStyles } from '@material/web/typography/md-typescale-styles.js';

    document.adoptedStyleSheets.push(typescaleStyles.styleSheet);
  </script>
  <style>
    /* Typography imports to match Figma */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto:ital,wght@0,100..900;1,100..900&display=swap');

    body,
    * {
      font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      font-optical-sizing: auto;
      font-weight: 400;
      font-style: normal;
      font-variation-settings: "wdth" 100;
    }


    /* Footer links spacing */
    .footer-center {
      display: flex;
      gap: 8px;
      align-items: center;
      justify-content: center;
    }
  </style>
  <script src="assets/js/page-overlay-loader.js"></script>
  <script src="assets/js/permissions.js"></script>
  <script src="assets/js/translations.js"></script>
  <script src="assets/js/account-tooltip.js"></script>
  <script src="assets/js/staff-timer.js"></script>
  <script src="assets/js/staff-nav-items.js"></script>
  <script src="assets/js/auth-state.js"></script>
  <script src="assets/js/test_firebase.js" type="module"></script>
  <script src="assets/js/firebase-performance.js" type="module"></script>
  <script src="assets/js/youhub-notification-toaster.js" type="module"></script>
  <script src="assets/js/admin-console.js"></script>
  <script src="assets/js/consent-banner.js"></script>
  <script type="module" src="assets/js/student-calendar.js"></script>

  <script type="text/javascript" data-gdpr-required>
    // Clarity tracking - silently fail if blocked by adblocker
    try {
      (function (c, l, a, r, i, t, y) {
        c[a] = c[a] || function () { (c[a].q = c[a].q || []).push(arguments) };
        t = l.createElement(r); t.async = 1; t.src = "https://www.clarity.ms/tag/" + i;
        t.onerror = function () { /* Silently ignore if blocked */ };
        y = l.getElementsByTagName(r)[0];
        if (y && y.parentNode) {
          y.parentNode.insertBefore(t, y);
        }
      })(window, document, "clarity", "script", "s6n7qpfkv4");
    } catch (e) {
      // Silently ignore Clarity tracking errors (e.g., blocked by adblocker)
    }
  </script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-analytics.js";
    import { getFirestore, collection, onSnapshot, query, orderBy, limit, startAfter, getDocs, doc, getDoc, deleteDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
    import { getStorage, ref as storageRef, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-storage.js";
    import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-functions.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBRRVx6BtQtCDKjFYA8yh9qYrcUONmkkwI",
      authDomain: "eu2k-hub.firebaseapp.com",
      projectId: "eu2k-hub",
      storageBucket: "eu2k-hub.firebasestorage.app",
      messagingSenderId: "560244867055",
      appId: "1:560244867055:web:3cd51b85baead94989001a",
      measurementId: "G-2JDPR089WD"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    // Firebase Analytics csak GDPR beleegyezés után inicializálódik
    let analytics = null;
    if (window.eu2kGDPR && window.eu2kGDPR.hasConsent()) {
      analytics = getAnalytics(app);
    } else {
      // Várunk a GDPR beleegyezésre
      window.addEventListener('eu2k-gdpr-scripts-loaded', () => {
        if (!analytics) {
          analytics = getAnalytics(app);
        }
      });
    }
    const db = getFirestore(app);
    const storage = getStorage(app);
    const functions = getFunctions(app, 'europe-west1');

    // Make db, app and functions globally available
    window.db = db;
    window.firebaseApp = app;
    window.functions = functions;
    window.createHttpsCallable = (name) => httpsCallable(functions, name);
    window.storage = storage;

    // Helper function to show notification using toaster system
    // priority: 'positive' (confirmations), 'warning' (missing info), 'danger' (errors, wrong data, deletions)
    window.showNotification = async (message, title = null, priority = 'green') => {
      if (!title) {
        title = window.translationManager?.getTranslation('youhub.default_notification_title') || 'Értesítés';
      }
      try {
        // Wait a bit for showToastDirectly to be available (if module is still loading)
        let attempts = 0;
        while (!window.showToastDirectly && attempts < 10) {
          await new Promise(resolve => setTimeout(resolve, 50));
          attempts++;
        }

        // First try to use showToastDirectly if available (faster, no Firestore needed)
        if (window.showToastDirectly && typeof window.showToastDirectly === 'function') {
          window.showToastDirectly(title, message, priority, 'info');
          return;
        }

        // Fallback to Firestore method
        const { getAuth } = await import("https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js");
        const appToUse = window.firebaseApp || app;
        const auth = getAuth(appToUse);

        if (!auth.currentUser) {
          // Fallback to alert if not logged in
          alert(message);
          return;
        }
        const { doc, setDoc, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js");
        const dbToUse = window.db || db;
        const notificationRef = doc(dbToUse, `users/${auth.currentUser.uid}/notifs`, Date.now().toString());
        await setDoc(notificationRef, {
          title: title,
          content: message,
          type: 'message',
          priority: priority,
          icon: 'info',
          date: serverTimestamp(),
          action: 'view'
        });
      } catch (error) {
        console.error('[Notification] Failed to create notification:', error);
        // Fallback to alert
        alert(message);
      }
    };

    // Import Firestore debug module
    import('./assets/js/firestore-debug.js').catch(err => {
      console.warn('Firestore debug module not loaded:', err);
    });

    // Import Firebase test module
    import('./assets/js/test_firebase.js').catch(err => {
      console.warn('Firebase test module not loaded:', err);
    });

    // Info banner persistence (hide on close, remember in localStorage)
    try {
      const INFO_BANNER_KEY = 'eu2k-hide-info-banner';
      const banner = document.querySelector('.info-banner');
      // Ensure default key exists and is 'false' (banner shown by default)
      try { if (localStorage.getItem(INFO_BANNER_KEY) === null) localStorage.setItem(INFO_BANNER_KEY, 'false'); } catch (_) { }

      // BEFORE anything else: if key is true, do not show banner at all
      try {
        if (localStorage.getItem(INFO_BANNER_KEY) === 'true' && banner) {
          banner.style.setProperty('display', 'none', 'important');
          // notify spacing logic
          try { window.dispatchEvent(new Event('eu2k-banner-visibility-changed')); } catch (_) { }
        }
      } catch (_) { }

      // Use capture on the whole document to guarantee we see the click
      document.addEventListener('click', (e) => {
        const target = e.target && e.target.closest ? e.target.closest('.info-banner .banner-btn') : null;
        if (!target) return;
        e.preventDefault();
        e.stopPropagation();
        const isPrimary = target.classList.contains('primary');
        const isSecondary = target.classList.contains('secondary');
        if (isPrimary) {
          try { localStorage.setItem(INFO_BANNER_KEY, 'true'); console.log('[InfoBanner] Close clicked → stored flag'); } catch (err) { console.warn('[InfoBanner] LS write failed', err); }
          const b = document.querySelector('.info-banner');
          if (b) { b.style.setProperty('display', 'none', 'important'); console.log('[InfoBanner] Banner hidden via click'); }
          try { window.dispatchEvent(new Event('eu2k-banner-visibility-changed')); } catch (_) { }
          return false;
        }
        if (isSecondary) {
          try { console.log('[InfoBanner] Feedback clicked'); window.open('#feedback', '_blank'); } catch (err) { console.warn('[InfoBanner] Feedback open failed', err); }
          return false;
        }
      }, true);
    } catch (e) { /* no-op */ }

    // Warning banner persistence (hide on close, remember in localStorage)
    try {
      const WARNING_BANNER_KEY = 'eu2k-hide-warning-banner';
      const warningBanner = document.querySelector('.warning-banner');
      // Ensure default key exists and is 'false' (banner shown by default)
      try { if (localStorage.getItem(WARNING_BANNER_KEY) === null) localStorage.setItem(WARNING_BANNER_KEY, 'false'); } catch (_) { }

      // BEFORE anything else: if key is true, do not show banner at all
      try {
        if (localStorage.getItem(WARNING_BANNER_KEY) === 'true' && warningBanner) {
          warningBanner.style.setProperty('display', 'none', 'important');
          // notify spacing logic
          try { window.dispatchEvent(new Event('eu2k-banner-visibility-changed')); } catch (_) { }
        }
      } catch (_) { }

      // Use capture on the whole document to guarantee we see the click
      document.addEventListener('click', (e) => {
        const target = e.target && e.target.closest ? e.target.closest('.warning-banner .banner-btn') : null;
        if (!target) return;
        e.preventDefault();
        e.stopPropagation();
        const isPrimary = target.classList.contains('primary');
        const isSecondary = target.classList.contains('secondary');
        if (isPrimary) {
          try { localStorage.setItem(WARNING_BANNER_KEY, 'true'); console.log('[WarningBanner] Close clicked → stored flag'); } catch (err) { console.warn('[WarningBanner] LS write failed', err); }
          const b = document.querySelector('.warning-banner');
          if (b) { b.style.setProperty('display', 'none', 'important'); console.log('[WarningBanner] Banner hidden via click'); }
          try { window.dispatchEvent(new Event('eu2k-banner-visibility-changed')); } catch (_) { }
          return false;
        }
        if (isSecondary) {
          try { console.log('[WarningBanner] Feedback clicked'); window.open('#feedback', '_blank'); } catch (err) { console.warn('[WarningBanner] Feedback open failed', err); }
          return false;
        }
      }, true);
    } catch (e) { /* no-op */ }

    /* ---------------------- QR SCANNER INIT ----------------------- */
    // QR Scanner logic will be added below after checking camera permissions
  </script>
</head>

<body>

  <div class="app-bg">
    <!-- Sidebar / Navigation Rail (left) -->
    <aside class="sidebar" role="navigation" aria-label="Fő navigáció">
      <div class="nav-frame">
        <div class="nav-shell">
          <nav class="nav-rail">
            <a class="rail-item nav-btn" href="index.html" aria-current="page">
              <div class="rail-icon">
                <img src="assets/navbar/home.svg" alt="Otthon" />
              </div>
              <span class="rail-label" data-translate="navigation.home">Otthon</span>
            </a>

            <a class="rail-item nav-btn" href="qr-code.html">
              <div class="rail-icon">
                <img src="assets/navbar/qr_code.svg" alt="QR-Kód" />
              </div>
              <span class="rail-label" data-translate="navigation.qr" data-translate-fallback="QR-Kód">QR-Kód</span>
            </a>

            <a class="rail-item nav-btn is-active" href="youhub.html">
              <div class="rail-icon">
                <img src="assets/navbar/youhub.svg" alt="YouHub" />
              </div>
              <span class="rail-label" data-translate="navigation.youhub">YouHub</span>
            </a>

            <!-- <a class="rail-item nav-btn" href="class_hub.html">
              <div class="rail-icon">
                <img src="assets/navbar/class_hub.svg" alt="Class Hub" />
              </div>
              <span class="rail-label">Class Hub</span>
            </a> -->

            <!-- <a class="rail-item nav-btn" href="event_hub.html">
              <div class="rail-icon">
                  <img src="assets/navbar/event_hub.svg" alt="Event Hub" />
              </div>
              <span class="rail-label" data-translate="navigation.event_hub">Event Hub</span>
            </a> -->

            <!-- <a class="rail-item nav-btn" href="food_hub.html">
              <div class="rail-icon">
                <img src="assets/navbar/food_hub.svg" alt="Food Hub" />
              </div>
              <span class="rail-label">Food Hub</span>
            </a> -->
          </nav>
        </div>
      </div>
    </aside>

    <main class="main-area">
      <div class="main-scroll-area">
        <!-- Header -->
        <header class="header">
          <div class="header-content">
            <div class="welcome-container">
              <img src="assets/navbar/youhub.svg" class="welcome-icon" alt="Welcome">
              <span class="welcome-text" data-translate="pages.youhub.title">YouHub</span>
            </div>
            <div class="header-icon-container">
              <div class="header-icon-gradient">
                <div class="header-icon-wrapper" id="headerSettingsWrapper">
                  <a href="settings.html" class="header-icon-btn" id="headerSettingsBtn">
                    <img src="assets/general/settings.svg" alt="Settings">
                  </a>
                </div>
                <div class="header-icon-wrapper" id="headerAccountWrapper" style="display: none;">
                  <button class="header-icon-btn" id="headerAccountBtn">
                    <img src="assets/general/account.svg" alt="Account">
                  </button>
                </div>
                <button class="header-login-btn" id="headerLoginBtn" data-translate="pages.general.login"
                  style="display: none;">
                  Bejelentkezés
                </button>
                <button class="header-edit-mode-btn" id="headerEditModeBtn">
                  <img class="header-edit-mode-icon" src="assets/youhub/edit.svg" alt="Szerkesztés">
                  <span class="header-edit-mode-text" data-translate="youhub.edit_mode.enter"
                    data-translate-fallback="Szerkesztés">Szerkesztés</span>
                </button>
              </div>
            </div>
          </div>
          <!-- Notification / Info Banner -->
          <section class="info-banner" aria-label="Információ">
            <div class="info-banner-icon-container">
              <img class="info-banner-icon" src="assets/general/banners/info.svg" alt="Info" />
            </div>
            <div class="banner-content">
              <div class="banner-texts">
                <span class="info-banner-title" data-translate="youhub.banners.info.title"
                  data-translate-fallback="Ez az új dizájn.">Ez az új dizájn.</span>
                <span class="info-banner-desc" data-translate="youhub.banners.info.description"
                  data-translate-fallback="Reméljük neked is tetszik az Európa Dizájn Rendszer. Ha bármi kétséged van, jelezz vissza, akár innen is.">Reméljük
                  neked is tetszik az Európa Dizájn Rendszer. Ha bármi kétséged van, jelezz vissza, akár innen
                  is.</span>
              </div>
              <div class="banner-actions-wrapper">
                <div class="banner-actions">
                  <button class="banner-btn secondary" type="button" data-translate="youhub.banners.info.feedback"
                    data-translate-fallback="Visszajelzés">Visszajelzés</button>
                  <button class="banner-btn primary" type="button" data-translate="youhub.banners.info.close"
                    data-translate-fallback="Bezárás">Bezárás</button>
                </div>
              </div>
            </div>
          </section>
          <!-- Warning Banner -->
          <section class="warning-banner" aria-label="Figyelmeztetés">
            <div class="warning-banner-icon-container">
              <img class="warning-banner-icon" src="assets/general/banners/info_md.svg" alt="Warning" />
            </div>
            <div class="banner-content">
              <div class="banner-texts">
                <span class="warning-banner-title" data-translate="youhub.banners.warning.title"
                  data-translate-fallback="A YouHub még bétaverzióban van.">A YouHub még bétaverzióban van.</span>
                <span class="warning-banner-desc" data-translate="youhub.banners.warning.description"
                  data-translate-fallback="Örülünk hogy érdeklődsz a YouHub iránt, viszont vedd figyelembe, még nem befejezett szoftvert használsz.">Örülünk
                  hogy érdeklődsz a YouHub iránt, viszont vedd figyelembe, még nem befejezett szoftvert
                  használsz.</span>
              </div>
              <div class="banner-actions-wrapper">
                <div class="warning-banner-actions">
                  <button class="banner-btn secondary" type="button" data-translate="youhub.banners.info.feedback"
                    data-translate-fallback="Visszajelzés">Visszajelzés</button>
                  <button class="banner-btn primary" type="button" data-translate="youhub.banners.info.close"
                    data-translate-fallback="Bezárás">Bezárás</button>
                </div>
              </div>
            </div>
          </section>
        </header>

        <!-- Revert Popup (overlays main-scroll-area) -->
        <div id="revertPopup" class="permission-overlay-scroll-area" style="display: none;">
          <div class="permission-container">
            <button class="permission-close-btn" onclick="closeRevertPopup()">
              <img src="assets/general/close.svg" alt="Bezárás">
            </button>
            <div class="permission-content">
              <img src="assets/youhub/calendar/nothing_seems_to_be_here.svg" class="permission-icon-large"
                alt="Visszaállítás">
              <h2 class="permission-title" data-translate="youhub.revert.title"
                data-translate-fallback="Biztos visszaállítod a sorrendet?">Biztos visszaállítod a sorrendet?</h2>
              <p class="permission-text" data-translate="youhub.revert.text"
                data-translate-fallback="Ezzel a mostani elrendezésed elveszik, vissza kell állítanod manuálisan!">Ezzel
                a mostani elrendezésed elveszik, vissza kell állítanod manuálisan!</p>
              <button class="permission-ok-btn" onclick="confirmRevert()" data-translate="youhub.revert.button"
                data-translate-fallback="Visszaállítás">Visszaállítás</button>
            </div>
          </div>
        </div>

        <!-- Developer Mode Popup -->
        <div id="devModePopup" class="permission-overlay-scroll-area" style="display: none;">
          <div class="permission-container">
            <button class="permission-close-btn" onclick="closeDevModePopup()">
              <img src="assets/general/close.svg" alt="Bezárás">
            </button>
            <div class="permission-content">
              <h2 class="permission-title" data-translate="youhub.dev_mode.title"
                data-translate-fallback="Developer Mód">Developer Mód</h2>
              <p class="permission-text" data-translate="youhub.dev_mode.text"
                data-translate-fallback="Jelszó megadása:">Jelszó megadása:</p>
              <input type="password" id="devModePassword" class="dev-mode-input"
                data-translate-placeholder="youhub.dev_mode.password_placeholder" placeholder="Jelszó">
              <button class="permission-ok-btn" onclick="checkDevModePassword()"
                data-translate="youhub.dev_mode.login_button"
                data-translate-fallback="Bejelentkezés">Bejelentkezés</button>
            </div>
          </div>
        </div>

        <div class="main-content">
          <div class="youhub-grid-controls">
            <button class="youhub-revert-btn" id="youhubRevertBtn" style="display: none;">
              <img class="youhub-revert-icon" src="assets/youhub/notifications/history.svg" alt="Visszaállítás">
              <span class="youhub-revert-text" data-translate="youhub.revert.button"
                data-translate-fallback="Visszaállítás">Visszaállítás</span>
            </button>
          </div>
          <div class="youhub-grid">
            <div class="youhub-card" data-card-id="class" draggable="false">
              <div class="youhub-card-content myclass-card-content">
                <!-- Top Section -->
                <div class="myclass-top-section">
                  <img src="assets/youhub/myclass/class.svg" alt="Osztályom" class="myclass-icon">
                  <h2 class="myclass-title" data-translate="youhub.myclass.title" data-translate-fallback="Osztályom">
                    Osztályom</h2>
                </div>
                <!-- Middle Section -->
                <div class="myclass-middle-section">
                  <div class="myclass-sidebar">
                    <div class="myclass-sidebar-panel">
                      <div class="myclass-sidebar-navbar">
                        <div class="myclass-sidebar-nav-item">5.00</div>
                        <div class="myclass-sidebar-nav-item">4.00</div>
                        <div class="myclass-sidebar-nav-item">3.00</div>
                        <div class="myclass-sidebar-nav-item">2.00</div>
                        <div class="myclass-sidebar-nav-item">1.00</div>
                      </div>
                    </div>
                  </div>
                  <div class="myclass-main">
                    <div class="myclass-main-panel">
                      <div class="myclass-main-content">
                        <div class="myclass-chart-container">
                          <div class="myclass-chart-column myclass-chart-column--first"></div>
                          <div class="myclass-chart-column myclass-chart-column--first"></div>
                          <div class="myclass-chart-column myclass-chart-column--first"></div>
                          <div class="myclass-chart-column myclass-chart-column--middle"></div>
                          <div class="myclass-chart-column myclass-chart-column--middle"></div>
                          <div class="myclass-chart-column myclass-chart-column--highlight"></div>
                          <div class="myclass-chart-column myclass-chart-column--last"></div>
                          <div class="myclass-chart-column myclass-chart-column--last"></div>
                          <div class="myclass-chart-column myclass-chart-column--last"></div>
                        </div>
                      </div>
                    </div>
                    <div class="myclass-secondary-panel">
                      <div class="myclass-indicator-container">
                        <div class="myclass-indicator-item myclass-indicator-item--first">1</div>
                        <div class="myclass-indicator-item myclass-indicator-item--first">2</div>
                        <div class="myclass-indicator-item myclass-indicator-item--first">3</div>
                        <div class="myclass-indicator-item myclass-indicator-item--middle">4</div>
                        <div class="myclass-indicator-item myclass-indicator-item--middle">5</div>
                        <div class="myclass-indicator-item myclass-indicator-item--highlight">6</div>
                        <div class="myclass-indicator-item myclass-indicator-item--last">7</div>
                        <div class="myclass-indicator-item myclass-indicator-item--last">8</div>
                        <div class="myclass-indicator-item myclass-indicator-item--last">9</div>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- Bottom Section (duplicated top-section) -->
                <div class="myclass-bottom-section">
                  <div class="myclass-navbar myclass-navbar--scope-myclass">
                    <button class="myclass-nav-item active" data-tab="month">
                      <img src="assets/youhub/myclass/graph.svg" alt="Osztályom Hónapja">
                      <span data-translate="youhub.myclass.month" data-translate-fallback="Osztályom Hónapja">Osztályom
                        Hónapja</span>
                    </button>
                    <button class="myclass-nav-item" data-tab="suggestions">
                      <img src="assets/youhub/myclass/suggestions.svg" alt="Osztály Javaslatai">
                      <span data-translate="youhub.myclass.suggestions"
                        data-translate-fallback="Osztály Javaslatai">Osztály Javaslatai</span>
                    </button>
                    <button class="myclass-nav-item" data-tab="info">
                      <img src="assets/youhub/myclass/info.svg" alt="Információ">
                      <span data-translate="youhub.myclass.info" data-translate-fallback="Információ">Információ</span>
                    </button>
                  </div>
                  <button class="myclass-arrow-btn">
                    <img src="assets/youhub/myclass/arrow.svg" alt="Tovább">
                  </button>
                </div>
              </div>
              <div class="youhub-card-handle"></div>
            </div>
            <div class="youhub-card" data-card-id="notifications" draggable="false">
              <div class="youhub-card-content notifications-card-content">
                <div class="notifications-top-section">
                  <img src="assets/youhub/notifications/bell.svg" alt="Értesítések" class="notifications-icon">
                  <h2 class="notifications-title" data-translate="youhub.notifications.title"
                    data-translate-fallback="Értesítések">Értesítések</h2>
                  <button class="notifications-history-btn" type="button">
                    <img src="assets/youhub/notifications/history.svg" alt="Előzmények"
                      class="notifications-history-icon">
                    <span class="notifications-history-text" data-translate="youhub.notifications.history"
                      data-translate-fallback="Előzmények">Előzmények</span>
                  </button>
                </div>
                <div class="notifications-middle-section">
                  <div class="notifications-column notifications-column--left">
                    <div class="notifications-header-container">
                      <span class="notifications-header-text" data-translate="youhub.notifications.title"
                        data-translate-fallback="Értesítések">Értesítések</span>
                    </div>
                    <div class="notifications-empty-state" id="notificationsEmptyState">
                      <img src="assets/youhub/notifications/no_bell.svg" alt="Nincs értesítés"
                        class="notifications-empty-icon">
                      <div class="notifications-empty-text-container">
                        <p class="notifications-empty-title" data-translate="youhub.notifications.empty.title"
                          data-translate-fallback="Nincsenek értesítéseid">Nincsenek értesítéseid</p>
                        <p class="notifications-empty-subtitle" data-translate="youhub.notifications.empty.subtitle"
                          data-translate-fallback="Nézz vissza később :D">Nézz vissza később :D</p>
                      </div>
                    </div>
                    <div class="notifications-list-container" id="notificationsListContainer" style="display: none;">
                      <div class="notifications-list">
                        <!-- Items will be generated here -->
                      </div>
                      <div class="notifications-list-fade"></div>
                    </div>
                  </div>
                  <div class="notifications-column notifications-column--right">
                    <div class="notifications-empty-state" id="notificationsRightEmptyState">
                      <img src="assets/youhub/notifications/bell.svg" alt="Értesítések"
                        class="notifications-empty-icon notifications-empty-icon--right">
                      <div class="notifications-empty-text-container">
                        <p class="notifications-empty-title" data-translate="youhub.notifications.detail.title"
                          data-translate-fallback="Értesítések">Értesítések</p>
                        <p class="notifications-empty-subtitle" data-translate="youhub.notifications.detail.subtitle"
                          data-translate-fallback="Válassz ki egy értesítést">Válassz ki egy értesítést</p>
                      </div>
                    </div>
                    <div class="notifications-detail-view" id="notificationsDetailView" style="display: none;">
                      <!-- Detail content will be generated here -->
                    </div>
                  </div>
                </div>
              </div>
              <div class="youhub-card-handle"></div>
            </div>
            <div class="youhub-card" data-card-id="suggestions" draggable="false">
              <div class="youhub-card-content suggestions-card-content">
                <div class="suggestions-top-section">
                  <img src="assets/youhub/suggestions/suggestion.svg" alt="Javaslatok" class="suggestions-icon">
                  <h2 class="suggestions-title" data-translate="youhub.suggestions.title"
                    data-translate-fallback="Javaslatok">Javaslatok</h2>
                </div>
                <div class="suggestions-middle-section">
                  <div class="suggestions-nav-shell">
                    <div class="myclass-navbar myclass-navbar--scope-suggestions" role="tablist"
                      aria-label="Javaslatok navigáció">
                      <button class="myclass-nav-item suggestions-nav-item active" data-suggestion-nav="suggestions"
                        type="button">
                        <img src="assets/youhub/suggestions/suggestion.svg" alt=""
                          class="suggestions-calendar-nav-item-img" aria-hidden="true">
                        <span data-translate="youhub.suggestions.title"
                          data-translate-fallback="Javaslatok">Javaslatok</span>
                      </button>
                      <button class="myclass-nav-item suggestions-nav-item" data-suggestion-nav="hive" type="button">
                        <img src="assets/youhub/suggestions/hive.svg" alt="" class="suggestions-calendar-nav-item-img"
                          aria-hidden="true">
                        <span data-translate="youhub.suggestions.hive" data-translate-fallback="Hive">Hive</span>
                      </button>
                      <button class="myclass-nav-item suggestions-nav-item" data-suggestion-nav="submit" type="button">
                        <img src="assets/youhub/suggestions/send.svg" alt="" class="suggestions-calendar-nav-item-img"
                          aria-hidden="true">
                        <span data-translate="youhub.suggestions.submit"
                          data-translate-fallback="Beküldés">Beküldés</span>
                      </button>
                    </div>
                  </div>
                  <div class="suggestions-sections">
                    <div class="suggestions-grid suggestions-section is-visible" data-suggestions-section="suggestions">
                      <div class="suggestions-row suggestions-row--top">
                        <div class="suggestion-card suggestion-card--large" data-card-variant="large"
                          data-card-index="0">
                          <div class="suggestion-card-media">
                            <img src="assets/general/image_placeholder_blue.svg" alt="Javaslat előnézet"
                              class="suggestion-card-image">
                          </div>
                          <div class="suggestion-card-body">
                            <div class="suggestion-card-header">
                              <div class="suggestion-card-meta">
                                <div class="suggestion-meta-item">
                                  <div class="suggestion-meta-avatar"></div>
                                  <span class="suggestion-meta-label suggestion-meta-label--author">Név</span>
                                </div>
                                <div class="suggestion-meta-item">
                                  <div class="suggestion-meta-icon">
                                    <img src="assets/youhub/suggestions/prompt.svg" alt="" aria-hidden="true">
                                  </div>
                                  <span class="suggestion-meta-label suggestion-meta-label--type">AI prompt</span>
                                </div>
                              </div>
                              <div class="suggestion-card-action">
                                <button class="suggestion-card-more-btn" type="button" aria-label="További lehetőségek">
                                  <span class="suggestion-card-more-icon"></span>
                                </button>
                              </div>
                            </div>
                            <div class="suggestion-card-content">
                              <p class="suggestion-card-title">Cím</p>
                              <p class="suggestion-card-description">Description</p>
                            </div>
                          </div>
                        </div>
                        <div class="suggestion-card suggestion-card--small" data-card-variant="small"
                          data-card-index="1">
                          <div class="suggestion-card-body">
                            <div class="suggestion-card-header">
                              <div class="suggestion-card-meta">
                                <div class="suggestion-meta-item">
                                  <div class="suggestion-meta-avatar"></div>
                                  <span class="suggestion-meta-label suggestion-meta-label--author">Név</span>
                                </div>
                                <div class="suggestion-meta-item">
                                  <div class="suggestion-meta-icon">
                                    <img src="assets/youhub/suggestions/prompt.svg" alt="" aria-hidden="true">
                                  </div>
                                  <span class="suggestion-meta-label suggestion-meta-label--type">AI prompt</span>
                                </div>
                              </div>
                              <div class="suggestion-card-action">
                                <button class="suggestion-card-more-btn" type="button" aria-label="További lehetőségek">
                                  <span class="suggestion-card-more-icon"></span>
                                </button>
                              </div>
                            </div>
                            <div class="suggestion-card-content">
                              <p class="suggestion-card-title">Cím</p>
                              <p class="suggestion-card-description">Description</p>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="suggestions-row suggestions-row--bottom">
                        <div class="suggestion-card suggestion-card--small" data-card-variant="small"
                          data-card-index="2">
                          <div class="suggestion-card-body">
                            <div class="suggestion-card-header">
                              <div class="suggestion-card-meta">
                                <div class="suggestion-meta-item">
                                  <div class="suggestion-meta-avatar"></div>
                                  <span class="suggestion-meta-label suggestion-meta-label--author">Név</span>
                                </div>
                                <div class="suggestion-meta-item">
                                  <div class="suggestion-meta-icon">
                                    <img src="assets/youhub/suggestions/prompt.svg" alt="" aria-hidden="true">
                                  </div>
                                  <span class="suggestion-meta-label suggestion-meta-label--type">AI prompt</span>
                                </div>
                              </div>
                              <div class="suggestion-card-action">
                                <button class="suggestion-card-more-btn" type="button" aria-label="További lehetőségek">
                                  <span class="suggestion-card-more-icon"></span>
                                </button>
                              </div>
                            </div>
                            <div class="suggestion-card-content">
                              <p class="suggestion-card-title">Cím</p>
                              <p class="suggestion-card-description">Description</p>
                            </div>
                          </div>
                        </div>
                        <div class="suggestion-card suggestion-card--large" data-card-variant="large"
                          data-card-index="3">
                          <div class="suggestion-card-media">
                            <img src="assets/general/image_placeholder_blue.svg" alt="Javaslat előnézet"
                              class="suggestion-card-image">
                          </div>
                          <div class="suggestion-card-body">
                            <div class="suggestion-card-header">
                              <div class="suggestion-card-meta">
                                <div class="suggestion-meta-item">
                                  <div class="suggestion-meta-avatar"></div>
                                  <span class="suggestion-meta-label suggestion-meta-label--author">Név</span>
                                </div>
                                <div class="suggestion-meta-item">
                                  <div class="suggestion-meta-icon">
                                    <img src="assets/youhub/suggestions/prompt.svg" alt="" aria-hidden="true">
                                  </div>
                                  <span class="suggestion-meta-label suggestion-meta-label--type">AI prompt</span>
                                </div>
                              </div>
                              <div class="suggestion-card-action">
                                <button class="suggestion-card-more-btn" type="button" aria-label="További lehetőségek">
                                  <span class="suggestion-card-more-icon"></span>
                                </button>
                              </div>
                            </div>
                            <div class="suggestion-card-content">
                              <p class="suggestion-card-title">Cím</p>
                              <p class="suggestion-card-description">Description</p>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="suggestions-hive suggestions-section" data-suggestions-section="hive">
                      <div class="suggestions-hive-placeholder-card">
                        <p class="suggestions-hive-title" data-translate="youhub.suggestions.hive_placeholder.title"
                          data-translate-fallback="A Hive-ot még építik a méhek!">A Hive-ot még építik a méhek!</p>
                        <p class="suggestions-hive-desc"
                          data-translate="youhub.suggestions.hive_placeholder.description"
                          data-translate-fallback="Nemsokára az interaktív visszajelző rendszer elérhető lesz.">
                          Nemsokára az interaktív visszajelző rendszer elérhető lesz.</p>
                      </div>
                    </div>
                    <div class="suggestions-submit suggestions-section" data-suggestions-section="submit">
                      <div class="suggestions-submit-steps">
                        <div class="suggestions-submit-step is-active" data-step="1">
                          <div class="suggestions-step-columns">
                            <div class="suggestions-step-column suggestions-step-column--form">
                              <p class="suggestions-step-heading"
                                data-translate="youhub.suggestions.submit_steps.step1.heading"
                                data-translate-fallback="Alap adatok">Alap adatok</p>
                              <label class="suggestions-input-field">
                                <span class="suggestions-input-label"
                                  data-translate="youhub.suggestions.submit_steps.step1.title_label"
                                  data-translate-fallback="Cím">Cím</span>
                                <input id="suggestionTitleInput" data-form-field="title" type="text"
                                  class="suggestions-input-control"
                                  data-translate-placeholder="youhub.suggestions.submit_steps.step1.title_placeholder"
                                  placeholder="Ide írj..." autocomplete="off" />
                              </label>
                              <label class="suggestions-input-field suggestions-input-field--grow">
                                <span class="suggestions-input-label"
                                  data-translate="youhub.suggestions.submit_steps.step1.content_label"
                                  data-translate-fallback="Javaslat">Javaslat</span>
                                <textarea id="suggestionContentInput" data-form-field="content"
                                  class="suggestions-input-control suggestions-input-control--textarea"
                                  data-translate-placeholder="youhub.suggestions.submit_steps.step1.content_placeholder"
                                  placeholder="Ide írj..."></textarea>
                              </label>
                            </div>
                            <div class="suggestions-step-column suggestions-step-column--type">
                              <p class="suggestions-step-heading"
                                data-translate="youhub.suggestions.submit_steps.step1.type_heading"
                                data-translate-fallback="Válaszd ki a típusát">Válaszd ki a típusát</p>
                              <div class="suggestions-checkbox">
                                <button class="suggestions-checkbox-toggle is-checked" type="button"
                                  data-form-field="hiveToggle" aria-pressed="true">
                                  <img src="assets/youhub/suggestions/check_dark.svg" alt="" aria-hidden="true">
                                </button>
                                <div class="suggestions-checkbox-text">
                                  <span class="suggestions-checkbox-title"
                                    data-translate="youhub.suggestions.submit_steps.step1.hive_title"
                                    data-translate-fallback="Hive">Hive</span>
                                  <p class="suggestions-checkbox-desc"
                                    data-translate="youhub.suggestions.submit_steps.step1.hive_description"
                                    data-translate-fallback="Ha ezt választod, a Javaslatod bekerül a Hiveba, és a vezetőség át fogja gondolni az ötletedet.">
                                    Ha ezt választod, a Javaslatod bekerül a Hiveba, és a vezetőség át fogja gondolni az
                                    ötletedet.</p>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                        <div class="suggestions-submit-step" data-step="2">
                          <div class="suggestions-step-columns">
                            <div class="suggestions-step-column suggestions-step-column--form">
                              <p class="suggestions-step-heading"
                                data-translate="youhub.suggestions.submit_steps.step2.heading"
                                data-translate-fallback="Megjelenítés kinek">Megjelenítés kinek</p>
                              <label class="suggestions-input-field">
                                <span class="suggestions-input-label"
                                  data-translate="youhub.suggestions.submit_steps.step2.user_label"
                                  data-translate-fallback="Megjelenítés kinek">Megjelenítés kinek</span>
                              <p class="suggestions-help-text" data-translate="youhub.suggestions.submit_steps.step2.user_hint" data-translate-fallback="Hagyd üresen a publikus megjelenítéshez.">Hagyd üresen a publikus megjelenítéshez.</p>
                                <div class="suggestions-search-wrapper">
                                  <input id="suggestionUserSearch" data-form-field="userSearch" type="text"
                                    class="suggestions-input-control suggestions-input-control--search"
                                    data-translate-placeholder="youhub.suggestions.submit_steps.step2.user_placeholder"
                                    placeholder="Ide írj..." autocomplete="off" />
                                  <span class="suggestions-search-ghost" data-ghost-for="user"></span>
                                  <img src="assets/general/components/search.svg" alt="" aria-hidden="true"
                                    class="suggestions-search-icon">
                                </div>
                              </label>
                              <label class="suggestions-input-field suggestions-input-field--grow">
                                <span class="suggestions-input-label"
                                  data-translate="youhub.suggestions.submit_steps.step2.group_label"
                                  data-translate-fallback="Célcsoport">Célcsoport</span>
                              <p class="suggestions-help-text" data-translate="youhub.suggestions.submit_steps.step2.group_hint" data-translate-fallback="Hagyd üresen a publikus megjelenítéshez.">Hagyd üresen a publikus megjelenítéshez.</p>
                                <div class="suggestions-search-wrapper">
                                  <input id="suggestionGroupSearch" data-form-field="groupSearch" type="text"
                                    class="suggestions-input-control suggestions-input-control--search suggestions-input-control--large"
                                    data-translate-placeholder="youhub.suggestions.submit_steps.step2.group_placeholder"
                                    placeholder="Ide írj..." autocomplete="off" />
                                  <span class="suggestions-search-ghost" data-ghost-for="group"></span>
                                  <img src="assets/general/components/search.svg" alt="" aria-hidden="true"
                                    class="suggestions-search-icon">
                                </div>
                              </label>
                            </div>
                            <div class="suggestions-step-column suggestions-step-column--type">
                              <p class="suggestions-step-heading"
                                data-translate="youhub.suggestions.submit_steps.step2.share_heading"
                                data-translate-fallback="Megosztás">Megosztás</p>
                              <div class="suggestions-checkbox suggestions-checkbox--with-switch">
                                <div class="suggestions-checkbox-text">
                                  <span class="suggestions-checkbox-title"
                                    data-translate="youhub.suggestions.submit_steps.step2.share_title"
                                    data-translate-fallback="Külső Megosztás">Külső Megosztás</span>
                                  <p class="suggestions-checkbox-desc"
                                    data-translate="youhub.suggestions.submit_steps.step2.share_description"
                                    data-translate-fallback="Engedélyezed az iskolának hogy a Javaslatodat külsős platformokra is megoszthatja -e.">
                                    Engedélyezed az iskolának hogy a Javaslatodat külsős platformokra is megoszthatja
                                    -e.</p>
                                </div>
                                <md-switch icon class="suggestions-share-switch" selected icons
                                  aria-label="Külső Megosztás"></md-switch>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="suggestions-global-actions">
                    <button class="suggestions-cta-sml suggestions-cta--secondary" type="button"
                      data-step-action="previous">
                      <img src="assets/youhub/suggestions/next.svg" alt="" aria-hidden="true"
                        class="suggestions-cta-icon--back">
                    </button>
                    <button class="suggestions-cta suggestions-cta--primary" type="button" data-step-action="next">
                      <img src="assets/youhub/suggestions/next.svg" alt="" aria-hidden="true">
                      <span data-translate="youhub.suggestions.actions.next"
                        data-translate-fallback="Tovább">Tovább</span>
                    </button>
                    <button class="suggestions-cta suggestions-cta--primary" type="button" data-step-action="submit">
                      <img src="assets/youhub/suggestions/send_dark.svg" alt="" aria-hidden="true">
                      <span data-translate="youhub.suggestions.actions.submit"
                        data-translate-fallback="Javaslat beküldése">Javaslat beküldése</span>
                    </button>
                  </div>
                </div>
              </div>
              <div class="youhub-card-handle"></div>
            </div>
            <div class="youhub-card" data-card-id="calendar" draggable="false">
              <div class="youhub-card-content calendar-card-content">
                <!-- Top Section (Header + Date Bar) -->
                <div class="calendar-top-section">
                  <div class="calendar-header-row">
                    <img src="assets/youhub/calendar/calendar.svg" alt="Naptár" class="calendar-icon">
                    <h2 class="calendar-title" data-translate="youhub.calendar.title" data-translate-fallback="Naptár">
                      Naptár</h2>
                    <button class="notifications-history-btn" type="button">
                      <img src="assets/youhub/calendar/calendar_dark.svg" alt="Teljes Naptár"
                        class="calendar-full-icon">
                      <span class="calendar-full-text" data-translate="youhub.calendar.full"
                        data-translate-fallback="Teljes Naptár">Teljes Naptár</span>
                    </button>
                  </div>

                  <!-- Date Bar -->
                  <div class="calendar-date-bar">
                    <div class="calendar-date-text" data-translate="youhub.calendar.date_placeholder"
                      data-translate-fallback="Január 02. - Péntek">Január 02. - Péntek</div>
                    <div class="calendar-date-controls">
                      <span class="calendar-month-text" data-translate="youhub.calendar.month_placeholder"
                        data-translate-fallback="Január 2026.">Január 2026.</span>
                      <button class="calendar-month-pill" type="button" aria-label="Hónap választása">
                        <img src="assets/youhub/calendar/arrow_down.svg" alt="" aria-hidden="true">
                      </button>
                      <button class="calendar-more-btn" type="button" aria-label="Szerkesztés">
                        <img src="assets/youhub/calendar/edit.svg" alt="" aria-hidden="true">
                      </button>
                    </div>
                  </div>
                </div>

                <!-- Middle Section -->
                <div class="suggestions-middle-section">
                  <!-- Navigation -->
                  <div class="calendar-nav-shell">
                    <div class="myclass-navbar calendar-navbar myclass-navbar--scope-calendar" role="tablist"
                      aria-label="Naptár navigáció">
                      <button class="myclass-nav-item calendar-nav-item active" data-calendar-nav="timetable"
                        type="button">
                        <img src="assets/youhub/calendar/class_sheet.svg" alt=""
                          class="suggestions-calendar-nav-item-img" aria-hidden="true">
                        <span data-translate="youhub.calendar.nav.timetable"
                          data-translate-fallback="Órarend">Órarend</span>
                      </button>
                      <button class="myclass-nav-item calendar-nav-item" data-calendar-nav="exams" type="button">
                        <img src="assets/youhub/calendar/exams.svg" alt="" class="suggestions-calendar-nav-item-img"
                          aria-hidden="true">
                        <span data-translate="youhub.calendar.nav.exams"
                          data-translate-fallback="Dolgozatok">Dolgozatok</span>
                      </button>
                      <button class="myclass-nav-item calendar-nav-item" data-calendar-nav="rp" type="button">
                        <img src="assets/youhub/calendar/rp.svg" alt="" class="suggestions-calendar-nav-item-img"
                          aria-hidden="true">
                        <span data-translate="youhub.calendar.nav.rp"
                          data-translate-fallback="Reading Progressek">Reading Progressek</span>
                      </button>
                      <button class="myclass-nav-item calendar-nav-item" data-calendar-nav="bell" type="button">
                        <img src="assets/youhub/calendar/bell.svg" alt="" class="suggestions-calendar-nav-item-img"
                          aria-hidden="true">
                        <span data-translate="youhub.calendar.nav.bell"
                          data-translate-fallback="Csengetési Rend">Csengetési Rend</span>
                      </button>
                    </div>
                  </div>

                  <!-- Main Content Grid -->
                  <div id="calendar-view-timetable" class="calendar-grid">
                    <div class="calendar-column">
                      <!-- Card 1 -->
                      <div class="calendar-schedule-card">
                        <div class="calendar-card-icon-container">
                          <img src="assets/youhub/calendar/notactive/smile.svg" alt="" class="calendar-card-icon">
                        </div>
                        <div class="calendar-card-middle">
                          <span class="calendar-subject-name">Óra neve</span>
                          <div class="calendar-card-details">
                            <div class="calendar-detail-item">
                              <img src="assets/youhub/calendar/notactive/person.svg" alt="">
                              <span>Tanár neve</span>
                            </div>
                            <span class="calendar-detail-separator">|</span>
                            <div class="calendar-detail-item">
                              <img src="assets/youhub/calendar/notactive/place.svg" alt="">
                              <span>Terem</span>
                            </div>
                          </div>
                        </div>
                        <div class="calendar-card-right-bar">
                          <img src="assets/youhub/calendar/notactive/clock.svg" alt="">
                        </div>
                      </div>
                      <!-- Card 2 -->
                      <div class="calendar-schedule-card calendar-schedule-card--highlight">
                        <div class="calendar-card-icon-container">
                          <img src="assets/youhub/calendar/active/code.svg" alt="" class="calendar-card-icon">
                        </div>
                        <div class="calendar-card-middle">
                          <span class="calendar-subject-name">Óra neve</span>
                          <div class="calendar-card-details">
                            <div class="calendar-detail-item">
                              <img src="assets/youhub/calendar/active/person.svg" alt="">
                              <span>Tanár neve</span>
                            </div>
                            <span class="calendar-detail-separator">|</span>
                            <div class="calendar-detail-item">
                              <img src="assets/youhub/calendar/active/place.svg" alt="">
                              <span>Terem</span>
                            </div>
                          </div>
                        </div>
                        <div class="calendar-card-right-bar">
                          <img src="assets/youhub/calendar/notactive/clock.svg" alt="">
                        </div>
                      </div>
                      <!-- Card 3 -->
                      <div class="calendar-schedule-card">
                        <div class="calendar-card-icon-container">
                          <img src="assets/youhub/calendar/notactive/brush.svg" alt="" class="calendar-card-icon">
                        </div>
                        <div class="calendar-card-middle">
                          <span class="calendar-subject-name">Óra neve</span>
                          <div class="calendar-card-details">
                            <div class="calendar-detail-item">
                              <img src="assets/youhub/calendar/notactive/person.svg" alt="">
                              <span>Tanár neve</span>
                            </div>
                            <span class="calendar-detail-separator">|</span>
                            <div class="calendar-detail-item">
                              <img src="assets/youhub/calendar/notactive/place.svg" alt="">
                              <span>Terem</span>
                            </div>
                          </div>
                        </div>
                        <div class="calendar-card-right-bar">
                          <img src="assets/youhub/calendar/notactive/clock.svg" alt="">
                        </div>
                      </div>
                    </div>
                    <div class="calendar-column">
                      <!-- Card 4 -->
                      <div class="calendar-schedule-card">
                        <div class="calendar-card-icon-container">
                          <img src="assets/youhub/calendar/notactive/leaf.svg" alt="" class="calendar-card-icon">
                        </div>
                        <div class="calendar-card-middle">
                          <span class="calendar-subject-name">Óra neve</span>
                          <div class="calendar-card-details">
                            <div class="calendar-detail-item">
                              <img src="assets/youhub/calendar/notactive/person.svg" alt="">
                              <span>Tanár neve</span>
                            </div>
                            <span class="calendar-detail-separator">|</span>
                            <div class="calendar-detail-item">
                              <img src="assets/youhub/calendar/notactive/place.svg" alt="">
                              <span>Terem</span>
                            </div>
                          </div>
                        </div>
                        <div class="calendar-card-right-bar">
                          <img src="assets/youhub/calendar/notactive/clock.svg" alt="">
                        </div>
                      </div>
                      <!-- Card 5 -->
                      <div class="calendar-schedule-card">
                        <div class="calendar-card-middle">
                          <span class="calendar-subject-name" data-translate="youhub.calendar.lunch"
                            data-translate-fallback="Ebédszünet">Ebédszünet</span>
                          <div class="calendar-card-details">
                            <div class="calendar-detail-item">
                              <img src="assets/youhub/calendar/notactive/clock.svg" alt="">
                              <span>11:55 - 12:25</span>
                            </div>
                          </div>
                        </div>
                      </div>
                      <!-- Card 6 -->
                      <div class="calendar-schedule-card">
                        <div class="calendar-card-icon-container">
                          <img src="assets/youhub/calendar/notactive/bank.svg" alt="" class="calendar-card-icon">
                        </div>
                        <div class="calendar-card-middle">
                          <span class="calendar-subject-name">Óra neve</span>
                          <div class="calendar-card-details">
                            <div class="calendar-detail-item">
                              <img src="assets/youhub/calendar/notactive/person.svg" alt="">
                              <span>Tanár neve</span>
                            </div>
                            <span class="calendar-detail-separator">|</span>
                            <div class="calendar-detail-item">
                              <img src="assets/youhub/calendar/notactive/place.svg" alt="">
                              <span>Terem</span>
                            </div>
                          </div>
                        </div>
                        <div class="calendar-card-right-bar">
                          <img src="assets/youhub/calendar/notactive/clock.svg" alt="">
                        </div>
                      </div>
                    </div>
                  </div>
                  <!-- Placeholder Views -->
                  <div id="calendar-view-exams" class="calendar-grid" style="display: none;"></div>
                  <div id="calendar-view-rp" class="calendar-grid" style="display: none;"></div>
                  <div id="calendar-view-bell" class="calendar-grid" style="display: none;"></div>
                </div>
              </div>
              <div class="youhub-card-handle"></div>
            </div>
          </div>

          <script type="module">
            import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";

            function lsLoggedInFallback() {
              try { return localStorage.getItem('eu2k-auth-logged-in') === 'true'; } catch { return false; }
            }

            function updateHeaderIcons(loggedIn) {
              const settingsWrapper = document.getElementById('headerSettingsWrapper');
              const accountWrapper = document.getElementById('headerAccountWrapper');
              const loginBtn = document.getElementById('headerLoginBtn');
              const gradientContainer = document.querySelector('.header-icon-gradient');
              if (!settingsWrapper || !accountWrapper || !loginBtn || !gradientContainer) return;

              if (loggedIn) {
                settingsWrapper.style.display = 'flex';
                accountWrapper.style.display = 'flex';
                loginBtn.style.display = 'none';
                gradientContainer.classList.remove('has-login'); // Csak zöld, nincs gradient
              } else {
                settingsWrapper.style.display = 'flex';
                accountWrapper.style.display = 'none';
                loginBtn.style.display = 'flex';
                gradientContainer.classList.add('has-login'); // Van gradient, mert van kék gomb
              }
            }

            try {
              const auth = getAuth();
              onAuthStateChanged(auth, (user) => {
                updateHeaderIcons(!!user);
              });
            } catch (e) {
              // Last resort: localStorage fallback
              updateHeaderIcons(lsLoggedInFallback());
              // Keep in sync with localStorage changes
              window.addEventListener('storage', () => updateHeaderIcons(lsLoggedInFallback()));
              setInterval(() => updateHeaderIcons(lsLoggedInFallback()), 1000);
            }

            // Bejelentkezés gomb kattintás
            const loginBtnEl = document.getElementById('headerLoginBtn');
            if (loginBtnEl) {
              loginBtnEl.addEventListener('click', function () {
                window.location.href = 'onboarding.html';
              });
            }
          </script>
          <script type="module">
            import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
            import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

            const suggestionsNavShell = document.querySelector('.suggestions-card-content .suggestions-nav-shell');
            const suggestionNavButtons = suggestionsNavShell ? Array.from(suggestionsNavShell.querySelectorAll('.suggestions-nav-item')) : [];
            const suggestionSections = Array.from(document.querySelectorAll('.suggestions-section'));
            const hiveButton = suggestionsNavShell?.querySelector('[data-suggestion-nav="hive"]') || null;
            const submitRoot = document.querySelector('.suggestions-submit');
            const globalActions = document.querySelector('.suggestions-global-actions');
            const globalNextBtn = globalActions?.querySelector('[data-step-action="next"]');
            const globalPrevBtn = globalActions?.querySelector('[data-step-action="previous"]');
            const globalSubmitBtn = globalActions?.querySelector('[data-step-action="submit"]');
            const allowedAccessLevels = new Set(['owner', 'administrator', 'teacher', 'admin']);
            const auth = getAuth();
            const suggestionsDb = window.db || getFirestore();
            const suggestionCardElements = Array.from(document.querySelectorAll('.suggestion-card'));
            const SUGGESTIONS_DEVICE_ID_KEY = 'youhub-suggestions-device-id';

            function generateSuggestionsDeviceId() {
              const randomPart = (crypto.randomUUID ? crypto.randomUUID() : `id-${Date.now()}-${Math.random().toString(36).slice(2, 10)}`);
              return `youhub-${randomPart}`;
            }

            function getSuggestionsDeviceId() {
              try {
                const existing = localStorage.getItem(SUGGESTIONS_DEVICE_ID_KEY);
                if (existing) return existing;
                const fresh = generateSuggestionsDeviceId();
                localStorage.setItem(SUGGESTIONS_DEVICE_ID_KEY, fresh);
                return fresh;
              } catch {
                return generateSuggestionsDeviceId();
              }
            }

            function persistSuggestionsDeviceId(deviceId) {
              if (!deviceId) return;
              try {
                const current = localStorage.getItem(SUGGESTIONS_DEVICE_ID_KEY);
                if (current !== deviceId) {
                  localStorage.setItem(SUGGESTIONS_DEVICE_ID_KEY, deviceId);
                }
              } catch {
                // ignore storage errors (private mode, etc.)
              }
            }

            const SUBMIT_FORM_STORAGE_KEY = 'youhub-submit-form-state';
            const submitFormState = {
              title: '',
              content: '',
              hive: true,
              share: true,
              restrictUsers: '',
              restrictGroups: ''
            };

            const formElements = {
              titleInput: document.getElementById('suggestionTitleInput'),
              contentInput: document.getElementById('suggestionContentInput'),
              hiveToggle: submitRoot?.querySelector('[data-form-field="hiveToggle"]'),
              shareSwitch: submitRoot?.querySelector('.suggestions-share-switch'),
              userSearchInput: document.getElementById('suggestionUserSearch'),
              userGhost: document.querySelector('[data-ghost-for="user"]'),
              groupSearchInput: document.getElementById('suggestionGroupSearch'),
              groupGhost: document.querySelector('[data-ghost-for="group"]')
            };

            let classSuggestions = [];
            let groupSuggestions = [];
            let userSuggestions = [];
            const userProfileCache = new Map();
            let referenceDataLoaded = false;
            let referenceDataLoading = false;

            function simplifyName(value) {
              return (value || '')
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .toLowerCase()
                .replace(/\s+/g, '_')
                .trim();
            }

            const DEFAULT_NAV_ID = 'suggestions';
            let activeNavId = DEFAULT_NAV_ID;
            let previousNavId = DEFAULT_NAV_ID; // Track previous nav to return after submit
            let currentSubmitStep = 1;

            function persistFormState() {
              try {
                localStorage.setItem(SUBMIT_FORM_STORAGE_KEY, JSON.stringify(submitFormState));
              } catch (err) {
                console.warn('[SuggestionsForm] Failed to persist form state', err);
              }
            }

            function restoreFormState() {
              try {
                const stored = localStorage.getItem(SUBMIT_FORM_STORAGE_KEY);
                if (stored) {
                  const parsed = JSON.parse(stored);
                  Object.assign(submitFormState, {
                    title: parsed.title ?? '',
                    content: parsed.content ?? '',
                    hive: typeof parsed.hive === 'boolean' ? parsed.hive : true,
                    share: typeof parsed.share === 'boolean' ? parsed.share : true,
                    restrictUsers: parsed.restrictUsers ?? '',
                    restrictGroups: parsed.restrictGroups ?? ''
                  });
                }
              } catch (err) {
                console.warn('[SuggestionsForm] Failed to parse stored state', err);
              }

              if (formElements.titleInput) formElements.titleInput.value = submitFormState.title;
              if (formElements.contentInput) formElements.contentInput.value = submitFormState.content;
              if (formElements.hiveToggle) {
                formElements.hiveToggle.classList.toggle('is-checked', !!submitFormState.hive);
                formElements.hiveToggle.setAttribute('aria-pressed', submitFormState.hive ? 'true' : 'false');
              }
              if (formElements.shareSwitch) {
                formElements.shareSwitch.selected = !!submitFormState.share;
              }
              if (formElements.userSearchInput) formElements.userSearchInput.value = submitFormState.restrictUsers;
              if (formElements.groupSearchInput) formElements.groupSearchInput.value = submitFormState.restrictGroups;
            }

            restoreFormState();

            function clearFormState() {
              submitFormState.title = '';
              submitFormState.content = '';
              submitFormState.hive = true;
              submitFormState.share = true;
              submitFormState.restrictUsers = '';
              submitFormState.restrictGroups = '';
              persistFormState();
              restoreFormState();
              hideGhost(formElements.userGhost);
              hideGhost(formElements.groupGhost);
            }

            function setSubmitStep(step) {
              if (!submitRoot) return;
              const steps = Array.from(submitRoot.querySelectorAll('.suggestions-submit-step'));
              if (!steps.length) return;
              currentSubmitStep = Math.max(1, Math.min(steps.length, step));
              steps.forEach((stepEl, index) => {
                stepEl.classList.toggle('is-active', index === currentSubmitStep - 1);
              });

              if (currentSubmitStep === 2) {
                preloadSubmitReferenceData();
              }
              updateGlobalActionsVisibility();
            }

            submitRoot?.addEventListener('click', (event) => {
              const checkboxToggle = event.target.closest('.suggestions-checkbox-toggle');
              if (checkboxToggle && !checkboxToggle.closest('.is-static')) {
                checkboxToggle.classList.toggle('is-checked');
                const isChecked = checkboxToggle.classList.contains('is-checked');
                checkboxToggle.setAttribute('aria-pressed', isChecked ? 'true' : 'false');
                submitFormState.hive = isChecked;
                persistFormState();
              }

            });

            if (formElements.titleInput) {
              formElements.titleInput.addEventListener('input', (event) => {
                submitFormState.title = event.target.value;
                persistFormState();
              });
            }

            if (formElements.contentInput) {
              formElements.contentInput.addEventListener('input', (event) => {
                submitFormState.content = event.target.value;
                persistFormState();
              });
            }

            if (formElements.shareSwitch) {
              formElements.shareSwitch.addEventListener('change', () => {
                submitFormState.share = formElements.shareSwitch.selected;
                persistFormState();
              });
            }

            if (formElements.userSearchInput) {
              let lastCommaSpaceDeleted = false; // Flag to track if comma+space was deleted

              const handleUserInput = () => {
                submitFormState.restrictUsers = formElements.userSearchInput.value;
                persistFormState();
                updateUserGhost();
                // Reset flag when user types
                lastCommaSpaceDeleted = false;
              };
              formElements.userSearchInput.addEventListener('input', handleUserInput);
              formElements.userSearchInput.addEventListener('focus', () => {
                preloadSubmitReferenceData();
                updateUserGhost();
                lastCommaSpaceDeleted = false; // Reset on focus
              });
              formElements.userSearchInput.addEventListener('blur', () => hideGhost(formElements.userGhost));
              formElements.userSearchInput.addEventListener('keydown', (event) => {
                if (event.key === 'Tab' && !event.shiftKey) {
                  const fullValue = formElements.userSearchInput.value;
                  // Extract the last part after the last comma (if any)
                  const lastCommaIndex = fullValue.lastIndexOf(',');
                  const searchValue = lastCommaIndex >= 0 ? fullValue.slice(lastCommaIndex + 1).trim() : fullValue.trim();
                  const suggestion = findUserSuggestion(searchValue);
                  if (suggestion && suggestion.display) {
                    event.preventDefault();
                    const newValue = suggestion.display;
                    const newLabel = suggestion.display;
                    // Replace the last part with the full name
                    if (lastCommaIndex >= 0) {
                      // There's a comma, replace the part after it
                      const beforeComma = fullValue.slice(0, lastCommaIndex + 1).trim();
                      const updatedValue = `${beforeComma} ${newValue}`;
                      formElements.userSearchInput.value = updatedValue;
                      submitFormState.restrictUsers = updatedValue;
                    } else {
                      // No comma, replace the entire value
                      formElements.userSearchInput.value = newValue;
                      submitFormState.restrictUsers = newValue;
                    }
                    persistFormState();
                    applyGhostToElement(formElements.userGhost, newValue, newLabel, formElements.userSearchInput);
                    lastCommaSpaceDeleted = false; // Reset after Tab
                  }
                } else if (event.key === ' ' && !lastCommaSpaceDeleted) {
                  // Space key pressed - check if we should add comma+space
                  const fullValue = formElements.userSearchInput.value;
                  const lastCommaIndex = fullValue.lastIndexOf(',');
                  const searchValue = lastCommaIndex >= 0 ? fullValue.slice(lastCommaIndex + 1).trim() : fullValue.trim();

                  // Check if the current search value matches a user name exactly
                  const suggestion = findUserSuggestion(searchValue);
                  if (suggestion && suggestion.display && suggestion.display.toLowerCase() === searchValue.toLowerCase()) {
                    // The current value is a complete name, add comma+space
                    event.preventDefault();
                    const beforeComma = lastCommaIndex >= 0 ? fullValue.slice(0, lastCommaIndex + 1).trim() : '';
                    const token = suggestion.display;
                    const updatedValue = beforeComma ? `${beforeComma} ${token}, ` : `${token}, `;
                    formElements.userSearchInput.value = updatedValue;
                    submitFormState.restrictUsers = updatedValue;
                    persistFormState();
                    updateUserGhost();
                  }
                } else if (event.key === 'Backspace') {
                  // Check if user is deleting comma+space
                  const fullValue = formElements.userSearchInput.value;
                  const cursorPos = formElements.userSearchInput.selectionStart || 0;
                  if (cursorPos > 0 && fullValue.slice(cursorPos - 2, cursorPos) === ', ') {
                    lastCommaSpaceDeleted = true;
                  }
                }
              });
            }

            if (formElements.groupSearchInput) {
              const handleGroupInput = () => {
                submitFormState.restrictGroups = formElements.groupSearchInput.value;
                persistFormState();
                updateGroupGhost();
              };
              formElements.groupSearchInput.addEventListener('input', handleGroupInput);
              formElements.groupSearchInput.addEventListener('focus', () => {
                preloadSubmitReferenceData();
                updateGroupGhost();
              });
              formElements.groupSearchInput.addEventListener('blur', () => hideGhost(formElements.groupGhost));
              formElements.groupSearchInput.addEventListener('keydown', (event) => {
                if (event.key === 'Tab' && !event.shiftKey) {
                  const fullValue = formElements.groupSearchInput.value;
                  // Extract the last part after the last comma (if any)
                  const lastCommaIndex = fullValue.lastIndexOf(',');
                  const searchValue = lastCommaIndex >= 0 ? fullValue.slice(lastCommaIndex + 1).trim() : fullValue.trim();
                  const suggestion = findClassOrGroupSuggestion(searchValue);
                  if (suggestion && suggestion.display) {
                    event.preventDefault();
                    const newItem = suggestion.display;
                    // Replace the last part with the full name
                    if (lastCommaIndex >= 0) {
                      // There's a comma, replace the part after it
                      const beforeComma = fullValue.slice(0, lastCommaIndex + 1).trim();
                      const updatedValue = `${beforeComma} ${newItem}`;
                      formElements.groupSearchInput.value = updatedValue;
                      submitFormState.restrictGroups = updatedValue;
                    } else {
                      // No comma, replace the entire value
                      formElements.groupSearchInput.value = newItem;
                      submitFormState.restrictGroups = newItem;
                    }
                    persistFormState();
                    updateGroupGhost();
                  }
                }
              });
            }

            globalActions?.addEventListener('click', (event) => {
              const actionBtn = event.target.closest('[data-step-action]');
              if (!actionBtn) return;
              const action = actionBtn.dataset.stepAction;
              if (action === 'next') {
                setSubmitStep(currentSubmitStep + 1);
              } else if (action === 'previous') {
                setSubmitStep(currentSubmitStep - 1);
              } else if (action === 'submit') {
                handleSuggestionSubmit();
              }
            });

            function setActiveNav(targetId, forceFallback = false) {
              const desiredId = targetId || DEFAULT_NAV_ID;
              let matchedSection = false;

              // Track previous nav (except when going to submit)
              if (activeNavId !== 'submit' && activeNavId !== desiredId) {
                previousNavId = activeNavId;
              }

              suggestionNavButtons.forEach((btn) => {
                if (!btn) return;
                const isActive = btn.dataset.suggestionNav === desiredId;
                btn.classList.toggle('active', isActive);
                btn.setAttribute('aria-selected', isActive ? 'true' : 'false');
                if (isActive) {
                  activeNavId = desiredId;
                }
              });

              suggestionSections.forEach((section) => {
                const matches = section.dataset.suggestionsSection === desiredId;
                section.classList.toggle('is-visible', matches);
                if (matches) matchedSection = true;
              });

              if (!matchedSection && desiredId !== DEFAULT_NAV_ID && !forceFallback) {
                setActiveNav(DEFAULT_NAV_ID, true);
              }

              if (desiredId === 'submit') {
                setSubmitStep(1);
              }

              updateGlobalActionsVisibility();
            }

            suggestionNavButtons.forEach((btn) => {
              btn.addEventListener('click', () => {
                const targetId = btn.dataset.suggestionNav || DEFAULT_NAV_ID;
                setActiveNav(targetId);
              });
            });

            setActiveNav(DEFAULT_NAV_ID);
            setSubmitStep(1);
            loadLatestSuggestions();

            function updateGlobalActionsVisibility() {
              if (!globalActions) return;

              if (activeNavId !== 'submit') {
                globalActions.style.display = 'none';
                return;
              }

              globalActions.style.display = 'flex';

              if (currentSubmitStep === 1) {
                if (globalPrevBtn) globalPrevBtn.style.display = 'none';
                if (globalNextBtn) globalNextBtn.style.display = 'inline-flex';
                if (globalSubmitBtn) globalSubmitBtn.style.display = 'none';
              } else {
                if (globalPrevBtn) globalPrevBtn.style.display = 'inline-flex';
                if (globalNextBtn) globalNextBtn.style.display = 'none';
                if (globalSubmitBtn) globalSubmitBtn.style.display = 'inline-flex';
              }
            }

            function hideGhost(element) {
              if (!element) return;
              element.textContent = '';
              element.classList.remove('is-visible');
            }

            function updateUserGhost() {
              if (!formElements.userSearchInput || !formElements.userGhost) return;
              const fullValue = formElements.userSearchInput.value;
              // Extract the last part after the last comma (if any)
              const lastCommaIndex = fullValue.lastIndexOf(',');
              const searchValue = lastCommaIndex >= 0 ? fullValue.slice(lastCommaIndex + 1).trim() : fullValue.trim();
              const suggestion = findUserSuggestion(searchValue);
              applyGhostToElement(formElements.userGhost, searchValue, suggestion?.display, formElements.userSearchInput);
            }

            function updateGroupGhost() {
              if (!formElements.groupSearchInput || !formElements.groupGhost) return;
              const fullValue = formElements.groupSearchInput.value;
              // Extract the last part after the last comma (if any)
              const lastCommaIndex = fullValue.lastIndexOf(',');
              const searchValue = lastCommaIndex >= 0 ? fullValue.slice(lastCommaIndex + 1).trim() : fullValue.trim();
              const suggestion = findClassOrGroupSuggestion(searchValue);
              applyGhostToElement(formElements.groupGhost, searchValue, suggestion?.display, formElements.groupSearchInput);
            }

            function applyGhostToElement(element, currentValue, suggestionText, inputEl) {
              if (!element) return;
              const isFocused = inputEl ? document.activeElement === inputEl : true;
              if (!currentValue || !suggestionText || !isFocused) {
                hideGhost(element);
                return;
              }

              const markup = buildGhostMarkup(currentValue, suggestionText);
              if (!markup) {
                hideGhost(element);
                return;
              }

              element.innerHTML = markup;
              element.classList.add('is-visible');
            }

            function buildGhostMarkup(currentValue, suggestionText) {
              if (!currentValue || !suggestionText) return '';
              const normalizedInput = currentValue.toLowerCase();
              const normalizedSuggestion = suggestionText.toLowerCase();
              if (!normalizedSuggestion.startsWith(normalizedInput)) return '';
              const prefix = suggestionText.slice(0, currentValue.length);
              const remainder = suggestionText.slice(currentValue.length);
              return `<span class="ghost-prefix">${escapeHtml(prefix)}</span>${escapeHtml(remainder)}`;
            }

            function escapeHtml(value) {
              return (value || '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
            }

            function findClassOrGroupSuggestion(rawValue) {
              const value = (rawValue || '').trim().toLowerCase();
              if (!value) return null;
              const combined = [...classSuggestions, ...groupSuggestions];

              // First try exact start match on display
              let match = combined.find((item) => item && item.display && item.display.toLowerCase().startsWith(value));
              if (match) return match;

              const words = value.split(/\s+/);
              const scored = combined
                .filter((item) => item && item.display)
                .map((item) => {
                  const matchLower = item.display.toLowerCase();
                  let score = 0;
                  const allWordsMatch = words.every((word) => matchLower.includes(word));
                  if (allWordsMatch) {
                    if (matchLower.startsWith(value)) {
                      score = 1000;
                    } else {
                      words.forEach((word) => {
                        const index = matchLower.indexOf(word);
                        if (index >= 0) score += 100 - index;
                      });
                    }
                  }
                  return { item, score };
                })
                .filter((entry) => entry.score > 0)
                .sort((a, b) => b.score - a.score);

              return scored.length > 0 ? scored[0].item : null;
            }

            function findUserSuggestion(rawValue) {
              const value = (rawValue || '').trim().toLowerCase();
              if (!value) return null;

              const fullValue = formElements.userSearchInput?.value || '';
              const lastCommaIndex = fullValue.lastIndexOf(',');
              const beforeLastComma = lastCommaIndex >= 0 ? fullValue.slice(0, lastCommaIndex) : '';
              const usedValues = beforeLastComma ? beforeLastComma.split(',').map(s => s.trim().toLowerCase()).filter(s => s) : [];

              const availableSuggestions = userSuggestions.filter((item) => {
                if (!item || !item.value) return false;
                const valueLower = item.value.toLowerCase();
                return !usedValues.some(used => valueLower === used);
              });

              let match = availableSuggestions.find((item) => item.display && item.display.toLowerCase().startsWith(value));
              if (match) return match;

              const words = value.split(/\s+/);
              const scored = availableSuggestions
                .filter((item) => item && item.display)
                .map((item) => {
                  const matchLower = item.display.toLowerCase();
                  let score = 0;
                  const matchWords = matchLower.split(/\s+/);
                  const startsWithWord = matchWords.some(word => word.startsWith(value));
                  if (startsWithWord) {
                    score = 2000;
                    const wordIndex = matchWords.findIndex(word => word.startsWith(value));
                    score += 1000 - (wordIndex * 100);
                  }
                  const allWordsMatch = words.every((word) => matchLower.includes(word));
                  if (allWordsMatch) {
                    if (matchLower.startsWith(value)) {
                      score = Math.max(score, 1500);
                    } else {
                      words.forEach((word) => {
                        const index = matchLower.indexOf(word);
                        if (index >= 0) score += 100 - index;
                      });
                    }
                  }
                  if (!startsWithWord) {
                    matchWords.forEach((word) => {
                      if (word.startsWith(value)) score = Math.max(score, 1000);
                    });
                  }
                  return { item, score };
                })
                .filter((entry) => entry.score > 0)
                .sort((a, b) => {
                  if (b.score !== a.score) return b.score - a.score;
                  return a.item.display.length - b.item.display.length;
                });

              return scored.length > 0 ? scored[0].item : null;
            }

            // Calendar Date Update Logic
            function updateCalendarDate() {
              const now = new Date();
              const months = ['Január', 'Február', 'Március', 'Április', 'Május', 'Június', 'Július', 'Augusztus', 'Szeptember', 'Október', 'November', 'December'];
              const days = ['Vasárnap', 'Hétfő', 'Kedd', 'Szerda', 'Csütörtök', 'Péntek', 'Szombat'];

              const monthName = months[now.getMonth()];
              const dayName = days[now.getDay()];
              const dayNum = now.getDate();
              const year = now.getFullYear();

              // Format: "Január 02. - Péntek"
              const dayPadded = dayNum < 10 ? `0${dayNum}` : dayNum;
              const dateText = `${monthName} ${dayPadded}. - ${dayName}`;

              // Format: "Január 2026."
              const monthText = `${monthName} ${year}.`;

              const dateEl = document.querySelector('.calendar-date-text');
              const monthEl = document.querySelector('.calendar-month-text');

              if (dateEl) {
                dateEl.textContent = dateText;
                // Update fallback as well to prevent flicker if translation kicks in late/fails
                dateEl.setAttribute('data-translate-fallback', dateText);
              }
              if (monthEl) {
                monthEl.textContent = monthText;
                monthEl.setAttribute('data-translate-fallback', monthText);
                monthEl.setAttribute('data-translate-fallback', monthText);
              }
            }

            // Call immediately
            updateCalendarDate();

            // Re-run periodically just in case date changes while open (optional, but good for midnight crossover)
            setInterval(updateCalendarDate, 60000);

            // Calendar Navigation Logic
            function setupCalendarNavigation() {
              const navItems = document.querySelectorAll('.calendar-navbar .calendar-nav-item');
              const views = {
                'timetable': document.getElementById('calendar-view-timetable'),
                'exams': document.getElementById('calendar-view-exams'),
                'rp': document.getElementById('calendar-view-rp'),
                'bell': document.getElementById('calendar-view-bell')
              };

              // Helper to switch view
              function switchTab(targetKey) {
                // 1. Update Active State
                navItems.forEach(nav => {
                  if (nav.getAttribute('data-calendar-nav') === targetKey) {
                    nav.classList.add('active');
                  } else {
                    nav.classList.remove('active');
                  }
                });

                // 2. Switch View
                Object.keys(views).forEach(key => {
                  const view = views[key];
                  if (view) {
                    view.style.display = (key === targetKey) ? 'grid' : 'none';
                  }
                });
              }

              navItems.forEach(item => {
                item.addEventListener('click', () => {
                  const targetKey = item.getAttribute('data-calendar-nav');
                  switchTab(targetKey);
                });
              });

              // Force default state
              switchTab('timetable');
            }

            // Initialize Navigation
            setupCalendarNavigation();


            async function preloadSubmitReferenceData() {
              if (referenceDataLoaded || referenceDataLoading) return;
              if (!suggestionsDb) return;
              referenceDataLoading = true;

              try {
                // Load classes (id -> display) - full load, to allow lookup by id
                try {
                  const { collection, getDocs } = await import("https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js");
                  const classesSnap = await getDocs(collection(suggestionsDb, 'classes'));
                  classSuggestions = classesSnap.docs.map((docSnap) => ({
                    id: docSnap.id,
                    display: formatClassLabel(docSnap.id),
                    match: docSnap.id.toLowerCase(),
                    value: docSnap.id
                  }));
                } catch (err) {
                  console.warn('[SuggestionsForm] Failed to load classes', err);
                }

                // Load groups
                try {
                  const { collection, getDocs } = await import("https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js");
                  const groupsSnap = await getDocs(collection(suggestionsDb, 'groups'));
                  groupSuggestions = groupsSnap.docs.map((docSnap) => {
                    const data = docSnap.data() || {};
                    const displayName = data.name || docSnap.id;
                    return {
                      id: docSnap.id,
                      display: displayName,
                      match: displayName.toLowerCase(),
                      value: docSnap.id
                    };
                  });
                } catch (err) {
                  console.warn('[SuggestionsForm] Failed to load groups', err);
                }

                // Load users from usrlookup/names (requires function)
                try {
                  const callable = window.createHttpsCallable ? window.createHttpsCallable('suggestionsFetchNames') : null;
                  if (callable) {
                    const resp = await callable({});
                    const list = resp?.data?.names || [];
                    userSuggestions = list.map((item) => ({
                      id: item.userId || item.id,
                      display: item.fullName || item.normalizedName || item.id,
                      match: (item.fullName || '').toLowerCase(),
                      value: item.normalizedName || simplifyName(item.fullName || '')
                    }));
                  } else {
                    userSuggestions = [];
                  }
                } catch (err) {
                  console.warn('[SuggestionsForm] Failed to load user suggestions (names lookup)', err);
                  userSuggestions = [];
                }
              } finally {
                referenceDataLoading = false;
                referenceDataLoaded = true;
              }
            }

            function formatClassLabel(classId) {
              if (!classId) return '';
              const match = classId.match(/^(\d{1,2})([a-zA-Z])/);
              if (!match) return classId;
              const grade = match[1];
              const letter = match[2].toUpperCase();
              const classLabel = window.translationManager?.getTranslation('youhub.myclass.title', 'Osztályom')?.replace('Osztályom', 'Osztály') || 'Osztály';
              return `${grade}.${letter} ${classLabel}`;
            }

            async function loadLatestSuggestions() {
              const callable = window.createHttpsCallable ? window.createHttpsCallable('suggestionsFetch') : null;
              if (!callable) {
                console.warn('[Suggestions] callable factory missing');
                return;
              }

              const deviceId = getSuggestionsDeviceId();
              const getTranslation = (key, fallback) => window.translationManager?.getTranslation(key) || fallback;
              const unknownUser = getTranslation('youhub.unknown_user', 'Ismeretlen felhasználó');

              try {
                const response = await callable({ deviceId });
                const payload = response?.data || {};

                if (payload.deviceId) {
                  persistSuggestionsDeviceId(payload.deviceId);
                }

                const currentUser = auth.currentUser;
                const items = (payload.suggestions || [])
                  .sort((a, b) => (b?.createdAt || 0) - (a?.createdAt || 0))
                  .slice(0, 4)
                  .map((entry) => {
                    const owner = entry.owner || {};
                    const ownerProfile = {
                      name: owner.fullName || unknownUser,
                      picture: owner.picture || null,
                      userId: owner.userId || null,
                      normalizedName: owner.normalizedName || null,
                      isCurrentUser: !!(owner.userId && currentUser && owner.userId === currentUser.uid)
                    };

                    return {
                      id: entry.id,
                      data: {
                        title: entry.title,
                        content: entry.content,
                        hive: !!entry.hive
                      },
                      ownerProfile
                    };
                  });

                updateSuggestionCards(items);
              } catch (error) {
                console.error('[Suggestions] Failed to load latest entries', error);
                updateSuggestionCards([]);
              }
            }

            function updateSuggestionCards(items) {
              suggestionCardElements.forEach((card, index) => {
                const payload = items[index];
                const titleEl = card.querySelector('.suggestion-card-title');
                const descEl = card.querySelector('.suggestion-card-description');
                const authorEl = card.querySelector('.suggestion-meta-label--author');
                const typeEl = card.querySelector('.suggestion-meta-label--type');
                const avatarEl = card.querySelector('.suggestion-meta-avatar');

                if (!payload) {
                  const getTranslation = (key, fallback) => window.translationManager?.getTranslation(key) || fallback;
                  if (titleEl) titleEl.textContent = getTranslation('youhub.suggestions.card.placeholder_title', 'Javaslat');
                  if (descEl) descEl.textContent = getTranslation('youhub.suggestions.card.placeholder_description', 'Ide fognak kerülni az új javaslataid.');
                  if (authorEl) authorEl.textContent = getTranslation('youhub.suggestions.card.author', 'Név');
                  if (typeEl) typeEl.textContent = getTranslation('youhub.suggestions.card.type_ai_prompt', 'AI prompt');
                  if (avatarEl) {
                    avatarEl.style.backgroundImage = '';
                    avatarEl.style.backgroundColor = '#7B7F78';
                  }
                  return;
                }

                const data = payload.data || {};
                const getTranslation = (key, fallback) => window.translationManager?.getTranslation(key) || fallback;
                const unknownUser = getTranslation('youhub.unknown_user', 'Ismeretlen felhasználó');
                const owner = payload.ownerProfile || { name: unknownUser, picture: null };
                if (titleEl) titleEl.textContent = data.title || getTranslation('youhub.suggestions.card.placeholder_title', 'Javaslat');
                if (descEl) descEl.textContent = data.content || '';
                if (authorEl) authorEl.textContent = owner.name || unknownUser;
                if (typeEl) typeEl.textContent = data.hive ? getTranslation('youhub.suggestions.card.type_hive', 'Hive') : getTranslation('youhub.suggestions.card.type_suggestion', 'Javaslat');
                if (avatarEl) {
                  if (owner.picture) {
                    avatarEl.style.backgroundImage = `url('${owner.picture}')`;
                    avatarEl.style.backgroundSize = 'cover';
                    avatarEl.style.backgroundPosition = 'center';
                  } else {
                    avatarEl.style.backgroundImage = '';
                    avatarEl.style.backgroundColor = '#7B7F78';
                  }
                }
              });
            }

            async function fetchUserProfile(userId, docFn, getDocFn) {
              const getTranslation = (key, fallback) => window.translationManager?.getTranslation(key) || fallback;
              const unknownUser = getTranslation('youhub.unknown_user', 'Ismeretlen felhasználó');
              if (!userId) {
                return { name: unknownUser, picture: null };
              }
              if (userProfileCache.has(userId)) {
                return userProfileCache.get(userId);
              }
              try {
                const db = window.db || suggestionsDb;

                // Load name from public/users/nevek/{userId}
                const nameRef = docFn(db, `public/users/nevek/${userId}`);
                const nameSnap = await getDocFn(nameRef);
                let name = unknownUser;
                if (nameSnap.exists()) {
                  const nameData = nameSnap.data() || {};
                  name = nameData.name || nameData.displayName || unknownUser;
                }

                // Load picture from public/users/profilePictures/{userId}
                let picture = null;
                try {
                  const pictureRef = docFn(db, `public/users/profilePictures/${userId}`);
                  const pictureSnap = await getDocFn(pictureRef);
                  if (pictureSnap.exists()) {
                    const pictureData = pictureSnap.data() || {};
                    // Use profilePictureUrl if available
                    if (pictureData.profilePictureUrl) {
                      picture = pictureData.profilePictureUrl;
                    }
                  }
                } catch (err) {
                  console.warn('[Suggestions] Failed to load user picture', err);
                }

                const profile = { name, picture };
                userProfileCache.set(userId, profile);
                return profile;
              } catch (err) {
                console.warn('[Suggestions] Failed to load user profile', err);
              }
              const fallback = { name: unknownUser, picture: null };
              userProfileCache.set(userId, fallback);
              return fallback;
            }

            function normalizeList(value) {
              return (value || '')
                .split(',')
                .map((token) => token.trim())
                .filter(Boolean)
                .join(', ');
            }

            async function generateSequentialSuggestionId(userId) {
              if (!suggestionsDb) return '1';
              let maxId = 0;
              const { getDocs, collection } = await import("https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js");

              try {
                const rootSnap = await getDocs(collection(suggestionsDb, 'suggestions'));
                rootSnap.forEach((docSnap) => {
                  const numericId = parseInt(docSnap.id, 10);
                  if (!Number.isNaN(numericId)) {
                    maxId = Math.max(maxId, numericId);
                  }
                });
              } catch (err) {
                console.warn('[Suggestions] Failed to read global suggestions for ID generation', err);
              }

              if (userId) {
                try {
                  const userSnap = await getDocs(collection(suggestionsDb, `users/${userId}/suggestions`));
                  userSnap.forEach((docSnap) => {
                    const numericId = parseInt(docSnap.id, 10);
                    if (!Number.isNaN(numericId)) {
                      maxId = Math.max(maxId, numericId);
                    }
                  });
                } catch (err) {
                  console.warn('[Suggestions] Failed to read user suggestions for ID generation', err);
                }
              }

              // Ha nincs dokumentum vagy nincs rendes számú dokumentum, 1-et adunk vissza
              if (maxId === 0) {
                return '1';
              }

              return (maxId + 1).toString();
            }

            async function handleSuggestionSubmit() {
              if (!submitRoot) return;
              if (activeNavId !== 'submit') {
                setActiveNav('submit');
                return;
              }
              if (currentSubmitStep !== 2) {
                setSubmitStep(2);
                return;
              }
              if (!auth.currentUser) {
                const getTranslation = (key, fallback) => window.translationManager?.getTranslation(key) || fallback;
                const msg = getTranslation('youhub.messages.login_required', 'A beküldéshez jelentkezz be.');
                const defaultTitle = getTranslation('youhub.default_notification_title', 'Értesítés');
                await window.showNotification(msg, defaultTitle, 'warning');
                return;
              }

              const title = submitFormState.title.trim();
              const content = submitFormState.content.trim();

              if (!title || !content) {
                const getTranslation = (key, fallback) => window.translationManager?.getTranslation(key) || fallback;
                const msg = getTranslation('youhub.messages.fill_required', 'Kérlek töltsd ki a címet és a javaslat mezőt.');
                const defaultTitle = getTranslation('youhub.default_notification_title', 'Értesítés');
                // Show toast directly in main-scroll-area for immediate feedback
                try {
                  if (window.showToastDirectly && typeof window.showToastDirectly === 'function') {
                    window.showToastDirectly(defaultTitle, msg, 'warning', 'info');
                  } else {
                    await window.showNotification(msg, defaultTitle, 'warning');
                  }
                } catch (error) {
                  console.error('[Suggestions] Failed to show notification:', error);
                  await window.showNotification(msg, defaultTitle, 'warning');
                }
                return;
              }

              try {
                if (globalSubmitBtn) globalSubmitBtn.disabled = true;
                const { doc, setDoc, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js");

                const suggestionId = await generateSequentialSuggestionId(auth.currentUser.uid);
                const resolvedUsers = normalizeList(submitFormState.restrictUsers).map((token) => {
                  const match = userSuggestions.find(u => u.display.toLowerCase() === token.toLowerCase());
                  return match?.value || token;
                });

                const resolvedGroups = normalizeList(submitFormState.restrictGroups).map((token) => {
                  const match = [...classSuggestions, ...groupSuggestions].find(g => g.display.toLowerCase() === token.toLowerCase());
                  return match?.id || match?.value || token;
                });

                const payload = {
                  title,
                  content,
                  hive: !!submitFormState.hive,
                  share: !!submitFormState.share,
                  restrictToUsers: resolvedUsers,
                  restrictToGroups: resolvedGroups,
                  ownerId: auth.currentUser.uid,
                  createdAt: serverTimestamp()
                };

                const rootRef = doc(suggestionsDb, 'suggestions', suggestionId);
                const userRef = doc(suggestionsDb, 'users', auth.currentUser.uid, 'suggestions', suggestionId);

                await Promise.all([
                  setDoc(rootRef, payload),
                  setDoc(userRef, payload)
                ]);

                clearFormState();
                // Return to previous nav (hive or suggestions) after successful submit
                const returnNavId = previousNavId || DEFAULT_NAV_ID;
                setActiveNav(returnNavId);
                loadLatestSuggestions();
                const getTranslation = (key, fallback) => {
                  try {
                    return window.translationManager?.getTranslation(key) || fallback;
                  } catch {
                    return fallback;
                  }
                };
                const successMsg = getTranslation('youhub.messages.submit_success', 'A javaslatot sikeresen beküldted!');
                const successTitle = getTranslation('youhub.notifications.types.success', 'Sikeres beküldés');
                await window.showNotification(successMsg, successTitle, 'positive');
              } catch (error) {
                console.error('[Suggestions] Submission failed', error);
                const errorMsg = window.translationManager?.getTranslation('youhub.messages.submit_error') || 'Nem sikerült beküldeni a javaslatot. Próbáld újra később.';
                const getTranslation = (key, fallback) => window.translationManager?.getTranslation(key) || fallback;
                const errorTitle = getTranslation('youhub.notifications.types.error', 'Hiba');
                await window.showNotification(errorMsg, errorTitle, 'danger');
              } finally {
                if (globalSubmitBtn) globalSubmitBtn.disabled = false;
              }
            }

            async function updateHiveVisibility(user) {
              if (!hiveButton) return;

              if (!user) {
                hiveButton.classList.add('is-hidden');
                if (activeNavId === 'hive') setActiveNav(DEFAULT_NAV_ID);
                return;
              }

              try {
                const userRef = doc(suggestionsDb, 'users', user.uid);
                const userSnap = await getDoc(userRef);
                const accessLevel = (userSnap.data()?.accessLevel || '').toLowerCase();
                const shouldShowHive = allowedAccessLevels.has(accessLevel);

                if (shouldShowHive) {
                  hiveButton.classList.remove('is-hidden');
                } else {
                  hiveButton.classList.add('is-hidden');
                  if (activeNavId === 'hive') setActiveNav(DEFAULT_NAV_ID);
                }
              } catch (error) {
                console.error('[SuggestionsNav] Failed to evaluate accessLevel:', error);
                hiveButton.classList.add('is-hidden');
                if (activeNavId === 'hive') setActiveNav(DEFAULT_NAV_ID);
              }
            }

            try {
              onAuthStateChanged(auth, async (user) => {
                await updateHiveVisibility(user);
                // Ensure "Javaslatok" is active by default
                if (activeNavId !== 'submit' && activeNavId !== 'hive') {
                  setActiveNav(DEFAULT_NAV_ID);
                }
              });
            } catch (error) {
              console.error('[SuggestionsNav] Auth listener error:', error);
              hiveButton?.classList.add('is-hidden');
              if (activeNavId === 'hive') setActiveNav(DEFAULT_NAV_ID);
            }

            // Ensure "Javaslatok" is active by default on initial load
            setTimeout(() => {
              if (activeNavId !== 'submit' && activeNavId !== 'hive') {
                setActiveNav(DEFAULT_NAV_ID);
              }
            }, 100);
          </script>
        </div>

        <!-- Footer -->
        <footer class="site-footer">
          <!-- Left Column -->
          <div class="footer-left">
            <!-- Logo and participated section -->
            <div class="footer-logo-container">
              <img src="assets/general/footer/eu2k_hub.png" alt="EU2K Hub">
              <span class="footer-participated-text">Részt vett még:</span>
              <div class="footer-participated-logos">
                <img src="assets/general/footer/eu2k.png" alt="EU2K">
                <img src="assets/general/footer/eu2k_devs.png" alt="EU2K Devs">
                <img src="assets/general/footer/eu2k_dok.png" alt="EU2K Dok">
                <img src="assets/general/footer/eu2k_ujsag.png" alt="EU2K Újság">
              </div>
            </div>

            <!-- Copyright -->
            <div class="footer-copyright">
              © 2025 EU2K Devs és Európa 2000 Gimnázium. All Rights Reserved.
            </div>

            <!-- Social icons -->
            <div class="footer-social">
              <img src="assets/general/footer/eu2k_ujsag.svg" alt="EU2K Újság"
                onclick="window.open('https://sites.google.com/view/eu2k-ujsag', '_blank')">
              <img src="assets/general/footer/x.svg" alt="X (Twitter)"
                onclick="window.open('https://x.com/eu2kdevs', '_blank')">
              <img src="assets/general/footer/instagram.svg" alt="Instagram"
                onclick="window.open('https://instagram.com/eu2k.devs', '_blank')">
              <img src="assets/general/footer/yt.svg" alt="YouTube"
                onclick="window.open('https://youtube.com/@eu2kdevs', '_blank')">
            </div>
          </div>

          <!-- Right Column -->
          <div class="footer-right">
            <!-- Jogi Nyilatkozatok -->
            <div class="footer-section-first">
              <div class="footer-section-title" data-translate="footer.legal.title">Jogi Nyilatkozatok</div>
              <div class="footer-section-items">
                <a href="privacy-policy.html" class="footer-item"
                  data-translate="footer.legal.privacy">Adatvédelmi&nbsp;Tájékoztató</a>
                <a href="terms-of-service.html" class="footer-item"
                  data-translate="footer.legal.terms">Használati&nbsp;Feltételek</a>
              </div>
            </div>

            <!-- Hubs -->
            <div class="footer-section">
              <div class="footer-section-title" data-translate="footer.hubs.title">Hubs</div>
              <div class="footer-section-items">
                <a href="youhub.html" class="footer-item">YouHub</a>
                <div class="footer-item">Class&nbsp;Hub<span class="beta-badge" data-translate="footer.hubs.soon"
                    data-translate-fallback="SOON">SOON</span></div>
                <div class="footer-item">Food&nbsp;Hub<span class="beta-badge" data-translate="footer.hubs.soon"
                    data-translate-fallback="SOON">SOON</span></div>
                <div class="footer-item">Event&nbsp;Hub<span class="beta-badge" data-translate="footer.hubs.soon"
                    data-translate-fallback="SOON">SOON</span></div>
                <div class="footer-item">Fitness&nbsp;Hub<span class="beta-badge" data-translate="footer.hubs.soon"
                    data-translate-fallback="SOON">SOON</span></div>
              </div>
            </div>

          </div>
        </footer>
      </div>
    </main>
  </div>


  <!-- <script>
    // Check if user has accepted terms of service and redirect to appropriate onboarding
    document.addEventListener('DOMContentLoaded', () => {
      // FIRST: Check if user is already logged in and has completed onboarding
      const isLoggedIn = localStorage.getItem('eu2k-auth-logged-in') === 'true';
      const onboardingCompleted = localStorage.getItem('onboardingCompleted') === 'true';
      const termsAccepted = localStorage.getItem('termsAccepted') === 'true';
      
      console.log('🔍 Index.html redirect check:', {
        isLoggedIn,
        onboardingCompleted,
        termsAccepted
      });
      
      // If user is logged in and onboarding is completed, stay on index.html
      if (isLoggedIn && onboardingCompleted && termsAccepted) {
        console.log('✅ User is fully set up, staying on index.html');
        // Mark as visited to prevent welcome screen redirect
        if (window.welcomeScreenManager) {
          window.welcomeScreenManager.markAsVisited();
        }
        return;
      }
      
      // Only redirect to onboarding if terms are not accepted
      if (termsAccepted !== 'true') {
        console.log('📋 Terms not accepted, redirecting to onboarding...');
        
        const userType = localStorage.getItem('eu2k-user-type');
        
        if (isLoggedIn && userType) {
          // Redirect to appropriate onboarding based on user type
          switch (userType) {
            case 'student':
              window.location.href = 'welcome/onboarding_student.html#student-profile';
              break;
            case 'parent':
              window.location.href = 'welcome/onboarding_parent.html#parent-profile';
              break;
            case 'teacher':
              window.location.href = 'welcome/onboarding_teacher.html#teacher-profile';
              break;
            default:
              // Default to student onboarding if user type is unknown
              window.location.href = 'welcome/onboarding_student.html';
          }
        } else {
          // Not logged in, redirect to default student onboarding
          window.location.href = 'welcome/onboarding_student.html';
        }
      }
    });
  </script>
  <script type="module">
    import { getAuth, signInWithPopup, OAuthProvider } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";

    const auth = getAuth();

    // Globális Microsoft bejelentkezés függvény
    window.startMicrosoftSignIn = async () => {
      console.log('🔐 Microsoft bejelentkezés indítása...');
      try {
        const provider = new OAuthProvider('microsoft.com');
        try { provider.setCustomParameters?.({ prompt: 'select_account' }); } catch {}

        const result = await signInWithPopup(auth, provider);
        const user = result?.user;
        console.log('✅ Microsoft bejelentkezés sikeres:', user);

        localStorage.setItem('eu2k-auth-logged-in', 'true');

        const termsAccepted = localStorage.getItem('termsAccepted') === 'true';
        const userType = localStorage.getItem('eu2k-user-type') || 'student';
        if (!termsAccepted) {
          switch (userType) {
            case 'student':
              window.location.href = 'welcome/onboarding_student.html#student-profile';
              return;
            case 'parent':
              window.location.href = 'welcome/onboarding_parent.html#parent-profile';
              return;
            case 'teacher':
              window.location.href = 'welcome/onboarding_teacher.html#teacher-profile';
              return;
            default:
              window.location.href = 'welcome/onboarding_student.html';
              return;
          }
        }

        window.location.href = 'index.html';
      } catch (error) {
        console.error('❌ Microsoft bejelentkezés hiba:', error);
        const unknownError = window.translationManager?.getTranslation('youhub.unknown_error') || 'Ismeretlen hiba';
        const msg = (error && (error.message || error.code)) || unknownError;
        await window.showNotification('Microsoft bejelentkezés nem érhető el: ' + msg, 'Hiba', 'danger');
      }
    };

    window.isMicrosoftSignInAvailable = () => {
      try {
        return typeof window.startMicrosoftSignIn === 'function';
      } catch {
        return false;
      }
    };
  </script> -->

  <!-- YouHub Drag and Drop System -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const STORAGE_KEY = 'youhub-card-order';
      const DEFAULT_ORDER = ['class', 'notifications', 'suggestions', 'calendar'];

      let isEditMode = false;
      let draggedCard = null;
      let draggedIndex = -1;
      let cardOrder = [];
      let hoverStartTime = null;
      let hoveredCard = null;
      let shiftTimeout = null;
      let currentTargetIndex = null;
      let targetStartTime = null;
      let moveTimeout = null;


      const editBtn = document.getElementById('headerEditModeBtn');
      if (!editBtn) {
        console.error('headerEditModeBtn not found');
        return;
      }
      const editIcon = editBtn.querySelector('.header-edit-mode-icon');
      const editText = editBtn.querySelector('.header-edit-mode-text');
      const grid = document.querySelector('.youhub-grid');
      if (!grid) {
        console.error('youhub-grid not found');
        return;
      }
      const cards = Array.from(document.querySelectorAll('.youhub-card'));

      // Load saved order from localStorage
      function loadCardOrder() {
        try {
          const saved = localStorage.getItem(STORAGE_KEY);
          if (saved) {
            cardOrder = JSON.parse(saved);
            if (cardOrder.length === 4) {
              reorderCards(cardOrder);
              return;
            }
          }
        } catch (e) {
          console.warn('Failed to load card order:', e);
        }
        cardOrder = DEFAULT_ORDER.slice();
      }

      // Save order to localStorage
      function saveCardOrder() {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(cardOrder));
        } catch (e) {
          console.warn('Failed to save card order:', e);
        }
      }

      // Reorder cards based on order array
      function reorderCards(order) {
        order.forEach((cardId, index) => {
          const card = document.querySelector(`[data-card-id="${cardId}"]`);
          if (card) {
            grid.appendChild(card);
          }
        });
        cardOrder = order.slice();
      }

      // Get card index in grid
      function getCardIndex(card) {
        return Array.from(grid.children).indexOf(card);
      }

      // Get card position (row, col)
      function getCardPosition(index) {
        return {
          row: Math.floor(index / 2),
          col: index % 2
        };
      }

      // Add bounce animation to card
      function bounceCard(card) {
        if (!card) return;
        card.classList.add('bounce');
        setTimeout(() => {
          card.classList.remove('bounce');
        }, 500);
      }

      // Toggle edit mode
      function toggleEditMode() {
        isEditMode = !isEditMode;

        // Get fresh cards list
        const currentCards = Array.from(document.querySelectorAll('.youhub-card'));
        const revertBtn = document.getElementById('youhubRevertBtn');

        if (isEditMode) {
          grid.classList.add('edit-mode');
          editIcon.src = 'assets/youhub/x.svg';
          updateEditButtonText();
          if (revertBtn) revertBtn.style.display = 'flex';

          // Enable dragging
          currentCards.forEach(card => {
            card.draggable = true;
            const handle = card.querySelector('.youhub-card-handle');
            if (handle) {
              handle.addEventListener('mousedown', startDrag);
              // Add hover listeners for bounce animation
              handle.addEventListener('mouseenter', () => {
                if (!draggedCard) {
                  bounceCard(card);
                }
              });
            }
          });
        } else {
          grid.classList.remove('edit-mode', 'dragging-active');
          editIcon.src = 'assets/youhub/edit.svg';
          updateEditButtonText();
          if (revertBtn) revertBtn.style.display = 'none';

          // Disable dragging
          currentCards.forEach(card => {
            card.draggable = false;
            card.classList.remove('dragging', 'drag-over', 'bounce');
            const handle = card.querySelector('.youhub-card-handle');
            if (handle) {
              handle.removeEventListener('mousedown', startDrag);
            }
          });

          // Save order
          updateCardOrder();
          saveCardOrder();
        }
      }

      // Show revert popup
      function showRevertPopup() {
        const openPopup = () => {
          const scrollArea = document.querySelector('.main-scroll-area');
          if (scrollArea) {
            scrollArea.scrollTop = 0;
            scrollArea.classList.add('no-scroll');
            scrollArea.classList.add('popup-active');
          }
          setTimeout(() => {
            document.getElementById('revertPopup').style.display = 'flex';
          }, 50);
        };

        if (window.tryOpenPopup) {
          window.tryOpenPopup(openPopup);
        } else {
          openPopup();
        }
      }

      // Close revert popup - make it global
      window.closeRevertPopup = function () {
        const popup = document.getElementById('revertPopup');
        if (popup) {
          popup.style.display = 'none';
        }
        const scrollArea = document.querySelector('.main-scroll-area');
        if (scrollArea) {
          scrollArea.classList.remove('no-scroll');
          scrollArea.classList.remove('popup-active');
        }
      }

      // Confirm revert - reset to default order - make it global
      window.confirmRevert = function () {
        // Reset to default order
        const defaultOrder = ['class', 'notifications', 'suggestions', 'calendar'];

        // FLIP animation for revert
        const allCards = Array.from(grid.children).filter(c => c.classList.contains('youhub-card'));

        // FLIP Step 1: FIRST - Store initial positions
        const first = new Map();
        allCards.forEach(card => {
          first.set(card, card.getBoundingClientRect());
        });

        // FLIP Step 2: Reorder cards
        reorderCards(defaultOrder);

        // FLIP Step 3: LAST - Get new positions
        const last = new Map();
        allCards.forEach(card => {
          last.set(card, card.getBoundingClientRect());
        });

        // FLIP Step 4: INVERT & PLAY - Animate the difference
        allCards.forEach(card => {
          const firstRect = first.get(card);
          const lastRect = last.get(card);

          if (firstRect && lastRect) {
            const dx = firstRect.left - lastRect.left;
            const dy = firstRect.top - lastRect.top;

            // Only animate if position actually changed
            if (Math.abs(dx) > 1 || Math.abs(dy) > 1) {
              // INVERT: Set transform to the difference
              card.style.transition = 'none';
              card.style.transform = `translate(${dx}px, ${dy}px)`;

              // Force reflow
              card.offsetHeight;

              // PLAY: Animate back to final position
              requestAnimationFrame(() => {
                card.style.transition = 'transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1)';
                card.style.transform = '';
              });
            }
          }
        });

        // Save to localStorage
        cardOrder = defaultOrder.slice();
        saveCardOrder();

        // Close popup
        closeRevertPopup();
      }

      // Update card order array
      function updateCardOrder() {
        cardOrder = Array.from(grid.children)
          .filter(card => card.getAttribute('data-card-id'))
          .map(card => card.getAttribute('data-card-id'));
      }

      // Shift cards when drag starts - fill the gap by moving all cards after dragged one left with FLIP animation
      function shiftCardsOnDragStart(fromIndex) {
        // Get all cards except draggedCard
        const allChildren = Array.from(grid.children).filter(c => c !== draggedCard);

        // FLIP Step 1: FIRST - Store initial positions
        const first = new Map();
        allChildren.forEach(item => {
          first.set(item, item.getBoundingClientRect());
        });

        // FLIP Step 2: Move cards (this changes the layout)
        const cardsToShift = [];
        for (let i = fromIndex; i < allChildren.length; i++) {
          if (allChildren[i]) {
            cardsToShift.push(allChildren[i]);
          }
        }

        cardsToShift.forEach((card, idx) => {
          if (!card) return;
          const targetPosition = fromIndex + idx;
          const currentChildren = Array.from(grid.children).filter(c => c !== draggedCard);

          if (targetPosition < currentChildren.length) {
            const targetCard = currentChildren[targetPosition];
            if (targetCard && targetCard !== card) {
              grid.insertBefore(card, targetCard);
            }
          }
        });

        // FLIP Step 3: LAST - Get new positions after layout change
        const last = new Map();
        allChildren.forEach(item => {
          last.set(item, item.getBoundingClientRect());
        });

        // FLIP Step 4: INVERT & PLAY - Animate the difference
        allChildren.forEach(item => {
          const firstRect = first.get(item);
          const lastRect = last.get(item);

          if (firstRect && lastRect) {
            const dx = firstRect.left - lastRect.left;
            const dy = firstRect.top - lastRect.top;

            // Only animate if position actually changed
            if (Math.abs(dx) > 1 || Math.abs(dy) > 1) {
              // INVERT: Set transform to the difference (so it appears in old position)
              item.style.transition = 'none';
              item.style.transform = `translate(${dx}px, ${dy}px)`;

              // Force reflow
              item.offsetHeight;

              // PLAY: Animate back to final position
              requestAnimationFrame(() => {
                item.style.transition = 'transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1)';
                item.style.transform = '';
              });
            }
          }
        });
      }

      // Start drag
      function startDrag(e) {
        e.preventDefault();
        draggedCard = e.target.closest('.youhub-card');
        if (!draggedCard) return;

        // Add dragging-active class to grid
        grid.classList.add('dragging-active');

        // Initialize target tracking variables
        currentTargetIndex = null;
        targetStartTime = Date.now();
        if (moveTimeout) {
          clearTimeout(moveTimeout);
          moveTimeout = null;
        }

        draggedIndex = getCardIndex(draggedCard);
        const rect = draggedCard.getBoundingClientRect();

        // Store initial position and offset
        draggedCard._dragOffset = {
          x: e.clientX - rect.left,
          y: e.clientY - rect.top
        };

        // Remove card from grid first
        draggedCard.classList.add('dragging');
        draggedCard.style.position = 'fixed';
        draggedCard.style.width = rect.width + 'px';
        draggedCard.style.height = rect.height + 'px';
        draggedCard.style.left = e.clientX - draggedCard._dragOffset.x + 'px';
        draggedCard.style.top = e.clientY - draggedCard._dragOffset.y + 'px';
        draggedCard.style.margin = '0';

        // Shift cards to fill the gap
        shiftCardsOnDragStart(draggedIndex);

        // Create placeholder at the end
        const placeholder = document.createElement('div');
        placeholder.className = 'youhub-card-placeholder';
        placeholder.style.width = rect.width + 'px';
        placeholder.style.height = rect.height + 'px';
        placeholder.style.visibility = 'hidden';
        draggedCard._placeholder = placeholder;
        grid.appendChild(placeholder);

        document.addEventListener('mousemove', onDrag);
        document.addEventListener('mouseup', endDrag);
      }

      // Auto-scroll when near edges
      function handleAutoScroll(e) {
        const scrollArea = document.querySelector('.main-scroll-area');
        if (!scrollArea) return;

        const scrollSpeed = 15; // Increased from 5 to 15 for faster scrolling
        const threshold = 32;

        // Vertical scroll only
        if (e.clientY < threshold) {
          scrollArea.scrollTop -= scrollSpeed;
        } else if (e.clientY > window.innerHeight - threshold) {
          scrollArea.scrollTop += scrollSpeed;
        }
      }

      // Shift cards to make space for target position with smooth animation
      function shiftCardsToPosition(targetIndex) {
        const placeholderIndex = getCardIndex(draggedCard._placeholder);

        if (targetIndex === placeholderIndex) return; // No shift needed

        // Use requestAnimationFrame to ensure smooth animation
        requestAnimationFrame(() => {
          // Get current state
          const currentChildren = Array.from(grid.children);
          const cardElements = currentChildren.filter(c => c !== draggedCard && c !== draggedCard._placeholder);

          if (targetIndex < placeholderIndex) {
            // Moving left: cards from targetIndex to placeholderIndex-1 need to shift right
            const cardsToMove = [];
            for (let i = targetIndex; i < placeholderIndex && i < cardElements.length; i++) {
              if (cardElements[i]) cardsToMove.push(cardElements[i]);
            }

            // Move them one position right (reverse order to avoid conflicts)
            cardsToMove.reverse().forEach((card) => {
              const currentPos = getCardIndex(card);
              const nextPos = currentPos + 1;
              const allCurrent = Array.from(grid.children);
              if (nextPos < allCurrent.length) {
                const nextCard = allCurrent[nextPos];
                if (nextCard && nextCard !== draggedCard && nextCard !== draggedCard._placeholder) {
                  grid.insertBefore(card, nextCard.nextSibling);
                }
              } else {
                grid.appendChild(card);
              }
            });
          } else {
            // Moving right: cards from placeholderIndex to targetIndex-1 need to shift left
            const cardsToMove = [];
            for (let i = placeholderIndex; i < targetIndex && i < cardElements.length; i++) {
              if (cardElements[i]) cardsToMove.push(cardElements[i]);
            }

            // Move them one position left
            cardsToMove.forEach((card) => {
              const currentPos = getCardIndex(card);
              const prevPos = currentPos - 1;
              const allCurrent = Array.from(grid.children);
              if (prevPos >= 0) {
                const prevCard = allCurrent[prevPos];
                if (prevCard && prevCard !== draggedCard && prevCard !== draggedCard._placeholder) {
                  grid.insertBefore(card, prevCard);
                } else {
                  const firstCard = allCurrent[0];
                  if (firstCard && firstCard !== draggedCard && firstCard !== draggedCard._placeholder) {
                    grid.insertBefore(card, firstCard);
                  }
                }
              }
            });
          }
        });
      }

      // Calculate distance from point to edge
      function distanceToEdge(px, py, rect, edge) {
        if (edge === 'top') {
          return Math.abs(py - rect.top);
        } else if (edge === 'bottom') {
          return Math.abs(py - rect.bottom);
        } else if (edge === 'left') {
          return Math.abs(px - rect.left);
        } else if (edge === 'right') {
          return Math.abs(px - rect.right);
        }
        return Infinity;
      }

      // Calculate distance from point to center
      function distanceToCenter(px, py, rect) {
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;
        return Math.sqrt(Math.pow(px - centerX, 2) + Math.pow(py - centerY, 2));
      }

      // Get target index based on cursor position
      function getTargetIndexFromCursor(cursorX, cursorY) {
        const placeholderIndex = getCardIndex(draggedCard._placeholder);
        const cardElements = Array.from(grid.children).filter(c => c !== draggedCard && c !== draggedCard._placeholder && c.classList.contains('youhub-card'));

        // Get placeholder position
        const placeholderRect = draggedCard._placeholder.getBoundingClientRect();
        const placeholderDist = Math.min(
          distanceToEdge(cursorX, cursorY, placeholderRect, 'top'),
          distanceToEdge(cursorX, cursorY, placeholderRect, 'bottom'),
          distanceToEdge(cursorX, cursorY, placeholderRect, 'left'),
          distanceToEdge(cursorX, cursorY, placeholderRect, 'right'),
          distanceToCenter(cursorX, cursorY, placeholderRect)
        );

        // Find closest target (edge or center)
        let minDist = placeholderDist;
        let targetIndex = placeholderIndex;

        // Check each card's edges and center
        cardElements.forEach(card => {
          const rect = card.getBoundingClientRect();
          const cardIndex = getCardIndex(card);
          const pos = getCardPosition(cardIndex);

          // Check center
          const centerDist = distanceToCenter(cursorX, cursorY, rect);
          if (centerDist < minDist) {
            minDist = centerDist;
            targetIndex = cardIndex;
          }

          // Check edges
          const threshold = 50; // Distance threshold for edge detection

          // Top edge (only if card is in top row)
          if (pos.row === 0) {
            const topDist = distanceToEdge(cursorX, cursorY, rect, 'top');
            if (topDist < minDist && topDist < threshold) {
              minDist = topDist;
              targetIndex = cardIndex; // Card moves down, target is its position
            }
          }

          // Bottom edge (only if card is in bottom row)
          if (pos.row === 1) {
            const bottomDist = distanceToEdge(cursorX, cursorY, rect, 'bottom');
            if (bottomDist < minDist && bottomDist < threshold) {
              minDist = bottomDist;
              targetIndex = cardIndex - 2; // Card moves up, target is position above
            }
          }

          // Left edge (only if card is in left column)
          if (pos.col === 0) {
            const leftDist = distanceToEdge(cursorX, cursorY, rect, 'left');
            if (leftDist < minDist && leftDist < threshold) {
              minDist = leftDist;
              targetIndex = cardIndex; // Card moves right, target is its position
            }
          }

          // Right edge (only if card is in right column)
          if (pos.col === 1) {
            const rightDist = distanceToEdge(cursorX, cursorY, rect, 'right');
            if (rightDist < minDist && rightDist < threshold) {
              minDist = rightDist;
              targetIndex = cardIndex - 1; // Card moves left, target is position to the left
            }
          }
        });

        // Clamp target index
        targetIndex = Math.max(0, Math.min(3, targetIndex));

        return targetIndex;
      }

      // FLIP animation: Move placeholder with smooth animation for cards
      function movePlaceholderWithAnimation(targetIndex) {
        const placeholderIndex = getCardIndex(draggedCard._placeholder);
        if (targetIndex === placeholderIndex) return;

        // Get all cards (including placeholder for position tracking)
        const allItems = Array.from(grid.children).filter(c => c !== draggedCard);

        // FLIP Step 1: FIRST - Store initial positions
        const first = new Map();
        allItems.forEach(item => {
          first.set(item, item.getBoundingClientRect());
        });

        // FLIP Step 2: Move placeholder (this changes the layout)
        const allChildren = Array.from(grid.children);
        const targetElement = allChildren[targetIndex];
        if (targetElement && targetElement !== draggedCard._placeholder) {
          grid.insertBefore(draggedCard._placeholder, targetElement);
        } else if (targetIndex >= allChildren.length - 1) {
          grid.appendChild(draggedCard._placeholder);
        }

        // FLIP Step 3: LAST - Get new positions after layout change
        const last = new Map();
        allItems.forEach(item => {
          last.set(item, item.getBoundingClientRect());
        });

        // FLIP Step 4: INVERT & PLAY - Animate the difference
        allItems.forEach(item => {
          const firstRect = first.get(item);
          const lastRect = last.get(item);

          if (firstRect && lastRect) {
            const dx = firstRect.left - lastRect.left;
            const dy = firstRect.top - lastRect.top;

            // Only animate if position actually changed
            if (Math.abs(dx) > 1 || Math.abs(dy) > 1) {
              // INVERT: Set transform to the difference (so it appears in old position)
              item.style.transition = 'none';
              item.style.transform = `translate(${dx}px, ${dy}px)`;

              // Force reflow
              item.offsetHeight;

              // PLAY: Animate back to final position
              requestAnimationFrame(() => {
                item.style.transition = 'transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1)';
                item.style.transform = '';
              });
            }
          }
        });

        // Update visual feedback
        const cardElements = Array.from(grid.children).filter(c => c !== draggedCard && c !== draggedCard._placeholder && c.classList.contains('youhub-card'));
        cardElements.forEach(card => {
          card.classList.remove('drag-over');
          const cardIndex = getCardIndex(card);
          const placeholderNewIndex = getCardIndex(draggedCard._placeholder);
          if (Math.abs(cardIndex - placeholderNewIndex) === 1 || Math.abs(cardIndex - placeholderNewIndex) === 2) {
            card.classList.add('drag-over');
          }
        });
      }

      // On drag
      function onDrag(e) {
        if (!draggedCard) return;

        // Update card position to follow cursor
        draggedCard.style.left = e.clientX - draggedCard._dragOffset.x + 'px';
        draggedCard.style.top = e.clientY - draggedCard._dragOffset.y + 'px';

        // Auto-scroll when near edges
        handleAutoScroll(e);

        const placeholderIndex = getCardIndex(draggedCard._placeholder);
        const targetIndex = getTargetIndexFromCursor(e.clientX, e.clientY);

        // Check if target changed
        if (targetIndex !== currentTargetIndex) {
          // Target changed - reset timer
          currentTargetIndex = targetIndex;
          targetStartTime = Date.now();

          // Clear any existing timeout
          if (moveTimeout) {
            clearTimeout(moveTimeout);
            moveTimeout = null;
          }
        }

        // Only move placeholder if target is different from placeholder and we've been on this target for 1.5 seconds
        if (targetIndex !== placeholderIndex && targetIndex >= 0 && targetIndex < 4) {
          const timeOnTarget = Date.now() - targetStartTime;
          const delayMs = 1500; // 1.5 seconds delay

          if (timeOnTarget >= delayMs && !moveTimeout) {
            // Time has passed - move placeholder with animation
            movePlaceholderWithAnimation(targetIndex);
          } else if (timeOnTarget < delayMs && !moveTimeout) {
            // Set timeout to move after delay
            moveTimeout = setTimeout(() => {
              if (currentTargetIndex === targetIndex && draggedCard && draggedCard._placeholder) {
                movePlaceholderWithAnimation(targetIndex);
              }
              moveTimeout = null;
            }, delayMs - timeOnTarget);
          }
        } else {
          // Target is same as placeholder or invalid - clear timeout
          if (moveTimeout) {
            clearTimeout(moveTimeout);
            moveTimeout = null;
          }
        }
      }

      // End drag
      function endDrag(e) {
        if (!draggedCard) return;

        // Get target index from cursor position
        const targetIndex = getTargetIndexFromCursor(e.clientX, e.clientY);
        const placeholderIndex = draggedCard._placeholder ? getCardIndex(draggedCard._placeholder) : -1;

        // Remove placeholder
        if (draggedCard._placeholder) {
          draggedCard._placeholder.remove();
          draggedCard._placeholder = null;
        }

        // Insert card at target position
        const finalCardElements = Array.from(grid.children).filter(c => c !== draggedCard);
        if (targetIndex >= 0 && targetIndex < finalCardElements.length) {
          grid.insertBefore(draggedCard, finalCardElements[targetIndex]);
        } else {
          grid.appendChild(draggedCard);
        }

        // Reset card styles
        draggedCard.style.position = '';
        draggedCard.style.width = '';
        draggedCard.style.height = '';
        draggedCard.style.left = '';
        draggedCard.style.top = '';
        draggedCard.style.margin = '';
        delete draggedCard._dragOffset;

        // Cleanup - remove transform and transition from all cards
        const allCards = Array.from(document.querySelectorAll('.youhub-card'));
        allCards.forEach(card => {
          card.style.transform = '';
          card.style.transition = '';
          card.classList.remove('drag-over');
        });
        draggedCard.classList.remove('dragging');
        grid.classList.remove('dragging-active');
        draggedCard = null;
        draggedIndex = -1;
        hoveredCard = null;
        hoverStartTime = null;
        currentTargetIndex = null;
        targetStartTime = null;
        if (shiftTimeout) {
          clearTimeout(shiftTimeout);
          shiftTimeout = null;
        }
        if (moveTimeout) {
          clearTimeout(moveTimeout);
          moveTimeout = null;
        }

        document.removeEventListener('mousemove', onDrag);
        document.removeEventListener('mouseup', endDrag);

        updateCardOrder();
      }

      // Update edit button text based on current language and mode
      function updateEditButtonText() {
        if (!editText) return;
        try {
          if (isEditMode) {
            editText.textContent = window.translationManager?.getTranslation('youhub.edit_mode.exit') || 'Kilépés a szerkesztési módból';
          } else {
            editText.textContent = window.translationManager?.getTranslation('youhub.edit_mode.enter') || 'Szerkesztés';
          }
        } catch (error) {
          console.warn('[YouHub] Error updating edit button text:', error);
          // Fallback to default text
          editText.textContent = isEditMode ? 'Kilépés a szerkesztési módból' : 'Szerkesztés';
        }
      }

      // Hook into translation system to update button text on language change
      if (window.translationManager) {
        // Override applyTranslations to update edit button text after translations are applied
        const originalApplyTranslations = window.translationManager.applyTranslations;
        if (originalApplyTranslations) {
          window.translationManager.applyTranslations = function () {
            const result = originalApplyTranslations.call(this);
            // Update edit button text after translations are applied
            setTimeout(() => {
              updateEditButtonText();
            }, 50);
            return result;
          };
        }

        // Also listen for language change events
        if (window.translationManager.onLanguageChange) {
          const originalOnLanguageChange = window.translationManager.onLanguageChange;
          window.translationManager.onLanguageChange = () => {
            if (originalOnLanguageChange) originalOnLanguageChange();
            updateEditButtonText();
          };
        } else {
          window.translationManager.onLanguageChange = () => {
            updateEditButtonText();
          };
        }

        // Listen for storage events (language change from other tabs)
        window.addEventListener('storage', (e) => {
          if (e.key === 'eu2k_language') {
            setTimeout(() => {
              updateEditButtonText();
              // Also update MyClass state templates if they're visible
              if (middleSection && currentMode) {
                renderMyClassState(currentMode);
              }
            }, 100);
          }
        });

        // Hook into translation manager's applyTranslations to update MyClass states
        if (window.translationManager && window.translationManager.applyTranslations) {
          const originalApplyTranslations = window.translationManager.applyTranslations;
          window.translationManager.applyTranslations = function () {
            const result = originalApplyTranslations.call(this);
            // Update MyClass state templates if they're visible
            setTimeout(() => {
              if (middleSection && currentMode) {
                renderMyClassState(currentMode);
              }
            }, 50);
            return result;
          };
        }
      }

      // Initialize
      editBtn.addEventListener('click', toggleEditMode);
      const revertBtn = document.getElementById('youhubRevertBtn');
      if (revertBtn) {
        revertBtn.addEventListener('click', showRevertPopup);
      }
      loadCardOrder();

      // Initial update of edit button text - wait for translation manager to be ready
      const initEditButton = () => {
        if (window.translationManager && window.translationManager.translations) {
          updateEditButtonText();
        } else {
          // Wait for translation manager to load
          setTimeout(initEditButton, 100);
        }
      };
      initEditButton();

      // MyClass data + chart helpers
      const MONTH_NAMES_HU = ['Január', 'Február', 'Március', 'Április', 'Május', 'Június', 'Július', 'Augusztus', 'Szeptember', 'Október', 'November', 'December'];
      const MONTH_OFFSETS = [-5, -4, -3, -2, -1, 0, 1, 2, 3]; // Fixed order: 7, 8, 9, 10, 11, current, 1, 2, 3

      // Get month name in current language
      function getMonthName(monthIndex) {
        if (!window.translationManager) {
          return MONTH_NAMES_HU[monthIndex] || '';
        }
        const monthKeys = [
          'general.months.january',
          'general.months.february',
          'general.months.march',
          'general.months.april',
          'general.months.may',
          'general.months.june',
          'general.months.july',
          'general.months.august',
          'general.months.september',
          'general.months.october',
          'general.months.november',
          'general.months.december'
        ];
        try {
          const translation = window.translationManager?.getTranslation(monthKeys[monthIndex]);
          return translation || MONTH_NAMES_HU[monthIndex] || '';
        } catch (error) {
          console.warn('[YouHub] Error getting month translation:', error);
          return MONTH_NAMES_HU[monthIndex] || '';
        }
      }
      let myClassGradesData = null;

      // Check if a month is in the next school year (should be ignored if current year is 2025 and month is 2026 Jan-Jun)
      function isMonthInNextSchoolYear(monthNumber, monthYear, currentYear, currentMonthIndex) {
        // If current year is 2025 and current month is Sep-Dec (8-11), then 2026 Jan-Jun should be ignored
        if (currentYear === 2025 && currentMonthIndex >= 8) {
          // Next year months: Jan (1), Feb (2), Mar (3), Apr (4), May (5), Jun (6)
          if (monthYear === currentYear + 1 && monthNumber >= 1 && monthNumber <= 6) {
            return true;
          }
        }
        return false;
      }

      // Check if a month is in the previous school year (should be used if current year is 2026)
      function isMonthInPreviousSchoolYear(monthNumber, monthYear, currentYear, currentMonthIndex) {
        // If current year is 2026 or later, then previous year Sep-Dec should be used
        if (currentYear >= 2026) {
          if (monthYear === currentYear - 1 && monthNumber >= 9 && monthNumber <= 12) {
            return true;
          }
        }
        return false;
      }

      const getMonthMeta = (baseIndex, offset, baseYear = null) => {
        const now = new Date();
        const currentYear = baseYear || now.getFullYear();
        const currentMonthIndex = baseIndex;

        // Calculate the target month index and year
        let targetMonthIndex = baseIndex + offset;
        let targetYear = currentYear;

        // Adjust year if needed
        while (targetMonthIndex < 0) {
          targetMonthIndex += 12;
          targetYear -= 1;
        }
        while (targetMonthIndex >= 12) {
          targetMonthIndex -= 12;
          targetYear += 1;
        }

        const monthNumber = targetMonthIndex + 1;
        const normalized = targetMonthIndex;

        return {
          monthIndex: normalized,
          monthNumber,
          year: targetYear,
          docId: monthNumber.toString().padStart(2, '0'),
          displayName: getMonthName(normalized),
          numericDisplay: monthNumber.toString(),
          isInNextSchoolYear: isMonthInNextSchoolYear(monthNumber, targetYear, currentYear, currentMonthIndex),
          isInPreviousSchoolYear: isMonthInPreviousSchoolYear(monthNumber, targetYear, currentYear, currentMonthIndex)
        };
      };

      function fitIndicatorTextSizes() {
        const highlightItems = document.querySelectorAll('.myclass-indicator-item--highlight');
        if (!highlightItems.length) return;

        requestAnimationFrame(() => {
          highlightItems.forEach(item => {
            let fontSize = 13;
            const minFontSize = 8;
            const computed = getComputedStyle(item);
            const paddingLeft = parseFloat(computed.paddingLeft || '0');
            const paddingRight = parseFloat(computed.paddingRight || '0');
            const maxContentWidth = Math.max(0, item.offsetWidth - (paddingLeft + paddingRight));

            item.style.fontSize = `${fontSize}px`;
            let guard = 0;
            const step = 0.1;
            while (fontSize > minFontSize && item.scrollWidth > maxContentWidth && guard < 200) {
              fontSize = Math.max(minFontSize, fontSize - step);
              item.style.fontSize = `${fontSize}px`;
              guard += 1;
            }
          });
        });
      }

      function updateMyClassIndicators() {
        const indicatorItems = document.querySelectorAll('.myclass-indicator-item');
        if (!indicatorItems.length) return;
        const now = new Date();
        const currentMonthIndex = now.getMonth();
        const currentYear = now.getFullYear();
        const currentMonthNumber = currentMonthIndex + 1;

        indicatorItems.forEach((item, index) => {
          const offset = MONTH_OFFSETS[index] ?? 0;
          const meta = getMonthMeta(currentMonthIndex, offset, currentYear);
          const usesText = item.classList.contains('myclass-indicator-item--highlight');
          const middleAsNumber = item.classList.contains('myclass-indicator-item--middle');
          item.dataset.monthId = meta.docId;

          // Check if this month should show "-" (summer break or future months in certain periods)
          const isSummerBreak = meta.monthNumber === 7 || meta.monthNumber === 8;
          // If Sep-Dec-Jan (9-12-1) and offset > 0, and month is 7 or 8, show "-"
          const isFutureInSepDecJan = (currentMonthNumber >= 9 || currentMonthNumber <= 1) && offset > 0;
          const shouldShowDash = isSummerBreak || (isFutureInSepDecJan && (meta.monthNumber === 7 || meta.monthNumber === 8));

          if (shouldShowDash && !usesText) {
            item.textContent = '-';
            item.classList.remove('myclass-indicator-item--text');
          } else if (usesText) {
            item.textContent = meta.displayName;
            item.classList.add('myclass-indicator-item--text');
          } else if (middleAsNumber) {
            item.textContent = meta.numericDisplay;
            item.classList.remove('myclass-indicator-item--text');
          } else {
            item.textContent = meta.numericDisplay;
            item.classList.remove('myclass-indicator-item--text');
          }
        });

        fitIndicatorTextSizes();
      }

      function getSidebarScaleHeight() {
        const sidebarNavbar = document.querySelector('.myclass-sidebar-navbar');
        if (!sidebarNavbar) return 120;
        const rect = sidebarNavbar.getBoundingClientRect();
        return rect.height || 120;
      }

      // Track which months are predicted (not from Firebase)
      const predictedMonths = new Set();

      // Predict next 3 months based on previous 6 months trend
      function predictFutureMonths() {
        if (!myClassGradesData) return;

        // Clear previous predictions
        predictedMonths.clear();

        const now = new Date();
        const currentMonthIndex = now.getMonth();
        const currentYear = now.getFullYear();

        // Get the first 6 months (offsets: -5, -4, -3, -2, -1, 0)
        const pastOffsets = [-5, -4, -3, -2, -1, 0];
        const pastValues = [];

        pastOffsets.forEach(offset => {
          const meta = getMonthMeta(currentMonthIndex, offset, currentYear);
          // Skip if month is 07 or 08 (summer break)
          if (meta.monthNumber === 7 || meta.monthNumber === 8) {
            return; // Skip summer months
          }
          // Skip if month is in next school year (2026 Jan-Jun when current is 2025 Sep-Dec)
          if (meta.isInNextSchoolYear) {
            return; // Skip next year months
          }

          const value = myClassGradesData[meta.docId];
          if (typeof value === 'number' && !Number.isNaN(value) && value > 0) {
            pastValues.push(value);
          }
        });

        // Need at least 3 values to make a prediction
        if (pastValues.length < 3) return;

        // Calculate trend: simple linear regression
        let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;
        pastValues.forEach((value, index) => {
          const x = index;
          const y = value;
          sumX += x;
          sumY += y;
          sumXY += x * y;
          sumX2 += x * x;
        });

        const n = pastValues.length;
        const denominator = (n * sumX2 - sumX * sumX);
        if (denominator === 0 || n === 0) {
          console.warn('[YouHub][MyClass] Cannot calculate prediction: invalid data');
          return;
        }
        const slope = (n * sumXY - sumX * sumY) / denominator;
        const intercept = (sumY - slope * sumX) / n;

        // Predict next 3 months (offsets: 0, 1, 2, 3)
        const futureOffsets = [0, 1, 2, 3];
        futureOffsets.forEach(offset => {
          const meta = getMonthMeta(currentMonthIndex, offset, currentYear);
          // Skip if month is 07 or 08 (summer break)
          if (meta.monthNumber === 7 || meta.monthNumber === 8) {
            return; // Skip summer months
          }
          // Don't skip next year months for prediction - we want to predict Jan-Mar when in Dec
          // The isInNextSchoolYear check is only for reading past data, not for predictions

          // Check if this is a future month that should be predicted
          // Future months are those with offset >= 0 (including current)
          const isFutureMonth = offset >= 0;

          // Only predict if value doesn't exist yet (null, undefined, NaN, or 0.00)
          // OR if it's a future month (offset >= 0) - always predict future months
          const currentValue = myClassGradesData[meta.docId];
          const hasNoValue = currentValue === null ||
            currentValue === undefined ||
            (typeof currentValue === 'number' && (Number.isNaN(currentValue) || currentValue === 0));

          // Predict if no value exists OR if it's a future month (we want to show prediction even if Firebase has data)
          if (hasNoValue || isFutureMonth) {

            // Predict value using linear regression
            // Map offset to regression x-scale. 
            // If offset 0 follows immediately after previous data, it's at index n.
            const predictedIndex = n + (offset - 1);
            let predictedValue = intercept + slope * predictedIndex;

            // Clamp to valid range (1.0 - 5.0)
            predictedValue = Math.max(1.0, Math.min(5.0, predictedValue));

            // Round to 2 decimal places
            predictedValue = Math.round(predictedValue * 100) / 100;

            // Store locally (don't save to Firebase)
            myClassGradesData[meta.docId] = predictedValue;

            // Mark as predicted (always mark future months as predicted)
            predictedMonths.add(meta.docId);

            console.log(`[YouHub][MyClass] Predicted ${meta.displayName} (${meta.docId}): ${predictedValue}`, {
              trend: { slope, intercept },
              basedOn: pastValues.length + ' months',
              predictedMonths: Array.from(predictedMonths),
              isFutureMonth: isFutureMonth,
              hadValue: !hasNoValue
            });
          }
        });

        console.log('[YouHub][MyClass] All predicted months:', Array.from(predictedMonths));
      }

      function updateMyClassChartHeights() {
        const chartColumns = document.querySelectorAll('.myclass-chart-column');
        if (!chartColumns.length) return;
        const now = new Date();
        const currentMonthIndex = now.getMonth();
        const currentYear = now.getFullYear();
        const currentMonthNumber = currentMonthIndex + 1;
        const scaleHeight = getSidebarScaleHeight();
        const minHeight = 12;

        // Predict future months before rendering
        try {
          predictFutureMonths();
        } catch (error) {
          console.error('[YouHub][MyClass] Error predicting future months:', error);
        }

        chartColumns.forEach((column, index) => {
          const offset = MONTH_OFFSETS[index] ?? 0;
          const meta = getMonthMeta(currentMonthIndex, offset, currentYear);
          const rawValue = myClassGradesData && typeof myClassGradesData[meta.docId] === 'number'
            ? myClassGradesData[meta.docId]
            : null;

          column.dataset.monthId = meta.docId;

          // Check if this month is predicted (not from Firebase)
          try {
            const isPredicted = predictedMonths && predictedMonths.has(meta.docId);
            console.log(`[YouHub][MyClass] Month ${meta.displayName} (${meta.docId}): isPredicted=${isPredicted}, predictedMonths has:`, predictedMonths ? Array.from(predictedMonths) : 'null');

            // Remove existing tooltip if any
            const existingTooltip = column.querySelector('.myclass-chart-tooltip');
            if (existingTooltip) {
              existingTooltip.remove();
            }

            // Add tooltip for predicted months
            if (isPredicted) {
              column.classList.add('myclass-chart-column--predicted');
              const tooltip = document.createElement('div');
              tooltip.className = 'myclass-chart-tooltip';
              tooltip.textContent = window.translationManager?.getTranslation('youhub.prediction') || 'Előrejelzés';
              column.appendChild(tooltip);
              console.log(`[YouHub][MyClass] Added tooltip to ${meta.displayName} (${meta.docId})`, tooltip);
            } else {
              column.classList.remove('myclass-chart-column--predicted');
            }
          } catch (error) {
            console.error('[YouHub][MyClass] Error adding tooltip:', error);
          }

          // Check if this month should be set to 1.00 (summer break or future months in certain periods)
          const isSummerBreak = meta.monthNumber === 7 || meta.monthNumber === 8;
          const isFutureInSepDecJan = (currentMonthNumber >= 9 || currentMonthNumber <= 1) && offset > 0;
          const isMarAprMayJun = currentMonthNumber >= 3 && currentMonthNumber <= 6;
          const shouldBeMinHeight = isSummerBreak || (isFutureInSepDecJan && (meta.monthNumber === 7 || meta.monthNumber === 8)) || (isMarAprMayJun && offset > 0);

          if (shouldBeMinHeight) {
            // Set to minimum height (1.00 equivalent)
            const heightPx = Math.max(minHeight, (1.0 / 5) * scaleHeight);
            column.style.height = `${heightPx}px`;
            column.classList.add('myclass-chart-column--empty');
          } else if (rawValue === null || Number.isNaN(rawValue)) {
            column.style.height = `${minHeight}px`;
            column.classList.add('myclass-chart-column--empty');
          } else {
            const clamped = Math.max(0, Math.min(5, rawValue));
            const heightPx = Math.max(minHeight, (clamped / 5) * scaleHeight);
            column.style.height = `${heightPx}px`;
            column.classList.remove('myclass-chart-column--empty');
          }
        });

        syncChartAndIndicators();
        console.log('[YouHub][MyClass] Chart heights recalculated', {
          scaleHeight,
          hasData: !!myClassGradesData
        });
      }

      window.updateMyClassUI = function (gradesMap) {
        const forceEmpty = localStorage.getItem('forceEmptyState') === 'true';
        
        // If empty state is forced OR no data, show empty state
        if (forceEmpty || !gradesMap || Object.keys(gradesMap).length === 0) {
          console.log('[YouHub][MyClass] Showing empty state:', forceEmpty ? 'FORCED' : 'NO DATA');
          const middleSection = document.querySelector('.myclass-middle-section');
          if (middleSection) {
            middleSection.innerHTML = buildEmptyStateTemplate(
              'assets/youhub/myclass/class.svg',
              'Nincs osztályod!',
              'Beszélj az osztályfőnököddel hogy fejezze be az osztályod regisztrálását a Hubra!'
            );
          }
          return;
        }
        
        myClassGradesData = gradesMap || null;
        updateMyClassIndicators();
        updateMyClassChartHeights();
        console.log('[YouHub][MyClass] UI updated with grades:', gradesMap);
      };

      if ('pendingMyClassGrades' in window) {
        window.updateMyClassUI(window.pendingMyClassGrades);
        delete window.pendingMyClassGrades;
      }

      window.addEventListener('resize', () => {
        if (myClassGradesData) {
          updateMyClassChartHeights();
        }
      });

      // MyClass Mode Switching System
      let currentMode = 'myclass-graph';
      const middleSection = document.querySelector('.myclass-middle-section');
      const arrowBtn = document.querySelector('.myclass-arrow-btn');
      const navItems = document.querySelectorAll('.myclass-navbar--scope-myclass .myclass-nav-item');
      const graphTemplate = middleSection ? middleSection.innerHTML : '';

      const buildMyClassStateTemplate = (tagLabel, title, description, extra = '') => `
        <div class="myclass-state">
          <span class="myclass-state-tag">${tagLabel}</span>
          <h3 class="myclass-state-title">${title}</h3>
          <p class="myclass-state-desc">${description}</p>
          ${extra}
        </div>
      `;

      // Build students-style empty state for sections with no data
      const buildEmptyStateTemplate = (iconSrc, title, subtitle) => `
        <div class="students-empty-state" style="display: flex;">
          <img src="${iconSrc}" alt="${title}" class="students-empty-icon">
          <div class="students-empty-text-container">
            <p class="students-empty-title">${title}</p>
            <p class="students-empty-subtitle">${subtitle}</p>
          </div>
        </div>
      `;

      // Console commands for empty state testing
      window.emptyState = {
        enable: () => {
          localStorage.setItem('forceEmptyState', 'true');
          console.log('[YouHub] Empty states ENABLED - Reload page to see effect');
        },
        disable: () => {
          localStorage.removeItem('forceEmptyState');
          console.log('[YouHub] Empty states DISABLED - Reload page to see effect');
        },
        status: () => {
          const enabled = localStorage.getItem('forceEmptyState') === 'true';
          console.log(`[YouHub] Empty states: ${enabled ? 'ENABLED ✅' : 'DISABLED ❌'}`);
          return enabled;
        },
        check: () => {
          return localStorage.getItem('forceEmptyState') === 'true';
        }
      };

      // Log available commands
      console.log('%c[YouHub] Empty State Commands Available:', 'color: #CEFF97; font-weight: bold;');
      console.log('  emptyState.enable()  - Force all sections to show empty states');
      console.log('  emptyState.disable() - Disable forced empty states');
      console.log('  emptyState.status()  - Check current status');
      console.log('  emptyState.check()   - Returns true/false');

      // Check and apply empty state for suggestions on load
      (function checkSuggestionsEmptyState() {
        const forceEmpty = localStorage.getItem('forceEmptyState') === 'true';
        if (forceEmpty) {
          console.log('[YouHub][Suggestions] Empty state FORCED - replacing hardcoded cards');
          const suggestionsGrid = document.querySelector('.suggestions-grid[data-suggestions-section="suggestions"]');
          if (suggestionsGrid) {
            suggestionsGrid.innerHTML = buildEmptyStateTemplate(
              'assets/youhub/suggestions/suggestion.svg',
              'Nincsenek Javaslatok!',
              'Legyél te az első, inspiráld valamivel a közösséget!'
            );
          }
        }
      })();

      // Check and apply empty states for calendar views (exams, rp, bell)
      (function checkCalendarViewsEmptyState() {
        const forceEmpty = localStorage.getItem('forceEmptyState') === 'true';
        if (forceEmpty) {
          console.log('[YouHub][Calendar] Empty states FORCED for all calendar views');
          
          // Exams view
          const examsView = document.getElementById('calendar-view-exams');
          if (examsView) {
            examsView.innerHTML = buildEmptyStateTemplate(
              'assets/youhub/calendar/exams.svg',
              'Nincsenek dolgozatok!',
              'Itt jelennek meg majd a közelgő dolgozatok és vizsgák.'
            );
          }
          
          // Reading Progress view
          const rpView = document.getElementById('calendar-view-rp');
          if (rpView) {
            rpView.innerHTML = buildEmptyStateTemplate(
              'assets/youhub/calendar/rp.svg',
              'Nincs Reading Progress!',
              'Itt jelennek meg majd az olvasási előrehaladásod adatai.'
            );
          }
          
          // Bell (Csengetési rend) view
          const bellView = document.getElementById('calendar-view-bell');
          if (bellView) {
            bellView.innerHTML = buildEmptyStateTemplate(
              'assets/youhub/calendar/bell.svg',
              'Nincs csengetési rend!',
              'Itt jelenik meg majd az órák csengetési rendje.'
            );
          }
        }
      })();

      // Calculate days until school starts (September 1 or nearest Monday)
      function getDaysUntilSchoolStarts() {
        const now = new Date();
        const currentYear = now.getFullYear();
        const september1 = new Date(currentYear, 8, 1); // Month 8 = September (0-indexed)

        // If we're past September 1 this year, use next year
        if (now > september1) {
          september1.setFullYear(currentYear + 1);
        }

        // Find the nearest Monday to September 1
        const dayOfWeek = september1.getDay(); // 0 = Sunday, 1 = Monday, etc.
        const daysToMonday = dayOfWeek === 0 ? 1 : (dayOfWeek === 1 ? 0 : (8 - dayOfWeek));
        september1.setDate(september1.getDate() + daysToMonday);

        // Calculate difference in days
        const diffTime = september1 - now;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        return diffDays;
      }

      const MYCLASS_STATE_TEMPLATES = {
        'myclass-graph': () => graphTemplate,
        'myclass-suggestions': () => {
          try {
            const now = new Date();
            const currentMonthNumber = now.getMonth() + 1;
            const isJulyOrAugust = currentMonthNumber === 7 || currentMonthNumber === 8;

            if (isJulyOrAugust) {
              const daysUntilStart = getDaysUntilSchoolStarts();
              const suggestionsTab = window.translationManager?.getTranslation('youhub.tabs.suggestions') || 'Javaslatok';
              const getTranslation = (key, fallback) => {
                try {
                  return window.translationManager?.getTranslation(key) || fallback;
                } catch {
                  return fallback;
                }
              };
              const summerTitle = getTranslation('youhub.myclass.states.suggestions_summer.title', 'Ennyire nem várhatod az iskolát.');
              const summerDesc = getTranslation('youhub.myclass.states.suggestions_summer.description', 'Az iskola {days} nap múlva kezdődik.').replace('{days}', daysUntilStart);
              const summerItem1 = getTranslation('youhub.myclass.states.suggestions_summer.list_item1', 'Dolgozunk a megvalósításán a Suggestions Hub-bal.');
              const summerItem2 = getTranslation('youhub.myclass.states.suggestions_summer.list_item2', 'Amikor kész, a kedvenc ötleteid ide kerülnek.');
              return buildMyClassStateTemplate(
                suggestionsTab,
                summerTitle,
                summerDesc,
                `<ul class="myclass-state-list">
                  <li>${summerItem1}</li>
                  <li>${summerItem2}</li>
                </ul>`
              );
            } else {
              const suggestionsTab = window.translationManager?.getTranslation('youhub.tabs.suggestions') || 'Javaslatok';
              const classSuggestions = window.translationManager?.getTranslation('youhub.tabs.class_suggestions') || 'Osztály Javaslatai';
              const getTranslation = (key, fallback) => {
                try {
                  return window.translationManager?.getTranslation(key) || fallback;
                } catch {
                  return fallback;
                }
              };
              const normalDesc = getTranslation('youhub.myclass.states.suggestions_normal.description', 'Hamarosan itt fognak megjelenni az osztály ötletei és visszajelzései.');
              const normalItem1 = getTranslation('youhub.myclass.states.suggestions_normal.list_item1', 'Dolgozunk a megvalósításán a Suggestions Hub-bal.');
              const normalItem2 = getTranslation('youhub.myclass.states.suggestions_normal.list_item2', 'Amikor kész, a kedvenc ötleteid ide kerülnek.');
              return buildMyClassStateTemplate(
                suggestionsTab,
                classSuggestions,
                normalDesc,
                `<ul class="myclass-state-list">
                  <li>${normalItem1}</li>
                  <li>${normalItem2}</li>
                </ul>`
              );
            }
          } catch (error) {
            console.error('[YouHub][MyClass] Error in suggestions template:', error);
            return buildMyClassStateTemplate('Javaslatok', 'Hiba', 'Hiba történt a sablon betöltésekor.', '');
          }
        },
        'myclass-info1': () => {
          try {
            const getTranslation = (key, fallback) => {
              try {
                return window.translationManager?.getTranslation(key) || fallback;
              } catch {
                return fallback;
              }
            };
            return buildMyClassStateTemplate(
              getTranslation('youhub.myclass.states.info1.tag', 'Információk'),
              getTranslation('youhub.myclass.states.info1.title', 'Osztály elérhetőségi kártyája'),
              getTranslation('youhub.myclass.states.info1.description', 'Itt láthatod majd nemsokára az osztályod elérhetőségi kártyáját.'),
              `<ul class="myclass-state-list">
                <li>${getTranslation('youhub.myclass.states.info1.list_item1', 'QR-Kód az osztályodnak, és a tanárai.')}</li>
                <li>${getTranslation('youhub.myclass.states.info1.list_item2', 'Egyszerű megosztás a többiekkel.')}</li>
              </ul>`
            );
          } catch (error) {
            console.error('[YouHub][MyClass] Error in info1 template:', error);
            return buildMyClassStateTemplate('Információk', 'Hiba', 'Hiba történt a sablon betöltésekor.', '');
          }
        },
        'myclass-info2': () => {
          try {
            const getTranslation = (key, fallback) => {
              try {
                return window.translationManager?.getTranslation(key) || fallback;
              } catch {
                return fallback;
              }
            };
            return buildMyClassStateTemplate(
              getTranslation('youhub.myclass.states.info2.tag', 'Információk'),
              getTranslation('youhub.myclass.states.info2.title', 'Osztály alapadatok'),
              getTranslation('youhub.myclass.states.info2.description', 'Ide kerül az osztály létszáma, termi beosztása és az osztályfőnök adatai.'),
              `<ul class="myclass-state-list">
                <li>${getTranslation('youhub.myclass.states.info2.list_item1', 'Termi beosztás, kiválasztott adatai.')}</li>
                <li>${getTranslation('youhub.myclass.states.info2.list_item2', 'Osztályfőnök elérhetőségei')}</li>
              </ul>`
            );
          } catch (error) {
            console.error('[YouHub][MyClass] Error in info2 template:', error);
            return buildMyClassStateTemplate('Információk', 'Hiba', 'Hiba történt a sablon betöltésekor.', '');
          }
        }
      };

      const INFO_MODES = ['myclass-info1', 'myclass-info2'];
      const NAV_MODE_MAP = {
        month: 'myclass-graph',
        suggestions: 'myclass-suggestions',
        info: 'myclass-info1'
      };

      let chartResizeObserver = null;

      function detachChartResizeObserver() {
        if (chartResizeObserver) {
          chartResizeObserver.disconnect();
          chartResizeObserver = null;
        }
      }

      function attachChartResizeObserver() {
        detachChartResizeObserver();
        const container = document.querySelector('.myclass-chart-container');
        if (!container) return;
        chartResizeObserver = new ResizeObserver(() => {
          syncChartAndIndicators();
        });
        chartResizeObserver.observe(container);
        document.querySelectorAll('.myclass-chart-column').forEach(col => {
          chartResizeObserver.observe(col);
        });
      }

      function renderMyClassState(mode) {
        if (!middleSection) return;
        try {
          // Get template function and call it to get fresh template with current language
          const templateFn = MYCLASS_STATE_TEMPLATES[mode] || MYCLASS_STATE_TEMPLATES['myclass-graph'];
          const template = typeof templateFn === 'function' ? templateFn() : templateFn;
          middleSection.innerHTML = template;
          middleSection.dataset.mode = mode;
          if (mode === 'myclass-graph') {
            attachChartResizeObserver();
            updateMyClassIndicators();
            updateMyClassChartHeights();
          } else {
            detachChartResizeObserver();
          }
        } catch (error) {
          console.error('[YouHub][MyClass] Error rendering state:', error);
          // Fallback to graph template on error
          if (middleSection && MYCLASS_STATE_TEMPLATES['myclass-graph']) {
            try {
              middleSection.innerHTML = typeof MYCLASS_STATE_TEMPLATES['myclass-graph'] === 'function'
                ? MYCLASS_STATE_TEMPLATES['myclass-graph']()
                : MYCLASS_STATE_TEMPLATES['myclass-graph'];
              middleSection.dataset.mode = 'myclass-graph';
            } catch (fallbackError) {
              console.error('[YouHub][MyClass] Fallback also failed:', fallbackError);
            }
          }
        }
      }

      function setMode(mode) {
        if (!middleSection) return;
        const templateFn = MYCLASS_STATE_TEMPLATES[mode];
        const resolvedMode = templateFn ? mode : 'myclass-graph';
        currentMode = resolvedMode;
        renderMyClassState(resolvedMode);
        updateArrowButton();
        updateNavItems();
      }

      function updateArrowButton() {
        if (!arrowBtn) return;

        // Remove all state classes
        arrowBtn.classList.remove('low-opacity', 'flipped');

        // Check if we're in info modes
        const isInfoMode = INFO_MODES.includes(currentMode);
        arrowBtn.classList.toggle('low-opacity', !isInfoMode);
        arrowBtn.classList.toggle('flipped', currentMode === 'myclass-info2');
      }

      function updateNavItems() {
        navItems.forEach(item => {
          const tab = item.getAttribute('data-tab');
          item.classList.remove('active');

          if (
            (tab === 'month' && currentMode === 'myclass-graph') ||
            (tab === 'suggestions' && currentMode === 'myclass-suggestions') ||
            (tab === 'info' && INFO_MODES.includes(currentMode))
          ) {
            item.classList.add('active');
          }
        });
      }

      // Nav item click handlers
      navItems.forEach(item => {
        item.addEventListener('click', function () {
          const tab = this.getAttribute('data-tab');

          const targetMode = NAV_MODE_MAP[tab];
          if (!targetMode) return;
          setMode(targetMode);
        });
      });

      // Arrow button click handler
      if (arrowBtn) {
        arrowBtn.addEventListener('click', function () {
          if (!INFO_MODES.includes(currentMode)) {
            return;
          }
          const nextMode = currentMode === 'myclass-info1' ? 'myclass-info2' : 'myclass-info1';
          setMode(nextMode);
        });
      }

      // Initialize mode
      setMode('myclass-graph');

      // Chart és Indicator szinkronizáló rendszer
      function syncChartAndIndicators() {
        const chartContainer = document.querySelector('.myclass-chart-container');
        const secondaryPanel = document.querySelector('.myclass-secondary-panel');
        const indicatorItems = document.querySelectorAll('.myclass-indicator-item');
        const chartColumns = document.querySelectorAll('.myclass-chart-column');

        if (!chartContainer || !secondaryPanel || indicatorItems.length === 0 || chartColumns.length === 0) {
          return;
        }

        // Közvetlenül mérjük meg a grafikon oszlopok valós pixel szélességét
        const firstColumns = Array.from(chartColumns).filter(col =>
          col.classList.contains('myclass-chart-column--first') ||
          col.classList.contains('myclass-chart-column--last')
        );
        const middleColumns = Array.from(chartColumns).filter(col =>
          col.classList.contains('myclass-chart-column--middle')
        );
        const highlightColumn = Array.from(chartColumns).find(col =>
          col.classList.contains('myclass-chart-column--highlight')
        );

        // Mérjük meg az első oszlop szélességét (minden első/utolsó ugyanolyan széles)
        let firstWidth = 0;
        if (firstColumns.length > 0) {
          firstWidth = firstColumns[0].getBoundingClientRect().width;
        }

        // Mérjük meg a középső oszlop szélességét
        let middleWidth = 0;
        if (middleColumns.length > 0) {
          middleWidth = middleColumns[0].getBoundingClientRect().width;
        }

        // Mérjük meg a highlight oszlop szélességét
        let highlightWidth = 0;
        if (highlightColumn) {
          highlightWidth = highlightColumn.getBoundingClientRect().width;
        }

        // Frissítsük a secondary panel itemek szélességét pontosan ugyanolyan pixel értékekkel
        if (firstWidth > 0) {
          secondaryPanel.style.setProperty('--indicator-width-first', `${firstWidth}px`);
        }
        if (middleWidth > 0) {
          secondaryPanel.style.setProperty('--indicator-width-middle', `${middleWidth}px`);
        }
        if (highlightWidth > 0) {
          secondaryPanel.style.setProperty('--indicator-width-highlight', `${highlightWidth}px`);
        }
        console.log('[YouHub][MyClass] Indicator widths synced', {
          firstWidth,
          middleWidth,
          highlightWidth
        });
        fitIndicatorTextSizes();
      }

      // Notifications empty text sizing
      function fitNotificationsEmptyText() {
        const leftColumn = document.querySelector('.notifications-column--left .notifications-empty-text-container');
        const rightColumn = document.querySelector('.notifications-column--right .notifications-empty-text-container');

        requestAnimationFrame(() => {
          // Left column (smaller) - separate logic
          if (leftColumn) {
            const leftTitle = leftColumn.querySelector('.notifications-empty-title');
            const leftSubtitle = leftColumn.querySelector('.notifications-empty-subtitle');
            if (leftTitle && leftSubtitle) {
              const containerWidth = leftColumn.offsetWidth;
              const leftCol = leftColumn.closest('.notifications-column--left');
              const leftColPadding = leftCol ? parseFloat(getComputedStyle(leftCol).paddingLeft || '10') : 10;
              const calculatedWidth = containerWidth - leftColPadding;
              const availableWidth = Math.max(0, calculatedWidth * 1.5);

              let titleFontSize = 18;
              const minTitleFontSize = 12;
              const step = 0.5;

              // Reset to initial size
              leftTitle.style.fontSize = `${titleFontSize}px`;
              leftSubtitle.style.fontSize = `${titleFontSize * 0.75}px`;

              // Adjust title size to fit
              let guard = 0;
              while (titleFontSize > minTitleFontSize && leftTitle.scrollWidth > availableWidth && guard < 100) {
                titleFontSize = Math.max(minTitleFontSize, titleFontSize - step);
                leftTitle.style.fontSize = `${titleFontSize}px`;
                leftSubtitle.style.fontSize = `${titleFontSize * 0.75}px`;
                guard += 1;
              }
            }
          }

          // Right column (larger) - separate logic
          if (rightColumn) {
            const rightTitle = rightColumn.querySelector('.notifications-empty-title');
            const rightSubtitle = rightColumn.querySelector('.notifications-empty-subtitle');
            if (rightTitle && rightSubtitle) {
              const containerWidth = rightColumn.offsetWidth;
              const emptyState = rightColumn.closest('.notifications-empty-state');
              const emptyStatePadding = emptyState ? parseFloat(getComputedStyle(emptyState).paddingLeft || '16') : 16;
              const calculatedWidth = containerWidth - emptyStatePadding;
              const availableWidth = Math.max(0, calculatedWidth * 1.5);

              let titleFontSize = 18;
              const minTitleFontSize = 12;
              const step = 0.5;

              // Reset to initial size
              rightTitle.style.fontSize = `${titleFontSize}px`;
              rightSubtitle.style.fontSize = `${titleFontSize * 0.75}px`;

              // Adjust title size to fit
              let guard = 0;
              while (titleFontSize > minTitleFontSize && rightTitle.scrollWidth > availableWidth && guard < 100) {
                titleFontSize = Math.max(minTitleFontSize, titleFontSize - step);
                rightTitle.style.fontSize = `${titleFontSize}px`;
                rightSubtitle.style.fontSize = `${titleFontSize * 0.75}px`;
                guard += 1;
              }
            }
          }

          // History button text sizing
          const historyBtn = document.querySelector('.notifications-history-btn');
          if (historyBtn) {
            const historyText = historyBtn.querySelector('.notifications-history-text');
            const historyIcon = historyBtn.querySelector('.notifications-history-icon');
            if (historyText && historyIcon) {
              const btnWidth = historyBtn.offsetWidth;
              const btnPadding = parseFloat(getComputedStyle(historyBtn).paddingLeft || '10');
              const iconWidth = historyIcon.offsetWidth || 18;
              const gap = parseFloat(getComputedStyle(historyBtn).gap || '8');
              const calculatedWidth = btnWidth - btnPadding - iconWidth - gap;
              const availableWidth = Math.max(0, calculatedWidth * 1.5);

              let fontSize = 14;
              const minFontSize = 10;
              const step = 0.5;

              // Reset to initial size
              historyText.style.fontSize = `${fontSize}px`;

              // Adjust text size to fit
              let guard = 0;
              while (fontSize > minFontSize && historyText.scrollWidth > availableWidth && guard < 100) {
                fontSize = Math.max(minFontSize, fontSize - step);
                historyText.style.fontSize = `${fontSize}px`;
                guard += 1;
              }
            }
          }
        });
      }

      // Initial sizing and resize observer
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
          setTimeout(fitNotificationsEmptyText, 100);
        });
      } else {
        setTimeout(fitNotificationsEmptyText, 100);
      }

      const notificationsColumns = document.querySelectorAll('.notifications-column');
      if (notificationsColumns.length > 0) {
        const resizeObserver = new ResizeObserver(() => {
          fitNotificationsEmptyText();
        });
        notificationsColumns.forEach(col => {
          resizeObserver.observe(col);
        });
      }

      window.addEventListener('resize', fitNotificationsEmptyText);

      // Developer mode functions are now loaded from developer-mode.js

      try {
        const storedPending = localStorage.getItem('youhub-pending-notification');
        if (storedPending) {
          window.pendingNotificationToSelect = storedPending;
          localStorage.removeItem('youhub-pending-notification');
        } else {
          window.pendingNotificationToSelect = null;
        }
      } catch (err) {
        window.pendingNotificationToSelect = null;
      }

      // Store notifications data globally
      window.notificationsData = [];
      window.selectedNotificationId = null;

      async function loadNotifications(userId) {
        if (!window.db || !userId) {
          console.warn('[Notifications] No db or userId available');
          return;
        }

        try {
          console.log('[Notifications] Loading notifications for user:', userId);
          // Use dynamic import for Firestore functions
          const { collection, getDocs } = await import("https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js");
          const notifsRef = collection(window.db, `users/${userId}/notifs`);
          const snapshot = await getDocs(notifsRef);

          if (snapshot.empty) {
            console.log('[Notifications] No notifications found');
            window.notificationsData = [];
            updateNotificationsView();
            return;
          }

          // Parse document IDs as numbers and sort descending (larger numbers first)
          const docs = snapshot.docs.map(doc => ({
            id: doc.id,
            numericId: parseInt(doc.id) || 0,
            data: doc.data()
          }));

          // Sort by numeric ID descending (13, 12, 11, ...)
          docs.sort((a, b) => b.numericId - a.numericId);

          // Take first 10
          window.notificationsData = docs.slice(0, 10);
          console.log('[Notifications] Loaded', window.notificationsData.length, 'notifications');

          updateNotificationsView();
        } catch (error) {
          console.error('[Notifications] Error loading notifications:', error);
          window.notificationsData = [];
          updateNotificationsView();
        }
      }

      function updateNotificationsView() {
        const emptyState = document.getElementById('notificationsEmptyState');
        const listContainer = document.getElementById('notificationsListContainer');
        const rightEmptyState = document.getElementById('notificationsRightEmptyState');
        const detailView = document.getElementById('notificationsDetailView');

        if (window.notificationsData && window.notificationsData.length > 0) {
          if (emptyState) emptyState.style.display = 'none';
          if (listContainer) {
            listContainer.style.display = 'flex';
            generateNotificationItems();
          }
          if (rightEmptyState && !window.selectedNotificationId) rightEmptyState.style.display = 'flex';
          if (detailView && !window.selectedNotificationId) detailView.style.display = 'none';
        } else {
          if (emptyState) emptyState.style.display = 'flex';
          if (listContainer) listContainer.style.display = 'none';
          if (rightEmptyState) rightEmptyState.style.display = 'flex';
          if (detailView) detailView.style.display = 'none';
        }
      }

      async function updateNotificationDetailView() {
        const activeItem = document.querySelector('.notification-item--active');
        const rightEmptyState = document.getElementById('notificationsRightEmptyState');
        const detailView = document.getElementById('notificationsDetailView');

        if (!window.selectedNotificationId || !window.db) {
          if (rightEmptyState && detailView) {
            rightEmptyState.style.display = 'flex';
            detailView.style.display = 'none';
          }
          return;
        }

        // Use dynamic import for Firestore and Auth functions
        const { getAuth } = await import("https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js");
        const { doc, getDoc, deleteDoc, collection, getDocs } = await import("https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js");

        const auth = getAuth();
        if (!auth.currentUser) {
          if (rightEmptyState && detailView) {
            rightEmptyState.style.display = 'flex';
            detailView.style.display = 'none';
          }
          return;
        }

        const userId = auth.currentUser.uid;
        const notificationId = window.selectedNotificationId;

        try {
          // Load notification document
          const notifRef = doc(window.db, `users/${userId}/notifs/${notificationId}`);
          const notifSnap = await getDoc(notifRef);

          if (!notifSnap.exists()) {
            console.error('[Notifications] Notification not found:', notificationId);
            if (rightEmptyState && detailView) {
              rightEmptyState.style.display = 'flex';
              detailView.style.display = 'none';
            }
            return;
          }

          const notifData = notifSnap.data();
          const title = notifData.title || '';
          const content = notifData.content || '';
          const sender = notifData.sender || '';
          const sentTo = (notifData.sent_to || '').toString().trim();
          console.log('[Notifications] sent_to from document:', sentTo);
          const dateValue = notifData.date;

          // Format date
          let dateText = '';
          if (dateValue && dateValue.toDate) {
            const dateObj = dateValue.toDate();
            dateText = dateObj.toLocaleDateString('hu-HU', { year: 'numeric', month: '2-digit', day: '2-digit' });
          }

          // Load sender info (user or group)
          let senderName = sender;
          let senderImageUrl = null;

          // Check if sender is a userid (starts with specific pattern or is a valid userid)
          const isUserId = sender && sender.length > 10 && !sender.includes(' ');

          if (isUserId) {
            // Load user name and picture
            try {
              // Load name from public/users/nevek/{sender}
              const nameRef = doc(window.db, `public/users/nevek/${sender}`);
              const nameSnap = await getDoc(nameRef);
              if (nameSnap.exists()) {
                const nameData = nameSnap.data();
                if (nameData.name) senderName = nameData.name;
              }

              // Load picture from public/users/profilePictures/{sender}
              try {
                const pictureRef = doc(window.db, `public/users/profilePictures/${sender}`);
                const pictureSnap = await getDoc(pictureRef);
                if (pictureSnap.exists()) {
                  const pictureData = pictureSnap.data();
                  if (pictureData.profilePictureUrl) {
                    senderImageUrl = pictureData.profilePictureUrl;
                  }
                }
              } catch (err) {
                console.warn('[Notifications] Error loading user picture:', err);
              }
            } catch (err) {
              console.warn('[Notifications] Error loading user:', err);
            }
          } else {
            // Load group info
            try {
              const groupRef = doc(window.db, 'public', 'senders', 'groups', sender);
              const groupSnap = await getDoc(groupRef);
              if (groupSnap.exists()) {
                const groupData = groupSnap.data();
                senderName = groupData.name || sender;
                senderImageUrl = groupData.picture || null;
              }
            } catch (err) {
              console.warn('[Notifications] Error loading group:', err);
            }
          }

          // Helper function to get translation
          const getTranslation = (key, fallback) => {
            if (window.translationManager && typeof window.translationManager.getTranslation === 'function') {
              const translation = window.translationManager.getTranslation(key);
              return translation || fallback;
            }
            return fallback;
          };

          // Load recipients info
          let recipientsHtml = '';
          let sentToText = '';
          let showAvatars = false;

          if (sentTo) {
            // Check if sentTo is a class name (e.g., 8e2030 or 2030e)
            // Try to load class document first - if it exists, it's a class
            let isClassName = false;
            let classData = null;

            try {
              const classRef = doc(window.db, `classes/${sentTo}`);
              const classSnap = await getDoc(classRef);
              console.log('[Notifications] Checking class:', sentTo, 'exists:', classSnap.exists());
              if (classSnap.exists()) {
                isClassName = true;
                classData = classSnap.data();
                console.log('[Notifications] Class found, data:', classData);
              }
            } catch (err) {
              console.warn('[Notifications] Error checking class:', err);
              // Not a class, continue to check as userid
            }

            if (isClassName && classData) {
              // Load class users from subcollection
              try {
                const classUsersRef = collection(window.db, `classes/${sentTo}/users`);
                const classUsersSnap = await getDocs(classUsersRef);
                const userIds = [];
                classUsersSnap.forEach(userDoc => {
                  userIds.push(userDoc.id);
                });

                // Format class name for display (e.g., 2030e -> 8.E Osztálynak)
                let displayName = sentTo;
                try {
                  // Try to parse class ID format (e.g., 2030e)
                  const classMatch = sentTo.match(/^(\d+)([a-z])$/i);
                  if (classMatch) {
                    const graduationYear = parseInt(classMatch[1]);
                    const classLetter = classMatch[2].toUpperCase();

                    const now = new Date();
                    const currentYear = now.getFullYear();
                    const currentMonth = now.getMonth() + 1; // 1-12

                    const yearsRemaining = graduationYear - currentYear;
                    let gradeNumber = 12 - yearsRemaining;

                    if (currentMonth >= 9) {
                      gradeNumber += 1;
                    }

                    if (gradeNumber >= 1 && gradeNumber <= 13) {
                      let classLabel = window.translationManager?.getTranslation('youhub.myclass.title', 'Osztályom');
                      if (classLabel === 'Osztályom') classLabel = 'Osztálynak'; // Hu
                      else if (classLabel === 'My Class') classLabel = 'Class'; // En
                      else if (!classLabel) classLabel = 'Osztálynak';

                      displayName = `${gradeNumber}.${classLetter} ${classLabel}`;
                    }
                  }
                } catch (err) {
                  console.warn('[Notifications] Error parsing class name:', err);
                }

                const sentToLabel = getTranslation('youhub.notifications.detail.sent_to', 'Kiküldve:');
                sentToText = `${sentToLabel} ${displayName}`;
                console.log('[Notifications] Final sentToText:', sentToText);

                // Load first 3 user pictures
                const avatarUrls = [];
                const avatarData = [];
                for (let i = 0; i < Math.min(3, userIds.length); i++) {
                  try {
                    // Load picture from public/users/profilePictures/{userId}
                    const pictureRef = doc(window.db, `public/users/profilePictures/${userIds[i]}`);
                    const pictureSnap = await getDoc(pictureRef);
                    let avatarUrl = null;
                    if (pictureSnap.exists()) {
                      const pictureData = pictureSnap.data();
                      if (pictureData.profilePictureUrl) {
                        avatarUrl = pictureData.profilePictureUrl;
                      } else if (pictureData.useProvidedPfp && pictureData.pfpColor) {
                        // Use color if no URL
                        avatarUrl = null;
                      }
                    }
                    avatarData.push({ userId: userIds[i], url: avatarUrl });
                    if (avatarUrl) {
                      avatarUrls.push(avatarUrl);
                    }
                  } catch (err) {
                    console.warn('[Notifications] Error loading recipient user picture:', err);
                    avatarData.push({ userId: userIds[i], url: null });
                  }
                }

                console.log('[Notifications] UserIds found:', userIds.length, userIds);
                console.log('[Notifications] Avatar data:', avatarData);
                if (userIds.length > 0) {
                  showAvatars = true;
                  recipientsHtml = `
                      <div class="notification-detail-recipients">
                        <div class="notification-detail-avatars">
                          ${avatarData.map((avatar, idx) => {
                    if (avatar.url) {
                      return `<div class="notification-detail-avatar-small" style="background-image: url('${avatar.url}'); background-size: cover; background-position: center;"></div>`;
                    } else {
                      return `<div class="notification-detail-avatar-small" style="background: #808080;"></div>`;
                    }
                  }).join('')}
              </div>
                        ${userIds.length > 3 ? `<div class="notification-detail-overflow"><span>+${userIds.length - 3}</span></div>` : ''}
            </div>
                    `;
                  console.log('[Notifications] Recipients HTML:', recipientsHtml);
                } else {
                  console.warn('[Notifications] No userIds found for class:', sentTo);
                }
              } catch (err) {
                console.warn('[Notifications] Error loading class users:', err);
                const sentToLabel = getTranslation('notifications.sent_to', 'Kiküldve:');
                sentToText = `${sentToLabel} ${sentTo}`;
              }
            } else {
              // sentTo is a userid
              try {
                // Load picture from public/users/profilePictures/{sentTo}
                const pictureRef = doc(window.db, `public/users/profilePictures/${sentTo}`);
                const pictureSnap = await getDoc(pictureRef);
                if (pictureSnap.exists()) {
                  const pictureData = pictureSnap.data();
                  const picture = pictureData.profilePictureUrl;

                  if (picture) {
                    showAvatars = true;
                    recipientsHtml = `
              <div class="notification-detail-recipients">
                <div class="notification-detail-avatars">
                          <div class="notification-detail-avatar-small" style="background-image: url('${picture}'); background-size: cover; background-position: center;"></div>
                </div>
                </div>
                    `;
                  } else {
                    const unknownUsers = getTranslation('general.unknown_user', 'Ismeretlen felhasználó(k)');
                    const sentToLabel = getTranslation('youhub.notifications.detail.sent_to', 'Kiküldve:');
                    sentToText = `${sentToLabel} ${unknownUsers}`;
                  }
                } else {
                  const unknownUsers = getTranslation('general.unknown_user', 'Ismeretlen felhasználó(k)');
                  const sentToLabel = getTranslation('youhub.notifications.detail.sent_to', 'Kiküldve:');
                  sentToText = `${sentToLabel} ${unknownUsers}`;
                }
              } catch (err) {
                console.warn('[Notifications] Error loading recipient user:', err);
                const unknownUsers = getTranslation('general.unknown_user', 'Ismeretlen felhasználó(k)');
                const sentToLabel = getTranslation('notifications.sent_to', 'Kiküldve:');
                sentToText = `${sentToLabel} ${unknownUsers}`;
              }
            }
          }

          if (!sentToText && !showAvatars) {
            const unknownUsers = getTranslation('general.unknown_user', 'Ismeretlen felhasználó(k)');
            const sentToLabel = getTranslation('youhub.notifications.detail.sent_to', 'Kiküldve:');
            sentToText = `${sentToLabel} ${unknownUsers}`;
          }

          // Build avatar style for sender
          const senderAvatarStyle = senderImageUrl
            ? `background-image: url('${senderImageUrl}'); background-size: cover; background-position: center;`
            : 'background: #808080;';

          // Render detail view
          if (detailView && rightEmptyState) {
            rightEmptyState.style.display = 'none';
            detailView.style.display = 'flex';

            detailView.innerHTML = `
              <div class="notification-detail-header">
                <div class="notification-detail-avatar" style="${senderAvatarStyle}"></div>
                <div class="notification-detail-header-text">
                  <p class="notification-detail-title">${title}</p>
                  <p class="notification-detail-date">${dateText}</p>
                  <p class="notification-detail-sender">${senderName}</p>
              </div>
              </div>
              <div class="notification-detail-content-container">
                <p class="notification-detail-message" data-full-text="${content}">${content}</p>
                ${recipientsHtml}
                <p class="notification-detail-sent-to">${sentToText}</p>
            </div>
            <div class="notification-detail-actions">
                <button class="notification-detail-action-btn notification-detail-action-btn--delete" data-notification-id="${notificationId}">
                <img src="assets/youhub/notifications/trahscan.svg" alt="${getTranslation('youhub.notifications.detail.delete', 'Törlés')}" class="notification-detail-action-icon">
                <span class="notification-detail-action-text">${getTranslation('youhub.notifications.detail.delete', 'Törlés')}</span>
              </button>
                <button class="notification-detail-action-btn notification-detail-action-btn--snooze" data-notification-id="${notificationId}">
                <img src="assets/youhub/notifications/snooze.svg" alt="${getTranslation('youhub.notifications.detail.snooze', 'Elhalasztás')}" class="notification-detail-action-icon">
                <span class="notification-detail-action-text">${getTranslation('youhub.notifications.detail.snooze', 'Elhalasztás')}</span>
              </button>
            </div>
          `;

            // Add delete button handler
            const deleteBtn = detailView.querySelector('.notification-detail-action-btn--delete');
            if (deleteBtn) {
              deleteBtn.addEventListener('click', async () => {
                try {
                  await deleteDoc(notifRef);
                  console.log('[Notifications] Notification deleted:', notificationId);
                  window.selectedNotificationId = null;
                  // Reload notifications
                  await loadNotifications(userId);
                  // Reset view
                  if (rightEmptyState && detailView) {
                    rightEmptyState.style.display = 'flex';
                    detailView.style.display = 'none';
                  }
                } catch (err) {
                  console.error('[Notifications] Error deleting notification:', err);
                  const msg = window.translationManager?.getTranslation('youhub.messages.delete_error') || 'Hiba történt a törlés során.';
                  const getTranslation = (key, fallback) => window.translationManager?.getTranslation(key) || fallback;
                  const errorTitle = getTranslation('youhub.notifications.types.error', 'Hiba');
                  await window.showNotification(msg, errorTitle, 'danger');
                }
              });
            }

            // Add snooze button handler
            const snoozeBtn = detailView.querySelector('.notification-detail-action-btn--snooze');
            if (snoozeBtn) {
              snoozeBtn.addEventListener('click', async () => {
                // TODO: Implement snooze functionality
                // 1. Get current time
                // 2. Add 10 minutes to current time
                // 3. Schedule a notification to be sent at that time
                // 4. The notification should appear on the website as if it just arrived
                // 5. This will need to be implemented based on how notifications are sent
                //    - Could use a Cloud Function with a scheduled trigger
                //    - Or use a client-side setTimeout (but this won't work if user closes browser)
                //    - Or create a document in a "scheduled_notifications" collection with a timestamp
                //    - And have a Cloud Function that checks this collection periodically
                //    - When the time arrives, the function should create a new notification document
                //    - in the user's notifs collection, which will then appear in the UI
                console.log('[Notifications] Snooze clicked for notification:', notificationId);
                console.log('[Notifications] Should schedule notification for 10 minutes from now');
              });
            }

            // Add click handler for message expand/collapse
            const messageEl = detailView.querySelector('.notification-detail-message');
            const container = detailView.querySelector('.notification-detail-content-container');

            if (messageEl && container) {
              const fullText = messageEl.dataset.fullText || messageEl.textContent;
              const checkIfNeedsExpansion = () => {
                // Temporarily expand to check if it needs truncation
                messageEl.style.display = 'block';
                messageEl.style.webkitLineClamp = 'unset';
                messageEl.style.lineClamp = 'unset';
                const lineHeight = parseFloat(getComputedStyle(messageEl).lineHeight);
                const needsExpansion = messageEl.scrollHeight > lineHeight * 3;

                if (needsExpansion) {
                  messageEl.style.display = '-webkit-box';
                  messageEl.style.webkitLineClamp = '3';
                  messageEl.style.lineClamp = '3';
                  messageEl.style.cursor = 'pointer';
                } else {
                  messageEl.style.cursor = 'default';
                }
              };

              checkIfNeedsExpansion();

              messageEl.addEventListener('click', () => {
                if (messageEl.classList.contains('expanded')) {
                  // Collapse
                  messageEl.classList.remove('expanded');
                  messageEl.style.display = '-webkit-box';
                  messageEl.style.webkitLineClamp = '3';
                  messageEl.style.lineClamp = '3';
                  container.style.overflowY = 'visible';
                } else {
                  // Expand
                  messageEl.classList.add('expanded');
                  messageEl.style.display = 'block';
                  messageEl.style.webkitLineClamp = 'unset';
                  messageEl.style.lineClamp = 'unset';
                  container.style.overflowY = 'auto';
                }
              });
            }
          }
        } catch (error) {
          console.error('[Notifications] Error loading notification detail:', error);
          if (rightEmptyState && detailView) {
            rightEmptyState.style.display = 'flex';
            detailView.style.display = 'none';
          }
        }
      }

      function attemptPendingNotificationSelection() {
        if (!window.pendingNotificationToSelect) return;
        const success = typeof window.selectNotificationById === 'function'
          ? window.selectNotificationById(window.pendingNotificationToSelect)
          : false;
        if (success) {
          window.pendingNotificationToSelect = null;
          try {
            localStorage.removeItem('youhub-pending-notification');
          } catch (err) {
            /* no-op */
          }
        }
      }

      window.selectNotificationById = function (notifId) {
        if (!notifId) return false;
        const target = document.querySelector(`.notification-item[data-notification-id="${notifId}"]`);
        if (!target) {
          return false;
        }
        target.click();
        try {
          target.scrollIntoView({ block: 'nearest', inline: 'nearest', behavior: 'smooth' });
        } catch (err) {
          /* no-op */
        }
        return true;
      };

      function generateNotificationItems() {
        const list = document.querySelector('.notifications-list');
        if (!list) return;

        list.innerHTML = '';

        if (!window.notificationsData || window.notificationsData.length === 0) {
          return;
        }

        window.notificationsData.forEach((notif) => {
          const item = document.createElement('div');
          item.className = 'notification-item';
          item.dataset.notificationId = notif.id;

          const avatar = document.createElement('div');
          avatar.className = 'notification-avatar';

          const content = document.createElement('div');
          content.className = 'notification-content';

          const name = document.createElement('p');
          name.className = 'notification-name';
          const defaultNotificationTitle = window.translationManager?.getTranslation('youhub.default_notification_title') || 'Értesítés';
          name.textContent = notif.data.title || defaultNotificationTitle;

          const date = document.createElement('p');
          date.className = 'notification-date';
          const dateValue = notif.data.date;
          if (dateValue && dateValue.toDate) {
            const dateObj = dateValue.toDate();
            date.textContent = dateObj.toLocaleDateString('hu-HU', { year: 'numeric', month: '2-digit', day: '2-digit' });
          } else {
            date.textContent = '';
          }

          content.appendChild(name);
          content.appendChild(date);

          item.appendChild(avatar);
          item.appendChild(content);

          item.addEventListener('click', () => {
            document.querySelectorAll('.notification-item').forEach(it => it.classList.remove('notification-item--active'));
            item.classList.add('notification-item--active');
            window.selectedNotificationId = notif.id;
            updateNotificationDetailView();
          });

          list.appendChild(item);
        });

        attemptPendingNotificationSelection();
      }

      window.addEventListener('youhub-open-notification', (event) => {
        const targetId = event?.detail?.id;
        if (!targetId) return;
        window.pendingNotificationToSelect = targetId;
        attemptPendingNotificationSelection();
      });

      // Alt+H keyboard shortcut
      document.addEventListener('keydown', (e) => {
        if (e.altKey && e.key.toLowerCase() === 'h') {
          e.preventDefault();
          if (!isDevModeEnabled()) {
            showDevModePopup();
          }
        }
      });

      // Enter key in password input
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && document.getElementById('devModePopup')?.style.display === 'flex') {
          checkDevModePassword();
        }
      });

      // Load notifications on auth state change (using dynamic import)
      (async () => {
        const { getAuth, onAuthStateChanged } = await import("https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js");
        const auth = getAuth();
        onAuthStateChanged(auth, (user) => {
          if (user) {
            loadNotifications(user.uid);
          } else {
            window.notificationsData = [];
            window.selectedNotificationId = null;
            updateNotificationsView();
          }
        });

        // Also check if user is already logged in
        if (auth.currentUser) {
          loadNotifications(auth.currentUser.uid);
        }
      })();

    });
  </script>

  <script type="module">
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
    import { doc, getDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

    const myClassDb = window.db;
    const MONTH_IDS = ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12'];
    let latestClassId = null;

    const publishGrades = (grades) => {
      console.log('[YouHub][MyClass] Publishing grades to UI', grades);
      if (typeof window.updateMyClassUI === 'function') {
        window.updateMyClassUI(grades);
      } else {
        window.pendingMyClassGrades = grades;
      }
    };

    const resolveClassIdForUser = async (uid) => {
      if (!myClassDb) return null;
      try {
        console.log('[YouHub][MyClass] Resolving class for user', uid);
        const ownClassRef = doc(myClassDb, 'users', uid, 'groups', 'ownclass');
        const ownClassSnap = await getDoc(ownClassRef);
        if (!ownClassSnap.exists()) {
          console.warn('[YouHub] ownclass document missing for user:', uid);
          return null;
        }
        const data = ownClassSnap.data() || {};
        const classFinishes = (data.classFinishes || '').toString().trim();
        const classType = (data.classType || '').toString().trim().toLowerCase();
        if (!classFinishes || !classType) {
          console.warn('[YouHub] classFinishes or classType missing for user:', uid);
          return null;
        }
        const classId = `${classFinishes}${classType}`;
        console.log('[YouHub][MyClass] Resolved class id:', classId);
        return classId;
      } catch (error) {
        console.error('[YouHub] Failed to resolve class id:', error);
        return null;
      }
    };

    const loadGradesForClass = async (classId) => {
      if (!myClassDb || !classId) return null;
      try {
        console.log('[YouHub][MyClass] Loading grades for class:', classId);
        const gradesRef = collection(myClassDb, 'classes', classId, 'grades');
        const snapshot = await getDocs(gradesRef);
        if (snapshot.empty) {
          console.warn('[YouHub] No grades found for class:', classId);
        }
        const grades = {};
        snapshot.forEach(docSnap => {
          const rawValue = docSnap.data()?.value;
          const docId = docSnap.id.padStart(2, '0');
          if (typeof rawValue === 'number') {
            grades[docId] = rawValue;
          }
        });
        // Ensure every month key exists (even if undefined) for predictable lookups
        MONTH_IDS.forEach(id => {
          if (!(id in grades)) {
            grades[id] = null;
          }
        });
        console.log('[YouHub][MyClass] Grades fetched:', grades);
        return grades;
      } catch (error) {
        console.error('[YouHub] Failed to load grades for class:', classId, error);
        return null;
      }
    };

    const ensureClassData = async (user) => {
      if (!user) {
        publishGrades(null);
        return;
      }
      const classId = await resolveClassIdForUser(user.uid);
      latestClassId = classId;
      if (!classId) {
        publishGrades(null);
        return;
      }
      const grades = await loadGradesForClass(classId);
      if (latestClassId !== classId) {
        return; // another request already started
      }
      publishGrades(grades);
    };

    const classAuth = getAuth();
    if (classAuth.currentUser) {
      ensureClassData(classAuth.currentUser);
    }

    onAuthStateChanged(classAuth, (user) => {
      ensureClassData(user);
    });
  </script>
  <script src="assets/js/developer-mode.js"></script>
  <script src="assets/js/account-tooltip.js"></script>
  <script src="assets/js/footer.js"></script>
  <script src="assets/js/staff-timer.js"></script>
  <script src="assets/js/staff-nav-items.js"></script>
  <script src="assets/global/hub-maintenance-overlay.js"></script>
</body>

</html>