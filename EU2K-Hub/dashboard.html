<!DOCTYPE html>
<html lang="hu">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description"
    content="Üdvözöllek az EU2K Hub Kezelőpultjában! Kezeld az eseményeket, híreket és publikálj tartalmakat.">
  <title data-translate="pages.dashboard.title" data-translate-fallback="Kezelőpult">Kezelőpult</title>
  <link rel="stylesheet" href="dashboard.css">
  <link rel="stylesheet" href="assets/css/consent-banner.css">
  <link rel="icon" href="favicon.ico">
  <script>
    (function () {
      if (!document.getElementById('eu2k-page-overlay')) {
        var o = document.createElement('div');
        o.id = 'eu2k-page-overlay';
        o.style.cssText = 'position:fixed;inset:0;z-index:9999;background:#000000;border-radius:32px;opacity:1;transition:opacity 300ms ease-in-out;';
        var inner = document.createElement('div');
        inner.style.cssText = 'position:relative;width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:#000000;border-radius:32px;';
        var m = document.createElement('div');
        m.id = 'eu2k-overlay-mount';
        m.style.cssText = 'position:relative;width:100%;height:100%';
        inner.appendChild(m);
        o.appendChild(inner);
        document.documentElement.appendChild(o);
      }
    })();
  </script>

  <script src="assets/js/page-overlay-loader.js"></script>
  <script>
    window.addEventListener('load', function () {
      try {
        var o = document.getElementById('eu2k-page-overlay');
        if (o) {
          o.style.opacity = '0';
          o.style.pointerEvents = 'none';
          setTimeout(function () { try { o.remove(); } catch (e) { } }, 300);
        }
      } catch (e) { /* no-op */ }
    });
  </script>
  <script src="assets/js/permissions.js"></script>
  <script src="assets/js/translations.js"></script>
  <script src="assets/js/account-tooltip.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      if (window.translationManager) {
        try {
          if (!window.translationManager.isInitialized && window.translationManager.init) {
            await window.translationManager.init();
          }
          if (window.translationManager.applyTranslations) {
            window.translationManager.applyTranslations();
          }
        } catch (e) {
          console.error('[Dashboard] Translation error:', e);
        }
      }
    });

    window.addEventListener('storage', async (evt) => {
      if (evt.key === 'eu2k_language' && window.translationManager) {
        try {
          await window.translationManager.switchLanguage(evt.newValue || 'hu');
          window.translationManager.applyTranslations?.();
        } catch (e) {
          console.error('[Dashboard] Storage translation error:', e);
        }
      }
    });
  </script>
  <script src="assets/js/auth-state.js"></script>
  <script src="assets/js/test_firebase.js" type="module"></script>
  <script src="assets/js/firebase-performance.js" type="module"></script>
  <script src="assets/js/youhub-notification-toaster.js" type="module"></script>
  <script src="assets/js/first-input-delay.js"></script>

  <script type="text/javascript" data-gdpr-required>
    (function (c, l, a, r, i, t, y) {
      c[a] = c[a] || function () { (c[a].q = c[a].q || []).push(arguments) };
      t = l.createElement(r); t.async = 1; t.src = "https://www.clarity.ms/tag/" + i;
      y = l.getElementsByTagName(r)[0]; y.parentNode.insertBefore(t, y);
    })(window, document, "clarity", "script", "s6n7qpfkv4");
  </script>
  <script type="importmap">
    {
      "imports": {
        "@material/web/": "https://esm.run/@material/web/"
      }
    }
  </script>
  <script type="module">
    import '@material/web/all.js';
    import { styles as typescaleStyles } from '@material/web/typography/md-typescale-styles.js';

    document.adoptedStyleSheets.push(typescaleStyles.styleSheet);
  </script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-analytics.js";
    import { getFirestore } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
    import { getStorage } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-storage.js";
    import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-functions.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBRRVx6BtQtCDKjFYA8yh9qYrcUONmkkwI",
      authDomain: "eu2k-hub.firebaseapp.com",
      projectId: "eu2k-hub",
      storageBucket: "eu2k-hub.firebasestorage.app",
      messagingSenderId: "560244867055",
      appId: "1:560244867055:web:3cd51b85baead94989001a",
      measurementId: "G-2JDPR089WD"
    };

    const app = initializeApp(firebaseConfig);
    let analytics = null;
    if (window.eu2kGDPR && window.eu2kGDPR.hasConsent()) {
      analytics = getAnalytics(app);
    } else {
      window.addEventListener('eu2k-gdpr-scripts-loaded', () => {
        if (!analytics) {
          analytics = getAnalytics(app);
        }
      });
    }
    const db = getFirestore(app);
    const storage = getStorage(app);
    const functions = getFunctions(app, 'europe-west1');

    window.firebaseApp = app;
    window.db = db;
    window.functions = functions;
    window.createHttpsCallable = (name) => httpsCallable(functions, name);
    window.storage = storage;

    window.addEventListener("load", () => {
      try {
        const INFO_BANNER_KEY = 'eu2k-hide-info-banner';
        const banner = document.querySelector('.info-banner');
        try { if (localStorage.getItem(INFO_BANNER_KEY) === null) localStorage.setItem(INFO_BANNER_KEY, 'false'); } catch (_) { }

        try {
          if (localStorage.getItem(INFO_BANNER_KEY) === 'true' && banner) {
            banner.style.setProperty('display', 'none', 'important');
            try { window.dispatchEvent(new Event('eu2k-banner-visibility-changed')); } catch (_) { }
          }
        } catch (_) { }

        document.addEventListener('click', (e) => {
          const target = e.target && e.target.closest ? e.target.closest('.info-banner .banner-btn') : null;
          if (!target) return;
          e.preventDefault();
          e.stopPropagation();
          const isPrimary = target.classList.contains('primary');
          const isSecondary = target.classList.contains('secondary');
          if (isPrimary) {
            try { localStorage.setItem(INFO_BANNER_KEY, 'true'); } catch (err) { }
            const b = document.querySelector('.info-banner');
            if (b) { b.style.setProperty('display', 'none', 'important'); }
            try { window.dispatchEvent(new Event('eu2k-banner-visibility-changed')); } catch (_) { }
            return false;
          }
          if (isSecondary) {
            try { window.open('#feedback', '_blank'); } catch (err) { }
            return false;
          }
        }, true);
      } catch (e) { }

      try {
        const WARNING_BANNER_KEY = 'eu2k-hide-dashboard-warning-banner';
        const warningBanner = document.querySelector('.warning-banner');
        try { if (localStorage.getItem(WARNING_BANNER_KEY) === null) localStorage.setItem(WARNING_BANNER_KEY, 'false'); } catch (_) { }

        try {
          if (localStorage.getItem(WARNING_BANNER_KEY) === 'true' && warningBanner) {
            warningBanner.style.setProperty('display', 'none', 'important');
          }
        } catch (_) { }

        document.addEventListener('click', (e) => {
          const target = e.target && e.target.closest ? e.target.closest('.warning-banner .banner-btn-single') : null;
          if (!target) return;
          e.preventDefault();
          e.stopPropagation();
          try { localStorage.setItem(WARNING_BANNER_KEY, 'true'); } catch (err) { }
          const b = document.querySelector('.warning-banner');
          if (b) { b.style.setProperty('display', 'none', 'important'); }
          return false;
        }, true);
      } catch (e) { }
    });
  </script>
</head>

<body>
  <div class="app-bg">
    <aside class="sidebar" role="navigation" aria-label="Fő navigáció">
      <div class="nav-frame">
        <div class="nav-shell">
          <nav class="nav-rail">
            <a class="rail-item nav-btn" href="index.html">
              <div class="rail-icon">
                <img src="assets/navbar/home.svg" alt="Otthon" />
              </div>
              <span class="rail-label" data-translate="navigation.home">Otthon</span>
            </a>
            <a class="rail-item nav-btn" href="qr-code.html">
              <div class="rail-icon">
                <img src="assets/navbar/qr_code.svg" alt="QR-Kód" />
              </div>
              <span class="rail-label" data-translate="navigation.qr">QR-Kód</span>
            </a>
            <a class="rail-item nav-btn" href="youhub.html">
              <div class="rail-icon">
                <img src="assets/navbar/youhub.svg" alt="YouHub" />
              </div>
              <span class="rail-label" data-translate="navigation.youhub">YouHub</span>
            </a>
          </nav>
        </div>
      </div>
    </aside>

    <main class="main-area">
      <div class="main-scroll-area">
        <header class="header">
          <div class="header-content">
            <div class="welcome-container">
              <img src="assets/navbar/dashboard.svg" class="welcome-icon" alt="Dashboard">
              <span class="welcome-text" id="dashboardPageTitle"
                data-translate="pages.dashboard.heading">Kezelőpult</span>
            </div>
            <div class="header-icon-container">
              <div class="header-icon-gradient">
                <!-- Vissza gomb (50% opacity a fő dashboardon, aktív a formokon) -->
                <button class="header-edit-mode-btn" id="dashboardBackBtn" style="opacity: 0.5; pointer-events: none;">
                  <img class="header-edit-mode-icon" src="assets/onboarding/back_arrow.svg" alt="Vissza">
                  <span class="header-edit-mode-text" data-translate="pages.settings.back">Vissza</span>
                </button>
                <div class="header-icon-wrapper" id="headerSettingsWrapper">
                  <a href="settings.html" class="header-icon-btn" id="headerSettingsBtn">
                    <img src="assets/general/settings.svg" alt="Settings">
                  </a>
                </div>
                <div class="header-icon-wrapper" id="headerAccountWrapper" style="display: none;">
                  <button class="header-icon-btn" id="headerAccountBtn">
                    <img src="assets/general/account.svg" alt="Account">
                  </button>
                </div>
                <button class="header-login-btn" id="headerLoginBtn" data-translate="pages.general.login"
                  style="display: none;">
                  Bejelentkezés
                </button>
              </div>
            </div>
          </div>

          <section class="info-banner" aria-label="Információ">
            <div class="info-banner-icon-container">
              <img class="info-banner-icon" src="assets/general/banners/info.svg" alt="Info" />
            </div>
            <div class="banner-content">
              <div class="banner-texts">
                <span class="info-banner-title" data-translate="pages.index.banner.title">Ez az új dizájn.</span>
                <span class="info-banner-desc" data-translate="pages.index.banner.description">Reméljük neked is tetszik
                  az Európa Dizájn Rendszer. Ha bármi kétséged van, jelezz vissza, akár innen is.</span>
              </div>
              <div class="banner-actions-wrapper">
                <div class="banner-actions">
                  <button class="banner-btn secondary" type="button"
                    data-translate="pages.index.banner.feedback">Visszajelzés</button>
                  <button class="banner-btn primary" type="button"
                    data-translate="pages.index.banner.close">Bezárás</button>
                </div>
              </div>
            </div>
          </section>

          <section class="warning-banner" aria-label="Figyelmeztetés">
            <div class="warning-banner-icon-container">
              <img class="warning-banner-icon" src="assets/general/banners/info_md.svg" alt="Warning" />
            </div>
            <div class="banner-content">
              <div class="banner-texts">
                <span class="warning-banner-title" data-translate="pages.dashboard.beta_banner.title">A Kezelőpult a
                  bétaverzió elején hiányos lehet.</span>
                <span class="warning-banner-desc" data-translate="pages.dashboard.beta_banner.description">A Kezelőpult
                  funkciói a bétaverzióban hiányosak. További részei a teljes kiadásban lesznek jelen.</span>
              </div>
              <div class="banner-actions-wrapper">
                <div class="banner-actions-single">
                  <button class="banner-btn-warning primary" type="button" data-translate="common.ok">Rendben</button>
                </div>
              </div>
            </div>
          </section>
        </header>

        <div class="main-content">
          <!-- Main Dashboard Page -->
          <div id="main-page" class="dashboard-page active">
            <div class="qr-controls-container">
              <span class="qr-controls-title" data-translate="pages.dashboard.quick_commands">Gyorsparancsok</span>
              <div class="qr-controls-row">
                <div class="qr-buttons-column">
                  <button class="qr-control-btn qr-btn-green qr-btn-participation" onclick="openSuggestionCenter()">
                    <img src="assets/dashboard/suggestion-center.svg" class="qr-control-icon" alt="Javaslat-központ">
                    <span data-translate="pages.dashboard.suggestion_center">Javaslat-központ</span>
                  </button>
                  <!-- Changed to Blue as per updated requirements (image & text match) -->
                  <button class="qr-control-btn qr-btn-blue qr-btn-restart" onclick="openNotificationCenter()">
                    <img src="assets/dashboard/notification-center.svg" class="qr-control-icon" alt="Értesítésközpont">
                    <span data-translate="pages.dashboard.notification_center">Értesítésközpont</span>
                  </button>
                </div>
                <button class="qr-control-btn qr-btn-blue qr-btn-publish" onclick="openPublish()">
                  <img src="assets/dashboard/publish_blue.svg" class="qr-control-icon" alt="Publikálás">
                  <span data-translate="pages.dashboard.publish">Publikálás</span>
                </button>
              </div>
            </div>
          </div>

          <!-- Publish Page -->
          <div id="publish-page" class="dashboard-page">
            <!-- Initial view: type selection -->
            <div id="publish-type-selection" class="publish-container">
              <span class="publish-title" data-translate="pages.dashboard.publish">Publikálás</span>
              <span class="publish-subtitle" data-translate="pages.dashboard.select_type">Válaszd ki a típusát</span>
              <div class="publish-buttons-container">
                <!-- Hír: Green, Fill -->
                <button class="publish-btn publish-btn-news" data-translate="pages.dashboard.news"
                  onclick="showNewsPublishForm()">Hír</button>
                <!-- Esemény: Blue, Hug -->
                <button class="publish-btn publish-btn-event" data-translate="pages.dashboard.event"
                  onclick="publishEvent()">Esemény</button>
              </div>
            </div>

            <!-- News publish form -->
            <div id="news-publish-form" class="news-publish-form" style="display: none;">
              <button class="header-edit-mode-btn" onclick="hideNewsPublishForm()">
                <img src="assets/onboarding/back_arrow.svg" alt="Vissza">
                <span data-translate="pages.settings.back">Vissza</span>
              </button>

              <h2 class="news-publish-form-title" data-translate="pages.dashboard.news_publish.title">Hír Publikálása
              </h2>
              <p class="news-publish-form-subtitle" data-translate="pages.dashboard.news_publish.subtitle">Kérlek tölts
                ki minden mezőt :)</p>

              <div class="news-publish-row">
                <!-- Left: 4 inputs -->
                <div class="news-inputs-column">
                  <div class="news-input-group">
                    <label class="news-input-label" data-translate="pages.dashboard.news_publish.title_label">Hír
                      címe</label>
                    <input type="text" id="newsTitle" class="news-input" placeholder="Value" maxlength="120">
                  </div>
                  <div class="news-input-group">
                    <label class="news-input-label" data-translate="pages.dashboard.news_publish.link_label">Hír
                      linkje</label>
                    <input type="url" id="newsLink" class="news-input" placeholder="Value">
                  </div>
                  <div class="news-input-group">
                    <label class="news-input-label" data-translate="pages.dashboard.news_publish.author_label">Hír
                      szerzője</label>
                    <input type="text" id="newsAuthor" class="news-input" placeholder="Value">
                  </div>
                  <div class="news-input-group">
                    <label class="news-input-label" data-translate="pages.dashboard.news_publish.date_label">Kiadási
                      dátum (mai napért hagyd üresen)</label>
                    <input type="date" id="newsDate" class="news-input">
                  </div>
                </div>

                <!-- Middle: textarea -->
                <div class="news-content-container">
                  <label class="news-input-label" data-translate="pages.dashboard.news_publish.content_label">Hír
                    Leírása</label>
                  <textarea id="newsContent" class="news-content-textarea" placeholder="Value"></textarea>
                </div>

                <!-- Divider -->
                <div class="news-divider"></div>

                <!-- Preview card + upload -->
                <div class="news-preview-container">
                  <div class="news-preview-card">
                    <img id="newsPreviewImage" class="news-preview-card-bg"
                      src="assets/general/image_placeholder_blue.svg" alt="Előnézet">
                  </div>
                  <button class="news-upload-btn" onclick="triggerNewsImageUpload()"
                    data-translate="pages.dashboard.news_publish.upload_image">Kép feltöltése</button>
                  <input type="file" id="newsImageInput" class="news-file-input" accept="image/*">
                </div>

                <!-- Divider -->
                <div class="news-divider"></div>

                <!-- Publish button -->
                <div class="news-publish-btn-container">
                  <button id="newsPublishBtn" class="news-publish-btn" onclick="submitNewsPublish()"
                    data-translate="pages.dashboard.news_publish.publish">Publikálás</button>
                </div>
              </div>
            </div>
          </div>

          <!-- News publish loading popup -->
          <div id="newsPublishPopup" class="news-publish-popup">
            <div class="news-publish-popup-content">
              <h3 class="news-publish-popup-title" data-translate="pages.dashboard.news_publish.loading_title">Hír
                publikálása folyamatban</h3>
              <p class="news-publish-popup-subtitle" data-translate="pages.dashboard.news_publish.loading_subtitle">
                Kérjük ne zárd be ezt az oldalt!</p>
              <div class="news-publish-loader"></div>
            </div>
          </div>

          <!-- Event publish form -->
          <div id="event-publish-form" class="news-publish-form event-publish-form" style="display: none;">
            <button class="header-edit-mode-btn" onclick="hideEventPublishForm()">
              <img src="assets/onboarding/back_arrow.svg" alt="Vissza">
              <span data-translate="pages.settings.back">Vissza</span>
            </button>

            <h2 class="news-publish-form-title" data-translate="pages.dashboard.event_publish.title">Esemény Publikálása
            </h2>
            <p class="news-publish-form-subtitle" data-translate="pages.dashboard.event_publish.subtitle">Kérlek tölts
              ki minden mezőt :)</p>

            <div class="news-publish-row">
              <!-- Left: 5 inputs -->
              <div class="news-inputs-column event-inputs-column">
                <div class="news-input-group">
                  <label class="news-input-label" data-translate="pages.dashboard.event_publish.title_label">Esemény
                    címe</label>
                  <input type="text" id="eventTitle" class="news-input" placeholder="Value" maxlength="120">
                </div>
                <div class="news-input-group">
                  <label class="news-input-label" data-translate="pages.dashboard.event_publish.link_label">Esemény
                    linkje</label>
                  <input type="url" id="eventLink" class="news-input" placeholder="Value">
                </div>
                <div class="news-input-group">
                  <label class="news-input-label" data-translate="pages.dashboard.event_publish.place_label">Esemény
                    helye</label>
                  <input type="text" id="eventPlace" class="news-input" placeholder="Value">
                </div>
                <div class="news-input-group">
                  <label class="news-input-label" data-translate="pages.dashboard.event_publish.date_from_label">Esemény
                    kezdődátuma</label>
                  <input type="date" id="eventDateFrom" class="news-input">
                </div>
                <div class="news-input-group">
                  <label class="news-input-label" data-translate="pages.dashboard.event_publish.date_to_label">Esemény
                    befejező dátuma (egynapos eseményeknél a kezdődátumot írd ide is)</label>
                  <input type="date" id="eventDateTo" class="news-input">
                </div>
              </div>

              <!-- Middle: textarea -->
              <div class="news-content-container">
                <label class="news-input-label" data-translate="pages.dashboard.event_publish.description_label">Esemény
                  Leírása</label>
                <textarea id="eventDescription" class="news-content-textarea" placeholder="Value"></textarea>
              </div>

              <!-- Divider -->
              <div class="news-divider"></div>

              <!-- Preview card + upload -->
              <div class="news-preview-container">
                <div class="news-preview-card">
                  <img id="eventPreviewImage" class="news-preview-card-bg"
                    src="assets/general/image_placeholder_blue.svg" alt="Előnézet">
                </div>
                <button class="news-upload-btn" onclick="triggerEventImageUpload()"
                  data-translate="pages.dashboard.event_publish.upload_image">Kép feltöltése</button>
                <input type="file" id="eventImageInput" class="news-file-input" accept="image/*">
              </div>

              <!-- Divider -->
              <div class="news-divider"></div>

              <!-- Publish button -->
              <div class="news-publish-btn-container">
                <button id="eventPublishBtn" class="news-publish-btn" onclick="submitEventPublish()"
                  data-translate="pages.dashboard.event_publish.publish">Publikálás</button>
              </div>
            </div>
          </div>

          <!-- Event publish loading popup -->
          <div id="eventPublishPopup" class="news-publish-popup">
            <div class="news-publish-popup-content">
              <h3 class="news-publish-popup-title" data-translate="pages.dashboard.event_publish.loading_title">Esemény
                publikálása folyamatban</h3>
              <p class="news-publish-popup-subtitle" data-translate="pages.dashboard.event_publish.loading_subtitle">
                Kérjük ne zárd be ezt az oldalt!</p>
              <div class="news-publish-loader"></div>
            </div>
          </div>

          <script type="module">
            import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";

            function updateHeaderIcons(loggedIn) {
              const settingsWrapper = document.getElementById('headerSettingsWrapper');
              const accountWrapper = document.getElementById('headerAccountWrapper');
              const loginBtn = document.getElementById('headerLoginBtn');
              const gradientContainer = document.querySelector('.header-icon-gradient');
              if (!settingsWrapper || !accountWrapper || !loginBtn || !gradientContainer) return;

              if (loggedIn) {
                settingsWrapper.style.display = 'flex';
                accountWrapper.style.display = 'flex';
                loginBtn.style.display = 'none';
                gradientContainer.classList.remove('has-login');
              } else {
                settingsWrapper.style.display = 'flex';
                accountWrapper.style.display = 'none';
                loginBtn.style.display = 'flex';
                gradientContainer.classList.add('has-login');
              }
            }

            try {
              const auth = getAuth();
              onAuthStateChanged(auth, (user) => {
                updateHeaderIcons(!!user);
              });
            } catch (e) {
              // no-op
            }

            const loginBtnEl = document.getElementById('headerLoginBtn');
            if (loginBtnEl) {
              loginBtnEl.addEventListener('click', function () {
                window.location.href = 'onboarding.html';
              });
            }
          </script>
        </div>

        <footer class="site-footer">
          <div class="footer-left">
            <div class="footer-logo-container">
              <img src="assets/general/footer/eu2k_hub.png" alt="EU2K Hub">
              <span class="footer-participated-text" data-translate="footer.participated">Részt vett még:</span>
              <div class="footer-participated-logos">
                <img src="assets/general/footer/eu2k.png" alt="EU2K">
                <img src="assets/general/footer/eu2k_devs.png" alt="EU2K Devs">
                <img src="assets/general/footer/eu2k_dok.png" alt="EU2K Dok">
                <img src="assets/general/footer/eu2k_ujsag.png" alt="EU2K Újság">
              </div>
            </div>
            <div class="footer-copyright" data-translate="footer.copyright">© 2025 EU2K Devs és Európa 2000 Gimnázium.
              All Rights Reserved.</div>
            <div class="footer-social">
              <img src="assets/general/footer/eu2k_ujsag.svg" alt="EU2K Újság"
                onclick="window.open('https://sites.google.com/view/eu2k-ujsag', '_blank')">
              <img src="assets/general/footer/x.svg" alt="X (Twitter)"
                onclick="window.open('https://x.com/eu2kdevs', '_blank')">
              <img src="assets/general/footer/instagram.svg" alt="Instagram"
                onclick="window.open('https://instagram.com/eu2k.devs', '_blank')">
              <img src="assets/general/footer/yt.svg" alt="YouTube"
                onclick="window.open('https://youtube.com/@eu2kdevs', '_blank')">
            </div>
          </div>
          <div class="footer-right">
            <div class="footer-section-first">
              <div class="footer-section-title" data-translate="footer.legal.title">Jogi Nyilatkozatok</div>
              <div class="footer-section-items">
                <a href="privacy-policy.html" class="footer-item"
                  data-translate="footer.legal.privacy">Adatvédelmi&nbsp;Tájékoztató</a>
                <a href="terms-of-service.html" class="footer-item"
                  data-translate="footer.legal.terms">Használati&nbsp;Feltételek</a>
              </div>
            </div>
            <div class="footer-section">
              <div class="footer-section-title" data-translate="footer.hubs.title">Hubs</div>
              <div class="footer-section-items">
                <div class="footer-item">YouHub</div>
                <div class="footer-item">Class&nbsp;Hub</div>
                <div class="footer-item">Food&nbsp;Hub</div>
                <div class="footer-item">Event&nbsp;Hub</div>
                <div class="footer-item">Fitness&nbsp;Hub<span class="beta-badge">BETA</span></div>
              </div>
            </div>
          </div>
        </footer>
      </div>
    </main>
  </div>

  <div id="devModePopup" class="permission-overlay-scroll-area" style="display: none;">
    <div class="permission-container">
      <button class="permission-close-btn" onclick="closeDevModePopup()">
        <img src="assets/general/close.svg" alt="Bezárás">
      </button>
      <div class="permission-content">
        <h2 class="permission-title" data-translate="youhub.dev_mode.title">Developer Mód</h2>
        <p class="permission-text" data-translate="youhub.dev_mode.text">Jelszó megadása:</p>
        <input type="password" id="devModePassword" class="dev-mode-input"
          data-translate-placeholder="youhub.dev_mode.password_placeholder" placeholder="Jelszó">
        <button class="permission-ok-btn" onclick="checkDevModePassword()"
          data-translate="youhub.dev_mode.login_button">Bejelentkezés</button>
      </div>
    </div>
  </div>

  <script src="assets/js/developer-mode.js"></script>
  <script src="assets/js/account-tooltip.js"></script>
  <script src="assets/js/footer.js"></script>
  <script src="assets/js/consent-banner.js"></script>
  <script src="assets/js/staff-timer.js"></script>
  <script src="assets/js/staff-nav-items.js"></script>
  <script>
    function handleHashChange() {
      const hash = window.location.hash || '#main';
      const mainPage = document.getElementById('main-page');
      const publishPage = document.getElementById('publish-page');
      const pageTitle = document.getElementById('dashboardPageTitle');

      if (mainPage) mainPage.classList.remove('active');
      if (publishPage) publishPage.classList.remove('active');

      if (hash === '#publish') {
        if (publishPage) publishPage.classList.add('active');
        if (pageTitle) {
          const publishTitle = window.translationManager?.getTranslation('pages.dashboard.heading_publish') || 'Kezelőpult - Publikálás';
          pageTitle.textContent = publishTitle;
        }
      } else {
        if (mainPage) mainPage.classList.add('active');
        if (pageTitle) {
          const mainTitle = window.translationManager?.getTranslation('pages.dashboard.heading') || 'Kezelőpult';
          pageTitle.textContent = mainTitle;
        }
      }
    }

    window.addEventListener('hashchange', handleHashChange);

    document.addEventListener('DOMContentLoaded', () => {
      handleHashChange();
      if (window.translationManager?.applyTranslations) {
        setTimeout(() => {
          window.translationManager.applyTranslations();
          handleHashChange();
        }, 100);
      }
    });

    function openSuggestionCenter() {
      console.log('[Dashboard] Opening Suggestion Center');
      window.location.href = 'youhub.html';
    }

    function openNotificationCenter() {
      console.log('[Dashboard] Opening Notification Center');
      window.location.href = 'youhub.html';
    }

    function openPublish() {
      console.log('[Dashboard] Opening Publish page');
      window.location.hash = '#publish';
    }

    function publishNews() {
      // Legacy function - now redirects to showNewsPublishForm
      showNewsPublishForm();
    }

    // Store selected image file
    let selectedNewsImage = null;

    function showNewsPublishForm() {
      console.log('[Dashboard] Showing news publish form');
      const typeSelection = document.getElementById('publish-type-selection');
      const newsForm = document.getElementById('news-publish-form');
      const backBtn = document.getElementById('dashboardBackBtn');
      if (typeSelection) typeSelection.style.display = 'none';
      if (newsForm) newsForm.style.display = 'flex';
      // Activate back button
      if (backBtn) {
        backBtn.style.opacity = '1';
        backBtn.style.pointerEvents = 'auto';
        backBtn.onclick = hideNewsPublishForm;
      }
      // Clear previous inputs
      clearNewsForm();
    }

    function hideNewsPublishForm() {
      console.log('[Dashboard] Hiding news publish form');
      const typeSelection = document.getElementById('publish-type-selection');
      const newsForm = document.getElementById('news-publish-form');
      const backBtn = document.getElementById('dashboardBackBtn');
      if (typeSelection) typeSelection.style.display = 'flex';
      if (newsForm) newsForm.style.display = 'none';
      // Deactivate back button
      if (backBtn) {
        backBtn.style.opacity = '0.5';
        backBtn.style.pointerEvents = 'none';
        backBtn.onclick = null;
      }
      clearNewsForm();
    }

    function clearNewsForm() {
      const titleInput = document.getElementById('newsTitle');
      const linkInput = document.getElementById('newsLink');
      const authorInput = document.getElementById('newsAuthor');
      const contentInput = document.getElementById('newsContent');
      const dateInput = document.getElementById('newsDate');
      const previewImg = document.getElementById('newsPreviewImage');

      if (titleInput) { titleInput.value = ''; titleInput.classList.remove('error'); }
      if (linkInput) { linkInput.value = ''; linkInput.classList.remove('error'); }
      if (authorInput) { authorInput.value = ''; authorInput.classList.remove('error'); }
      if (contentInput) { contentInput.value = ''; contentInput.classList.remove('error'); }
      if (dateInput) { dateInput.value = ''; }
      if (previewImg) previewImg.src = 'assets/general/image_placeholder_blue.svg';
      selectedNewsImage = null;
    }

    function triggerNewsImageUpload() {
      const fileInput = document.getElementById('newsImageInput');
      if (fileInput) fileInput.click();
    }

    // Image input change handler
    document.addEventListener('DOMContentLoaded', () => {
      const fileInput = document.getElementById('newsImageInput');
      if (fileInput) {
        fileInput.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (file && file.type.startsWith('image/')) {
            selectedNewsImage = file;
            const previewImg = document.getElementById('newsPreviewImage');
            if (previewImg) {
              const reader = new FileReader();
              reader.onload = (e) => {
                previewImg.src = e.target.result;
              };
              reader.readAsDataURL(file);
            }
            console.log('[Dashboard] Image selected:', file.name);
          }
        });
      }
    });

    function showNewsPublishPopup() {
      const popup = document.getElementById('newsPublishPopup');
      if (popup) popup.classList.add('active');
    }

    function hideNewsPublishPopup() {
      const popup = document.getElementById('newsPublishPopup');
      if (popup) popup.classList.remove('active');
    }

    function getTranslation(key, fallback) {
      try {
        return window.translationManager?.getTranslation(key) || fallback;
      } catch {
        return fallback;
      }
    }

    function showInputError(inputId, errorKey, fallbackMsg) {
      const input = document.getElementById(inputId);
      if (input) input.classList.add('error');

      // Show toast notification
      if (window.showToastDirectly) {
        window.showToastDirectly(
          getTranslation('youhub.suggestions.notifications.types.error', 'Hiba'),
          getTranslation(errorKey, fallbackMsg),
          'danger'
        );
      } else {
        alert(getTranslation(errorKey, fallbackMsg));
      }
    }

    function clearInputErrors() {
      ['newsTitle', 'newsLink', 'newsAuthor', 'newsContent'].forEach(id => {
        const input = document.getElementById(id);
        if (input) input.classList.remove('error');
      });
    }

    // HTML tag detection regex
    const htmlTagRegex = /<[^>]*>/;

    function validateNewsInputs() {
      const title = document.getElementById('newsTitle')?.value?.trim() || '';
      const link = document.getElementById('newsLink')?.value?.trim() || '';
      const author = document.getElementById('newsAuthor')?.value?.trim() || '';
      const content = document.getElementById('newsContent')?.value?.trim() || '';

      clearInputErrors();

      // Title validation
      if (title.length < 3) {
        showInputError('newsTitle', 'pages.dashboard.news_publish.error.title_too_short', 'A cím túl rövid (min. 3 karakter)');
        return false;
      }
      if (title.length > 120) {
        showInputError('newsTitle', 'pages.dashboard.news_publish.error.title_too_long', 'A cím túl hosszú (max. 120 karakter)');
        return false;
      }
      if (htmlTagRegex.test(title)) {
        showInputError('newsTitle', 'pages.dashboard.news_publish.error.title_html', 'A cím nem tartalmazhat HTML kódot');
        return false;
      }

      // Author validation  
      if (!author) {
        showInputError('newsAuthor', 'pages.dashboard.news_publish.error.author_required', 'A szerző megadása kötelező');
        return false;
      }
      if (htmlTagRegex.test(author)) {
        showInputError('newsAuthor', 'pages.dashboard.news_publish.error.author_html', 'A szerző nem tartalmazhat HTML kódot');
        return false;
      }

      // Content HTML check
      if (htmlTagRegex.test(content)) {
        showInputError('newsContent', 'pages.dashboard.news_publish.error.content_html', 'A tartalom nem tartalmazhat HTML kódot');
        return false;
      }

      // Link validation (if provided)
      if (link && htmlTagRegex.test(link)) {
        showInputError('newsLink', 'pages.dashboard.news_publish.error.link_html', 'A link nem tartalmazhat HTML kódot');
        return false;
      }

      // Image validation
      if (!selectedNewsImage) {
        showInputError('newsImageInput', 'pages.dashboard.news_publish.error.image_required', 'Kérlek tölts fel egy képet');
        return false;
      }

      return true;
    }

    async function submitNewsPublish() {
      console.log('[Dashboard] Submitting news...');

      // Validate inputs
      if (!validateNewsInputs()) {
        return;
      }

      const title = document.getElementById('newsTitle')?.value?.trim();
      const link = document.getElementById('newsLink')?.value?.trim();
      const author = document.getElementById('newsAuthor')?.value?.trim();
      const content = document.getElementById('newsContent')?.value?.trim();
      const dateInput = document.getElementById('newsDate')?.value;

      // Show loading popup
      showNewsPublishPopup();

      try {
        // Import functions for europe-west3 region
        const { getFunctions, httpsCallable } = await import("https://www.gstatic.com/firebasejs/11.10.0/firebase-functions.js");
        const functionsWest3 = getFunctions(window.firebaseApp, 'europe-west3');

        // Step 1: Get signed URL for image upload
        console.log('[Dashboard] Getting signed upload URL...');
        const getUploadUrl = httpsCallable(functionsWest3, 'getNewsUploadUrl');

        // Generate a temporary newsId (will be confirmed by server)
        const tempNewsId = Date.now().toString();

        const uploadUrlResult = await getUploadUrl({
          contentType: selectedNewsImage.type,
          newsId: tempNewsId
        });

        const { uploadUrl, fileName } = uploadUrlResult.data;
        console.log('[Dashboard] Got signed URL, uploading image...');

        // Step 2: Upload image directly to Storage via signed URL
        const uploadResponse = await fetch(uploadUrl, {
          method: 'PUT',
          headers: {
            'Content-Type': selectedNewsImage.type
          },
          body: selectedNewsImage
        });

        if (!uploadResponse.ok) {
          throw new Error('Image upload failed');
        }

        // Step 3: Get the public URL of the uploaded image
        const bucket = 'eu2k-hub.firebasestorage.app';
        const imageUrl = `https://firebasestorage.googleapis.com/v0/b/${bucket}/o/${encodeURIComponent(fileName)}?alt=media`;
        console.log('[Dashboard] Image uploaded, publishing news...');

        // Step 4: Call publishNews function with optional custom date
        const publishNewsFunc = httpsCallable(functionsWest3, 'publishNews');
        const publishResult = await publishNewsFunc({
          title: title,
          author: author,
          desc: content,
          link: link,
          imageUrl: imageUrl,
          customDate: dateInput || null  // Pass custom date if provided
        });

        console.log('[Dashboard] News published:', publishResult.data);

        // Success
        hideNewsPublishPopup();
        hideNewsPublishForm();

        if (window.showToastDirectly) {
          window.showToastDirectly(
            getTranslation('youhub.suggestions.notifications.types.success_operation', 'Sikeres művelet'),
            getTranslation('pages.dashboard.news_publish.success', 'Sikeresen publikáltuk a hírt!'),
            'positive'
          );
        } else {
          alert(getTranslation('pages.dashboard.news_publish.success', 'Sikeresen publikáltuk a hírt!'));
        }

      } catch (error) {
        console.error('[Dashboard] News publish error:', error);
        hideNewsPublishPopup();

        // Parse error message from Cloud Function
        let errorMessage = error.message || getTranslation('pages.dashboard.news_publish.error.generic', 'Hiba történt a publikálás során');

        // Check for specific error codes
        if (error.code === 'permission-denied') {
          errorMessage = getTranslation('pages.dashboard.news_publish.error.permission', 'Nincs jogosultságod a publikáláshoz');
        } else if (error.code === 'unauthenticated') {
          errorMessage = getTranslation('pages.dashboard.news_publish.error.login', 'Kérlek jelentkezz be');
        }

        if (window.showToastDirectly) {
          window.showToastDirectly(
            getTranslation('youhub.suggestions.notifications.types.error', 'Hiba'),
            errorMessage,
            'danger'
          );
        } else {
          alert(errorMessage);
        }
      }
    }



    // ========== EVENT PUBLISH FUNCTIONS ==========

    // Store selected event image file
    let selectedEventImage = null;

    function showEventPublishForm() {
      console.log('[Dashboard] Showing event publish form');
      const typeSelection = document.getElementById('publish-type-selection');
      const eventForm = document.getElementById('event-publish-form');
      const backBtn = document.getElementById('dashboardBackBtn');
      if (typeSelection) typeSelection.style.display = 'none';
      if (eventForm) eventForm.style.display = 'flex';
      // Activate back button
      if (backBtn) {
        backBtn.style.opacity = '1';
        backBtn.style.pointerEvents = 'auto';
        backBtn.onclick = hideEventPublishForm;
      }
      clearEventForm();
    }

    function hideEventPublishForm() {
      console.log('[Dashboard] Hiding event publish form');
      const typeSelection = document.getElementById('publish-type-selection');
      const eventForm = document.getElementById('event-publish-form');
      const backBtn = document.getElementById('dashboardBackBtn');
      if (typeSelection) typeSelection.style.display = 'flex';
      if (eventForm) eventForm.style.display = 'none';
      // Deactivate back button
      if (backBtn) {
        backBtn.style.opacity = '0.5';
        backBtn.style.pointerEvents = 'none';
        backBtn.onclick = null;
      }
      clearEventForm();
    }

    function clearEventForm() {
      const titleInput = document.getElementById('eventTitle');
      const linkInput = document.getElementById('eventLink');
      const placeInput = document.getElementById('eventPlace');
      const dateFromInput = document.getElementById('eventDateFrom');
      const dateToInput = document.getElementById('eventDateTo');
      const descInput = document.getElementById('eventDescription');
      const previewImg = document.getElementById('eventPreviewImage');

      if (titleInput) { titleInput.value = ''; titleInput.classList.remove('error'); }
      if (linkInput) { linkInput.value = ''; linkInput.classList.remove('error'); }
      if (placeInput) { placeInput.value = ''; placeInput.classList.remove('error'); }
      if (dateFromInput) { dateFromInput.value = ''; dateFromInput.classList.remove('error'); }
      if (dateToInput) { dateToInput.value = ''; dateToInput.classList.remove('error'); }
      if (descInput) { descInput.value = ''; descInput.classList.remove('error'); }
      if (previewImg) previewImg.src = 'assets/general/image_placeholder_blue.svg';
      selectedEventImage = null;
    }

    function triggerEventImageUpload() {
      const fileInput = document.getElementById('eventImageInput');
      if (fileInput) fileInput.click();
    }

    // Event image input change handler
    document.addEventListener('DOMContentLoaded', () => {
      const fileInput = document.getElementById('eventImageInput');
      if (fileInput) {
        fileInput.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (file && file.type.startsWith('image/')) {
            selectedEventImage = file;
            const previewImg = document.getElementById('eventPreviewImage');
            if (previewImg) {
              const reader = new FileReader();
              reader.onload = (e) => {
                previewImg.src = e.target.result;
              };
              reader.readAsDataURL(file);
            }
            console.log('[Dashboard] Event image selected:', file.name);
          }
        });
      }
    });

    function showEventPublishPopup() {
      const popup = document.getElementById('eventPublishPopup');
      if (popup) popup.classList.add('active');
    }

    function hideEventPublishPopup() {
      const popup = document.getElementById('eventPublishPopup');
      if (popup) popup.classList.remove('active');
    }

    function showEventInputError(inputId, translationKey, fallback) {
      const input = document.getElementById(inputId);
      if (input) {
        input.classList.add('error');
        const errorMsg = getTranslation(translationKey, fallback);
        if (window.showToastDirectly) {
          window.showToastDirectly(
            getTranslation('youhub.suggestions.notifications.types.warning', 'Figyelmeztetés'),
            errorMsg,
            'warning'
          );
        }
      }
    }

    function validateEventInputs() {
      // Clear previous errors
      ['eventTitle', 'eventLink', 'eventPlace', 'eventDateFrom', 'eventDateTo', 'eventDescription'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.classList.remove('error');
      });

      const title = document.getElementById('eventTitle')?.value?.trim() || '';
      const place = document.getElementById('eventPlace')?.value?.trim() || '';
      const dateFrom = document.getElementById('eventDateFrom')?.value || '';
      const dateTo = document.getElementById('eventDateTo')?.value || '';

      // Title validation
      if (!title || title.length < 3) {
        showEventInputError('eventTitle', 'pages.dashboard.event_publish.error.title_required', 'Az esemény címe kötelező (min. 3 karakter)');
        return false;
      }

      // Place validation
      if (!place) {
        showEventInputError('eventPlace', 'pages.dashboard.event_publish.error.place_required', 'Az esemény helye kötelező');
        return false;
      }

      // Date from validation
      if (!dateFrom) {
        showEventInputError('eventDateFrom', 'pages.dashboard.event_publish.error.date_from_required', 'A kezdődátum kötelező');
        return false;
      }

      // Date to validation
      if (!dateTo) {
        showEventInputError('eventDateTo', 'pages.dashboard.event_publish.error.date_to_required', 'A befejező dátum kötelező');
        return false;
      }

      // Image validation
      if (!selectedEventImage) {
        showEventInputError('eventPreviewImage', 'pages.dashboard.event_publish.error.image_required', 'Kérlek tölts fel egy képet');
        return false;
      }

      return true;
    }

    async function submitEventPublish() {
      console.log('[Dashboard] Submitting event...');

      // Validate inputs
      if (!validateEventInputs()) {
        return;
      }

      const title = document.getElementById('eventTitle')?.value?.trim();
      const link = document.getElementById('eventLink')?.value?.trim() || '';
      const place = document.getElementById('eventPlace')?.value?.trim();
      const dateFrom = document.getElementById('eventDateFrom')?.value;
      const dateTo = document.getElementById('eventDateTo')?.value;
      const description = document.getElementById('eventDescription')?.value?.trim() || '';

      // Show loading popup
      showEventPublishPopup();

      try {
        // Import functions for europe-west3 region
        const { getFunctions, httpsCallable } = await import("https://www.gstatic.com/firebasejs/11.10.0/firebase-functions.js");
        const functionsWest3 = getFunctions(window.firebaseApp, 'europe-west3');

        // Step 1: Get signed URL for image upload
        console.log('[Dashboard] Getting signed upload URL for event...');
        const getUploadUrl = httpsCallable(functionsWest3, 'getEventUploadUrl');

        // Generate a temporary eventId (will be confirmed by server)
        const tempEventId = Date.now().toString();

        const uploadUrlResult = await getUploadUrl({
          contentType: selectedEventImage.type,
          eventId: tempEventId
        });

        const { uploadUrl, fileName } = uploadUrlResult.data;
        console.log('[Dashboard] Got signed URL, uploading event image...');

        // Step 2: Upload image directly to Storage via signed URL
        const uploadResponse = await fetch(uploadUrl, {
          method: 'PUT',
          headers: {
            'Content-Type': selectedEventImage.type
          },
          body: selectedEventImage
        });

        if (!uploadResponse.ok) {
          throw new Error('Image upload failed');
        }

        // Step 3: Get the public URL of the uploaded image
        const bucket = 'eu2k-hub.firebasestorage.app';
        const imageUrl = `https://firebasestorage.googleapis.com/v0/b/${bucket}/o/${encodeURIComponent(fileName)}?alt=media`;
        console.log('[Dashboard] Event image uploaded, publishing event...');

        // Step 4: Call publishEvent function
        const publishEventFunc = httpsCallable(functionsWest3, 'publishEvent');
        const publishResult = await publishEventFunc({
          title: title,
          link: link,
          place: place,
          description: description,
          imageUrl: imageUrl,
          dateFrom: dateFrom,
          dateTo: dateTo
        });

        console.log('[Dashboard] Event published:', publishResult.data);

        // Success
        hideEventPublishPopup();
        hideEventPublishForm();

        if (window.showToastDirectly) {
          window.showToastDirectly(
            getTranslation('youhub.suggestions.notifications.types.success_operation', 'Sikeres művelet'),
            getTranslation('pages.dashboard.event_publish.success', 'Sikeresen publikáltuk az eseményt!'),
            'positive'
          );
        } else {
          alert(getTranslation('pages.dashboard.event_publish.success', 'Sikeresen publikáltuk az eseményt!'));
        }

      } catch (error) {
        console.error('[Dashboard] Event publish error:', error);
        hideEventPublishPopup();

        // Parse error message from Cloud Function
        let errorMessage = error.message || getTranslation('pages.dashboard.event_publish.error.generic', 'Hiba történt a publikálás során');

        // Check for specific error codes
        if (error.code === 'permission-denied') {
          errorMessage = getTranslation('pages.dashboard.event_publish.error.permission', 'Nincs jogosultságod a publikáláshoz');
        } else if (error.code === 'unauthenticated') {
          errorMessage = getTranslation('pages.dashboard.event_publish.error.login', 'Kérlek jelentkezz be');
        }

        if (window.showToastDirectly) {
          window.showToastDirectly(
            getTranslation('youhub.suggestions.notifications.types.error', 'Hiba'),
            errorMessage,
            'danger'
          );
        } else {
          alert(errorMessage);
        }
      }
    }

    // Redirect from the button in publish-type-selection
    function publishEvent() {
      showEventPublishForm();
    }

    async function checkSessionAndUpdateBlur() {
      const scrollArea = document.querySelector('.main-scroll-area');
      if (!scrollArea) return;
      try {
        let retries = 0;
        while ((!window.firebaseApp || !window.functions) && retries < 50) {
          await new Promise(resolve => setTimeout(resolve, 100));
          retries++;
        }
        if (!window.firebaseApp || !window.functions) {
          scrollArea.classList.add('session-inactive');
          return;
        }
        const { getAuth } = await import("https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js");
        const auth = getAuth(window.firebaseApp);
        await new Promise(resolve => {
          if (auth.currentUser) resolve();
          else { const u = auth.onAuthStateChanged(() => { u(); resolve(); }); }
        });
        if (!auth.currentUser) {
          scrollArea.classList.add('session-inactive');
          return;
        }
        const { httpsCallable } = await import("https://www.gstatic.com/firebasejs/11.10.0/firebase-functions.js");
        const checkSession = httpsCallable(window.functions, 'staffSessionCheck');
        const result = await checkSession();
        if (result.data.active) scrollArea.classList.remove('session-inactive');
        else scrollArea.classList.add('session-inactive');
      } catch (error) {
        scrollArea.classList.add('session-inactive');
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      checkSessionAndUpdateBlur();
      setInterval(checkSessionAndUpdateBlur, 5000);
    });
  </script>
</body>

</html>