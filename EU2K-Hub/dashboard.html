<!DOCTYPE html>
<html lang="hu">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description"
    content="Üdvözöllek az EU2K Hub Kezelőpultjában! Kezeld az eseményeket, híreket és publikálj tartalmakat.">
  <title data-translate="pages.dashboard.title" data-translate-fallback="Kezelőpult">Kezelőpult</title>
  <link rel="stylesheet" href="dashboard.css">
  <link rel="stylesheet" href="assets/css/consent-banner.css">
  <link rel="stylesheet" href="assets/components/language-dropdown.css">
  <link rel="icon" href="favicon.ico">
  <script>
    (function () {
      if (!document.getElementById('eu2k-page-overlay')) {
        var o = document.createElement('div');
        o.id = 'eu2k-page-overlay';
        o.style.cssText = 'position:fixed;inset:0;z-index:9999;background:#000000;border-radius:32px;opacity:1;transition:opacity 300ms ease-in-out;';
        var inner = document.createElement('div');
        inner.style.cssText = 'position:relative;width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:#000000;border-radius:32px;';
        var m = document.createElement('div');
        m.id = 'eu2k-overlay-mount';
        m.style.cssText = 'position:relative;width:100%;height:100%';
        inner.appendChild(m);
        o.appendChild(inner);
        document.documentElement.appendChild(o);
      }
    })();
  </script>

  <script src="assets/js/page-overlay-loader.js"></script>
  <script>
    window.addEventListener('load', function () {
      try {
        var o = document.getElementById('eu2k-page-overlay');
        if (o) {
          o.style.opacity = '0';
          o.style.pointerEvents = 'none';
          setTimeout(function () { try { o.remove(); } catch (e) { } }, 300);
        }
      } catch (e) { /* no-op */ }
    });
  </script>
  <script src="assets/js/permissions.js"></script>
  <script src="assets/js/translations.js"></script>
  <script src="assets/js/day-greetings.js"></script>
  <script src="assets/js/account-tooltip.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      if (window.translationManager) {
        try {
          if (!window.translationManager.isInitialized && window.translationManager.init) {
            await window.translationManager.init();
          }
          if (window.translationManager.applyTranslations) {
            window.translationManager.applyTranslations();
          }
        } catch (e) {
          console.error('[Dashboard] Translation error:', e);
        }
      }
    });

    window.addEventListener('storage', async (evt) => {
      if (evt.key === 'eu2k_language' && window.translationManager) {
        try {
          await window.translationManager.switchLanguage(evt.newValue || 'hu');
          window.translationManager.applyTranslations?.();
        } catch (e) {
          console.error('[Dashboard] Storage translation error:', e);
        }
      }
    });
  </script>
  <script src="assets/js/auth-state.js"></script>
  <script src="assets/js/test_firebase.js" type="module"></script>
  <script src="assets/js/firebase-performance.js" type="module"></script>
  <script src="assets/js/youhub-notification-toaster.js" type="module"></script>
  <script src="assets/js/first-input-delay.js"></script>

  <script type="text/javascript" data-gdpr-required>
    (function (c, l, a, r, i, t, y) {
      c[a] = c[a] || function () { (c[a].q = c[a].q || []).push(arguments) };
      t = l.createElement(r); t.async = 1; t.src = "https://www.clarity.ms/tag/" + i;
      y = l.getElementsByTagName(r)[0]; y.parentNode.insertBefore(t, y);
    })(window, document, "clarity", "script", "s6n7qpfkv4");
  </script>
  <script type="importmap">
    {
      "imports": {
        "@material/web/": "https://esm.run/@material/web/"
      }
    }
  </script>
  <script type="module">
    import '@material/web/all.js';
    import { styles as typescaleStyles } from '@material/web/typography/md-typescale-styles.js';

    document.adoptedStyleSheets.push(typescaleStyles.styleSheet);
  </script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-analytics.js";
    import { getFirestore } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
    import { getStorage } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-storage.js";
    import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-functions.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBRRVx6BtQtCDKjFYA8yh9qYrcUONmkkwI",
      authDomain: "eu2k-hub.firebaseapp.com",
      projectId: "eu2k-hub",
      storageBucket: "eu2k-hub.firebasestorage.app",
      messagingSenderId: "560244867055",
      appId: "1:560244867055:web:3cd51b85baead94989001a",
      measurementId: "G-2JDPR089WD"
    };

    const app = initializeApp(firebaseConfig);
    let analytics = null;
    if (window.eu2kGDPR && window.eu2kGDPR.hasConsent()) {
      analytics = getAnalytics(app);
    } else {
      window.addEventListener('eu2k-gdpr-scripts-loaded', () => {
        if (!analytics) {
          analytics = getAnalytics(app);
        }
      });
    }
    const db = getFirestore(app);
    const storage = getStorage(app);
    const functions = getFunctions(app, 'europe-west1');

    window.firebaseApp = app;
    window.app = app;
    window.db = db;
    window.functions = functions;
    window.createHttpsCallable = (name) => httpsCallable(functions, name);
    window.storage = storage;

    // Helper for monolithic Calendar API calls
    window.calendarApiCall = async function (action, data = {}) {
      const { getFunctions, httpsCallable } = await import('https://www.gstatic.com/firebasejs/11.10.0/firebase-functions.js');
      const calFunctions = getFunctions(window.firebaseApp || window.app, 'europe-west3');
      const calendarApi = httpsCallable(calFunctions, 'calendarApi');
      return calendarApi({ action, ...data });
    };

    window.addEventListener("load", () => {
      try {
        const INFO_BANNER_KEY = 'eu2k-hide-info-banner';
        const banner = document.querySelector('.info-banner');
        try { if (localStorage.getItem(INFO_BANNER_KEY) === null) localStorage.setItem(INFO_BANNER_KEY, 'false'); } catch (_) { }

        try {
          if (localStorage.getItem(INFO_BANNER_KEY) === 'true' && banner) {
            banner.style.setProperty('display', 'none', 'important');
            try { window.dispatchEvent(new Event('eu2k-banner-visibility-changed')); } catch (_) { }
          }
        } catch (_) { }

        document.addEventListener('click', (e) => {
          const target = e.target && e.target.closest ? e.target.closest('.info-banner .banner-btn') : null;
          if (!target) return;
          e.preventDefault();
          e.stopPropagation();
          const isPrimary = target.classList.contains('primary');
          const isSecondary = target.classList.contains('secondary');
          if (isPrimary) {
            try { localStorage.setItem(INFO_BANNER_KEY, 'true'); } catch (err) { }
            const b = document.querySelector('.info-banner');
            if (b) { b.style.setProperty('display', 'none', 'important'); }
            try { window.dispatchEvent(new Event('eu2k-banner-visibility-changed')); } catch (_) { }
            return false;
          }
          if (isSecondary) {
            try { window.open('#feedback', '_blank'); } catch (err) { }
            return false;
          }
        }, true);
      } catch (e) { }

      try {
        const WARNING_BANNER_KEY = 'eu2k-hide-dashboard-warning-banner';
        const warningBanner = document.querySelector('.warning-banner');
        try { if (localStorage.getItem(WARNING_BANNER_KEY) === null) localStorage.setItem(WARNING_BANNER_KEY, 'false'); } catch (_) { }

        try {
          if (localStorage.getItem(WARNING_BANNER_KEY) === 'true' && warningBanner) {
            warningBanner.style.setProperty('display', 'none', 'important');
          }
        } catch (_) { }

        document.addEventListener('click', (e) => {
          const target = e.target && e.target.closest ? e.target.closest('.warning-banner .banner-btn-single') : null;
          if (!target) return;
          e.preventDefault();
          e.stopPropagation();
          try { localStorage.setItem(WARNING_BANNER_KEY, 'true'); } catch (err) { }
          const b = document.querySelector('.warning-banner');
          if (b) { b.style.setProperty('display', 'none', 'important'); }
          return false;
        }, true);
      } catch (e) { }
    });
  </script>
  <script src="assets/components/language-dropdown.js" defer></script>
</head>

<body>
  <div class="app-bg">
    <aside class="sidebar" role="navigation" aria-label="Fő navigáció">
      <div class="nav-frame">
        <div class="nav-shell">
          <nav class="nav-rail">
            <a class="rail-item nav-btn" href="index.html">
              <div class="rail-icon">
                <img src="assets/navbar/home.svg" alt="Otthon" />
              </div>
              <span class="rail-label" data-translate="navigation.home">Otthon</span>
            </a>
            <a class="rail-item nav-btn" href="qr-code.html">
              <div class="rail-icon">
                <img src="assets/navbar/qr_code.svg" alt="QR-Kód" />
              </div>
              <span class="rail-label" data-translate="navigation.qr">QR-Kód</span>
            </a>
            <a class="rail-item nav-btn" href="youhub.html">
              <div class="rail-icon">
                <img src="assets/navbar/youhub.svg" alt="YouHub" />
              </div>
              <span class="rail-label" data-translate="navigation.youhub">YouHub</span>
            </a>
          </nav>
        </div>
      </div>
    </aside>

    <main class="main-area">
      <div class="main-scroll-area">
        <header class="header">
          <div class="header-content">
            <div class="welcome-container">
              <img src="assets/navbar/dashboard.svg" class="welcome-icon" alt="Dashboard">
              <span class="welcome-text" id="dashboardPageTitle"
                data-translate="pages.dashboard.heading">Kezelőpult</span>
            </div>
            <div class="header-icon-container">
              <div class="header-icon-gradient">
                <div class="header-icon-wrapper" id="headerSettingsWrapper">
                  <a href="settings.html" class="header-icon-btn" id="headerSettingsBtn">
                    <img src="assets/general/settings.svg" alt="Settings">
                  </a>
                </div>
                <div class="header-icon-wrapper" id="headerAccountWrapper" style="display: none;">
                  <button class="header-icon-btn" id="headerAccountBtn">
                    <img src="assets/general/account.svg" alt="Account">
                  </button>
                </div>
                <button class="header-login-btn" id="headerLoginBtn" data-translate="pages.general.login"
                  style="display: none;">
                  Bejelentkezés
                </button>
              </div>
            </div>
          </div>

          <section class="info-banner" aria-label="Információ">
            <div class="info-banner-icon-container">
              <img class="info-banner-icon" src="assets/general/banners/info.svg" alt="Info" />
            </div>
            <div class="banner-content">
              <div class="banner-texts">
                <span class="info-banner-title" data-translate="pages.index.banner.title">Ez az új dizájn.</span>
                <span class="info-banner-desc" data-translate="pages.index.banner.description">Reméljük neked is tetszik
                  az Európa Dizájn Rendszer. Ha bármi kétséged van, jelezz vissza, akár innen is.</span>
              </div>
              <div class="banner-actions-wrapper">
                <div class="banner-actions">
                  <button class="banner-btn secondary" type="button"
                    data-translate="pages.index.banner.feedback">Visszajelzés</button>
                  <button class="banner-btn primary" type="button"
                    data-translate="pages.index.banner.close">Bezárás</button>
                </div>
              </div>
            </div>
          </section>

          <section class="warning-banner" aria-label="Figyelmeztetés">
            <div class="warning-banner-icon-container">
              <img class="warning-banner-icon" src="assets/general/banners/info_md.svg" alt="Warning" />
            </div>
            <div class="banner-content">
              <div class="banner-texts">
                <span class="warning-banner-title" data-translate="pages.dashboard.beta_banner.title">A Kezelőpult a
                  bétaverzió elején hiányos lehet.</span>
                <span class="warning-banner-desc" data-translate="pages.dashboard.beta_banner.description">A Kezelőpult
                  funkciói a bétaverzióban hiányosak. További részei a teljes kiadásban lesznek jelen.</span>
              </div>
              <div class="banner-actions-wrapper">
                <div class="banner-actions-single">
                  <button class="banner-btn-warning primary" type="button" data-translate="common.ok">Rendben</button>
                </div>
              </div>
            </div>
          </section>
        </header>

        <div class="main-content">
          <!-- Main Dashboard Page -->
          <div id="main-page" class="dashboard-page active">
            <div class="qr-controls-container">
              <span class="qr-controls-title" data-translate="pages.dashboard.quick_commands">Gyorsparancsok</span>
              <div class="qr-controls-row qr-controls-2x2">
                <!-- Column 1 -->
                <div class="qr-buttons-column">
                  <button class="qr-control-btn qr-btn-green qr-btn-participation" onclick="openSuggestionCenter()" style="opacity: 0.5; pointer-events: none;">
                    <img src="assets/dashboard/suggestion-center.svg" class="qr-control-icon" alt="Javaslat-központ">
                    <span data-translate="pages.dashboard.suggestion_center">Javaslat-központ</span>
                  </button>
                  <button class="qr-control-btn qr-btn-blue qr-btn-restart" onclick="openNotificationCenter()" style="opacity: 0.5; pointer-events: none;">
                    <img src="assets/dashboard/notification-center.svg" class="qr-control-icon" alt="Értesítésközpont">
                    <span data-translate="pages.dashboard.notification_center">Értesítésközpont</span>
                  </button>
                </div>
                <!-- Column 2 -->
                <div class="qr-buttons-column">
                  <button class="qr-control-btn qr-btn-blue qr-btn-publish" onclick="openPublish()">
                    <img src="assets/dashboard/publish_blue.svg" class="qr-control-icon" alt="Publikálás">
                    <span data-translate="pages.dashboard.publish">Publikálás</span>
                  </button>
                  <button class="qr-control-btn qr-btn-green qr-btn-calendar" onclick="openCalendarManager()">
                    <img src="assets/youhub/calendar/calendar_dark.svg" class="qr-control-icon" alt="Naptárak kezelése">
                    <span data-translate="pages.dashboard.manage_calendars"
                      data-translate-fallback="Naptárak kezelése">Naptárak kezelése</span>
                  </button>
                </div>
              </div>
              <div class="qr-controls-row qr-controls-single">
                <button class="qr-control-btn qr-btn-green qr-btn-myclass" onclick="openManageMyClass()">
                  <span class="qr-control-icon masked-students-icon" aria-hidden="true"></span>
                  <span data-translate="pages.dashboard.manage_myclass" data-translate-fallback="Osztályom kezelése">Osztályom kezelése</span>
                </button>
              </div>
            </div>
          </div>

          <!-- Publish Page -->
          <div id="publish-page" class="dashboard-page">
            <!-- Initial view: type selection -->
            <div id="publish-type-selection" class="publish-container">
              <span class="publish-title" data-translate="pages.dashboard.publish">Publikálás</span>
              <span class="publish-subtitle" data-translate="pages.dashboard.select_type">Válaszd ki a típusát</span>
              <div class="publish-buttons-container">
                <!-- Hír: Green, Fill -->
                <button class="publish-btn publish-btn-news" data-translate="pages.dashboard.news"
                  onclick="showNewsPublishForm()">Hír</button>
                <!-- Esemény: Blue, Hug -->
                <button class="publish-btn publish-btn-event" data-translate="pages.dashboard.event"
                  onclick="publishEvent()">Esemény</button>
              </div>
            </div>

            <!-- News publish form -->
            <div id="news-publish-form" class="news-publish-form" style="display: none;">
              <button class="header-edit-mode-btn" onclick="hideNewsPublishForm()">
                <img src="assets/onboarding/back_arrow.svg" alt="Vissza">
                <span data-translate="pages.settings.back">Vissza</span>
              </button>

              <h2 class="news-publish-form-title" data-translate="pages.dashboard.news_publish.title">Hír Publikálása
              </h2>
              <p class="news-publish-form-subtitle" data-translate="pages.dashboard.news_publish.subtitle">Kérlek tölts
                ki minden mezőt :)</p>

              <div class="news-publish-row">
                <!-- Left: 4 inputs -->
                <div class="news-inputs-column">
                  <div class="news-input-group">
                    <label class="news-input-label" data-translate="pages.dashboard.news_publish.title_label">Hír
                      címe</label>
                    <input type="text" id="newsTitle" class="news-input" placeholder="Value" maxlength="120">
                  </div>
                  <div class="news-input-group">
                    <label class="news-input-label" data-translate="pages.dashboard.news_publish.link_label">Hír
                      linkje</label>
                    <input type="url" id="newsLink" class="news-input" placeholder="Value">
                  </div>
                  <div class="news-input-group">
                    <label class="news-input-label" data-translate="pages.dashboard.news_publish.author_label">Hír
                      szerzője</label>
                    <input type="text" id="newsAuthor" class="news-input" placeholder="Value">
                  </div>
                  <div class="news-input-group">
                    <label class="news-input-label" data-translate="pages.dashboard.news_publish.date_label">Kiadási
                      dátum (mai napért hagyd üresen)</label>
                    <input type="date" id="newsDate" class="news-input">
                  </div>
                </div>

                <!-- Middle: textarea -->
                <div class="news-content-container">
                  <label class="news-input-label" data-translate="pages.dashboard.news_publish.content_label">Hír
                    Leírása</label>
                  <textarea id="newsContent" class="news-content-textarea" placeholder="Value"></textarea>
                </div>

                <!-- Divider -->
                <div class="news-divider"></div>

                <!-- Preview card + upload -->
                <div class="news-preview-container">
                  <div class="news-preview-card">
                    <img id="newsPreviewImage" class="news-preview-card-bg"
                      src="assets/general/image_placeholder_blue.svg" alt="Előnézet">
                  </div>
                  <button class="news-upload-btn" onclick="triggerNewsImageUpload()"
                    data-translate="pages.dashboard.news_publish.upload_image">Kép feltöltése</button>
                  <input type="file" id="newsImageInput" class="news-file-input" accept="image/*">
                </div>

                <!-- Divider -->
                <div class="news-divider"></div>

                <!-- Publish button -->
                <div class="news-publish-btn-container">
                  <button id="newsPublishBtn" class="news-publish-btn" onclick="submitNewsPublish()"
                    data-translate="pages.dashboard.news_publish.publish">Publikálás</button>
                </div>
              </div>
            </div>
          </div>

          <!-- News publish loading popup -->
          <div id="newsPublishPopup" class="news-publish-popup">
            <div class="news-publish-popup-content">
              <h3 class="news-publish-popup-title" data-translate="pages.dashboard.news_publish.loading_title">Hír
                publikálása folyamatban</h3>
              <p class="news-publish-popup-subtitle" data-translate="pages.dashboard.news_publish.loading_subtitle">
                Kérjük ne zárd be ezt az oldalt!</p>
              <div class="news-publish-loader"></div>
            </div>
          </div>

          <!-- Event publish form -->
          <div id="event-publish-form" class="news-publish-form event-publish-form" style="display: none;">
            <button class="header-edit-mode-btn" onclick="hideEventPublishForm()">
              <img src="assets/onboarding/back_arrow.svg" alt="Vissza">
              <span data-translate="pages.settings.back">Vissza</span>
            </button>

            <h2 class="news-publish-form-title" data-translate="pages.dashboard.event_publish.title">Esemény Publikálása
            </h2>
            <p class="news-publish-form-subtitle" data-translate="pages.dashboard.event_publish.subtitle">Kérlek tölts
              ki minden mezőt :)</p>

            <div class="news-publish-row">
              <!-- Left: 5 inputs -->
              <div class="news-inputs-column event-inputs-column">
                <div class="news-input-group">
                  <label class="news-input-label" data-translate="pages.dashboard.event_publish.title_label">Esemény
                    címe</label>
                  <input type="text" id="eventTitle" class="news-input" placeholder="Value" maxlength="120">
                </div>
                <div class="news-input-group">
                  <label class="news-input-label" data-translate="pages.dashboard.event_publish.link_label">Esemény
                    linkje</label>
                  <input type="url" id="eventLink" class="news-input" placeholder="Value">
                </div>
                <div class="news-input-group">
                  <label class="news-input-label" data-translate="pages.dashboard.event_publish.place_label">Esemény
                    helye</label>
                  <input type="text" id="eventPlace" class="news-input" placeholder="Value">
                </div>
                <div class="news-input-group">
                  <label class="news-input-label" data-translate="pages.dashboard.event_publish.date_from_label">Esemény
                    kezdődátuma</label>
                  <input type="date" id="eventDateFrom" class="news-input">
                </div>
                <div class="news-input-group">
                  <label class="news-input-label" data-translate="pages.dashboard.event_publish.date_to_label">Esemény
                    befejező dátuma (egynapos eseményeknél a kezdődátumot írd ide is)</label>
                  <input type="date" id="eventDateTo" class="news-input">
                </div>
              </div>

              <!-- Middle: textarea -->
              <div class="news-content-container">
                <label class="news-input-label" data-translate="pages.dashboard.event_publish.description_label">Esemény
                  Leírása</label>
                <textarea id="eventDescription" class="news-content-textarea" placeholder="Value"></textarea>
              </div>

              <!-- Divider -->
              <div class="news-divider"></div>

              <!-- Preview card + upload -->
              <div class="news-preview-container">
                <div class="news-preview-card">
                  <img id="eventPreviewImage" class="news-preview-card-bg"
                    src="assets/general/image_placeholder_blue.svg" alt="Előnézet">
                </div>
                <button class="news-upload-btn" onclick="triggerEventImageUpload()"
                  data-translate="pages.dashboard.event_publish.upload_image">Kép feltöltése</button>
                <input type="file" id="eventImageInput" class="news-file-input" accept="image/*">
              </div>

              <!-- Divider -->
              <div class="news-divider"></div>

              <!-- Publish button -->
              <div class="news-publish-btn-container">
                <button id="eventPublishBtn" class="news-publish-btn" onclick="submitEventPublish()"
                  data-translate="pages.dashboard.event_publish.publish">Publikálás</button>
              </div>
            </div>
          </div>

          <!-- Event publish loading popup -->
          <div id="eventPublishPopup" class="news-publish-popup">
            <div class="news-publish-popup-content">
              <h3 class="news-publish-popup-title" data-translate="pages.dashboard.event_publish.loading_title">Esemény
                publikálása folyamatban</h3>
              <p class="news-publish-popup-subtitle" data-translate="pages.dashboard.event_publish.loading_subtitle">
                Kérjük ne zárd be ezt az oldalt!</p>
              <div class="news-publish-loader"></div>
            </div>
          </div>

          <!-- ============================================ -->
          <!-- CALENDAR ASSIGNMENT SECTION                  -->
          <!-- ============================================ -->

          <!-- ============================================ -->
          <!-- MANAGE CALENDARS PAGE                        -->
          <!-- ============================================ -->
          <div id="manage-calendars-page" class="dashboard-page" style="display: none;">
            <div class="manage-calendars-container">
              <!-- Top dropdowns row -->
              <div class="manage-calendars-dropdowns">
                <div class="manage-calendars-dropdown-group">
                  <label class="manage-calendars-label" data-translate="pages.dashboard.manage_calendars.select_class">Válassz osztályt</label>
                  <div id="manageCalendarsClassDropdown" class="language-dropdown"></div>
                </div>
                <div class="manage-calendars-dropdown-group">
                  <label class="manage-calendars-label" data-translate="pages.dashboard.manage_calendars.select_calendar_type">Válassz naptártípust</label>
                  <div id="manageCalendarsTypeDropdown" class="language-dropdown"></div>
                </div>
              </div>

              <!-- Main content area -->
              <div class="manage-calendars-card">
                <div class="manage-calendars-middle-section">
                  <!-- Top blur gradient -->
                  <div class="manage-calendars-fade manage-calendars-fade--top">
                    <div class="manage-calendars-date-bar" id="manageCalendarsDateBar">
                      <div class="manage-calendars-date-bar-scroll" id="manageCalendarsDateBarScroll">
                        <!-- Date items will be generated by JavaScript -->
                      </div>
                    </div>
                  </div>
                  
                  <!-- Lesson cards container -->
                  <div class="manage-calendars-column">
                    <div class="manage-calendars-cards-container">
                      <!-- Empty state -->
                          <div class="manage-calendars-empty-state" id="manageCalendarsEmptyState">
                            <img src="assets/youhub/myclass/class.svg" alt="Válassz osztályt" class="manage-calendars-empty-icon">
                        <div class="manage-calendars-empty-text-container">
                          <p class="manage-calendars-empty-title" data-translate="pages.dashboard.manage_calendars.select_class_prompt">Válassz ki egy osztályt</p>
                          <p class="manage-calendars-empty-subtitle" data-translate="pages.dashboard.manage_calendars.select_class_hint">A fenti legördülő menüből</p>
                        </div>
                      </div>
                      <!-- Lesson cards will be added here by JavaScript -->
                    </div>
                  </div>

                  <!-- Bottom blur with add button -->
                      <div class="manage-calendars-fade manage-calendars-fade--bottom">
                        <div class="calendar-add-lesson-container manage-calendars-add-container">
                          <button class="calendar-assign-btn calendar-assign-btn-back manage-calendars-back-btn" onclick="calendarAssignBack()">
                            <img src="assets/onboarding/back_arrow.svg" alt="Vissza">
                          </button>
                          <button class="calendar-add-lesson-btn" onclick="manageCalendarsAddLesson()">
                            <span id="manageCalendarsAddLessonText" data-translate="pages.dashboard.assign_calendars.add_lesson">Óra hozzáadása</span>
                          </button>
                        </div>
                      </div>
                </div>
              </div>
            </div>
          </div>

          <!-- ============================================ -->
          <!-- MANAGE MY CLASS PAGE                         -->
          <!-- ============================================ -->
          <div id="manage-myclass-page" class="dashboard-page" style="display: none;">
            <div class="manage-myclass-container">
              <div class="qr-controls-container manage-myclass-card">
                <span class="qr-controls-title" data-translate="pages.dashboard.manage_myclass.title" data-translate-fallback="Osztályom kezelése">Osztályom kezelése</span>
                <div class="qr-controls-row qr-controls-single">
                  <button class="qr-control-btn qr-btn-green manage-myclass-access-btn" onclick="openManageMyClassAccessPopup()">
                    <span class="qr-control-icon masked-students-icon" aria-hidden="true"></span>
                    <span data-translate="pages.dashboard.manage_myclass.grant_access" data-translate-fallback="Hozzáférés engedélyezése tanároknak az osztályomhoz">Hozzáférés engedélyezése tanároknak az osztályomhoz</span>
                  </button>
                </div>
                <button class="calendar-assign-btn calendar-assign-btn-back manage-myclass-back-btn" onclick="calendarAssignBack()">
                  <img src="assets/onboarding/back_arrow.svg" alt="Vissza">
                </button>
              </div>
            </div>
          </div>

          <!-- Calendar Assignment Page - Step 1: Class & Process Selection -->
          <div id="calendar-assign-page" class="dashboard-page">
            <div id="calendar-assign-selection" class="calendar-assign-container">
              <span class="calendar-assign-title" data-translate="pages.dashboard.assign_calendars.title">Naptárak
                hozzárendelése</span>
              <span class="calendar-assign-subtitle" data-translate="pages.dashboard.assign_calendars.subtitle">Válaszd
                ki az osztályt és a folyamatot</span>

              <div class="calendar-assign-dropdowns">
                <!-- Class Dropdown -->
                <div class="calendar-assign-dropdown-group">
                  <label class="calendar-assign-label"
                    data-translate="pages.dashboard.assign_calendars.class_label">Osztály</label>
                  <div id="calendarClassDropdown" class="language-dropdown"></div>
                </div>

                <!-- Process Dropdown -->
                <div class="calendar-assign-dropdown-group">
                  <label class="calendar-assign-label"
                    data-translate="pages.dashboard.assign_calendars.process_label">Hozzárendelési folyamat</label>
                  <div id="calendarProcessDropdown" class="language-dropdown"></div>
                </div>
              </div>

              <!-- Navigation Buttons -->
              <div class="calendar-assign-nav-buttons">
                <button class="calendar-assign-btn calendar-assign-btn-back" onclick="calendarAssignBack()">
                  <img src="assets/onboarding/back_arrow.svg" alt="Vissza">
                </button>
                <button class="calendar-assign-btn calendar-assign-btn-next" id="calendarStep1Next"
                  onclick="calendarSelectTime()" disabled>
                  <span data-translate="common.next">Tovább</span>
                </button>
              </div>
            </div>
          </div>

          <!-- Calendar Assignment Page - Step 2: Select Time -->
          <div id="calendar-select-time-page" class="dashboard-page" style="display: none;">
            <div class="calendar-assign-container">
              <span class="calendar-assign-title" data-translate="pages.dashboard.assign_calendars.select_time">Válassz
                időpontot</span>
              <span class="calendar-assign-subtitle" id="calendarSelectTimeSubtitle"></span>

              <div class="calendar-assign-dropdowns">
                <!-- Day Dropdown -->
                <div class="calendar-assign-dropdown-group">
                  <label class="calendar-assign-label" data-translate="pages.dashboard.assign_calendars.day">Nap</label>
                  <div id="calendarDayDropdown" class="language-dropdown"></div>
                </div>

                <!-- Hour Dropdown -->
                <div class="calendar-assign-dropdown-group">
                  <label class="calendar-assign-label"
                    data-translate="pages.dashboard.assign_calendars.hour">Óra</label>
                  <div id="calendarHourDropdown" class="language-dropdown"></div>
                </div>
              </div>

              <!-- Navigation Buttons -->
              <div class="calendar-assign-nav-buttons calendar-assign-nav-3btn">
                <button class="calendar-assign-btn calendar-assign-btn-back" onclick="calendarBackToStep1()">
                  <img src="assets/onboarding/back_arrow.svg" alt="Vissza">
                </button>
                <div class="calendar-assign-right-buttons">
                  <button class="calendar-assign-btn calendar-assign-btn-next" id="calendarStep2Next"
                    onclick="calendarGoToStep3()" disabled>
                    <span data-translate="common.next">Tovább</span>
                  </button>
                  <button class="calendar-assign-btn calendar-assign-btn-variation" id="calendarVariationBtn"
                    onclick="calendarAddVariation()" disabled>
                    <span data-translate="pages.dashboard.assign_calendars.add_variation">Variáció hozzáadása</span>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Calendar Assignment Page - Step 3: Schedule Assignment -->
          <div id="calendar-schedule-assign-page" class="dashboard-page" style="display: none;">
            <div class="calendar-assign-container">
              <span class="calendar-assign-title" id="calendarScheduleTitle"
                data-translate="pages.dashboard.assign_calendars.schedule_assign">Órarend hozzárendelése</span>
              <span class="calendar-assign-subtitle" id="calendarScheduleSubtitle"></span>

              <div class="calendar-assign-inputs">
                <!-- Lesson Type Dropdown -->
                <div class="calendar-assign-dropdown-group">
                  <label class="calendar-assign-label" data-translate="pages.dashboard.assign_calendars.lesson_type">Óra
                    típusa</label>
                  <div id="calendarLessonTypeDropdown" class="language-dropdown"></div>
                </div>

                <!-- Teacher Dropdown -->
                <div class="calendar-assign-dropdown-group">
                  <label class="calendar-assign-label"
                    data-translate="pages.dashboard.assign_calendars.teacher_name">Szaktanár neve</label>
                  <div class="calendar-teacher-row">
                    <div id="calendarTeacherDropdown" class="language-dropdown"></div>
                    <button id="calendarAddTeacherBtn" class="calendar-add-teacher-btn"
                      onclick="calendarShowSplitTeacher()">
                      <span data-translate="pages.dashboard.assign_calendars.add_another_teacher">Másik szaktanár
                        hozzáadása</span>
                    </button>
                  </div>
                </div>

                <!-- Split Class Container (Teacher 2 + Student Group) -->
                <div id="calendarSplitContainer" class="calendar-split-container" style="display: none;">
                  <div class="calendar-assign-dropdown-group">
                    <label class="calendar-assign-label"
                      data-translate="pages.dashboard.assign_calendars.teacher_name">Másik szaktanár</label>
                    <div id="calendarTeacher2Dropdown" class="language-dropdown"></div>
                  </div>
                  <div class="calendar-assign-dropdown-group">
                    <label class="calendar-assign-label"
                      data-translate="pages.dashboard.assign_calendars.student_group">Diákcsoport kiválasztása</label>
                    <div class="calendar-student-search-wrapper">
                      <div id="calendarStudentGhost" class="ghost-text"></div>
                      <input type="text" id="calendarStudentSearchInput" class="calendar-student-search-input"
                        placeholder="Keresés..." autocomplete="off">
                    </div>
                  </div>
                </div>

                <!-- Timeline Input -->
                <div class="calendar-assign-dropdown-group">
                  <label class="calendar-assign-label"
                    data-translate="pages.dashboard.assign_calendars.timeline">Idővonal</label>
                  <div class="calendar-timeline-input-group">
                    <input type="text" id="calendarTimelineStart" class="calendar-timeline-input" placeholder="00:00"
                      maxlength="5">
                    <span class="calendar-timeline-separator">-</span>
                    <input type="text" id="calendarTimelineEnd" class="calendar-timeline-input" placeholder="00:00"
                      maxlength="5" readonly>
                  </div>
                </div>

                <!-- Place Dropdown -->
                <div class="calendar-assign-dropdown-group" style="position: relative; z-index: 10;">
                  <label class="calendar-assign-label"
                    data-translate="pages.dashboard.assign_calendars.place">Helyszín</label>
                  <div id="calendarPlaceDropdown" class="language-dropdown"></div>
                </div>
              </div>

              <!-- Optional Lesson Toggle -->
              <div class="calendar-assign-dropdown-group">
                <div class="suggestions-checkbox suggestions-checkbox--with-switch">
                  <div class="suggestions-checkbox-text">
                    <span class="suggestions-checkbox-title"
                      data-translate="pages.dashboard.assign_calendars.optional_lesson_title"
                      data-translate-fallback="Változtasd meg opcionális óra-ára">Változtasd meg opcionális óra-ára</span>
                    <p class="suggestions-checkbox-desc"
                      data-translate="pages.dashboard.assign_calendars.optional_lesson_description"
                      data-translate-fallback="A következő lépésben ha szeretnél hozzárendelhetsz egyes diákokat, hogy jelezd nekik, kötelező ez az óra számukra.">
                      A következő lépésben ha szeretnél hozzárendelhetsz egyes diákokat, hogy jelezd nekik, kötelező ez az óra számukra.</p>
                  </div>
                  <md-switch icon class="calendar-optional-lesson-switch" icons
                    aria-label="Opcionális óra">
                  </md-switch>
                </div>
              </div>

              <!-- Navigation Buttons -->
              <div class="calendar-assign-nav-buttons">
                <button class="calendar-assign-btn calendar-assign-btn-back" onclick="calendarBackToStep2()">
                  <img src="assets/onboarding/back_arrow.svg" alt="Vissza">
                </button>
                <button class="calendar-assign-btn calendar-assign-btn-next" id="calendarStep3Next"
                  onclick="console.log('[Calendar] Next button clicked'); calendarShowLessons()" disabled>
                  <span data-translate="common.next">Tovább</span>
                </button>
              </div>
            </div>
          </div>

          <!-- Calendar Assignment Page - Step 3b: Exam Assignment -->
          <div id="calendar-exam-assign-page" class="dashboard-page" style="display: none;">
            <div class="calendar-assign-container">
              <span class="calendar-assign-title" id="calendarExamTitle">Dolgozat bejelentése</span>
              <span class="calendar-assign-subtitle" id="calendarExamSubtitle"></span>

              <div class="calendar-assign-inputs">
                <!-- Lesson Type Dropdown (Hozzárendelés órához) -->
                <div class="calendar-assign-dropdown-group">
                  <label class="calendar-assign-label">Hozzárendelés órához</label>
                  <div id="calendarExamLessonTypeDropdown" class="language-dropdown"></div>
                </div>

                <!-- Exam Type Dropdown (Dolgozat típusa) -->
                <div class="calendar-assign-dropdown-group">
                  <label class="calendar-assign-label">Dolgozat típusa</label>
                  <div id="calendarExamTypeDropdown" class="language-dropdown"></div>
                </div>

                <!-- Exam Date Input -->
                <div class="calendar-assign-dropdown-group">
                  <label class="calendar-assign-label">Dolgozat dátuma</label>
                  <input type="date" id="calendarExamDate" class="calendar-date-input">
                </div>
              </div>

              <!-- Navigation Buttons -->
              <div class="calendar-assign-nav-buttons">
                <button class="calendar-assign-btn calendar-assign-btn-back" onclick="calendarBackToStep2()">
                  <img src="assets/onboarding/back_arrow.svg" alt="Vissza">
                </button>
                <button class="calendar-assign-btn calendar-assign-btn-next" id="calendarExamNext"
                  onclick="calendarPublishExam()" disabled>
                  <span>Publikálás</span>
                </button>
              </div>
            </div>
          </div>

          <!-- Calendar Assignment Page - Step 4: Lessons View -->
          <div id="calendar-lessons-page" class="dashboard-page" style="display: none;">
            <div class="calendar-assign-container calendar-lessons-container">
              <div class="calendar-lessons-header"
                style="display: flex; align-items: center; justify-content: space-between; width: 100%; margin-bottom: 16px;">
                <span class="calendar-assign-title" id="calendarLessonsTitle" style="margin: 0;">Órák - Hétfő</span>
                <div id="calendarModifiedDaysDropdown" class="calendar-modified-days-dropdown"
                  style="display: none; min-width: 150px;"></div>
              </div>

              <!-- Lesson Cards Wrapper -->
              <div class="calendar-lessons-wrapper">
                <div class="calendar-lessons-scroll" id="calendarLessonsScroll">
                  <!-- 0. óra Card -->
                  <div class="calendar-lesson-card" data-lesson="0">
                    <span class="calendar-lesson-number">0. óra</span>
                    <span class="calendar-lesson-optional-indicator" style="display: none;">?</span>
                    <span class="calendar-lesson-info"><span
                        data-translate="pages.dashboard.assign_calendars.lesson_type">Óra típusa</span>: <span
                        class="lesson-type-value">-</span></span>
                    <span class="calendar-lesson-info"><span
                        data-translate="pages.dashboard.assign_calendars.teacher_name">Szaktanár</span>: <span
                        class="lesson-teacher-value">-</span></span>
                    <span class="calendar-lesson-info"><span
                        data-translate="pages.dashboard.assign_calendars.place">Helyszín</span>: <span
                        class="lesson-place-value">-</span></span>
                    <span class="calendar-lesson-info"><span
                        data-translate="pages.dashboard.assign_calendars.timeline">Idővonal</span>: <span
                        class="lesson-timeline-value">-</span></span>
                    <span class="calendar-lesson-optional-row" style="display: none;">
                      <span data-translate="pages.dashboard.assign_calendars.optional_lesson_label">Opcionális:</span>
                      <span class="lesson-optional-students-value"></span>
                    </span>
                    <button class="calendar-lesson-delete-btn" onclick="event.stopPropagation(); deleteLessonCard(0)">
                      <img src="assets/youhub/notifications/trahscan_red.svg" alt="Törlés">
                    </button>
                  </div>
                  <!-- 1. óra Card -->
                  <div class="calendar-lesson-card" data-lesson="1">
                    <span class="calendar-lesson-number">1. óra</span>
                    <span class="calendar-lesson-optional-indicator" style="display: none;">?</span>
                    <span class="calendar-lesson-info"><span
                        data-translate="pages.dashboard.assign_calendars.lesson_type">Óra típusa</span>: <span
                        class="lesson-type-value">-</span></span>
                    <span class="calendar-lesson-info"><span
                        data-translate="pages.dashboard.assign_calendars.teacher_name">Szaktanár</span>: <span
                        class="lesson-teacher-value">-</span></span>
                    <span class="calendar-lesson-info"><span
                        data-translate="pages.dashboard.assign_calendars.place">Helyszín</span>: <span
                        class="lesson-place-value">-</span></span>
                    <span class="calendar-lesson-info"><span
                        data-translate="pages.dashboard.assign_calendars.timeline">Idővonal</span>: <span
                        class="lesson-timeline-value">-</span></span>
                    <span class="calendar-lesson-optional-row" style="display: none;">
                      <span data-translate="pages.dashboard.assign_calendars.optional_lesson_label">Opcionális:</span>
                      <span class="lesson-optional-students-value"></span>
                    </span>
                    <button class="calendar-lesson-delete-btn" onclick="event.stopPropagation(); deleteLessonCard(1)">
                      <img src="assets/youhub/notifications/trahscan_red.svg" alt="Törlés">
                    </button>
                  </div>
                  <div class="calendar-lesson-card" data-lesson="2">
                    <span class="calendar-lesson-number">2. óra</span>
                    <span class="calendar-lesson-optional-indicator" style="display: none;">?</span>
                    <span class="calendar-lesson-info"><span
                        data-translate="pages.dashboard.assign_calendars.lesson_type">Óra típusa</span>: <span
                        class="lesson-type-value">-</span></span>
                    <span class="calendar-lesson-info"><span
                        data-translate="pages.dashboard.assign_calendars.teacher_name">Szaktanár</span>: <span
                        class="lesson-teacher-value">-</span></span>
                    <span class="calendar-lesson-info"><span
                        data-translate="pages.dashboard.assign_calendars.place">Helyszín</span>: <span
                        class="lesson-place-value">-</span></span>
                    <span class="calendar-lesson-info"><span
                        data-translate="pages.dashboard.assign_calendars.timeline">Idővonal</span>: <span
                        class="lesson-timeline-value">-</span></span>
                    <span class="calendar-lesson-optional-row" style="display: none;">
                      <span data-translate="pages.dashboard.assign_calendars.optional_lesson_label">Opcionális:</span>
                      <span class="lesson-optional-students-value"></span>
                    </span>
                    <button class="calendar-lesson-delete-btn" onclick="deleteLessonCard(2)">
                      <img src="assets/youhub/notifications/trahscan_red.svg" alt="Törlés">
                    </button>
                  </div>
                  <div class="calendar-lesson-card" data-lesson="3">
                    <span class="calendar-lesson-number">3. óra</span>
                    <span class="calendar-lesson-optional-indicator" style="display: none;">?</span>
                    <span class="calendar-lesson-info"><span
                        data-translate="pages.dashboard.assign_calendars.lesson_type">Óra típusa</span>: <span
                        class="lesson-type-value">-</span></span>
                    <span class="calendar-lesson-info"><span
                        data-translate="pages.dashboard.assign_calendars.teacher_name">Szaktanár</span>: <span
                        class="lesson-teacher-value">-</span></span>
                    <span class="calendar-lesson-info"><span
                        data-translate="pages.dashboard.assign_calendars.place">Helyszín</span>: <span
                        class="lesson-place-value">-</span></span>
                    <span class="calendar-lesson-info"><span
                        data-translate="pages.dashboard.assign_calendars.timeline">Idővonal</span>: <span
                        class="lesson-timeline-value">-</span></span>
                    <span class="calendar-lesson-optional-row" style="display: none;">
                      <span data-translate="pages.dashboard.assign_calendars.optional_lesson_label">Opcionális:</span>
                      <span class="lesson-optional-students-value"></span>
                    </span>
                    <button class="calendar-lesson-delete-btn" onclick="deleteLessonCard(3)">
                      <img src="assets/youhub/notifications/trahscan_red.svg" alt="Törlés">
                    </button>
                  </div>
                  <div class="calendar-lesson-card" data-lesson="4">
                    <span class="calendar-lesson-number">4. óra</span>
                    <span class="calendar-lesson-optional-indicator" style="display: none;">?</span>
                    <span class="calendar-lesson-info"><span
                        data-translate="pages.dashboard.assign_calendars.lesson_type">Óra típusa</span>: <span
                        class="lesson-type-value">-</span></span>
                    <span class="calendar-lesson-info"><span
                        data-translate="pages.dashboard.assign_calendars.teacher_name">Szaktanár</span>: <span
                        class="lesson-teacher-value">-</span></span>
                    <span class="calendar-lesson-info"><span
                        data-translate="pages.dashboard.assign_calendars.place">Helyszín</span>: <span
                        class="lesson-place-value">-</span></span>
                    <span class="calendar-lesson-info"><span
                        data-translate="pages.dashboard.assign_calendars.timeline">Idővonal</span>: <span
                        class="lesson-timeline-value">-</span></span>
                    <span class="calendar-lesson-optional-row" style="display: none;">
                      <span data-translate="pages.dashboard.assign_calendars.optional_lesson_label">Opcionális:</span>
                      <span class="lesson-optional-students-value"></span>
                    </span>
                    <button class="calendar-lesson-delete-btn" onclick="deleteLessonCard(4)">
                      <img src="assets/youhub/notifications/trahscan_red.svg" alt="Törlés">
                    </button>
                  </div>
                  <div class="calendar-lesson-card" data-lesson="5">
                    <span class="calendar-lesson-number">5. óra</span>
                    <span class="calendar-lesson-optional-indicator" style="display: none;">?</span>
                    <span class="calendar-lesson-info"><span
                        data-translate="pages.dashboard.assign_calendars.lesson_type">Óra típusa</span>: <span
                        class="lesson-type-value">-</span></span>
                    <span class="calendar-lesson-info"><span
                        data-translate="pages.dashboard.assign_calendars.teacher_name">Szaktanár</span>: <span
                        class="lesson-teacher-value">-</span></span>
                    <span class="calendar-lesson-info"><span
                        data-translate="pages.dashboard.assign_calendars.place">Helyszín</span>: <span
                        class="lesson-place-value">-</span></span>
                    <span class="calendar-lesson-info"><span
                        data-translate="pages.dashboard.assign_calendars.timeline">Idővonal</span>: <span
                        class="lesson-timeline-value">-</span></span>
                    <span class="calendar-lesson-optional-row" style="display: none;">
                      <span data-translate="pages.dashboard.assign_calendars.optional_lesson_label">Opcionális:</span>
                      <span class="lesson-optional-students-value"></span>
                    </span>
                    <button class="calendar-lesson-delete-btn" onclick="deleteLessonCard(5)">
                      <img src="assets/youhub/notifications/trahscan_red.svg" alt="Törlés">
                    </button>
                  </div>
                  <div class="calendar-lesson-card" data-lesson="6">
                    <span class="calendar-lesson-number">6. óra</span>
                    <span class="calendar-lesson-optional-indicator" style="display: none;">?</span>
                    <span class="calendar-lesson-info"><span
                        data-translate="pages.dashboard.assign_calendars.lesson_type">Óra típusa</span>: <span
                        class="lesson-type-value">-</span></span>
                    <span class="calendar-lesson-info"><span
                        data-translate="pages.dashboard.assign_calendars.teacher_name">Szaktanár</span>: <span
                        class="lesson-teacher-value">-</span></span>
                    <span class="calendar-lesson-info"><span
                        data-translate="pages.dashboard.assign_calendars.place">Helyszín</span>: <span
                        class="lesson-place-value">-</span></span>
                    <span class="calendar-lesson-info"><span
                        data-translate="pages.dashboard.assign_calendars.timeline">Idővonal</span>: <span
                        class="lesson-timeline-value">-</span></span>
                    <span class="calendar-lesson-optional-row" style="display: none;">
                      <span data-translate="pages.dashboard.assign_calendars.optional_lesson_label">Opcionális:</span>
                      <span class="lesson-optional-students-value"></span>
                    </span>
                    <button class="calendar-lesson-delete-btn" onclick="deleteLessonCard(6)">
                      <img src="assets/youhub/notifications/trahscan_red.svg" alt="Törlés">
                    </button>
                  </div>
                  <div class="calendar-lesson-card" data-lesson="7">
                    <span class="calendar-lesson-number">7. óra</span>
                    <span class="calendar-lesson-optional-indicator" style="display: none;">?</span>
                    <span class="calendar-lesson-info"><span
                        data-translate="pages.dashboard.assign_calendars.lesson_type">Óra típusa</span>: <span
                        class="lesson-type-value">-</span></span>
                    <span class="calendar-lesson-info"><span
                        data-translate="pages.dashboard.assign_calendars.teacher_name">Szaktanár</span>: <span
                        class="lesson-teacher-value">-</span></span>
                    <span class="calendar-lesson-info"><span
                        data-translate="pages.dashboard.assign_calendars.place">Helyszín</span>: <span
                        class="lesson-place-value">-</span></span>
                    <span class="calendar-lesson-info"><span
                        data-translate="pages.dashboard.assign_calendars.timeline">Idővonal</span>: <span
                        class="lesson-timeline-value">-</span></span>
                    <span class="calendar-lesson-optional-row" style="display: none;">
                      <span data-translate="pages.dashboard.assign_calendars.optional_lesson_label">Opcionális:</span>
                      <span class="lesson-optional-students-value"></span>
                    </span>
                    <button class="calendar-lesson-delete-btn" onclick="deleteLessonCard(7)">
                      <img src="assets/youhub/notifications/trahscan_red.svg" alt="Törlés">
                    </button>
                  </div>
                  <div class="calendar-lesson-card" data-lesson="8">
                    <span class="calendar-lesson-number">8. óra</span>
                    <span class="calendar-lesson-optional-indicator" style="display: none;">?</span>
                    <span class="calendar-lesson-info"><span
                        data-translate="pages.dashboard.assign_calendars.lesson_type">Óra típusa</span>: <span
                        class="lesson-type-value">-</span></span>
                    <span class="calendar-lesson-info"><span
                        data-translate="pages.dashboard.assign_calendars.teacher_name">Szaktanár</span>: <span
                        class="lesson-teacher-value">-</span></span>
                    <span class="calendar-lesson-info"><span
                        data-translate="pages.dashboard.assign_calendars.place">Helyszín</span>: <span
                        class="lesson-place-value">-</span></span>
                    <span class="calendar-lesson-info"><span
                        data-translate="pages.dashboard.assign_calendars.timeline">Idővonal</span>: <span
                        class="lesson-timeline-value">-</span></span>
                    <span class="calendar-lesson-optional-row" style="display: none;">
                      <span data-translate="pages.dashboard.assign_calendars.optional_lesson_label">Opcionális:</span>
                      <span class="lesson-optional-students-value"></span>
                    </span>
                    <button class="calendar-lesson-delete-btn" onclick="deleteLessonCard(8)">
                      <img src="assets/youhub/notifications/trahscan_red.svg" alt="Törlés">
                    </button>
                  </div>
                </div>

                <!-- Add Lesson Button (fixed right with blur) -->
                <div class="calendar-add-lesson-container">
                  <button class="calendar-add-lesson-btn" onclick="addLessonCard()">
                    <span data-translate="pages.dashboard.assign_calendars.add_lesson">Óra hozzáadása</span>
                  </button>
                </div>
              </div>

              <!-- Navigation Buttons -->
              <div class="calendar-assign-nav-buttons" style="justify-content: space-between;">
                <button class="calendar-assign-btn calendar-assign-btn-back" onclick="calendarBackToStep2()">
                  <img src="assets/onboarding/back_arrow.svg" alt="Vissza">
                  <span data-translate="common.back">Vissza</span>
                </button>

                <div style="display: flex; gap: 12px; align-items: center;">
                  <button class="calendar-assign-btn calendar-assign-btn-next" id="calendarStep4Next"
                    onclick="calendarApplyChanges()">
                    <span data-translate="common.next">Tovább</span>
                  </button>
                  <button class="calendar-assign-btn"
                    style="background: #FF8181; color: #210A0A; border: 1px solid #FF5555;"
                    onclick="openResetDayPopup()">
                    <img src="assets/youhub/notifications/trahscan_red.svg" alt="Reset"
                      style="width: 16px; height: 16px;">
                    <span data-translate="pages.dashboard.assign_calendars.reset_day">Nap törlése</span>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Calendar Reset Confirmation Popup -->
          <div id="calendarResetPopup" class="news-publish-popup">
            <div class="news-publish-popup-content" style="max-width: 420px;">
              <h3 class="news-publish-popup-title" style="color: #FF8181;">Nap törlése</h3>
              <p class="news-publish-popup-subtitle">Válaszd ki a törölni kívánt napot:</p>
              <div id="calendarResetDayDropdown" style="margin-bottom: 24px;"></div>
              <div style="display: flex; gap: 12px; justify-content: center;">
                <button class="calendar-assign-btn calendar-assign-btn-back" onclick="closeResetDayPopup()">
                  <span>Mégse</span>
                </button>
                <button class="calendar-assign-btn"
                  style="background: #FF8181; color: #210A0A; border: 1px solid #FF5555;" onclick="confirmResetDay()">
                  <span>Törlés</span>
                </button>
              </div>
            </div>
          </div>

          <!-- Calendar Publish Loading Popup -->
          <div id="calendarPublishPopup" class="news-publish-popup">
            <div class="news-publish-popup-content" style="max-width: 400px;">
              <!-- Loader animation -->
              <div class="onboarding-loader" style="
                width: 80px;
                aspect-ratio: 1;
                border: 10px solid #0000;
                padding: 5px;
                box-sizing: border-box;
                background: 
                  radial-gradient(farthest-side,#fff 98%,#0000 ) 0 0/20px 20px no-repeat,
                  conic-gradient(from 90deg at 10px 10px,#0000 90deg,#fff 0) content-box,
                  conic-gradient(from -90deg at 40px 40px,#0000 90deg,#fff 0) content-box,
                  #000;
                filter: blur(4px) contrast(10);
                animation: loaderAnim 2s infinite;
                margin: 0 auto;
              "></div>
              <h3 class="news-publish-popup-title" style="margin-top: 24px;">Órarend publikálása</h3>
              <p class="news-publish-popup-subtitle">Kérjük ne zárd be ezt az oldalt!</p>
            </div>
          </div>

          <!-- Calendar Assignment Page - Variation -->
          <div id="calendar-variation-page" class="dashboard-page" style="display: none;">
            <div class="calendar-assign-container">
              <span class="calendar-assign-title" id="calendarVariationTitle">Variáció hozzáadása - Hétfő 1. óra</span>
              <span class="calendar-assign-subtitle" id="calendarVariationSubtitle"></span>

              <div class="calendar-assign-inputs">
                <!-- Lesson Type Dropdown -->
                <div class="calendar-assign-dropdown-group">
                  <label class="calendar-assign-label" data-translate="pages.dashboard.assign_calendars.lesson_type">Óra
                    típusa</label>
                  <select id="variationLessonTypeDropdown" class="calendar-assign-dropdown">
                    <option value="" data-translate="pages.dashboard.assign_calendars.select_placeholder">Válassz...
                    </option>
                  </select>
                </div>

                <!-- Teacher Dropdown -->
                <div class="calendar-assign-dropdown-group">
                  <label class="calendar-assign-label"
                    data-translate="pages.dashboard.assign_calendars.teacher_name">Szaktanár neve</label>
                  <select id="variationTeacherDropdown" class="calendar-assign-dropdown">
                    <option value="" data-translate="pages.dashboard.assign_calendars.select_placeholder">Válassz...
                    </option>
                  </select>
                </div>

                <!-- Repeat Type -->
                <div class="calendar-assign-dropdown-group">
                  <label class="calendar-assign-label"
                    data-translate="pages.dashboard.assign_calendars.repeat_type">Ismétlődés típusa</label>
                  <div class="calendar-repeat-input-group">
                    <input type="number" id="variationRepeatCount" class="calendar-repeat-count-input" placeholder="1"
                      min="1" max="52">
                    <select id="variationRepeatType" class="calendar-assign-dropdown calendar-repeat-dropdown">
                      <option value="" data-translate="pages.dashboard.assign_calendars.select_placeholder">Válassz...
                      </option>
                      <option value="week" data-translate="pages.dashboard.assign_calendars.repeat_weekly">hetente
                      </option>
                      <option value="month" data-translate="pages.dashboard.assign_calendars.repeat_monthly">havonta
                      </option>
                    </select>
                  </div>
                </div>

                <!-- Special Sequence -->
                <div class="calendar-assign-dropdown-group calendar-special-sequence-group"
                  style="opacity: 0.5; pointer-events: none;">
                  <label class="calendar-assign-label"
                    data-translate="pages.dashboard.assign_calendars.special_sequence">Speciális ismétlődési
                    szekvencia</label>
                  <input type="text" id="variationDateSequence" class="calendar-date-sequence-input"
                    placeholder="éééé.hh.nn - éééé.hh.nn">
                  <span class="calendar-sequence-help"
                    data-translate="pages.dashboard.assign_calendars.special_sequence_help">(ha egy dátumot írsz be csak
                    addig a napig fogja ismételni a variációt a kiválasztott napodon, de ha egy tartományt írsz be a
                    kezdődátumtól a befejeződátumig fogja ismételni.)</span>
                </div>
              </div>

              <!-- Navigation Buttons -->
              <div class="calendar-assign-nav-buttons">
                <button class="calendar-assign-btn calendar-assign-btn-back" onclick="calendarBackToStep2()">
                  <img src="assets/onboarding/back_arrow.svg" alt="Vissza">
                  <span data-translate="common.back">Vissza</span>
                </button>
                <button class="calendar-assign-btn calendar-assign-btn-apply" id="calendarVariationApply"
                  onclick="calendarApplyVariation()">
                  <span data-translate="pages.dashboard.assign_calendars.apply">Alkalmazás</span>
                </button>
              </div>
            </div>
          </div>

          <!-- Calendar Variation Confirmation Popup -->
          <div id="calendarVariationPopup" class="permission-overlay-scroll-area" style="display: none;">
            <div class="permission-container">
              <button class="permission-close-btn" onclick="closeVariationPopup()">
                <img src="assets/general/close.svg" alt="Bezárás">
              </button>
              <div class="permission-content">
                <h2 class="permission-title" data-translate="pages.dashboard.assign_calendars.variation_confirm_title">
                  Variáció megerősítése</h2>
                <p class="permission-text" id="variationConfirmText"></p>
                <div class="permission-btn-group">
                  <button class="permission-cancel-btn" onclick="closeVariationPopup()"
                    data-translate="common.cancel">Mégse</button>
                  <button class="permission-ok-btn" onclick="confirmVariation()"
                    data-translate="common.continue">Folytatás</button>
                </div>
              </div>
            </div>
          </div>

          <script type="module">
            import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";

            function updateHeaderIcons(loggedIn) {
              const settingsWrapper = document.getElementById('headerSettingsWrapper');
              const accountWrapper = document.getElementById('headerAccountWrapper');
              const loginBtn = document.getElementById('headerLoginBtn');
              const gradientContainer = document.querySelector('.header-icon-gradient');
              if (!settingsWrapper || !accountWrapper || !loginBtn || !gradientContainer) return;

              if (loggedIn) {
                settingsWrapper.style.display = 'flex';
                accountWrapper.style.display = 'flex';
                loginBtn.style.display = 'none';
                gradientContainer.classList.remove('has-login');
              } else {
                settingsWrapper.style.display = 'flex';
                accountWrapper.style.display = 'none';
                loginBtn.style.display = 'flex';
                gradientContainer.classList.add('has-login');
              }
            }

            try {
              const auth = getAuth();
              onAuthStateChanged(auth, (user) => {
                updateHeaderIcons(!!user);
              });
            } catch (e) {
              // no-op
            }

            const loginBtnEl = document.getElementById('headerLoginBtn');
            if (loginBtnEl) {
              loginBtnEl.addEventListener('click', function () {
                window.location.href = 'onboarding.html';
              });
            }
          </script>
        </div>

        <footer class="site-footer">
          <div class="footer-left">
            <div class="footer-logo-container">
              <img src="assets/general/footer/eu2k_hub.png" alt="EU2K Hub">
              <span class="footer-participated-text" data-translate="footer.participated">Részt vett még:</span>
              <div class="footer-participated-logos">
                <img src="assets/general/footer/eu2k.png" alt="EU2K">
                <img src="assets/general/footer/eu2k_devs.png" alt="EU2K Devs">
                <img src="assets/general/footer/eu2k_dok.png" alt="EU2K Dok">
                <img src="assets/general/footer/eu2k_ujsag.png" alt="EU2K Újság">
              </div>
            </div>
            <div class="footer-copyright" data-translate="footer.copyright">© 2025 EU2K Devs és Európa 2000 Gimnázium.
              All Rights Reserved.</div>
            <div class="footer-social">
              <img src="assets/general/footer/eu2k_ujsag.svg" alt="EU2K Újság"
                onclick="window.open('https://sites.google.com/view/eu2k-ujsag', '_blank')">
              <img src="assets/general/footer/x.svg" alt="X (Twitter)"
                onclick="window.open('https://x.com/eu2kdevs', '_blank')">
              <img src="assets/general/footer/instagram.svg" alt="Instagram"
                onclick="window.open('https://instagram.com/eu2k.devs', '_blank')">
              <img src="assets/general/footer/yt.svg" alt="YouTube"
                onclick="window.open('https://youtube.com/@eu2kdevs', '_blank')">
            </div>
          </div>
          <div class="footer-right">
            <div class="footer-section-first">
              <div class="footer-section-title" data-translate="footer.legal.title">Jogi Nyilatkozatok</div>
              <div class="footer-section-items">
                <a href="privacy-policy.html" class="footer-item"
                  data-translate="footer.legal.privacy">Adatvédelmi&nbsp;Tájékoztató</a>
                <a href="terms-of-service.html" class="footer-item"
                  data-translate="footer.legal.terms">Használati&nbsp;Feltételek</a>
              </div>
            </div>
            <div class="footer-section">
              <div class="footer-section-title" data-translate="footer.hubs.title">Hubs</div>
              <div class="footer-section-items">
                <div class="footer-item">YouHub</div>
                <div class="footer-item">Class&nbsp;Hub</div>
                <div class="footer-item">Food&nbsp;Hub</div>
                <div class="footer-item">Event&nbsp;Hub</div>
                <div class="footer-item">Fitness&nbsp;Hub<span class="beta-badge">BETA</span></div>
              </div>
            </div>
          </div>
        </footer>
      </div>
    </main>
  </div>

  <div id="devModePopup" class="permission-overlay-scroll-area" style="display: none;">
    <div class="permission-container">
      <button class="permission-close-btn" onclick="closeDevModePopup()">
        <img src="assets/general/close.svg" alt="Bezárás">
      </button>
      <div class="permission-content">
        <h2 class="permission-title" data-translate="youhub.dev_mode.title">Developer Mód</h2>
        <p class="permission-text" data-translate="youhub.dev_mode.text">Jelszó megadása:</p>
        <input type="password" id="devModePassword" class="dev-mode-input"
          data-translate-placeholder="youhub.dev_mode.password_placeholder" placeholder="Jelszó">
        <button class="permission-ok-btn" onclick="checkDevModePassword()"
          data-translate="youhub.dev_mode.login_button">Bejelentkezés</button>
      </div>
    </div>
  </div>

  <!-- Optional Lesson Assignment Popup -->
  <div id="optionalLessonPopup" class="permission-overlay-scroll-area" style="display: none;">
    <div class="permission-container">
      <button class="permission-close-btn" onclick="closeOptionalLessonPopup()">
        <img src="assets/general/close.svg" alt="Bezárás">
      </button>
      <div class="permission-content">
        <h2 class="permission-title" data-translate="pages.dashboard.assign_calendars.optional_lesson_popup_title"
          data-translate-fallback="Opcionális óra hozzárendelése">Opcionális óra hozzárendelése</h2>
        <p class="permission-text" id="optionalLessonPopupDescription"
          data-translate="pages.dashboard.assign_calendars.optional_lesson_popup_description"
          data-translate-fallback="Most hozzárendelhetsz diákokat a nevük alapján, hogy jelezd hogy nekik ez az óra kötelező mint minden más tanóra. Ha nem szeretnéd jelezni ezt, hagyd üresen a beviteli mezőt, és kattints a tovább gombra.">
          Most hozzárendelhetsz diákokat a nevük alapján, hogy jelezd hogy nekik ez az óra kötelező mint minden más tanóra. Ha nem szeretnéd jelezni ezt, hagyd üresen a beviteli mezőt, és kattints a tovább gombra.</p>
        <div class="calendar-student-search-wrapper" style="margin-top: 20px;">
          <div id="optionalLessonStudentGhost" class="ghost-text"></div>
          <input type="text" id="optionalLessonStudentInput" class="calendar-student-search-input"
            placeholder="Diákok nevei..." autocomplete="off">
        </div>
        <button class="permission-ok-btn" onclick="handleOptionalLessonAssignment()"
          data-translate="common.next">Tovább</button>
      </div>
    </div>
  </div>

  <script src="assets/js/developer-mode.js"></script>
  <script src="assets/js/account-tooltip.js"></script>
  <script src="assets/js/footer.js"></script>
  <script src="assets/js/consent-banner.js"></script>
  <script src="assets/js/staff-timer.js"></script>
  <script src="assets/js/staff-nav-items.js"></script>
  <script>
    function handleHashChange() {
      const hash = window.location.hash || '#main';
      const mainPage = document.getElementById('main-page');
      const publishPage = document.getElementById('publish-page');
      const manageCalendarsPage = document.getElementById('manage-calendars-page');
      const manageMyClassPage = document.getElementById('manage-myclass-page');
      const pageTitle = document.getElementById('dashboardPageTitle');

      if (mainPage) mainPage.classList.remove('active');
      if (publishPage) publishPage.classList.remove('active');
      if (manageCalendarsPage) manageCalendarsPage.classList.remove('active');
      if (manageMyClassPage) manageMyClassPage.classList.remove('active');

      if (hash === '#publish') {
        if (publishPage) publishPage.classList.add('active');
        if (pageTitle) {
          const publishTitle = window.translationManager?.getTranslation('pages.dashboard.heading_publish') || 'Kezelőpult - Publikálás';
          pageTitle.textContent = publishTitle;
        }
      } else if (hash === '#manage-calendars') {
        if (manageCalendarsPage) {
          manageCalendarsPage.classList.add('active');
          manageCalendarsPage.style.display = 'block';
        }
        if (pageTitle) {
          const manageTitle = window.translationManager?.getTranslation('pages.dashboard.heading_manage_calendars') || 'Kezelőpult - Naptárak Kezelése';
          pageTitle.textContent = manageTitle;
        }
      } else if (hash === '#manage-myclass') {
        if (manageMyClassPage) {
          manageMyClassPage.classList.add('active');
          manageMyClassPage.style.display = 'block';
        }
        if (pageTitle) {
          pageTitle.textContent = window.translationManager?.getTranslation('pages.dashboard.heading_manage_myclass') || 'Kezelőpult - Osztályom kezelése';
        }
      } else {
        if (mainPage) mainPage.classList.add('active');
        if (pageTitle) {
          const mainTitle = window.translationManager?.getTranslation('pages.dashboard.heading') || 'Kezelőpult';
          pageTitle.textContent = mainTitle;
        }
      }
    }

    window.addEventListener('hashchange', handleHashChange);

    document.addEventListener('DOMContentLoaded', () => {
      handleHashChange();
      if (window.translationManager?.applyTranslations) {
        setTimeout(() => {
          window.translationManager.applyTranslations();
          handleHashChange();
        }, 100);
      }
    });

    function openSuggestionCenter() {
      console.log('[Dashboard] Opening Suggestion Center');
      window.location.href = 'youhub.html';
    }

    function openNotificationCenter() {
      console.log('[Dashboard] Opening Notification Center');
      window.location.href = 'youhub.html';
    }

    function openPublish() {
      console.log('[Dashboard] Opening Publish page');
      window.location.hash = '#publish';
    }

    // =====================================================
    // CALENDAR ASSIGNMENT CONTROLLER
    // =====================================================

    // State management
    const calendarState = {
      classes: {},           // { classId: formattedName }
      selectedClassId: null,
      selectedClassName: null,
      selectedProcess: null,
      optionalLessonEnabled: false, // Toggle state for optional lesson
      selectedDay: null,
      selectedDayName: null,
      selectedHour: null,
      lessons: {},           // { lessonId: name }
      teachers: {},          // { normalizedName: fullName }
      timetable: {},         // { lesson1: { startTime, finishTime }, ... }
      lessonData: {},        // saved lesson data { day: { lessonNum: data } }
      variationData: null,   // current variation being edited
      firstSchoolDay: null,  // first day of school year
      sessionId: null,       // unique session ID for temp data validation
      optionalLessonStudents: null, // normalizedNames for optional lesson students
      // Exam state
      selectedExamLessonType: null,
      selectedExamLessonTypeName: null,
      selectedExamType: null,
      selectedExamDate: null
    };

    // Restore state from session storage
    function restoreCalendarState() {
      try {
        const lData = sessionStorage.getItem('calendar_lessonData');
        if (lData) {
          calendarState.lessonData = JSON.parse(lData);
          console.log('[Calendar] Restored lessonData:', calendarState.lessonData);
        }

        calendarState.selectedClassId = sessionStorage.getItem('calendar_classId');
        calendarState.selectedClassName = sessionStorage.getItem('calendar_className');
        // Process usually defaults or is reselected
      } catch (e) {
        console.error('[Calendar] Failed to restore state:', e);
      }
    }

    // Call restore on load
    restoreCalendarState();

    // Open calendar manager
    window.openCalendarManager = function openCalendarManager() {
      console.log('[Calendar] Opening Calendar Manager');

      // Use hash navigation
      window.location.hash = '#manage-calendars';

      // Hide all dashboard pages including main-page
      hideAllDashboardPages();

      // Show manage calendars page
      const page = document.getElementById('manage-calendars-page');
      if (page) {
        page.style.display = 'block';
        page.classList.add('active');
      }

      // Update header title
      updateManageCalendarsHeader();

      // Load classes for dropdown
      loadManageCalendarsClasses();

      // Initialize date bar
      initManageCalendarsDateBar();
    }

    window.openManageMyClass = function openManageMyClass() {
      window.location.hash = '#manage-myclass';
      hideAllDashboardPages();
      const page = document.getElementById('manage-myclass-page');
      if (page) {
        page.style.display = 'block';
        page.classList.add('active');
      }
    }

    // Hide all dashboard pages
    function hideAllDashboardPages() {
      const allPages = [
        'main-page',
        'publish-page',
        'manage-calendars-page',
        'manage-myclass-page',
        'calendar-assign-page',
        'calendar-select-time-page',
        'calendar-schedule-assign-page',
        'calendar-lessons-page',
        'calendar-variation-page',
        'calendar-exam-assign-page'
      ];
      allPages.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.classList.remove('active');
          el.style.display = 'none';
        }
      });
    }

    // ============================================
    // MANAGE CALENDARS FUNCTIONS
    // ============================================
    
    function updateManageCalendarsHeader() {
      // Add " - Naptárak Kezelése" to header title after translations load
      const t = (key, fallback) => window.translationManager?.getTranslation(key) || fallback;
      const manageText = t('pages.dashboard.manage_calendars.header_suffix', 'Naptárak Kezelése');
      
      // Could update a header element here if needed
      console.log('[ManageCalendars] Header updated:', manageText);
    }

    let manageCalendarsClassDropdown = null;
    let manageCalendarsTypeDropdown = null;
    let manageCalendarsSelectedClassId = null;
    let manageCalendarsSelectedClassName = null;
    let manageCalendarsSelectedType = null;
    let manageCalendarsCurrentDate = new Date();
    let manageCalendarsDateItems = [];
    let manageCalendarsLessonCache = {};
    let manageCalendarsClassAccessMap = {};
    let manageCalendarsCanEdit = true;

    async function loadManageCalendarsClasses() {
      const classDropdownEl = document.getElementById('manageCalendarsClassDropdown');
      const typeDropdownEl = document.getElementById('manageCalendarsTypeDropdown');
      if (!classDropdownEl || !typeDropdownEl) {
        console.warn('[ManageCalendars] Dropdown elements not found');
        return;
      }

      try {
        if (!window.calendarApiCall) {
          console.error('[ManageCalendars] calendarApiCall not available');
          return;
        }

        // Ensure a sessionId exists for calendar API calls
        if (!calendarState.sessionId) {
          const sessionResult = await window.calendarApiCall('generateSessionId');
          calendarState.sessionId = sessionResult.data.sessionId;
        }

        console.log('[ManageCalendars] Loading classes via Cloud Function...');
        const result = await window.calendarApiCall('loadClasses');
        const classes = result.data?.classes || [];

        const classOptions = [{ value: '', label: 'Válassz osztályt...' }];
        manageCalendarsClassAccessMap = {};
        classes.forEach(cls => {
          classOptions.push({ value: cls.id, label: cls.name });
          manageCalendarsClassAccessMap[cls.id] = { canEdit: cls.canEdit !== false, accessRole: cls.accessRole || null };
        });

        if (!window.LanguageDropdown) {
          console.error('[ManageCalendars] LanguageDropdown not available!');
          return;
        }

        if (manageCalendarsClassDropdown && manageCalendarsClassDropdown.destroy) {
          manageCalendarsClassDropdown.destroy();
        }
        manageCalendarsClassDropdown = new window.LanguageDropdown(classDropdownEl, {
          options: classOptions,
          initialValue: manageCalendarsSelectedClassId || '',
          placeholder: 'Válassz...',
          onChange: (value) => {
            manageCalendarsSelectedClassId = value || null;
            const selected = classes.find(cls => cls.id === value);
            manageCalendarsSelectedClassName = selected ? selected.name : null;
            manageCalendarsCanEdit = manageCalendarsClassAccessMap[value]?.canEdit !== false;
            applyManageCalendarsAccess();
            updateManageCalendarsAddButtonText();
            loadManageCalendarsLessons();
          }
        });

        const typeOptions = [
          { value: '', label: 'Válassz naptártípust...' },
          { value: 'timetable', label: 'Órarend' },
          { value: 'exams', label: 'Dolgozat' }
        ];
        if (manageCalendarsTypeDropdown && manageCalendarsTypeDropdown.destroy) {
          manageCalendarsTypeDropdown.destroy();
        }
        manageCalendarsTypeDropdown = new window.LanguageDropdown(typeDropdownEl, {
          options: typeOptions,
          initialValue: manageCalendarsSelectedType || '',
          placeholder: 'Válassz...',
          onChange: (value) => {
            manageCalendarsSelectedType = value || null;
            updateManageCalendarsAddButtonText();
            applyManageCalendarsAccess();
            loadManageCalendarsLessons();
          }
        });

        console.log('[ManageCalendars] Dropdowns initialized successfully');
        updateManageCalendarsAddButtonText();
        manageCalendarsCanEdit = true;
        applyManageCalendarsAccess();
      } catch (e) {
        console.error('[ManageCalendars] Error loading classes:', e);
      }
    }

    async function loadManageCalendarsLessons() {
      const cardsContainer = document.querySelector('.manage-calendars-cards-container');
      const emptyState = document.getElementById('manageCalendarsEmptyState');
      if (!cardsContainer) return;

      const existingCards = cardsContainer.querySelectorAll('.manage-calendars-lesson-card');
      existingCards.forEach(c => c.remove());

      if (!manageCalendarsSelectedClassId || !manageCalendarsSelectedType) {
        if (emptyState) emptyState.style.display = 'flex';
        return;
      }

      if (emptyState) emptyState.style.display = 'none';

      try {
        const days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
        const currentDay = days[manageCalendarsCurrentDate.getDay()];
        manageCalendarsLessonCache = {};

        if (manageCalendarsSelectedType === 'timetable') {
          const result = await window.calendarApiCall('getClassTimetableCards', {
            classId: manageCalendarsSelectedClassId,
            day: currentDay
          });
          const cards = (result.data?.cards || []).slice();
          cards.sort((a, b) => (a.number ?? 0) - (b.number ?? 0));

          cards.forEach(cardData => {
            manageCalendarsLessonCache[cardData.number] = cardData;
            const card = createManageCalendarsLessonCard(cardData);
            cardsContainer.appendChild(card);
          });
          applyManageCalendarsAccess();

          if (cards.length === 0 && emptyState) {
            emptyState.querySelector('.manage-calendars-empty-title').textContent = 'Nincsenek órák';
            emptyState.querySelector('.manage-calendars-empty-subtitle').textContent = 'Ezen a napon nincsenek órák beállítva';
            emptyState.style.display = 'flex';
          }
        } else if (manageCalendarsSelectedType === 'exams') {
          const result = await window.calendarApiCall('getExamCards', {
            classId: manageCalendarsSelectedClassId,
            dayName: currentDay
          });
          const exams = (result.data?.exams || []).slice();
          exams.sort((a, b) => new Date(a.examDate || 0) - new Date(b.examDate || 0));

          exams.forEach(exam => {
            const card = createManageCalendarsExamCard(exam);
            cardsContainer.appendChild(card);
          });
          applyManageCalendarsAccess();

          if (exams.length === 0 && emptyState) {
            emptyState.querySelector('.manage-calendars-empty-title').textContent = 'Nincsenek dolgozatok';
            emptyState.querySelector('.manage-calendars-empty-subtitle').textContent = 'Ezen a napon nincsenek dolgozatok beállítva';
            emptyState.style.display = 'flex';
          }
        }
      } catch (e) {
        console.error('[ManageCalendars] Error loading lessons:', e);
      }
    }

    function createManageCalendarsLessonCard(lesson) {
      const card = document.createElement('div');
      card.className = 'manage-calendars-lesson-card';
      card.dataset.lessonNumber = lesson.number;

      const hourNum = lesson.number ?? '?';
      const lessonName = lesson.lessonTypeName || lesson.name || 'Ismeretlen óra';
      const teacherName = lesson.teacherName || lesson.teacher || '-';
      const roomNumber = lesson.placeName || lesson.place || lesson.room || '-';
      const timeline = lesson.timeline || (lesson.timelineStart && lesson.timelineEnd ? `${lesson.timelineStart} - ${lesson.timelineEnd}` : '-');
      const iconName = lesson.lessonIcon || lesson.icon || 'smile';
      const isOptional = lesson.optionalClass || false;

      card.innerHTML = `
        <div class="manage-calendars-card-checkbox">
          <span class="manage-calendars-card-number">${hourNum}.</span>
        </div>
        <div class="manage-calendars-card-icon">
          <img src="assets/youhub/calendar/classes/notactive/${iconName}.svg" alt="">
        </div>
        <div class="manage-calendars-card-info">
          <span class="manage-calendars-card-name">${lessonName}</span>
          <span class="manage-calendars-card-detail">Szaktanár: ${teacherName}</span>
          <span class="manage-calendars-card-detail">Teremszám: ${roomNumber}</span>
          <span class="manage-calendars-card-detail">Idővonal: ${timeline}</span>
        </div>
        <div class="manage-calendars-card-actions">
          <div class="manage-calendars-card-optional">
            <span>${isOptional ? 'Opcionális óra' : 'Nem opcionális óra'}</span>
          </div>
          <div class="manage-calendars-card-action-row">
            <button class="manage-calendars-card-edit" type="button" aria-label="Szerkesztés">
              <img src="assets/students/edit.svg" alt="">
            </button>
            <button class="students-delete-class-btn manage-calendars-delete-lesson-btn" type="button" aria-label="Óra törlése">
              <img src="assets/students/delete_class.svg" alt="Óra törlése" class="students-delete-class-btn-icon">
              <span class="students-delete-class-btn-text">Óra törlése</span>
            </button>
          </div>
        </div>
      `;

      const editBtn = card.querySelector('.manage-calendars-card-edit');
      if (editBtn) {
        editBtn.addEventListener('click', (event) => {
          event.stopPropagation();
          openManageCalendarsEdit(lesson);
        });
      }
      const deleteBtn = card.querySelector('.manage-calendars-delete-lesson-btn');
      if (deleteBtn) {
        deleteBtn.addEventListener('click', async (event) => {
          event.stopPropagation();
          await deleteManageCalendarsLesson(lesson);
        });
      }

      return card;
    }

    function createManageCalendarsExamCard(exam) {
      const card = document.createElement('div');
      card.className = 'manage-calendars-lesson-card manage-calendars-exam-card';

      const name = exam.lessonTypeName || exam.lessonType || 'Dolgozat';
      const examType = exam.examType || '-';
      let dateText = '-';
      if (exam.examDate) {
        const d = new Date(exam.examDate);
        if (!isNaN(d.getTime())) {
          const y = d.getFullYear();
          const m = String(d.getMonth() + 1).padStart(2, '0');
          const day = String(d.getDate()).padStart(2, '0');
          dateText = `${y}.${m}.${day}`;
        }
      }
      const iconName = exam.lessonIcon || 'smile';

      card.innerHTML = `
        <div class="manage-calendars-card-checkbox">
          <span class="manage-calendars-card-number">-</span>
        </div>
        <div class="manage-calendars-card-icon">
          <img src="assets/youhub/calendar/classes/notactive/${iconName}.svg" alt="">
        </div>
        <div class="manage-calendars-card-info">
          <span class="manage-calendars-card-name">${name}</span>
          <span class="manage-calendars-card-detail">Dolgozat típusa: ${examType}</span>
          <span class="manage-calendars-card-detail">Dátum: ${dateText}</span>
        </div>
      `;

      return card;
    }

    function manageCalendarsAddLesson() {
      if (manageCalendarsCanEdit === false) {
        if (window.showToastDirectly) {
          window.showToastDirectly('Hiba', 'Nincs jogosultságod a módosításhoz.', 'warning');
        }
        return;
      }
      if (!manageCalendarsSelectedClassId || !manageCalendarsSelectedClassName || !manageCalendarsSelectedType) {
        if (window.showToastDirectly) {
          window.showToastDirectly('Hiba', 'Előbb válassz osztályt és naptártípust!', 'warning');
        }
        return;
      }

      calendarState.selectedClassId = manageCalendarsSelectedClassId;
      calendarState.selectedClassName = manageCalendarsSelectedClassName;
      if (manageCalendarsSelectedType === 'exams') {
        calendarState.selectedProcess = 'exam';
      } else {
        calendarState.selectedProcess = 'schedule';
      }
      calendarState.manageCalendarsEditMode = false;
      sessionStorage.setItem('calendar_classId', calendarState.selectedClassId);
      sessionStorage.setItem('calendar_className', calendarState.selectedClassName);
      sessionStorage.setItem('calendar_process', calendarState.selectedProcess);

      window.manageCalendarsReturnTarget = 'manage-calendars';
      calendarSelectTime();
    }

    async function deleteManageCalendarsLesson(lesson) {
      if (manageCalendarsCanEdit === false) {
        if (window.showToastDirectly) {
          window.showToastDirectly('Hiba', 'Nincs jogosultságod a törléshez.', 'warning');
        }
        return;
      }
      if (!manageCalendarsSelectedClassId || !manageCalendarsSelectedType) {
        if (window.showToastDirectly) {
          window.showToastDirectly('Hiba', 'Előbb válassz osztályt és naptártípust!', 'warning');
        }
        return;
      }
      if (manageCalendarsSelectedType !== 'timetable') {
        if (window.showToastDirectly) {
          window.showToastDirectly('Hiba', 'Csak órarend órát lehet törölni.', 'warning');
        }
        return;
      }
      if (!lesson || lesson.number === undefined || lesson.number === null) return;

      const days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
      const day = days[manageCalendarsCurrentDate.getDay()];
      try {
        await window.calendarApiCall('deleteClassTimetableLesson', {
          classId: manageCalendarsSelectedClassId,
          day,
          lessonNumber: lesson.number
        });
        delete manageCalendarsLessonCache[lesson.number];
        const card = document.querySelector(`.manage-calendars-lesson-card[data-lesson-number="${lesson.number}"]`);
        if (card) card.remove();
        const cardsContainer = document.querySelector('.manage-calendars-cards-container');
        const emptyState = document.getElementById('manageCalendarsEmptyState');
        if (cardsContainer && cardsContainer.querySelectorAll('.manage-calendars-lesson-card').length === 0 && emptyState) {
          emptyState.querySelector('.manage-calendars-empty-title').textContent = 'Nincsenek órák';
          emptyState.querySelector('.manage-calendars-empty-subtitle').textContent = 'Ezen a napon nincsenek órák beállítva';
          emptyState.style.display = 'flex';
        }
        if (window.showToastDirectly) {
          window.showToastDirectly('Siker', 'Óra törölve.', 'success');
        }
      } catch (error) {
        console.error('[ManageCalendars] Error deleting lesson:', error);
        if (window.showToastDirectly) {
          window.showToastDirectly('Hiba', 'Nem sikerült törölni az órát.', 'warning');
        }
      }
    }

    async function openManageCalendarsEdit(lesson) {
      if (manageCalendarsCanEdit === false) {
        if (window.showToastDirectly) {
          window.showToastDirectly('Hiba', 'Nincs jogosultságod a szerkesztéshez.', 'warning');
        }
        return;
      }
      if (!manageCalendarsSelectedClassId || !manageCalendarsSelectedClassName) return;
      if (!lesson || lesson.number === undefined || lesson.number === null) return;

      calendarState.selectedClassId = manageCalendarsSelectedClassId;
      calendarState.selectedClassName = manageCalendarsSelectedClassName;
      calendarState.selectedProcess = 'schedule';
      calendarState.manageCalendarsEditMode = true;

      const dayNamesHu = ['Vasárnap', 'Hétfő', 'Kedd', 'Szerda', 'Csütörtök', 'Péntek', 'Szombat'];
      const daysEn = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
      const dayIndex = manageCalendarsCurrentDate.getDay();
      calendarState.selectedDay = daysEn[dayIndex];
      calendarState.selectedDayName = dayNamesHu[dayIndex];
      calendarState.selectedHour = lesson.number;

      if (!calendarState.lessonData[calendarState.selectedDay]) {
        calendarState.lessonData[calendarState.selectedDay] = {};
      }
      calendarState.lessonData[calendarState.selectedDay][lesson.number] = {
        lessonType: lesson.lessonType || null,
        lessonTypeName: lesson.lessonTypeName || null,
        teacher: lesson.teacherId || lesson.teacher || null,
        teacherName: lesson.teacherName || null,
        teacher2: lesson.teacher2 || null,
        teacherName2: lesson.teacher2Name || null,
        studentGroup: lesson.studentGroup || null,
        studentGroupName: lesson.studentGroupName || null,
        placeid: lesson.placeid || null,
        placeName: lesson.placeName || null,
        startTime: lesson.timelineStart || null,
        finishTime: lesson.timelineEnd || null,
        optionalLessonStudents: lesson.optionalLessonStudents || null
      };

      calendarState.optionalLessonEnabled = !!lesson.optionalLessonStudents;
      calendarState.optionalLessonStudents = lesson.optionalLessonStudents || null;

      try {
        await window.calendarApiCall('selectClass', { className: calendarState.selectedClassName });
      } catch (e) {
        console.warn('[ManageCalendars] selectClass failed:', e);
      }

      sessionStorage.setItem('calendar_classId', calendarState.selectedClassId);
      sessionStorage.setItem('calendar_className', calendarState.selectedClassName);
      sessionStorage.setItem('calendar_process', calendarState.selectedProcess);
      sessionStorage.setItem('calendar_day', calendarState.selectedDay);
      sessionStorage.setItem('calendar_dayName', calendarState.selectedDayName);
      sessionStorage.setItem('calendar_hour', calendarState.selectedHour);
      sessionStorage.setItem('calendar_lessonData', JSON.stringify(calendarState.lessonData));

      window.manageCalendarsReturnTarget = 'manage-calendars';
      calendarScheduleAssign();
    }

    function initManageCalendarsDateBar() {
      const scrollContainer = document.getElementById('manageCalendarsDateBarScroll');
      if (!scrollContainer) return;

      // Clear existing
      scrollContainer.innerHTML = '';

      // Generate date items around current date
      const centerDate = new Date(manageCalendarsCurrentDate);
      const items = [];

      // Generate more items to fill the bar width
      for (let i = -10; i <= 15; i++) {
        const date = new Date(centerDate);
        date.setDate(date.getDate() + i);
        items.push(createManageCalendarsDateItem(date, i === 0));
      }

      items.forEach(item => scrollContainer.appendChild(item));
      manageCalendarsDateItems = items;

      // Scroll to center (approximately)
      setTimeout(() => {
        const centerItem = scrollContainer.querySelector('.manage-calendars-date-item.current');
        if (centerItem) {
          centerItem.scrollIntoView({ inline: 'center', behavior: 'auto' });
        }
      }, 100);

      // Add scroll listener for infinite loading
      scrollContainer.addEventListener('scroll', handleManageCalendarsDateScroll);
    }

    function createManageCalendarsDateItem(date, isCurrent = false) {
      const item = document.createElement('div');
      item.className = 'manage-calendars-date-item' + (isCurrent ? ' current' : '');
      item.dataset.date = date.toISOString();

      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const dayNames = ['Vas', 'Hét', 'Kedd', 'Szer', 'Csüt', 'Pén', 'Szom'];
      const dayName = dayNames[date.getDay()];

      item.innerHTML = `
        <div class="manage-calendars-date-line"></div>
        <span class="manage-calendars-date-text">${month}.${day}</span>
        <div class="manage-calendars-date-hover">
          <span class="manage-calendars-date-hover-day">${dayName}</span>
          <span class="manage-calendars-date-hover-text">${month}.${day}</span>
        </div>
      `;

      item.addEventListener('click', () => {
        // Update selected date
        manageCalendarsCurrentDate = new Date(date);
        
        // Update visual selection
        document.querySelectorAll('.manage-calendars-date-item').forEach(i => i.classList.remove('selected'));
        item.classList.add('selected');

        // Reload lessons for new date
        loadManageCalendarsLessons();
      });

      return item;
    }

    // ============================================
    // MANAGE MY CLASS FUNCTIONS
    // ============================================
    let manageMyClassCandidates = [];

    function openManageMyClassAccessPopup() {
      showManageMyClassVerifyIdentityPopup();
    }

    function showManageMyClassVerifyIdentityPopup() {
      const scrollArea = document.querySelector('.main-scroll-area') || document.body;
      if (!scrollArea) return;

      scrollArea.scrollTo({ top: 0, behavior: 'instant' });
      scrollArea.classList.add('no-scroll');
      scrollArea.classList.add('popup-active');

      const popupHTML = `
        <div id="manageMyClassVerifyPopup" class="permission-overlay-scroll-area" style="display: none;">
          <div class="permission-container manage-myclass-access-container">
            <button class="permission-close-btn" id="manageMyClassVerifyCloseBtn">
              <img src="assets/general/close.svg" alt="Bezárás">
            </button>
            <div class="permission-content">
              <img src="assets/qr-code/hand.svg" class="permission-hand-icon" alt="Igazolás">
              <h2 class="permission-title">Igazold magad</h2>
              <p class="permission-text">Egy nagyobb hatású műveletet szeretnél végrehajtani, kérlek igazold magad.</p>
              <input type="password" id="manageMyClassVerifyPassword" class="dev-mode-input" placeholder="Jelszó">
              <button class="permission-ok-btn" id="manageMyClassVerifyConfirmBtn">Igazolás</button>
            </div>
          </div>
        </div>
      `;

      scrollArea.insertAdjacentHTML('beforeend', popupHTML);
      setTimeout(() => {
        const popup = document.getElementById('manageMyClassVerifyPopup');
        if (popup) popup.style.display = 'flex';

        const input = document.getElementById('manageMyClassVerifyPassword');
        const closeBtn = document.getElementById('manageMyClassVerifyCloseBtn');
        const confirmBtn = document.getElementById('manageMyClassVerifyConfirmBtn');

        const closePopup = () => {
          scrollArea.classList.remove('no-scroll');
          scrollArea.classList.remove('popup-active');
          if (popup) popup.remove();
        };

        closeBtn?.addEventListener('click', closePopup);

        confirmBtn?.addEventListener('click', async () => {
          if (!input) return;
          const password = input.value.trim();
          if (!password) {
            alert('Kérlek add meg a jelszót!');
            return;
          }
          try {
            let verifyPassword;
            if (window.functions) {
              const { httpsCallable } = await import('https://www.gstatic.com/firebasejs/11.10.0/firebase-functions.js');
              verifyPassword = httpsCallable(window.functions, 'verifyAdminConsolePassword');
            } else if (window.createHttpsCallable) {
              verifyPassword = window.createHttpsCallable('verifyAdminConsolePassword');
            } else {
              const { getFunctions, httpsCallable } = await import('https://www.gstatic.com/firebasejs/11.10.0/firebase-functions.js');
              const app = window.firebaseApp || (await import('https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js')).getApp();
              const functions = getFunctions(app, 'europe-west1');
              verifyPassword = httpsCallable(functions, 'verifyAdminConsolePassword');
            }

            const result = await verifyPassword({ password });
            if (result && result.data && result.data.success) {
              closePopup();
              showManageMyClassAccessForm();
            } else {
              alert('Hibás jelszó!');
            }
          } catch (e) {
            console.error('[ManageMyClass] Verify error:', e);
            alert('Hiba történt az igazoláskor.');
          }
        });
      }, 0);
    }

    async function showManageMyClassAccessForm() {
      const scrollArea = document.querySelector('.main-scroll-area') || document.body;
      if (!scrollArea) return;

      scrollArea.scrollTo({ top: 0, behavior: 'instant' });
      scrollArea.classList.add('no-scroll');
      scrollArea.classList.add('popup-active');

      const popupHTML = `
        <div id="manageMyClassAccessPopup" class="permission-overlay-scroll-area" style="display: none;">
          <div class="permission-container manage-myclass-access-container">
            <button class="permission-close-btn" id="manageMyClassAccessCloseBtn">
              <img src="assets/general/close.svg" alt="Bezárás">
            </button>
            <div class="permission-content">
              <h2 class="permission-title">Hozzáférés engedélyezése</h2>
              <div class="manage-myclass-step manage-myclass-step-1 active">
                <p class="permission-text">Add meg a tanár nevét:</p>
                <input type="text" id="manageMyClassTeacherInput" class="manage-myclass-input" placeholder="Tanár neve">
                <div id="manageMyClassSuggestions" class="manage-myclass-suggestions"></div>
                <div class="manage-myclass-actions">
                  <button class="permission-ok-btn disabled" id="manageMyClassNextBtn">Tovább</button>
                </div>
              </div>
              <div class="manage-myclass-step manage-myclass-step-2">
                <p class="permission-text">Válaszd ki a szerepköröket:</p>
                <div class="manage-myclass-role-list">
                  <div class="manage-myclass-role-item">
                    <div class="manage-myclass-role-checkbox" data-role="homeroomDeputy"></div>
                    <div class="manage-myclass-role-label">Osztályfőnök helyettes</div>
                  </div>
                  <div class="manage-myclass-role-item">
                    <div class="manage-myclass-role-checkbox" data-role="subjectTeacher"></div>
                    <div class="manage-myclass-role-label">Szaktanár</div>
                  </div>
                  <div class="manage-myclass-role-item">
                    <div class="manage-myclass-role-checkbox" data-role="substituteTeacher"></div>
                    <div class="manage-myclass-role-label">Helyettesítő tanár</div>
                  </div>
                  <div class="manage-myclass-role-item" style="position: relative;">
                    <div class="manage-myclass-role-checkbox" data-role="adminColleague"></div>
                    <div class="manage-myclass-role-label" id="manageMyClassAdminLabel">Adminisztrációs kolléga</div>
                    <div class="manage-myclass-tooltip" id="manageMyClassAdminTooltip">Ide tartoznak a karbantartók, Marcsi, és a titkárságon lévő illetve pénztárban és szervernek dolgozó munkatársak.</div>
                  </div>
                </div>
                <div class="manage-myclass-actions">
                  <button class="calendar-assign-btn calendar-assign-btn-back" id="manageMyClassBackBtn">
                    <img src="assets/onboarding/back_arrow.svg" alt="Vissza">
                  </button>
                  <button class="manage-myclass-btn primary disabled" id="manageMyClassFinishBtn">Befejezés</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;

      scrollArea.insertAdjacentHTML('beforeend', popupHTML);
      setTimeout(async () => {
        const popup = document.getElementById('manageMyClassAccessPopup');
        if (popup) popup.style.display = 'flex';

        const closeBtn = document.getElementById('manageMyClassAccessCloseBtn');
        const closePopup = () => {
          scrollArea.classList.remove('no-scroll');
          scrollArea.classList.remove('popup-active');
          if (popup) popup.remove();
        };
        closeBtn?.addEventListener('click', closePopup);

        const teacherInput = document.getElementById('manageMyClassTeacherInput');
        const suggestions = document.getElementById('manageMyClassSuggestions');
        const nextBtn = document.getElementById('manageMyClassNextBtn');
        const backBtn = document.getElementById('manageMyClassBackBtn');
        const finishBtn = document.getElementById('manageMyClassFinishBtn');
        const step1 = popup.querySelector('.manage-myclass-step-1');
        const step2 = popup.querySelector('.manage-myclass-step-2');

        // Load candidates
        try {
          const result = await window.calendarApiCall('searchTeacherCandidates');
          manageMyClassCandidates = result.data?.users || [];
        } catch (e) {
          console.error('[ManageMyClass] Failed to load candidates:', e);
          manageMyClassCandidates = [];
        }

        const updateSuggestions = (value) => {
          if (!suggestions) return;
          suggestions.innerHTML = '';
          if (!value) {
            suggestions.classList.remove('active');
            return;
          }
          const query = value.toLowerCase();
          const matches = manageMyClassCandidates.filter(u => (u.fullName || '').toLowerCase().includes(query)).slice(0, 6);
          matches.forEach(u => {
            const item = document.createElement('div');
            item.className = 'manage-myclass-suggestion-item';
            item.textContent = u.fullName;
            item.addEventListener('click', () => {
              if (teacherInput) teacherInput.value = u.fullName;
              suggestions.classList.remove('active');
              updateNextState();
            });
            suggestions.appendChild(item);
          });
          suggestions.classList.toggle('active', matches.length > 0);
        };

        const updateNextState = () => {
          const hasName = teacherInput && teacherInput.value.trim().length > 0;
          if (nextBtn) {
            nextBtn.classList.toggle('disabled', !hasName);
          }
        };

        teacherInput?.addEventListener('input', () => {
          updateSuggestions(teacherInput.value);
          updateNextState();
        });

        nextBtn?.addEventListener('click', () => {
          if (nextBtn.classList.contains('disabled')) return;
          step1.classList.remove('active');
          step2.classList.add('active');
          updateFinishState();
        });

        backBtn?.addEventListener('click', () => {
          step2.classList.remove('active');
          step1.classList.add('active');
        });

        const roleCheckboxes = popup.querySelectorAll('.manage-myclass-role-checkbox');
        roleCheckboxes.forEach(cb => {
          cb.addEventListener('click', () => {
            cb.classList.toggle('is-checked');
            updateFinishState();
          });
        });

        const updateFinishState = () => {
          const anyChecked = Array.from(roleCheckboxes).some(cb => cb.classList.contains('is-checked'));
          if (finishBtn) {
            finishBtn.classList.toggle('disabled', !anyChecked);
          }
        };

        finishBtn?.addEventListener('click', async () => {
          if (finishBtn.classList.contains('disabled')) return;
          const fullName = teacherInput?.value.trim();
          const roles = {
            homeroomDeputy: popup.querySelector('.manage-myclass-role-checkbox[data-role="homeroomDeputy"]')?.classList.contains('is-checked'),
            subjectTeacher: popup.querySelector('.manage-myclass-role-checkbox[data-role="subjectTeacher"]')?.classList.contains('is-checked'),
            substituteTeacher: popup.querySelector('.manage-myclass-role-checkbox[data-role="substituteTeacher"]')?.classList.contains('is-checked'),
            adminColleague: popup.querySelector('.manage-myclass-role-checkbox[data-role="adminColleague"]')?.classList.contains('is-checked')
          };
          try {
            await window.calendarApiCall('grantClassAccess', { fullName, roles });
            if (window.showToastDirectly) {
              window.showToastDirectly('Siker', 'Hozzáférés engedélyezve.', 'success');
            }
            closePopup();
          } catch (e) {
            console.error('[ManageMyClass] Grant access failed:', e);
            if (window.showToastDirectly) {
              window.showToastDirectly('Hiba', 'Nem sikerült engedélyezni a hozzáférést.', 'warning');
            }
          }
        });

        // Admin colleague tooltip (3s hover)
        const adminLabel = document.getElementById('manageMyClassAdminLabel');
        const adminTooltip = document.getElementById('manageMyClassAdminTooltip');
        let tooltipTimer = null;
        if (adminLabel && adminTooltip) {
          adminLabel.addEventListener('mouseenter', () => {
            tooltipTimer = setTimeout(() => {
              adminTooltip.style.display = 'block';
              const rect = adminLabel.getBoundingClientRect();
              adminTooltip.style.top = `${rect.bottom + 6}px`;
              adminTooltip.style.left = `${rect.left}px`;
            }, 3000);
          });
          adminLabel.addEventListener('mouseleave', () => {
            if (tooltipTimer) clearTimeout(tooltipTimer);
            tooltipTimer = null;
            adminTooltip.style.display = 'none';
          });
        }

        updateNextState();
      }, 0);
    }

    function updateManageCalendarsAddButtonText() {
      const textEl = document.getElementById('manageCalendarsAddLessonText');
      if (!textEl) return;
      if (!manageCalendarsSelectedClassId || !manageCalendarsSelectedType) {
        textEl.textContent = 'Órarend Hozzárendelése';
        return;
      }
      if (manageCalendarsSelectedType === 'exams') {
        textEl.textContent = 'Dolgozat bejelentése';
        return;
      }
      textEl.textContent = 'Óra hozzáadása';
    }

    function applyManageCalendarsAccess() {
      const canEdit = manageCalendarsCanEdit !== false;
      const addBtn = document.querySelector('.calendar-add-lesson-btn');
      if (addBtn) {
        addBtn.style.opacity = canEdit ? '1' : '0.5';
        addBtn.style.pointerEvents = canEdit ? 'auto' : 'none';
      }
      const editButtons = document.querySelectorAll('.manage-calendars-card-edit');
      const deleteButtons = document.querySelectorAll('.manage-calendars-delete-lesson-btn');
      editButtons.forEach(btn => {
        btn.style.opacity = canEdit ? '1' : '0.5';
        btn.style.pointerEvents = canEdit ? 'auto' : 'none';
      });
      deleteButtons.forEach(btn => {
        btn.style.opacity = canEdit ? '1' : '0.5';
        btn.style.pointerEvents = canEdit ? 'auto' : 'none';
      });
    }

    function handleManageCalendarsDateScroll(e) {
      const container = e.target;
      const scrollLeft = container.scrollLeft;
      const scrollWidth = container.scrollWidth;
      const clientWidth = container.clientWidth;

      // Load more items if near edges
      if (scrollLeft < 50) {
        // Near left edge - prepend items
        prependManageCalendarsDateItems();
      } else if (scrollLeft + clientWidth > scrollWidth - 50) {
        // Near right edge - append items
        appendManageCalendarsDateItems();
      }
    }

    function prependManageCalendarsDateItems() {
      const container = document.getElementById('manageCalendarsDateBarScroll');
      if (!container || manageCalendarsDateItems.length === 0) return;

      const firstItem = manageCalendarsDateItems[0];
      const firstDate = new Date(firstItem.dataset.date);

      // Add 3 items before
      for (let i = 3; i >= 1; i--) {
        const newDate = new Date(firstDate);
        newDate.setDate(newDate.getDate() - i);
        const newItem = createManageCalendarsDateItem(newDate);
        container.insertBefore(newItem, firstItem);
        manageCalendarsDateItems.unshift(newItem);
      }
    }

    function appendManageCalendarsDateItems() {
      const container = document.getElementById('manageCalendarsDateBarScroll');
      if (!container || manageCalendarsDateItems.length === 0) return;

      const lastItem = manageCalendarsDateItems[manageCalendarsDateItems.length - 1];
      const lastDate = new Date(lastItem.dataset.date);

      // Add 3 items after
      for (let i = 1; i <= 3; i++) {
        const newDate = new Date(lastDate);
        newDate.setDate(newDate.getDate() + i);
        const newItem = createManageCalendarsDateItem(newDate);
        container.appendChild(newItem);
        manageCalendarsDateItems.push(newItem);
      }
    }

    // Hide all calendar pages (keeps main-page visible)
    function hideAllCalendarPages() {
      const pages = [
        'calendar-assign-page',
        'calendar-select-time-page',
        'calendar-schedule-assign-page',
        'calendar-exam-assign-page',
        'calendar-lessons-page',
        'calendar-variation-page'
      ];
      pages.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.classList.remove('active');
          el.style.display = 'none';
        }
      });
    }

    // Setup dropdown event listeners
    function setupCalendarDropdownListeners() {
      const classDropdown = document.getElementById('calendarClassDropdown');
      const processDropdown = document.getElementById('calendarProcessDropdown');
      const dayDropdown = document.getElementById('calendarDayDropdown');
      const hourDropdown = document.getElementById('calendarHourDropdown');
      const repeatTypeDropdown = document.getElementById('variationRepeatType');

      // Step 1: Enable next button when both class and process selected
      const updateStep1Next = () => {
        const nextBtn = document.getElementById('calendarStep1Next');
        if (nextBtn) {
          const classSelected = classDropdown?.value;
          const processSelected = processDropdown?.value;
          nextBtn.disabled = !classSelected || !processSelected;
        }
      };

      if (classDropdown) classDropdown.addEventListener('change', updateStep1Next);
      if (processDropdown) processDropdown.addEventListener('change', updateStep1Next);

      // Step 2: Enable next/variation buttons when day and hour selected
      const updateStep2Btns = () => {
        const nextBtn = document.getElementById('calendarStep2Next');
        const varBtn = document.getElementById('calendarVariationBtn');
        const daySelected = dayDropdown?.value;
        const hourSelected = hourDropdown?.value;
        const bothSelected = daySelected && hourSelected;

        if (nextBtn) nextBtn.disabled = !bothSelected;
        if (varBtn) varBtn.disabled = !bothSelected;
      };

      if (dayDropdown) dayDropdown.addEventListener('change', updateStep2Btns);
      if (hourDropdown) hourDropdown.addEventListener('change', updateStep2Btns);

      // Variation: Enable special sequence when repeat type selected
      if (repeatTypeDropdown) {
        repeatTypeDropdown.addEventListener('change', () => {
          const sequenceGroup = document.querySelector('.calendar-special-sequence-group');
          if (sequenceGroup) {
            if (repeatTypeDropdown.value) {
              sequenceGroup.style.opacity = '1';
              sequenceGroup.style.pointerEvents = 'auto';
            } else {
              sequenceGroup.style.opacity = '0.5';
              sequenceGroup.style.pointerEvents = 'none';
            }
          }
        });
      }
    }

    // Calendar dropdown instances
    let calendarClassDropdownInstance = null;
    let calendarProcessDropdownInstance = null;
    let calendarDayDropdownInstance = null;
    let calendarHourDropdownInstance = null;

    // Load classes from Cloud Function
    async function loadClassesForDropdown() {
      console.log('[Calendar] Loading classes via Cloud Function...');
      try {
        // Generate a new sessionId for this calendar editing session
        if (!calendarState.sessionId) {
          const sessionResult = await window.calendarApiCall('generateSessionId');
          calendarState.sessionId = sessionResult.data.sessionId;
          console.log('[Calendar] Generated sessionId:', calendarState.sessionId);
        }

        const result = await window.calendarApiCall('loadClasses');
        const { classes } = result.data;

        // Store class data
        const classNames = ['Válassz osztályt...'];
        classes.forEach(cls => {
          calendarState.classes[cls.id] = cls.name;
          classNames.push(cls.name);
        });

        // Initialize LanguageDropdown for classes
        const classContainer = document.getElementById('calendarClassDropdown');
        if (classContainer && window.LanguageDropdown) {
          classContainer.innerHTML = '';
          calendarClassDropdownInstance = new window.LanguageDropdown(classContainer, {
            options: classNames,
            selectedIndex: 0,
            onChange: (value, index) => {
              calendarState.selectedClassName = index > 0 ? value : null;
              updateStep1NextButton();
            }
          });
        }

        // Initialize Process dropdown
        const processContainer = document.getElementById('calendarProcessDropdown');
        if (processContainer && window.LanguageDropdown) {
          processContainer.innerHTML = '';
          calendarProcessDropdownInstance = new window.LanguageDropdown(processContainer, {
            options: ['Válassz folyamatot...', 'Órarend', 'Dolgozat'],
            selectedIndex: 0,
            onChange: (value, index) => {
              if (index === 1) {
                calendarState.selectedProcess = 'schedule';
              } else if (index === 2) {
                calendarState.selectedProcess = 'exam';
              } else {
                calendarState.selectedProcess = null;
              }
              updateStep1NextButton();
            }
          });
        }

        console.log('[Calendar] Loaded', classes.length, 'classes from Cloud Function');
      } catch (e) {
        console.error('[Calendar] Failed to load classes:', e);
      }
    }

    // Update step 1 next button state
    function updateStep1NextButton() {
      const nextBtn = document.getElementById('calendarStep1Next');
      if (nextBtn) {
        nextBtn.disabled = !calendarState.selectedClassName || !calendarState.selectedProcess;
      }
    }

    // Format class ID to readable name (e.g., "2030e" -> "8.E Osztály")
    function formatClassName(classId) {
      // Pattern: graduation year + class letter (e.g., 2030e, 2029a)
      const match = classId.match(/^(\d{4})([a-z])$/i);
      if (!match) return classId;

      const gradYear = parseInt(match[1]);
      const classLetter = match[2].toUpperCase();
      const currentYear = new Date().getFullYear();
      const currentMonth = new Date().getMonth(); // 0-11

      // Calculate grade: if before September, subtract 1
      const schoolYear = currentMonth < 8 ? currentYear : currentYear + 1;
      const grade = 12 - (gradYear - schoolYear);

      if (grade < 1 || grade > 12) return classId;

      return `${grade}.${classLetter} Osztály`;
    }

    // Navigation functions
    function calendarAssignBack() {
      window.location.hash = '';
      hideAllCalendarPages();
      const mainPage = document.getElementById('main-page');
      if (mainPage) {
        mainPage.style.display = 'block';
        mainPage.classList.add('active');
      }
    }

    async function calendarSelectTime() {
      // Values already stored in calendarState from onChange callbacks
      if (window.manageCalendarsReturnTarget === 'manage-calendars') {
        setManageCalendarsContainerVisible(false);
      }

      // Send selection to Cloud Function
      try {
        const result = await window.calendarApiCall('selectClass', { className: calendarState.selectedClassName });
        calendarState.selectedClassId = result.data.classId;
        console.log('[Calendar] Class selected:', result.data);
      } catch (e) {
        console.error('[Calendar] Failed to select class:', e);
      }

      // Save to session storage
      sessionStorage.setItem('calendar_classId', calendarState.selectedClassId);
      sessionStorage.setItem('calendar_className', calendarState.selectedClassName);
      sessionStorage.setItem('calendar_process', calendarState.selectedProcess);

      hideAllCalendarPages();
      const page = document.getElementById('calendar-select-time-page');
      if (page) {
        page.style.display = 'block';
        page.classList.add('active');
      }

      // Update subtitle
      const subtitle = document.getElementById('calendarSelectTimeSubtitle');
      if (subtitle) {
        subtitle.textContent = calendarState.selectedClassName;
      }

      // Initialize Step 2 dropdowns (same for both schedule and exam)
      initStep2Dropdowns();
    }

    // Handle navigation from time selection based on process type
    function calendarGoToStep3() {
      if (calendarState.selectedProcess === 'exam') {
        calendarGoToExamAssign();
      } else {
        calendarScheduleAssign();
      }
    }

    // Navigate to exam assignment page
    async function calendarGoToExamAssign() {
      hideAllCalendarPages();
      const page = document.getElementById('calendar-exam-assign-page');
      if (page) {
        page.style.display = 'block';
        page.classList.add('active');
      }

      // Update title with class name
      const title = document.getElementById('calendarExamTitle');
      const subtitle = document.getElementById('calendarExamSubtitle');
      if (title && calendarState.selectedClassName) {
        title.textContent = `Dolgozat bejelentése - ${calendarState.selectedClassName}`;
      }
      if (subtitle && calendarState.selectedDayName) {
        subtitle.textContent = calendarState.selectedDayName;
      }

      // Initialize exam dropdowns
      initExamDropdowns();
    }

    // Initialize exam page dropdowns
    async function initExamDropdowns() {
      // Load lesson types for exam - same way as loadLessonTypes()
      try {
        console.log('[Calendar] Loading lesson types for exam via Cloud Function...');
        const result = await window.calendarApiCall('loadLessonTypes', { selectedHour: calendarState.selectedHour });
        const { lessons } = result.data;

        // Store lesson data
        const lessonNames = ['Válassz óra típust...'];
        const lessonIds = [null];

        lessons.forEach((lesson) => {
          calendarState.lessons[lesson.id] = lesson.name;
          lessonNames.push(lesson.name);
          lessonIds.push(lesson.id);
        });

        console.log('[Calendar] Loaded', lessons.length, 'lesson types for exam');
        
        const lessonContainer = document.getElementById('calendarExamLessonTypeDropdown');
        if (lessonContainer && window.LanguageDropdown) {
          lessonContainer.innerHTML = '';
          new window.LanguageDropdown(lessonContainer, {
            options: lessonNames,
            selectedIndex: 0,
            onChange: (value, index) => {
              calendarState.selectedExamLessonType = index > 0 ? lessonIds[index] : null;
              calendarState.selectedExamLessonTypeName = index > 0 ? value : null;
              updateExamNextButton();
            }
          });
        }
      } catch (e) {
        console.error('[Calendar] Failed to load lesson types for exam:', e);
      }

      // Exam type dropdown
      const examTypeOptions = ['Válassz típust...', 'Témazáró', 'Röpdolgozat', 'Felelés', 'Prezentáció'];
      const examTypeValues = [null, 'temazaro', 'ropdolgozat', 'feleles', 'prezentacio'];
      
      const examTypeContainer = document.getElementById('calendarExamTypeDropdown');
      if (examTypeContainer && window.LanguageDropdown) {
        examTypeContainer.innerHTML = '';
        new window.LanguageDropdown(examTypeContainer, {
          options: examTypeOptions,
          selectedIndex: 0,
          onChange: (value, index) => {
            calendarState.selectedExamType = examTypeValues[index];
            updateExamNextButton();
          }
        });
      }

      // Date input listener
      const dateInput = document.getElementById('calendarExamDate');
      if (dateInput) {
        dateInput.value = '';
        dateInput.addEventListener('change', () => {
          calendarState.selectedExamDate = dateInput.value || null;
          updateExamNextButton();
        });
      }

      // Reset state
      calendarState.selectedExamLessonType = null;
      calendarState.selectedExamLessonTypeName = null;
      calendarState.selectedExamType = null;
      calendarState.selectedExamDate = null;
      updateExamNextButton();
    }

    function updateExamNextButton() {
      const btn = document.getElementById('calendarExamNext');
      if (btn) {
        const allSelected = calendarState.selectedExamLessonType && 
                           calendarState.selectedExamType && 
                           calendarState.selectedExamDate;
        btn.disabled = !allSelected;
      }
    }

    async function calendarPublishExam() {
      const btn = document.getElementById('calendarExamNext');
      if (btn) btn.disabled = true;

      try {
        const result = await window.calendarApiCall('publishExam', {
          classId: calendarState.selectedClassId,
          dayName: calendarState.selectedDay,
          lessonType: calendarState.selectedExamLessonType,
          examType: calendarState.selectedExamType,
          examDate: calendarState.selectedExamDate
        });

        console.log('[Calendar] Exam published:', result.data);

        if (window.showToastDirectly) {
          window.showToastDirectly('Siker', 'Dolgozat publikálva!', 'positive');
        }

        // Navigate back to main page
        calendarAssignBack();
      } catch (e) {
        console.error('[Calendar] Failed to publish exam:', e);
        if (window.showToastDirectly) {
          window.showToastDirectly('Hiba', 'Nem sikerült publikálni a dolgozatot', 'negative');
        }
        if (btn) btn.disabled = false;
      }
    }

    // Initialize Step 2 (day/hour) dropdowns
    function initStep2Dropdowns() {
      const dayMapping = {
        'Válassz napot...': null,
        'Hétfő': 'monday',
        'Kedd': 'tuesday',
        'Szerda': 'wednesday',
        'Csütörtök': 'thursday',
        'Péntek': 'friday'
      };
      const dayNames = Object.keys(dayMapping);

      // Day dropdown
      const dayContainer = document.getElementById('calendarDayDropdown');
      if (dayContainer && window.LanguageDropdown) {
        dayContainer.innerHTML = '';
        calendarDayDropdownInstance = new window.LanguageDropdown(dayContainer, {
          options: dayNames,
          selectedIndex: 0,
          onChange: (value, index) => {
            calendarState.selectedDay = dayMapping[value] || null;
            calendarState.selectedDayName = index > 0 ? value : null;
            updateStep2Buttons();
          }
        });
      }

      // Hour dropdown (0-10, where 0 is valid)
      const hourOptions = ['Válassz órát...', '0.', '1.', '2.', '3.', '4.', '5.', '6.', '7.', '8.', '9.', '10.'];
      const hourContainer = document.getElementById('calendarHourDropdown');
      if (hourContainer && window.LanguageDropdown) {
        hourContainer.innerHTML = '';
        calendarHourDropdownInstance = new window.LanguageDropdown(hourContainer, {
          options: hourOptions,
          selectedIndex: 0,
          onChange: (value, index) => {
            // Robustly parse hour from value (e.g. "0.", "1.") to avoid index mismatch
            // "Válassz..." will fail regex and fall to else
            if (value && /^\d+\.$/.test(value)) {
              calendarState.selectedHour = parseInt(value, 10);
            } else {
              calendarState.selectedHour = null;
            }
            updateStep2Buttons();
          }
        });
      }
    }

    // Update Step 2 buttons (next and variation)
    function updateStep2Buttons() {
      const nextBtn = document.getElementById('calendarStep2Next');
      const varBtn = document.getElementById('calendarVariationBtn');
      // selectedHour can be 0, so check for null specifically
      const bothSelected = calendarState.selectedDay && calendarState.selectedHour !== null;

      if (nextBtn) nextBtn.disabled = !bothSelected;
      if (varBtn) {
        varBtn.disabled = !bothSelected;
        // Hide variation button for exam flow
        varBtn.style.display = calendarState.selectedProcess === 'exam' ? 'none' : '';
      }
    }

    function calendarBackToStep1() {
      if (window.manageCalendarsReturnTarget === 'manage-calendars') {
        window.manageCalendarsReturnTarget = null;
        setManageCalendarsContainerVisible(true);
        window.location.hash = '#manage-calendars';
        hideAllDashboardPages();
        const page = document.getElementById('manage-calendars-page');
        if (page) {
          page.style.display = 'block';
          page.classList.add('active');
        }
        loadManageCalendarsLessons();
        return;
      }
      window.location.hash = '#assign-calendars';
      hideAllCalendarPages();
      const page = document.getElementById('calendar-assign-page');
      if (page) {
        page.style.display = 'block';
        page.classList.add('active');
      }
    }

    async function calendarScheduleAssign() {
      // Values are already in calendarState from LanguageDropdown onChange callbacks
      // Don't override them with undefined DOM values!
      if (window.manageCalendarsReturnTarget === 'manage-calendars') {
        setManageCalendarsContainerVisible(false);
      }

      // Send selection to Cloud Function
      try {
        const result = await window.calendarApiCall('selectTimeSlot', {
          day: calendarState.selectedDay,
          hour: calendarState.selectedHour,
          process: calendarState.selectedProcess
        });
        console.log('[Calendar] Time slot selected:', result.data);
      } catch (e) {
        console.error('[Calendar] Failed to select time slot:', e);
      }

      // Save to session storage
      sessionStorage.setItem('calendar_day', calendarState.selectedDay);
      sessionStorage.setItem('calendar_hour', calendarState.selectedHour);
      sessionStorage.setItem('calendar_dayName', calendarState.selectedDayName || '');

      hideAllCalendarPages();
      const page = document.getElementById('calendar-schedule-assign-page');
      if (page) {
        page.style.display = 'block';
        page.classList.add('active');
      }

      // Update title and subtitle
      updateScheduleAssignTitle();

      // CHECK IF WE HAVE SAVED DATA FOR THIS SLOT
      const selectedDay = calendarState.selectedDay;
      const lessonNum = calendarState.selectedHour;
      const dayData = calendarState.lessonData[selectedDay] || {};
      const savedData = dayData[lessonNum];

      console.log(`[Calendar] ScheduleAssign - Checking for saved data. Day: ${selectedDay}, Hour: ${lessonNum}`, savedData);

      if (savedData) {
        // LOAD saved data
        console.log('[Calendar] Loading existing data for this slot');
        calendarState.selectedLessonType = savedData.lessonType;
        calendarState.selectedLessonTypeName = savedData.lessonTypeName;
        calendarState.selectedTeacher = savedData.teacher;
        calendarState.selectedTeacherName = savedData.teacherName;
        calendarState.selectedTeacher2 = savedData.teacher2;
        calendarState.selectedTeacherName2 = savedData.teacherName2;
        calendarState.studentGroup = savedData.studentGroup;
        calendarState.selectedPlace = savedData.placeid;
        calendarState.selectedPlaceName = savedData.placeName;
      } else {
        // CLEAR state for new/empty slot
        console.log('[Calendar] No data for this slot - CLEARING state');
        calendarState.selectedLessonType = null;
        calendarState.selectedLessonTypeName = null;
        calendarState.selectedTeacher = null;
        calendarState.selectedTeacherName = null;
        calendarState.selectedTeacher2 = null;
        calendarState.selectedTeacherName2 = null;
        calendarState.studentGroup = null;
        calendarState.selectedPlace = null;
        calendarState.selectedPlaceName = null;

        // CRITICAL: Clear DOM inputs to prevent bleeding
        const startInput = document.getElementById('calendarTimelineStart');
        const endInput = document.getElementById('calendarTimelineEnd');
        const studentInput = document.getElementById('calendarStudentSearchInput');
        const studentGhost = document.getElementById('calendarStudentGhost');

        if (startInput) startInput.value = '';
        if (endInput) endInput.value = '';
        if (studentInput) studentInput.value = '';
        if (studentGhost) {
          studentGhost.textContent = '';
          studentGhost.classList.remove('is-visible');
        }
      }

      // CRITICAL: Clear dropdown containers deeply to prevent visual flash
      const lessonDropdown = document.getElementById('calendarLessonTypeDropdown');
      const teacherDropdown = document.getElementById('calendarTeacherDropdown');
      const teacher2Dropdown = document.getElementById('calendarTeacher2Dropdown');
      const placeDropdown = document.getElementById('calendarPlaceDropdown');

      if (lessonDropdown) lessonDropdown.innerHTML = '';
      if (teacherDropdown) teacherDropdown.innerHTML = '';
      if (teacher2Dropdown) teacher2Dropdown.innerHTML = '';
      if (placeDropdown) placeDropdown.innerHTML = '';

      // Load lesson types and teachers (they will use the cleared/loaded calendarState to set initial selection)
      loadLessonTypes();
      loadTeachers();
      loadPlaces();
      initOptionalLessonToggle();
    }

    function updateScheduleAssignTitle() {
      const title = document.getElementById('calendarScheduleTitle');
      const subtitle = document.getElementById('calendarScheduleSubtitle');

      if (title && calendarState.selectedClassName) {
        const baseTitle = window.translationManager?.getTranslation('pages.dashboard.assign_calendars.schedule_assign') || 'Órarend hozzárendelése';
        title.textContent = `${baseTitle} - ${calendarState.selectedClassName}`;
      }

      if (subtitle) {
        const dayName = calendarState.selectedDayName || calendarState.selectedDay || '';
        subtitle.textContent = `${dayName} - ${calendarState.selectedHour}. óra`;
      }
    }

    function calendarBackToStep2() {
      if (window.manageCalendarsReturnTarget === 'manage-calendars') {
        window.manageCalendarsReturnTarget = null;
        setManageCalendarsContainerVisible(true);
        window.location.hash = '#manage-calendars';
        hideAllDashboardPages();
        const page = document.getElementById('manage-calendars-page');
        if (page) {
          page.style.display = 'block';
          page.classList.add('active');
        }
        loadManageCalendarsLessons();
        return;
      }
      hideAllCalendarPages();
      const page = document.getElementById('calendar-select-time-page');
      if (page) {
        page.style.display = 'block';
        page.classList.add('active');
      }
    }

    function setManageCalendarsContainerVisible(isVisible) {
      const container = document.querySelector('.manage-calendars-container');
      if (container) {
        container.style.display = isVisible ? 'flex' : 'none';
      }
    }

    // Calendar dropdown instances for Step 3
    let calendarLessonTypeDropdownInstance = null;
    let calendarTeacherDropdownInstance = null;
    let calendarTeacher2DropdownInstance = null;

    // Load lesson types from Cloud Function
    async function loadLessonTypes() {
      console.log('[Calendar] Loading lesson types via Cloud Function...');
      try {
        const result = await window.calendarApiCall('loadLessonTypes', { selectedHour: calendarState.selectedHour });
        const { lessons, defaultTimeline } = result.data;

        // Store lesson data
        const lessonNames = ['Válassz óra típust...'];
        const lessonIds = [null];
        let initialIndex = 0;

        lessons.forEach((lesson, index) => {
          calendarState.lessons[lesson.id] = lesson.name;
          lessonNames.push(lesson.name);
          lessonIds.push(lesson.id);

          // Check if this matches current selection (for editing)
          if (calendarState.selectedLessonType === lesson.id) {
            console.log(`[Calendar] Found matching lesson type: ${lesson.id} at index ${index + 1}`);
            initialIndex = index + 1; // +1 because of "Válassz..." option
          }
        });

        console.log(`[Calendar] Lesson Type Selection - State: ${calendarState.selectedLessonType}, InitialIndex: ${initialIndex}`);

        // Initialize LanguageDropdown for lesson types
        const container = document.getElementById('calendarLessonTypeDropdown');
        if (container && window.LanguageDropdown) {
          container.innerHTML = '';
          calendarLessonTypeDropdownInstance = new window.LanguageDropdown(container, {
            options: lessonNames,
            selectedIndex: initialIndex,
            onChange: (value, index) => {
              calendarState.selectedLessonType = index > 0 ? lessonIds[index] : null;
              calendarState.selectedLessonTypeName = index > 0 ? value : null;
              updateStep3NextButton();
            }
          });
        }

        // Populate timeline inputs with defaults ONLY if we are NOT editing an existing valid timeline
        // or if the inputs are currently empty
        const startInput = document.getElementById('calendarTimelineStart');
        const endInput = document.getElementById('calendarTimelineEnd');
        const selectedDay = calendarState.selectedDay;
        const dayData = calendarState.lessonData[selectedDay] || {};
        const currentData = dayData[calendarState.selectedHour];

        // If editing and we have saved data, use that
        if (currentData && currentData.timelineStart && currentData.timelineEnd) {
          if (startInput) startInput.value = currentData.timelineStart;
          if (endInput) endInput.value = currentData.timelineEnd;
        } else if (defaultTimeline) {
          // Otherwise use defaults from server ONLY if inputs are empty
          if (startInput && defaultTimeline.startTime && !startInput.value) {
            startInput.value = defaultTimeline.startTime;
          }
          if (endInput && defaultTimeline.finishTime && !endInput.value) {
            endInput.value = defaultTimeline.finishTime;
          }
        }

        console.log('[Calendar] Loaded', lessons.length, 'lesson types. Selected index:', initialIndex);
        updateStep3NextButton(); // Ensure button state is updated
      } catch (e) {
        console.error('[Calendar] Failed to load lesson types:', e);
      }
    }

    // Load teachers from Cloud Function
    // Load teachers from Cloud Function
    async function loadTeachers() {
      console.log('[Calendar] Loading teachers via Cloud Function...');
      try {
        const result = await window.calendarApiCall('loadTeachers');
        const { teachers } = result.data;

        const teacherNames = ['Válassz szaktanárt...'];
        const teacherIds = [null]; // Stores normalizedNames
        let initialIndex = 0;

        teachers.forEach((t, index) => {
          calendarState.teachers[t.normalizedName] = t.fullName;
          teacherNames.push(t.fullName);
          teacherIds.push(t.normalizedName); // Store normalizedName

          // Check if this matches current selection (for editing)
          if (calendarState.selectedTeacher === t.normalizedName || calendarState.selectedTeacherName === t.fullName) {
            initialIndex = index + 1;
            calendarState.selectedTeacher = t.normalizedName;
          }
        });

        // Initialize LanguageDropdown for Teacher 1
        const container = document.getElementById('calendarTeacherDropdown');
        if (container && window.LanguageDropdown) {
          container.innerHTML = '';
          calendarTeacherDropdownInstance = new window.LanguageDropdown(container, {
            options: teacherNames,
            selectedIndex: initialIndex,
            onChange: (value, index) => {
              calendarState.selectedTeacher = index > 0 ? teacherIds[index] : null;
              calendarState.selectedTeacherName = index > 0 ? value : null;
              updateStep3NextButton();
            }
          });
        }

        // Initialize LanguageDropdown for Teacher 2
        const container2 = document.getElementById('calendarTeacher2Dropdown');
        if (container2 && window.LanguageDropdown) {
          let initialIndex2 = 0;
          // Validate if persisted teacher2 is still valid
          if (calendarState.selectedTeacher2) {
            const idx = teacherIds.indexOf(calendarState.selectedTeacher2);
            if (idx >= 0) {
              initialIndex2 = idx;
            } else {
              // Teacher not found or null, reset state
              calendarState.selectedTeacher2 = null;
              calendarState.selectedTeacherName2 = null;
            }
          }

          container2.innerHTML = '';
          calendarTeacher2DropdownInstance = new window.LanguageDropdown(container2, {
            options: teacherNames,
            selectedIndex: initialIndex2,
            onChange: (value, index) => {
              calendarState.selectedTeacher2 = index > 0 ? teacherIds[index] : null;
              calendarState.selectedTeacherName2 = index > 0 ? value : null;
              updateStep3NextButton();
            }
          });

          // If we have a second teacher or student group data, show the split view
          const hasStudentGroup = calendarState.studentGroup && calendarState.studentGroup.length > 0;
          // Check input value too?
          const studentInput = document.getElementById('calendarStudentSearchInput');
          //const hasInputValue = studentInput && studentInput.value.trim().length > 0;

          if (initialIndex2 > 0 || hasStudentGroup) {
            calendarShowSplitTeacher();
            if (hasStudentGroup && studentInput && !studentInput.value) {
              studentInput.value = calendarState.studentGroup;
              // Trigger ghost update?
              const ghost = document.getElementById('calendarStudentGhost');
              // if (ghost) ghost.textContent = ''; // clear ghost on init since full value is present
            }
          } else {
            // Reset split view visibility?
            // If we are editing a card with single teacher, we should hide split view
            document.getElementById('calendarSplitContainer').style.display = 'none';
            document.getElementById('calendarAddTeacherBtn').style.display = 'flex';
          }
        }

        console.log('[Calendar] Loaded', teachers.length, 'teachers. Selected index:', initialIndex);
        updateStep3NextButton(); // Ensure button state is updated
      } catch (e) {
        console.error('[Calendar] Failed to load teachers:', e);
      }
    }


    // Calendar dropdown instance for Place
    let calendarPlaceDropdownInstance = null;

    // Load places via Cloud Function
    async function loadPlaces() {
      console.log('[Calendar] Loading places via Cloud Function...');
      try {
        const result = await window.calendarApiCall('loadPlaces');
        const { places } = result.data;

        const placeNames = ['Válassz helyszínt...'];
        const placeIds = [null];
        let initialIndex = 0;

        places.forEach((p, index) => {
          calendarState.places = calendarState.places || {};
          calendarState.places[p.placeid] = p.name;
          placeNames.push(p.name);
          placeIds.push(p.placeid);

          if (calendarState.selectedPlace === p.placeid || calendarState.selectedPlaceName === p.name) {
            initialIndex = index + 1;
            calendarState.selectedPlace = p.placeid;
          }
        });

        const container = document.getElementById('calendarPlaceDropdown');
        if (container && window.LanguageDropdown) {
          container.innerHTML = '';
          calendarPlaceDropdownInstance = new window.LanguageDropdown(container, {
            options: placeNames,
            selectedIndex: initialIndex,
            onChange: (value, index) => {
              calendarState.selectedPlace = index > 0 ? placeIds[index] : null;
              calendarState.selectedPlaceName = index > 0 ? value : null;
              updateStep3NextButton();
            }
          });
        }
        console.log('[Calendar] Loaded', places.length, 'places. Selected index:', initialIndex);
        updateStep3NextButton();
      } catch (e) {
        console.error('[Calendar] Failed to load places:', e);
      }
    }

    // Initialize optional lesson toggle
    function initOptionalLessonToggle() {
      const toggle = document.querySelector('.calendar-optional-lesson-switch');
      if (toggle) {
        // Restore state from calendarState
        if (calendarState.optionalLessonEnabled) {
          toggle.selected = true;
        }
        
        toggle.addEventListener('change', () => {
          calendarState.optionalLessonEnabled = toggle.selected;
          console.log('[Calendar] Optional lesson toggle:', calendarState.optionalLessonEnabled);
        });
      }
    }

    // Show optional lesson popup
    function showOptionalLessonPopup() {
      const popup = document.getElementById('optionalLessonPopup');
      if (!popup) return;

      // Get day name and lesson number
      const dayNames = ['Vasárnap', 'Hétfő', 'Kedd', 'Szerda', 'Csütörtök', 'Péntek', 'Szombat'];
      const dayIndex = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'].indexOf(calendarState.selectedDay);
      const dayName = dayIndex >= 0 ? dayNames[dayIndex] : calendarState.selectedDay;
      const lessonNum = calendarState.selectedHour;
      const lessonTypeName = calendarState.selectedLessonTypeName || 'óra';

      // Update popup description
      const descEl = document.getElementById('optionalLessonPopupDescription');
      if (descEl && window.translationManager) {
        const descText = window.translationManager.getTranslation('pages.dashboard.assign_calendars.optional_lesson_popup_description_dynamic');
        if (descText) {
          descEl.textContent = descText.replace('{day}', dayName).replace('{lesson}', lessonNum).replace('{type}', lessonTypeName);
        } else {
          descEl.textContent = `${dayName} ${lessonNum}. órára hozzáadtál egy ${lessonTypeName} opcionális órát, most hozzárendelhetsz diákokat a nevük alapján, hogy jelezd hogy nekik ez az óra kötelező mint minden más tanóra. Ha nem szeretnéd jelezni ezt, hagyd üresen a beviteli mezőt, és kattints a tovább gombra.`;
        }
      }

      // Clear input
      const input = document.getElementById('optionalLessonStudentInput');
      if (input) {
        input.value = '';
      }
      const ghost = document.getElementById('optionalLessonStudentGhost');
      if (ghost) {
        ghost.textContent = '';
        ghost.classList.remove('is-visible');
      }

      // Setup ghost autocomplete
      if (input && ghost) {
        setupOptionalLessonUserSearch(input, ghost);
      }

      // Show popup
      const scrollArea = document.querySelector('.main-scroll-area') || document.body;
      if (scrollArea) {
        scrollArea.scrollTop = 0;
        scrollArea.classList.add('no-scroll');
        scrollArea.classList.add('popup-active');
      }
      popup.style.display = 'flex';
      
      // Focus input
      setTimeout(() => {
        if (input) input.focus();
      }, 100);
    }

    // Close optional lesson popup
    function closeOptionalLessonPopup() {
      const popup = document.getElementById('optionalLessonPopup');
      if (popup) {
        popup.style.display = 'none';
      }
      const scrollArea = document.querySelector('.main-scroll-area') || document.body;
      if (scrollArea) {
        scrollArea.classList.remove('no-scroll');
        scrollArea.classList.remove('popup-active');
      }
    }

    // Setup ghost autocomplete for optional lesson input
    function setupOptionalLessonUserSearch(input, ghostElement) {
      if (!input || !ghostElement) return;
      loadUserSuggestions();

      function updateUserGhost() {
        if (!input || !ghostElement) return;
        const fullValue = input.value;
        const lastCommaIndex = fullValue.lastIndexOf(',');
        const searchValue = lastCommaIndex >= 0 ? fullValue.slice(lastCommaIndex + 1).trim() : fullValue.trim();
        const suggestion = findUserSuggestion(searchValue);
        applyGhostToElement(ghostElement, fullValue, searchValue, suggestion?.display, input);
      }

      input.addEventListener('input', updateUserGhost);
      input.addEventListener('focus', updateUserGhost);
      input.addEventListener('blur', () => {
        if (ghostElement) {
          ghostElement.textContent = '';
          ghostElement.classList.remove('is-visible');
        }
      });

      input.addEventListener('keydown', async (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          const fullValue = input.value;
          const lastCommaIndex = fullValue.lastIndexOf(',');
          const searchValue = lastCommaIndex >= 0 ? fullValue.slice(lastCommaIndex + 1).trim() : fullValue.trim();

          if (searchValue) {
            const simplifiedName = simplifyName(searchValue);
            await lookupAndReplaceUserName(input, simplifiedName, searchValue);
          }
        } else if (e.key === 'Tab' && !e.shiftKey) {
          // Tab key - if ghost has suggestion, insert it with comma and space
          const fullValue = input.value;
          const lastCommaIndex = fullValue.lastIndexOf(',');
          const searchValue = lastCommaIndex >= 0 ? fullValue.slice(lastCommaIndex + 1).trim() : fullValue.trim();
          const suggestion = findUserSuggestion(searchValue);
          if (suggestion && suggestion.display) {
            e.preventDefault();
            const beforeComma = lastCommaIndex >= 0 ? fullValue.slice(0, lastCommaIndex + 1).trim() : '';
            input.value = beforeComma ? `${beforeComma} ${suggestion.display}, ` : `${suggestion.display}, `;
            updateUserGhost();
          }
        }
      });
    }

    // Handle optional lesson assignment
    async function handleOptionalLessonAssignment() {
      const input = document.getElementById('optionalLessonStudentInput');
      if (!input) return;

      const namesString = input.value.trim();
      
      if (!namesString) {
        // Empty - save as null
        calendarState.optionalLessonStudents = null;
        closeOptionalLessonPopup();
        await proceedWithLessonSave();
        return;
      }

      // Call Cloud Function to lookup students
      try {
        console.log('[Calendar] Looking up optional lesson students:', namesString);
        const result = await window.calendarApiCall('lookupOptionalLessonStudents', {
          fullNames: namesString
        });
        
        const normalizedNames = result.data?.normalizedNames || null;
        calendarState.optionalLessonStudents = normalizedNames;
        
        console.log('[Calendar] Optional lesson students lookup result:', normalizedNames);
      } catch (error) {
        console.error('[Calendar] Error looking up optional lesson students:', error);
        // On error, save as null
        calendarState.optionalLessonStudents = null;
      }

      closeOptionalLessonPopup();
      await proceedWithLessonSave();
    }

    // Update Step 3 next button state
    function updateStep3NextButton() {
      const nextBtn = document.getElementById('calendarStep3Next');
      if (nextBtn) {
        nextBtn.disabled = !calendarState.selectedLessonType || !calendarState.selectedTeacher;
      }
    }

    async function calendarShowLessons() {
      // Check if optional lesson toggle is enabled
      if (calendarState.optionalLessonEnabled) {
        // Show popup instead of proceeding directly
        showOptionalLessonPopup();
        return;
      }

      // Continue with normal flow
      await proceedWithLessonSave();
    }

    async function proceedWithLessonSave() {
      // Get current inputs (might be empty)
      const inputStartTime = document.getElementById('calendarTimelineStart')?.value;
      const inputEndTime = document.getElementById('calendarTimelineEnd')?.value;

      try {
        console.log('[Calendar] Resolving timeline on server...');
        const result = await window.calendarApiCall('validateTimeline', {
          startTime: inputStartTime || null,
          endTime: inputEndTime || null,
          lessonNumber: calendarState.selectedHour,
          lessonType: calendarState.selectedLessonType
        });

        const { startTime, endTime, collision, warning, source } = result.data;
        console.log(`[Calendar] Server Resolved: ${startTime}-${endTime} (Source: ${source})`);

        if (warning) {
          alert(warning); // Simple alert for collision warnings
        }

        // Store resolved lesson data bucketed by day
        const lessonNum = calendarState.selectedHour;
        const selectedDay = calendarState.selectedDay;

        console.log(`[Calendar] Saving lesson: Day=${selectedDay}, Hour=${lessonNum} (type: ${typeof lessonNum})`);

        // Ensure day bucket exists
        if (!calendarState.lessonData[selectedDay]) {
          calendarState.lessonData[selectedDay] = {};
        }

        calendarState.lessonData[selectedDay][lessonNum] = {
          lessonType: calendarState.selectedLessonType,
          lessonTypeName: calendarState.selectedLessonTypeName,
          teacher: calendarState.selectedTeacher,
          teacherName: calendarState.selectedTeacherName,
          teacher2: calendarState.selectedTeacher2 || null,
          teacherName2: calendarState.selectedTeacherName2 || null,
          studentGroup: document.getElementById('calendarStudentSearchInput')?.value || null,
          timelineStart: startTime, // Use server resolved time
          timelineEnd: endTime,      // Use server resolved time
          placeid: calendarState.selectedPlace || null,
          placeName: calendarState.selectedPlaceName || null,
          optionalLessonStudents: calendarState.optionalLessonStudents || null, // Store optional lesson students
          optionalClass: calendarState.optionalLessonEnabled === true
        };

        console.log('[Calendar] Updated state snapshot:', JSON.parse(JSON.stringify(calendarState.lessonData)));

        sessionStorage.setItem('calendar_lessonData', JSON.stringify(calendarState.lessonData));

        // Track this day as edited in current session
        let editedDays = [];
        try {
          const stored = sessionStorage.getItem('calendar_editedDays');
          if (stored) editedDays = JSON.parse(stored);
        } catch (e) { editedDays = []; }
        if (!editedDays.includes(selectedDay)) {
          editedDays.push(selectedDay);
          sessionStorage.setItem('calendar_editedDays', JSON.stringify(editedDays));
        }

        if (isManageCalendarsEditFlow()) {
          await calendarApplyChanges(true);
          return;
        }

        hideAllCalendarPages();
        const page = document.getElementById('calendar-lessons-page');
        if (page) {
          page.style.display = 'block';
          page.classList.add('active');
        }

        // Update title
        updateLessonPageHeader();

        // Populate lesson cards
        await fetchDayLessons(calendarState.selectedDay); // Fetch latest from server
        updateModifiedDaysDropdown(); // Use sessionStorage-based dropdown
        initResetDayDropdown(); // Initialize reset dropdown
        populateLessonCards();

      } catch (e) {
        console.error('[Calendar] Failed to resolve timeline:', e);
        alert('Hiba történt az idővonal ellenőrzésekor. Kérlek próbáld újra.');
      }
    }

    function isManageCalendarsEditFlow() {
      return window.manageCalendarsReturnTarget === 'manage-calendars' && calendarState.manageCalendarsEditMode === true;
    }

    async function fetchModifiedDays() {
      try {
        const result = await window.calendarApiCall('getModifiedDays');
        calendarState.serverModifiedDays = result.data.days || [];
        console.log('[Calendar] Server modified days:', calendarState.serverModifiedDays);
        updateModifiedDaysDropdown();
      } catch (e) {
        console.error('[Calendar] Failed to fetch modified days:', e);
      }
    }

    // Load lessons for a specific day from server
    async function fetchDayLessons(day) {
      if (!day) return;
      try {
        console.log(`[Calendar] Fetching lessons for ${day}...`);
        const result = await window.calendarApiCall('getLessonCards', { day, sessionId: calendarState.sessionId });
        const { cards } = result.data;

        if (cards && cards.length > 0) {
          if (!calendarState.lessonData[day]) {
            calendarState.lessonData[day] = {};
          }

          cards.forEach(card => {
            // Map card data back to state structure
            if (card.typeName !== '-') { // Only saved lessons
              // Use existing local state if available (to avoid overwriting user edits not yet saved? No, server is truth)
              // But usually we want to merge. Server < Local < Input
              // If we just saved, Local is accurate. 
              // If we reloaded, Server is accurate.
              // We should probably ONLY overwrite if we don't have local changes?
              // But collision logic overwrites anyway.
              const lessonNum = card.number;

              // Only update if not currently being edited? 
              // Actually, overwrite everything to be safe and consistent with "Loading".

              calendarState.lessonData[day][lessonNum] = {
                lessonType: card.lessonType,
                lessonTypeName: card.typeName,
                teacher: card.teacherId || card.teacher, // Use ID if available
                teacherName: card.teacher,
                teacher2: card.teacher2,
                // teacherName2? 
                studentGroup: card.studentGroup,
                timelineStart: card.startTime,
                timelineEnd: card.finishTime,
                optionalLessonStudents: card.optionalLessonStudents || null // Load optional lesson students
              };
            }
          });
          console.log(`[Calendar] Fetched and updated ${cards.length} cards for ${day}`);
          // Update session storage
          sessionStorage.setItem('calendar_lessonData', JSON.stringify(calendarState.lessonData));
        }
      } catch (e) {
        console.error('[Calendar] Failed to fetch lessons:', e);
      }
    }

    function updateLessonPageHeader() {
      const title = document.getElementById('calendarLessonsTitle');
      const dayNames = {
        monday: 'Hétfő', tuesday: 'Kedd', wednesday: 'Szerda',
        thursday: 'Csütörtök', friday: 'Péntek'
      };
      if (title) {
        title.textContent = `Órák - ${dayNames[calendarState.selectedDay] || calendarState.selectedDay}`;
      }

      // Update day selector if it exists
      updateModifiedDaysDropdown();
    }

    async function populateLessonCards() {
      const cards = document.querySelectorAll('.calendar-lesson-card');
      const selectedDay = calendarState.selectedDay;
      const dayData = calendarState.lessonData[selectedDay] || {};

      // Get current user's normalizedName for checking if lesson is mandatory for them
      let currentUserNormalizedName = null;
      try {
        currentUserNormalizedName = await getCurrentUserNormalizedName();
      } catch (error) {
        console.error('[Calendar] Error getting current user normalizedName:', error);
      }

      for (const card of cards) {
        const lessonNum = parseInt(card.dataset.lesson);
        const data = dayData[lessonNum];

        const typeValue = card.querySelector('.lesson-type-value');
        const teacherValue = card.querySelector('.lesson-teacher-value');
        const placeValue = card.querySelector('.lesson-place-value');
        const timelineValue = card.querySelector('.lesson-timeline-value');
        const optionalIndicator = card.querySelector('.calendar-lesson-optional-indicator');
        const optionalRow = card.querySelector('.calendar-lesson-optional-row');
        const optionalStudentsValue = card.querySelector('.lesson-optional-students-value');

        if (data) {
          card.classList.remove('incomplete');
          if (typeValue) typeValue.textContent = data.lessonTypeName || '-';
          if (teacherValue) {
            let tText = data.teacherName || data.teacher || '-';
            if (data.teacherName2) {
              tText += ` vagy ${data.teacherName2}`;
            }
            teacherValue.textContent = tText;
          }
          if (placeValue) {
            placeValue.textContent = data.placeName || '-';
          }
          if (timelineValue) {
            timelineValue.textContent = (data.timelineStart && data.timelineEnd)
              ? `${data.timelineStart} - ${data.timelineEnd}`
              : '-';
          }

          // Handle optional lesson display
          // Check if optionalLessonStudents exists and is not empty
          const hasOptionalStudents = data.optionalLessonStudents && 
            typeof data.optionalLessonStudents === 'string' && 
            data.optionalLessonStudents.trim().length > 0;
          
          console.log(`[Calendar] Lesson ${lessonNum} optionalLessonStudents:`, data.optionalLessonStudents, 'hasOptionalStudents:', hasOptionalStudents);
          
          if (hasOptionalStudents) {
            // Show optional indicator
            if (optionalIndicator) {
              optionalIndicator.style.display = 'inline';
              optionalIndicator.textContent = '?';
              console.log(`[Calendar] Showing optional indicator for lesson ${lessonNum}`);
            } else {
              console.warn(`[Calendar] Optional indicator element not found for lesson ${lessonNum}`);
            }

            // Load and display optional students
            if (optionalRow && optionalStudentsValue) {
              optionalRow.style.display = 'block';
              try {
                const result = await window.calendarApiCall('getOptionalLessonStudents', {
                  normalizedNames: data.optionalLessonStudents
                });
                const fullNames = result.data?.fullNames || [];
                optionalStudentsValue.textContent = fullNames.join(', ') || '-';
              } catch (error) {
                console.error('[Calendar] Error loading optional lesson students:', error);
                optionalStudentsValue.textContent = '-';
              }
            }

            // Check if current user is in the list (mandatory for them)
            const normalizedNames = (data.optionalLessonStudents || '').split(',').map(n => n.trim()).filter(n => n.length > 0);
            const isMandatoryForUser = currentUserNormalizedName && normalizedNames.includes(currentUserNormalizedName);

            // Add hover tooltip (only if not already added)
            if (optionalIndicator && !optionalIndicator.dataset.listenersAdded) {
              optionalIndicator.dataset.listenersAdded = 'true';
              optionalIndicator.title = isMandatoryForUser
                ? (window.translationManager?.getTranslation('pages.dashboard.assign_calendars.optional_lesson_mandatory_for_you') || 'Számodra rendes tanítási óra')
                : (window.translationManager?.getTranslation('pages.dashboard.assign_calendars.optional_lesson_hover') || 'Opcionális óra');
              
              optionalIndicator.addEventListener('mouseenter', () => {
                if (isMandatoryForUser) {
                  // Show "Számodra rendes tanítási óra" message
                  const tooltip = document.createElement('div');
                  tooltip.className = 'calendar-optional-tooltip';
                  tooltip.textContent = window.translationManager?.getTranslation('pages.dashboard.assign_calendars.optional_lesson_mandatory_for_you') || 'Számodra rendes tanítási óra';
                  card.appendChild(tooltip);
                } else {
                  // Replace teacher and place with "Opcionális óra"
                  const originalTeacher = teacherValue?.textContent || '';
                  const originalPlace = placeValue?.textContent || '';
                  card.dataset.originalTeacher = originalTeacher;
                  card.dataset.originalPlace = originalPlace;
                  if (teacherValue) teacherValue.textContent = window.translationManager?.getTranslation('pages.dashboard.assign_calendars.optional_lesson_label') || 'Opcionális óra';
                  if (placeValue) placeValue.textContent = window.translationManager?.getTranslation('pages.dashboard.assign_calendars.optional_lesson_label') || 'Opcionális óra';
                }
              });

              optionalIndicator.addEventListener('mouseleave', () => {
                if (!isMandatoryForUser) {
                  // Restore original teacher and place
                  if (card.dataset.originalTeacher && teacherValue) {
                    teacherValue.textContent = card.dataset.originalTeacher;
                  }
                  if (card.dataset.originalPlace && placeValue) {
                    placeValue.textContent = card.dataset.originalPlace;
                  }
                }
                const tooltip = card.querySelector('.calendar-optional-tooltip');
                if (tooltip) tooltip.remove();
              });
            } else if (optionalIndicator && optionalIndicator.dataset.listenersAdded) {
              // Update title if already has listeners
              optionalIndicator.title = isMandatoryForUser
                ? (window.translationManager?.getTranslation('pages.dashboard.assign_calendars.optional_lesson_mandatory_for_you') || 'Számodra rendes tanítási óra')
                : (window.translationManager?.getTranslation('pages.dashboard.assign_calendars.optional_lesson_hover') || 'Opcionális óra');
            }
          } else {
            // Hide optional indicator and row
            if (optionalIndicator) optionalIndicator.style.display = 'none';
            if (optionalRow) optionalRow.style.display = 'none';
          }
        } else {
          card.classList.add('incomplete');
          if (typeValue) typeValue.textContent = '-';
          if (teacherValue) teacherValue.textContent = '-';
          if (placeValue) placeValue.textContent = '-';
          if (timelineValue) timelineValue.textContent = '-';
          if (optionalIndicator) optionalIndicator.style.display = 'none';
          if (optionalRow) optionalRow.style.display = 'none';
        }

        // Add click handler to edit lesson
        card.onclick = () => editLessonCard(lessonNum);
      }
    }

    // Get current user's normalizedName
    async function getCurrentUserNormalizedName() {
      try {
        const { getAuth } = await import("https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js");
        const { getFirestore, collection, getDocs } = await import("https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js");
        const auth = getAuth(window.firebaseApp || window.app);
        if (!auth.currentUser) return null;

        const db = window.db || getFirestore(window.firebaseApp || window.app);
        
        // Look up in usrlookup/names - find collection where userId matches
        const namesDocRef = collection(db, 'usrlookup', 'names');
        // We need to list all subcollections - this requires a Cloud Function
        // For now, use Cloud Function to get normalizedName
        try {
          const result = await window.calendarApiCall('getCurrentUserNormalizedName');
          return result.data?.normalizedName || null;
        } catch (error) {
          console.error('[Calendar] Error getting normalizedName from Cloud Function:', error);
          return null;
        }
      } catch (error) {
        console.error('[Calendar] Error getting current user normalizedName:', error);
        return null;
      }
    }

    function editLessonCard(lessonNum) {
      // Set selected hour to this lesson
      calendarState.selectedHour = lessonNum;
      sessionStorage.setItem('calendar_hour', lessonNum);

      // Populate local state from saved data so dropdowns are pre-selected correctly
      const selectedDay = calendarState.selectedDay;
      const dayData = calendarState.lessonData[selectedDay] || {};
      const savedData = dayData[lessonNum];

      console.log(`[Calendar] Edit Lesson ${lessonNum} (type: ${typeof lessonNum}). Data keys:`, Object.keys(dayData));

      if (savedData) {
        console.log(`[Calendar] Edit Lesson ${lessonNum}: loaded saved data`, savedData);
        calendarState.selectedLessonType = savedData.lessonType;
        calendarState.selectedLessonTypeName = savedData.lessonTypeName;
        calendarState.selectedTeacher = savedData.teacher;
        calendarState.selectedTeacherName = savedData.teacherName;
        calendarState.selectedTeacher2 = savedData.teacher2;
        calendarState.selectedTeacherName2 = savedData.teacherName2;
        calendarState.studentGroup = savedData.studentGroup;
        calendarState.optionalLessonEnabled = !!savedData.optionalLessonStudents;
        calendarState.optionalLessonStudents = savedData.optionalLessonStudents || null;
      } else {
        console.log(`[Calendar] Edit Lesson ${lessonNum}: no saved data, FULL RESET`);
        calendarState.selectedLessonType = null;
        calendarState.selectedLessonTypeName = null;
        calendarState.selectedTeacher = null;
        calendarState.selectedTeacherName = null;
        calendarState.selectedTeacher2 = null;
        calendarState.selectedTeacherName2 = null;
        calendarState.studentGroup = null;
        calendarState.optionalLessonEnabled = false;
        calendarState.optionalLessonStudents = null;
      }

      // Clear timeline inputs so defaults can be loaded
      const startInput = document.getElementById('calendarTimelineStart');
      const endInput = document.getElementById('calendarTimelineEnd');
      if (startInput) startInput.value = '';
      if (endInput) endInput.value = '';

      // Clear student search input to prevent data leak
      const studentInput = document.getElementById('calendarStudentSearchInput');
      const studentGhost = document.getElementById('calendarStudentGhost');
      if (studentInput) studentInput.value = '';
      if (studentGhost) {
        studentGhost.textContent = '';
        studentGhost.classList.remove('is-visible');
      }

      // Clear dropdown containers to prevent stale data flash
      const lessonDropdown = document.getElementById('calendarLessonTypeDropdown');
      const teacherDropdown = document.getElementById('calendarTeacherDropdown');
      if (lessonDropdown) lessonDropdown.innerHTML = '';
      if (teacherDropdown) teacherDropdown.innerHTML = '';

      // Go to Step 3 to edit this lesson
      hideAllCalendarPages();
      const page = document.getElementById('calendar-schedule-assign-page');
      if (page) {
        page.style.display = 'block';
        page.classList.add('active');
      }

      // Update title with the selected hour
      updateScheduleAssignTitle();

      // Load dropdowns
      loadLessonTypes();
      loadTeachers();
      loadPlaces();
      initOptionalLessonToggle();
    }

    function deleteLessonCard(lessonNum) {
      const selectedDay = calendarState.selectedDay;
      if (calendarState.lessonData[selectedDay]) {
        delete calendarState.lessonData[selectedDay][lessonNum];
        sessionStorage.setItem('calendar_lessonData', JSON.stringify(calendarState.lessonData));
        populateLessonCards();
        updateModifiedDaysDropdown();
      }
    }

    function updateModifiedDaysDropdown() {
      const container = document.getElementById('calendarModifiedDaysDropdown');
      if (!container || !window.LanguageDropdown) return;

      const dayNames = {
        monday: 'Hétfő', tuesday: 'Kedd', wednesday: 'Szerda',
        thursday: 'Csütörtök', friday: 'Péntek'
      };

      // Get edited days from sessionStorage (current session only)
      let editedDays = [];
      try {
        const stored = sessionStorage.getItem('calendar_editedDays');
        if (stored) editedDays = JSON.parse(stored);
      } catch (e) { editedDays = []; }

      // Ensure current day is included
      const currentDay = calendarState.selectedDay;
      const allDays = Array.from(new Set([...editedDays, currentDay]));

      // Filter and sort
      const validDays = allDays.filter(d => ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'].includes(d));
      const dayOrder = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'];
      validDays.sort((a, b) => dayOrder.indexOf(a) - dayOrder.indexOf(b));

      console.log('[Calendar] Edited days (session):', validDays);

      if (validDays.length > 1) {
        container.style.display = 'block';
        container.style.opacity = '1';
        container.style.pointerEvents = 'auto';
        container.innerHTML = '';

        const options = validDays.map(day => dayNames[day] || day);
        const selectedIndex = validDays.indexOf(currentDay);

        console.log('[Calendar] Dropdown options:', options, 'selectedIndex:', selectedIndex);

        new window.LanguageDropdown(container, {
          options: options,
          selectedIndex: selectedIndex,
          onChange: (value, index) => {
            const newDay = validDays[index];
            if (newDay !== calendarState.selectedDay) {
              console.log('[Calendar] Switching day to:', newDay);
              calendarState.selectedDay = newDay;
              sessionStorage.setItem('calendar_day', newDay);
              updateLessonPageHeader();
              fetchDayLessons(newDay).then(() => {
                populateLessonCards();
              });
            }
          }
        });
      } else if (validDays.length === 1) {
        container.style.display = 'block';
        container.style.opacity = '0.5';
        container.style.pointerEvents = 'none';
        container.innerHTML = '';
        const options = [dayNames[validDays[0]] || validDays[0]];
        new window.LanguageDropdown(container, {
          options: options,
          selectedIndex: 0,
          onChange: () => { }
        });
      } else {
        container.style.display = 'none';
      }
    }

    // Reset day dropdown state
    let calendarResetSelectedDay = null;

    function initResetDayDropdown() {
      const container = document.getElementById('calendarResetDayDropdown');
      if (!container || !window.LanguageDropdown) return;

      const dayNames = {
        monday: 'Hétfő', tuesday: 'Kedd', wednesday: 'Szerda',
        thursday: 'Csütörtök', friday: 'Péntek'
      };

      // Get edited days from sessionStorage
      let editedDays = [];
      try {
        const stored = sessionStorage.getItem('calendar_editedDays');
        if (stored) editedDays = JSON.parse(stored);
      } catch (e) { editedDays = []; }

      const dayOrder = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'];
      const validDays = editedDays.filter(d => dayOrder.includes(d));
      validDays.sort((a, b) => dayOrder.indexOf(a) - dayOrder.indexOf(b));

      if (validDays.length === 0) {
        container.innerHTML = '<span style="color: #E5FDCB;">Nincs szerkesztett nap</span>';
        calendarResetSelectedDay = null;
        return;
      }

      container.innerHTML = '';

      const options = validDays.map(day => dayNames[day] || day);
      calendarResetSelectedDay = validDays[0];

      new window.LanguageDropdown(container, {
        options: options,
        selectedIndex: 0,
        onChange: (value, index) => {
          calendarResetSelectedDay = validDays[index];
        }
      });
    }

    function openResetDayPopup() {
      initResetDayDropdown();
      const popup = document.getElementById('calendarResetPopup');
      if (popup) popup.classList.add('active');
    }

    function closeResetDayPopup() {
      const popup = document.getElementById('calendarResetPopup');
      if (popup) popup.classList.remove('active');
    }

    async function confirmResetDay() {
      if (!calendarResetSelectedDay) return;

      const dayNames = {
        monday: 'Hétfő', tuesday: 'Kedd', wednesday: 'Szerda',
        thursday: 'Csütörtök', friday: 'Péntek'
      };
      const dayName = dayNames[calendarResetSelectedDay] || calendarResetSelectedDay;

      try {
        console.log('[Calendar] Resetting day:', calendarResetSelectedDay);
        await window.calendarApiCall('clearTempLessons', { day: calendarResetSelectedDay });

        // Remove from local state
        delete calendarState.lessonData[calendarResetSelectedDay];
        sessionStorage.setItem('calendar_lessonData', JSON.stringify(calendarState.lessonData));

        // Update edited days
        let editedDays = [];
        try {
          const stored = sessionStorage.getItem('calendar_editedDays');
          if (stored) editedDays = JSON.parse(stored);
        } catch (e) { editedDays = []; }
        editedDays = editedDays.filter(d => d !== calendarResetSelectedDay);
        sessionStorage.setItem('calendar_editedDays', JSON.stringify(editedDays));

        // Close popup
        closeResetDayPopup();

        // Refresh UI
        updateModifiedDaysDropdown();

        // If we deleted current day, switch to another
        if (calendarState.selectedDay === calendarResetSelectedDay && editedDays.length > 0) {
          calendarState.selectedDay = editedDays[0];
          updateLessonPageHeader();
          await fetchDayLessons(editedDays[0]);
        }
        populateLessonCards();

        if (window.showToastDirectly) {
          window.showToastDirectly('Siker', `${dayName} nap órái törölve!`, 'positive');
        }
      } catch (e) {
        console.error('[Calendar] Failed to reset day:', e);
        closeResetDayPopup();
        alert('Hiba történt a törléskor!');
      }
    }

    function addLessonCard() {
      // Go back to Step 2 (Válassz időpontot) to select a new hour
      hideAllCalendarPages();
      const page = document.getElementById('calendar-select-time-page');
      if (page) {
        page.style.display = 'block';
        page.classList.add('active');
      }
      // Re-initialize dropdowns for Step 2
      initStep2Dropdowns();
    }

    function calendarAddVariation() {
      const dayDropdown = document.getElementById('calendarDayDropdown');
      const hourDropdown = document.getElementById('calendarHourDropdown');

      calendarState.selectedDay = dayDropdown?.value;
      calendarState.selectedHour = hourDropdown?.value;

      hideAllCalendarPages();
      const page = document.getElementById('calendar-variation-page');
      if (page) page.classList.add('active');

      // Update title
      const title = document.getElementById('calendarVariationTitle');
      const dayNames = {
        monday: 'Hétfő', tuesday: 'Kedd', wednesday: 'Szerda',
        thursday: 'Csütörtök', friday: 'Péntek'
      };
      if (title) {
        const dayName = dayNames[calendarState.selectedDay] || calendarState.selectedDay;
        title.textContent = `Variáció hozzáadása - ${dayName} ${calendarState.selectedHour}. óra`;
      }

      // Load dropdowns
      loadLessonTypes();
      loadTeachers();
      loadPlaces();
      initOptionalLessonToggle();
    }

    function calendarApplyVariation() {
      // Gather variation data
      const lessonType = document.getElementById('variationLessonTypeDropdown')?.value;
      const teacher = document.getElementById('variationTeacherDropdown')?.value;
      const repeatCount = document.getElementById('variationRepeatCount')?.value || '1';
      const repeatType = document.getElementById('variationRepeatType')?.value;
      const dateSequence = document.getElementById('variationDateSequence')?.value;

      if (!lessonType || !repeatType) {
        console.warn('[Calendar] Variation missing required fields');
        return;
      }

      // Format: week_1, month_2, etc.
      const repeatRule = `${repeatType}_${repeatCount}`;

      calendarState.variationData = {
        lessonType,
        lessonTypeName: calendarState.lessons[lessonType] || lessonType,
        teacher,
        repeatRule,
        dateSequence,
        day: calendarState.selectedDay,
        hour: calendarState.selectedHour
      };

      // Show confirmation popup
      showVariationConfirmPopup();
    }

    function showVariationConfirmPopup() {
      const popup = document.getElementById('calendarVariationPopup');
      const confirmText = document.getElementById('variationConfirmText');

      if (confirmText && calendarState.variationData) {
        const v = calendarState.variationData;
        const dayNames = {
          monday: 'Hétfő', tuesday: 'Kedd', wednesday: 'Szerda',
          thursday: 'Csütörtök', friday: 'Péntek'
        };
        const dayName = dayNames[v.day] || v.day;

        confirmText.innerHTML = `
          <strong>${dayName} ${v.hour}. óra</strong><br>
          Óra típusa: ${v.lessonTypeName}<br>
          Ismétlődés: ${v.repeatRule}<br>
          ${v.dateSequence ? `Időszak: ${v.dateSequence}` : ''}
        `;
      }

      if (popup) popup.style.display = 'flex';
    }

    function closeVariationPopup() {
      const popup = document.getElementById('calendarVariationPopup');
      if (popup) popup.style.display = 'none';
    }

    function confirmVariation() {
      console.log('[Calendar] Variation confirmed:', calendarState.variationData);
      closeVariationPopup();

      // Go back to select time
      calendarBackToStep2();
    }

    async function calendarApplyChanges(returnToManageCalendars = false) {
      console.log('[Calendar] Applying changes...');
      console.log('[Calendar] Lesson data:', calendarState.lessonData);
      console.log('[Calendar] Class ID:', calendarState.selectedClassId);

      // Show loading popup
      const popup = document.getElementById('calendarPublishPopup');
      if (popup) popup.classList.add('active');

      const nextBtn = document.getElementById('calendarStep4Next');
      if (nextBtn) {
        nextBtn.disabled = true;
      }

      try {
        // Step 1: Save all data to temp first
        const savePayload = {
          classId: calendarState.selectedClassId,
          className: calendarState.selectedClassName,
          day: calendarState.selectedDay,
          lessons: calendarState.lessonData,
          sessionId: calendarState.sessionId
        };

        await window.calendarApiCall('saveLessonAssignment', savePayload);
        console.log('[Calendar] Saved to temp successfully');

        // Step 2: Publish to class
        const publishResult = await window.calendarApiCall('publishTimetable', {
          classId: calendarState.selectedClassId
        });
        console.log('[Calendar] Published successfully:', publishResult.data);

        // Hide popup
        if (popup) popup.classList.remove('active');

        // Clear local state
        calendarState.lessonData = {};
        calendarState.sessionId = null;
        sessionStorage.removeItem('calendar_editedDays');
        sessionStorage.removeItem('calendar_lessonData');

        if (returnToManageCalendars) {
          window.manageCalendarsReturnTarget = null;
          calendarState.manageCalendarsEditMode = false;
          window.location.hash = '#manage-calendars';
          hideAllDashboardPages();
          const managePage = document.getElementById('manage-calendars-page');
          if (managePage) {
            managePage.style.display = 'block';
            managePage.classList.add('active');
          }
          setManageCalendarsContainerVisible(true);
          loadManageCalendarsLessons();
        } else {
          // Redirect to dashboard
          window.location.href = 'dashboard.html';
          hideAllCalendarPages();
        }

        // Show success toast
        if (window.showToastDirectly) {
          window.showToastDirectly(
            'Siker',
            'Órarend publikálva!',
            'positive'
          );
        }

      } catch (error) {
        console.error('[Calendar] Publish failed:', error);

        // Hide popup
        if (popup) popup.classList.remove('active');

        const msg = error.message || 'Ismeretlen hiba';
        if (window.showToastDirectly) {
          window.showToastDirectly('Hiba', 'Hiba a publikálás során: ' + msg, 'danger');
        } else {
          alert('Hiba a publikálás során: ' + msg);
        }

        if (nextBtn) {
          nextBtn.disabled = false;
        }
      }
    }

    // Timeline auto-calculation (+45 min)
    document.addEventListener('DOMContentLoaded', () => {
      const startInput = document.getElementById('calendarTimelineStart');
      const endInput = document.getElementById('calendarTimelineEnd');

      if (startInput && endInput) {
        startInput.addEventListener('input', () => {
          const time = startInput.value;
          if (/^\d{2}:\d{2}$/.test(time)) {
            const [hours, minutes] = time.split(':').map(Number);
            const endMinutes = minutes + 45;
            const endHours = hours + Math.floor(endMinutes / 60);
            const finalMinutes = endMinutes % 60;
            endInput.value = `${String(endHours).padStart(2, '0')}:${String(finalMinutes).padStart(2, '0')}`;
          }
        });
      }
    });

    function publishNews() {
      // Legacy function - now redirects to showNewsPublishForm
      showNewsPublishForm();
    }

    // Store selected image file
    let selectedNewsImage = null;

    function showNewsPublishForm() {
      console.log('[Dashboard] Showing news publish form');
      const typeSelection = document.getElementById('publish-type-selection');
      const newsForm = document.getElementById('news-publish-form');
      const backBtn = document.getElementById('dashboardBackBtn');
      if (typeSelection) typeSelection.style.display = 'none';
      if (newsForm) newsForm.style.display = 'flex';
      // Activate back button
      if (backBtn) {
        backBtn.style.opacity = '1';
        backBtn.style.pointerEvents = 'auto';
        backBtn.onclick = hideNewsPublishForm;
      }
      // Clear previous inputs
      clearNewsForm();
    }

    function hideNewsPublishForm() {
      console.log('[Dashboard] Hiding news publish form');
      const typeSelection = document.getElementById('publish-type-selection');
      const newsForm = document.getElementById('news-publish-form');
      const backBtn = document.getElementById('dashboardBackBtn');
      if (typeSelection) typeSelection.style.display = 'flex';
      if (newsForm) newsForm.style.display = 'none';
      // Deactivate back button
      if (backBtn) {
        backBtn.style.opacity = '0.5';
        backBtn.style.pointerEvents = 'none';
        backBtn.onclick = null;
      }
      clearNewsForm();
    }

    function clearNewsForm() {
      const titleInput = document.getElementById('newsTitle');
      const linkInput = document.getElementById('newsLink');
      const authorInput = document.getElementById('newsAuthor');
      const contentInput = document.getElementById('newsContent');
      const dateInput = document.getElementById('newsDate');
      const previewImg = document.getElementById('newsPreviewImage');

      if (titleInput) { titleInput.value = ''; titleInput.classList.remove('error'); }
      if (linkInput) { linkInput.value = ''; linkInput.classList.remove('error'); }
      if (authorInput) { authorInput.value = ''; authorInput.classList.remove('error'); }
      if (contentInput) { contentInput.value = ''; contentInput.classList.remove('error'); }
      if (dateInput) { dateInput.value = ''; }
      if (previewImg) previewImg.src = 'assets/general/image_placeholder_blue.svg';
      selectedNewsImage = null;
    }

    function triggerNewsImageUpload() {
      const fileInput = document.getElementById('newsImageInput');
      if (fileInput) fileInput.click();
    }

    // Image input change handler
    document.addEventListener('DOMContentLoaded', () => {
      const fileInput = document.getElementById('newsImageInput');
      if (fileInput) {
        fileInput.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (file && file.type.startsWith('image/')) {
            selectedNewsImage = file;
            const previewImg = document.getElementById('newsPreviewImage');
            if (previewImg) {
              const reader = new FileReader();
              reader.onload = (e) => {
                previewImg.src = e.target.result;
              };
              reader.readAsDataURL(file);
            }
            console.log('[Dashboard] Image selected:', file.name);
          }
        });
      }
    });

    function showNewsPublishPopup() {
      const popup = document.getElementById('newsPublishPopup');
      if (popup) popup.classList.add('active');
    }

    function hideNewsPublishPopup() {
      const popup = document.getElementById('newsPublishPopup');
      if (popup) popup.classList.remove('active');
    }

    function getTranslation(key, fallback) {
      try {
        return window.translationManager?.getTranslation(key) || fallback;
      } catch {
        return fallback;
      }
    }

    function showInputError(inputId, errorKey, fallbackMsg) {
      const input = document.getElementById(inputId);
      if (input) input.classList.add('error');

      // Show toast notification
      if (window.showToastDirectly) {
        window.showToastDirectly(
          getTranslation('youhub.suggestions.notifications.types.error', 'Hiba'),
          getTranslation(errorKey, fallbackMsg),
          'danger'
        );
      } else {
        alert(getTranslation(errorKey, fallbackMsg));
      }
    }

    function clearInputErrors() {
      ['newsTitle', 'newsLink', 'newsAuthor', 'newsContent'].forEach(id => {
        const input = document.getElementById(id);
        if (input) input.classList.remove('error');
      });
    }

    // HTML tag detection regex
    const htmlTagRegex = /<[^>]*>/;

    function validateNewsInputs() {
      const title = document.getElementById('newsTitle')?.value?.trim() || '';
      const link = document.getElementById('newsLink')?.value?.trim() || '';
      const author = document.getElementById('newsAuthor')?.value?.trim() || '';
      const content = document.getElementById('newsContent')?.value?.trim() || '';

      clearInputErrors();

      // Title validation
      if (title.length < 3) {
        showInputError('newsTitle', 'pages.dashboard.news_publish.error.title_too_short', 'A cím túl rövid (min. 3 karakter)');
        return false;
      }
      if (title.length > 120) {
        showInputError('newsTitle', 'pages.dashboard.news_publish.error.title_too_long', 'A cím túl hosszú (max. 120 karakter)');
        return false;
      }
      if (htmlTagRegex.test(title)) {
        showInputError('newsTitle', 'pages.dashboard.news_publish.error.title_html', 'A cím nem tartalmazhat HTML kódot');
        return false;
      }

      // Author validation  
      if (!author) {
        showInputError('newsAuthor', 'pages.dashboard.news_publish.error.author_required', 'A szerző megadása kötelező');
        return false;
      }
      if (htmlTagRegex.test(author)) {
        showInputError('newsAuthor', 'pages.dashboard.news_publish.error.author_html', 'A szerző nem tartalmazhat HTML kódot');
        return false;
      }

      // Content HTML check
      if (htmlTagRegex.test(content)) {
        showInputError('newsContent', 'pages.dashboard.news_publish.error.content_html', 'A tartalom nem tartalmazhat HTML kódot');
        return false;
      }

      // Link validation (if provided)
      if (link && htmlTagRegex.test(link)) {
        showInputError('newsLink', 'pages.dashboard.news_publish.error.link_html', 'A link nem tartalmazhat HTML kódot');
        return false;
      }

      // Image validation
      if (!selectedNewsImage) {
        showInputError('newsImageInput', 'pages.dashboard.news_publish.error.image_required', 'Kérlek tölts fel egy képet');
        return false;
      }

      return true;
    }

    async function submitNewsPublish() {
      console.log('[Dashboard] Submitting news...');

      // Validate inputs
      if (!validateNewsInputs()) {
        return;
      }

      const title = document.getElementById('newsTitle')?.value?.trim();
      const link = document.getElementById('newsLink')?.value?.trim();
      const author = document.getElementById('newsAuthor')?.value?.trim();
      const content = document.getElementById('newsContent')?.value?.trim();
      const dateInput = document.getElementById('newsDate')?.value;

      // Show loading popup
      showNewsPublishPopup();

      try {
        // Import functions for europe-west3 region
        const { getFunctions, httpsCallable } = await import("https://www.gstatic.com/firebasejs/11.10.0/firebase-functions.js");
        const functionsWest3 = getFunctions(window.firebaseApp, 'europe-west3');

        // Step 1: Get signed URL for image upload
        console.log('[Dashboard] Getting signed upload URL...');
        const getUploadUrl = httpsCallable(functionsWest3, 'getNewsUploadUrl');

        // Generate a temporary newsId (will be confirmed by server)
        const tempNewsId = Date.now().toString();

        const uploadUrlResult = await getUploadUrl({
          contentType: selectedNewsImage.type,
          newsId: tempNewsId
        });

        const { uploadUrl, fileName } = uploadUrlResult.data;
        console.log('[Dashboard] Got signed URL, uploading image...');

        // Step 2: Upload image directly to Storage via signed URL
        const uploadResponse = await fetch(uploadUrl, {
          method: 'PUT',
          headers: {
            'Content-Type': selectedNewsImage.type
          },
          body: selectedNewsImage
        });

        if (!uploadResponse.ok) {
          throw new Error('Image upload failed');
        }

        // Step 3: Get the public URL of the uploaded image
        const bucket = 'eu2k-hub.firebasestorage.app';
        const imageUrl = `https://firebasestorage.googleapis.com/v0/b/${bucket}/o/${encodeURIComponent(fileName)}?alt=media`;
        console.log('[Dashboard] Image uploaded, publishing news...');

        // Step 4: Call publishNews function with optional custom date
        const publishNewsFunc = httpsCallable(functionsWest3, 'publishNews');
        const publishResult = await publishNewsFunc({
          title: title,
          author: author,
          desc: content,
          link: link,
          imageUrl: imageUrl,
          customDate: dateInput || null  // Pass custom date if provided
        });

        console.log('[Dashboard] News published:', publishResult.data);

        // Success
        hideNewsPublishPopup();
        hideNewsPublishForm();

        if (window.showToastDirectly) {
          window.showToastDirectly(
            getTranslation('youhub.suggestions.notifications.types.success_operation', 'Sikeres művelet'),
            getTranslation('pages.dashboard.news_publish.success', 'Sikeresen publikáltuk a hírt!'),
            'positive'
          );
        } else {
          alert(getTranslation('pages.dashboard.news_publish.success', 'Sikeresen publikáltuk a hírt!'));
        }

      } catch (error) {
        console.error('[Dashboard] News publish error:', error);
        hideNewsPublishPopup();

        // Parse error message from Cloud Function
        let errorMessage = error.message || getTranslation('pages.dashboard.news_publish.error.generic', 'Hiba történt a publikálás során');

        // Check for specific error codes
        if (error.code === 'permission-denied') {
          errorMessage = getTranslation('pages.dashboard.news_publish.error.permission', 'Nincs jogosultságod a publikáláshoz');
        } else if (error.code === 'unauthenticated') {
          errorMessage = getTranslation('pages.dashboard.news_publish.error.login', 'Kérlek jelentkezz be');
        }

        if (window.showToastDirectly) {
          window.showToastDirectly(
            getTranslation('youhub.suggestions.notifications.types.error', 'Hiba'),
            errorMessage,
            'danger'
          );
        } else {
          alert(errorMessage);
        }
      }
    }



    // ========== EVENT PUBLISH FUNCTIONS ==========

    // Store selected event image file
    let selectedEventImage = null;

    function showEventPublishForm() {
      console.log('[Dashboard] Showing event publish form');
      const typeSelection = document.getElementById('publish-type-selection');
      const eventForm = document.getElementById('event-publish-form');
      const backBtn = document.getElementById('dashboardBackBtn');
      if (typeSelection) typeSelection.style.display = 'none';
      if (eventForm) eventForm.style.display = 'flex';
      // Activate back button
      if (backBtn) {
        backBtn.style.opacity = '1';
        backBtn.style.pointerEvents = 'auto';
        backBtn.onclick = hideEventPublishForm;
      }
      clearEventForm();
    }

    function hideEventPublishForm() {
      console.log('[Dashboard] Hiding event publish form');
      const typeSelection = document.getElementById('publish-type-selection');
      const eventForm = document.getElementById('event-publish-form');
      const backBtn = document.getElementById('dashboardBackBtn');
      if (typeSelection) typeSelection.style.display = 'flex';
      if (eventForm) eventForm.style.display = 'none';
      // Deactivate back button
      if (backBtn) {
        backBtn.style.opacity = '0.5';
        backBtn.style.pointerEvents = 'none';
        backBtn.onclick = null;
      }
      clearEventForm();
    }

    function clearEventForm() {
      const titleInput = document.getElementById('eventTitle');
      const linkInput = document.getElementById('eventLink');
      const placeInput = document.getElementById('eventPlace');
      const dateFromInput = document.getElementById('eventDateFrom');
      const dateToInput = document.getElementById('eventDateTo');
      const descInput = document.getElementById('eventDescription');
      const previewImg = document.getElementById('eventPreviewImage');

      if (titleInput) { titleInput.value = ''; titleInput.classList.remove('error'); }
      if (linkInput) { linkInput.value = ''; linkInput.classList.remove('error'); }
      if (placeInput) { placeInput.value = ''; placeInput.classList.remove('error'); }
      if (dateFromInput) { dateFromInput.value = ''; dateFromInput.classList.remove('error'); }
      if (dateToInput) { dateToInput.value = ''; dateToInput.classList.remove('error'); }
      if (descInput) { descInput.value = ''; descInput.classList.remove('error'); }
      if (previewImg) previewImg.src = 'assets/general/image_placeholder_blue.svg';
      selectedEventImage = null;
    }

    function triggerEventImageUpload() {
      const fileInput = document.getElementById('eventImageInput');
      if (fileInput) fileInput.click();
    }

    // Event image input change handler
    document.addEventListener('DOMContentLoaded', () => {
      const fileInput = document.getElementById('eventImageInput');
      if (fileInput) {
        fileInput.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (file && file.type.startsWith('image/')) {
            selectedEventImage = file;
            const previewImg = document.getElementById('eventPreviewImage');
            if (previewImg) {
              const reader = new FileReader();
              reader.onload = (e) => {
                previewImg.src = e.target.result;
              };
              reader.readAsDataURL(file);
            }
            console.log('[Dashboard] Event image selected:', file.name);
          }
        });
      }
    });

    function showEventPublishPopup() {
      const popup = document.getElementById('eventPublishPopup');
      if (popup) popup.classList.add('active');
    }

    function hideEventPublishPopup() {
      const popup = document.getElementById('eventPublishPopup');
      if (popup) popup.classList.remove('active');
    }

    function showEventInputError(inputId, translationKey, fallback) {
      const input = document.getElementById(inputId);
      if (input) {
        input.classList.add('error');
        const errorMsg = getTranslation(translationKey, fallback);
        if (window.showToastDirectly) {
          window.showToastDirectly(
            getTranslation('youhub.suggestions.notifications.types.warning', 'Figyelmeztetés'),
            errorMsg,
            'warning'
          );
        }
      }
    }

    function validateEventInputs() {
      // Clear previous errors
      ['eventTitle', 'eventLink', 'eventPlace', 'eventDateFrom', 'eventDateTo', 'eventDescription'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.classList.remove('error');
      });

      const title = document.getElementById('eventTitle')?.value?.trim() || '';
      const place = document.getElementById('eventPlace')?.value?.trim() || '';
      const dateFrom = document.getElementById('eventDateFrom')?.value || '';
      const dateTo = document.getElementById('eventDateTo')?.value || '';

      // Title validation
      if (!title || title.length < 3) {
        showEventInputError('eventTitle', 'pages.dashboard.event_publish.error.title_required', 'Az esemény címe kötelező (min. 3 karakter)');
        return false;
      }

      // Place validation
      if (!place) {
        showEventInputError('eventPlace', 'pages.dashboard.event_publish.error.place_required', 'Az esemény helye kötelező');
        return false;
      }

      // Date from validation
      if (!dateFrom) {
        showEventInputError('eventDateFrom', 'pages.dashboard.event_publish.error.date_from_required', 'A kezdődátum kötelező');
        return false;
      }

      // Date to validation
      if (!dateTo) {
        showEventInputError('eventDateTo', 'pages.dashboard.event_publish.error.date_to_required', 'A befejező dátum kötelező');
        return false;
      }

      // Image validation
      if (!selectedEventImage) {
        showEventInputError('eventPreviewImage', 'pages.dashboard.event_publish.error.image_required', 'Kérlek tölts fel egy képet');
        return false;
      }

      return true;
    }

    async function submitEventPublish() {
      console.log('[Dashboard] Submitting event...');

      // Validate inputs
      if (!validateEventInputs()) {
        return;
      }

      const title = document.getElementById('eventTitle')?.value?.trim();
      const link = document.getElementById('eventLink')?.value?.trim() || '';
      const place = document.getElementById('eventPlace')?.value?.trim();
      const dateFrom = document.getElementById('eventDateFrom')?.value;
      const dateTo = document.getElementById('eventDateTo')?.value;
      const description = document.getElementById('eventDescription')?.value?.trim() || '';

      // Show loading popup
      showEventPublishPopup();

      try {
        // Import functions for europe-west3 region
        const { getFunctions, httpsCallable } = await import("https://www.gstatic.com/firebasejs/11.10.0/firebase-functions.js");
        const functionsWest3 = getFunctions(window.firebaseApp, 'europe-west3');

        // Step 1: Get signed URL for image upload
        console.log('[Dashboard] Getting signed upload URL for event...');
        const getUploadUrl = httpsCallable(functionsWest3, 'getEventUploadUrl');

        // Generate a temporary eventId (will be confirmed by server)
        const tempEventId = Date.now().toString();

        const uploadUrlResult = await getUploadUrl({
          contentType: selectedEventImage.type,
          eventId: tempEventId
        });

        const { uploadUrl, fileName } = uploadUrlResult.data;
        console.log('[Dashboard] Got signed URL, uploading event image...');

        // Step 2: Upload image directly to Storage via signed URL
        const uploadResponse = await fetch(uploadUrl, {
          method: 'PUT',
          headers: {
            'Content-Type': selectedEventImage.type
          },
          body: selectedEventImage
        });

        if (!uploadResponse.ok) {
          throw new Error('Image upload failed');
        }

        // Step 3: Get the public URL of the uploaded image
        const bucket = 'eu2k-hub.firebasestorage.app';
        const imageUrl = `https://firebasestorage.googleapis.com/v0/b/${bucket}/o/${encodeURIComponent(fileName)}?alt=media`;
        console.log('[Dashboard] Event image uploaded, publishing event...');

        // Step 4: Call publishEvent function
        const publishEventFunc = httpsCallable(functionsWest3, 'publishEvent');
        const publishResult = await publishEventFunc({
          title: title,
          link: link,
          place: place,
          description: description,
          imageUrl: imageUrl,
          dateFrom: dateFrom,
          dateTo: dateTo
        });

        console.log('[Dashboard] Event published:', publishResult.data);

        // Success
        hideEventPublishPopup();
        hideEventPublishForm();

        if (window.showToastDirectly) {
          window.showToastDirectly(
            getTranslation('youhub.suggestions.notifications.types.success_operation', 'Sikeres művelet'),
            getTranslation('pages.dashboard.event_publish.success', 'Sikeresen publikáltuk az eseményt!'),
            'positive'
          );
        } else {
          alert(getTranslation('pages.dashboard.event_publish.success', 'Sikeresen publikáltuk az eseményt!'));
        }

      } catch (error) {
        console.error('[Dashboard] Event publish error:', error);
        hideEventPublishPopup();

        // Parse error message from Cloud Function
        let errorMessage = error.message || getTranslation('pages.dashboard.event_publish.error.generic', 'Hiba történt a publikálás során');

        // Check for specific error codes
        if (error.code === 'permission-denied') {
          errorMessage = getTranslation('pages.dashboard.event_publish.error.permission', 'Nincs jogosultságod a publikáláshoz');
        } else if (error.code === 'unauthenticated') {
          errorMessage = getTranslation('pages.dashboard.event_publish.error.login', 'Kérlek jelentkezz be');
        }

        if (window.showToastDirectly) {
          window.showToastDirectly(
            getTranslation('youhub.suggestions.notifications.types.error', 'Hiba'),
            errorMessage,
            'danger'
          );
        } else {
          alert(errorMessage);
        }
      }
    }

    // Redirect from the button in publish-type-selection
    function publishEvent() {
      showEventPublishForm();
    }

    /* Split Teacher Logic */
    // Global variables for user suggestions
    let userSuggestions = [];
    let userSuggestionsLoaded = false;


    function calendarShowSplitTeacher() {
      const btn = document.getElementById('calendarAddTeacherBtn');
      const container = document.getElementById('calendarSplitContainer');
      if (btn) btn.style.display = 'none';
      if (container) container.style.display = 'flex';

      // Initialize 2nd teacher dropdown if empty
      // We reusing the same logic as loadLessonTypes but we need to make sure we populate it with teachers
      // Ideally loadLessonTypes should populate both if the 2nd one exists?
      // Or we can just copy the innerHTML from the first one?
      const teacher1Dropdown = document.getElementById('calendarTeacherDropdown');
      const teacher2Dropdown = document.getElementById('calendarTeacher2Dropdown');

      if (teacher1Dropdown && teacher2Dropdown && !teacher2Dropdown.hasChildNodes()) {
        // Create a new LanguageDropdown instance for the 2nd teacher
        // Since LanguageDropdown framework might need re-init, we can try to clone or just re-render.
        // Assuming dashboard uses a global 'LanguageDropdown' class or helper.
        // Looking at initStep2Dropdowns:
        // teacherDropdown = new LanguageDropdown(document.getElementById('calendarTeacherDropdown'), ...)
        // We need to instantiate it.

        // Using the global teacher options stored in calendarState or similar?
        // loadLessonTypes fetches users and populates calendarTeacherDropdown.
        // We can access 'calendarState.teachers' if we saved it?

        // Actually, loadLessonTypes in dashboard.html calls Cloud Function which returns { teachers: [...] }?
        // No, loadLessonTypes populates the dropdowns directly? 
        // Let's check loadLessonTypes implementation.
        // It seems it receives data and updates dropdown.

        // If we don't have the teacher list readily available, we might need to fetch it or store it when loading lesson types.
        // HACK: Clone the nodes? LanguageDropdown is complex (custom custom element logic).

        // Better approach: When loadLessonTypes runs, it should populate 'teacher2' as well if it exists, OR store the teacher options globally so we can re-render.
        // But for now, if the user clicks "Add", we assume the list is the same as Teacher 1.
      }

      // Initialize user search logic
      const studentInput = document.getElementById('calendarStudentSearchInput');
      const studentGhost = document.getElementById('calendarStudentGhost');
      if (studentInput && studentGhost) {
        setupUserSearchLogic(studentInput, studentGhost);
      }
    }

    async function loadUserSuggestions() {
      if (userSuggestionsLoaded) return;
      try {
        console.log('[Dashboard] Loading user suggestions via Cloud Function...');
        const result = await window.calendarApiCall('searchUsers');
        const { users } = result.data;

        userSuggestions = (users || []).map(user => ({
          id: user.id,
          display: user.fullName,
          match: (user.fullName || '').toLowerCase()
        }));

        console.log('[Dashboard] Loaded', userSuggestions.length, 'user suggestions');
        userSuggestionsLoaded = true;
      } catch (err) {
        console.warn('[Dashboard] Failed to load user suggestions', err);
        userSuggestions = [];
      }
    }

    function findUserSuggestion(rawValue) {
      const value = (rawValue || '').trim().toLowerCase();
      console.log('[Ghost] findUserSuggestion called with:', value, 'suggestions count:', userSuggestions.length);
      if (!value || userSuggestions.length === 0) return null;

      let match = userSuggestions.find((item) => item && item.match && item.match.startsWith(value));
      if (match) {
        console.log('[Ghost] Found exact match:', match.display);
        return match;
      }

      const words = value.split(/\s+/);
      const scored = userSuggestions
        .filter((item) => item && item.match)
        .map((item) => {
          const matchLower = item.match.toLowerCase();
          let score = 0;
          const allWordsMatch = words.every((word) => matchLower.includes(word));
          if (allWordsMatch) {
            if (matchLower.startsWith(value)) {
              score = 1000;
            } else {
              words.forEach((word) => {
                const index = matchLower.indexOf(word);
                if (index >= 0) {
                  score += 100 - index;
                }
              });
            }
          }
          return { item, score };
        })
        .filter((entry) => entry.score > 0)
        .sort((a, b) => b.score - a.score);

      return scored.length > 0 ? scored[0].item : null;
    }

    function applyGhostToElement(element, fullValue, searchValue, suggestionText, inputEl) {
      if (!element) return;
      const isFocused = inputEl ? document.activeElement === inputEl : true;
      if (!searchValue || !suggestionText || !isFocused) {
        if (element) {
          element.textContent = '';
          element.classList.remove('is-visible');
        }
        return;
      }

      const normalizedInput = searchValue.toLowerCase();
      const normalizedSuggestion = suggestionText.toLowerCase();
      if (!normalizedSuggestion.startsWith(normalizedInput)) {
        if (element) {
          element.textContent = '';
          element.classList.remove('is-visible');
        }
        return;
      }

      const lastCommaIndex = fullValue.lastIndexOf(',');
      const prefixBeforeSearch = lastCommaIndex >= 0 ? fullValue.slice(0, lastCommaIndex + 1) + ' ' : '';
      const remainder = suggestionText.slice(searchValue.length);
      element.innerHTML = `<span class="ghost-prefix">${escapeHtml(prefixBeforeSearch)}${escapeHtml(searchValue)}</span>${escapeHtml(remainder)}`;
      element.classList.add('is-visible');
    }

    function escapeHtml(value) {
      return (value || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function simplifyName(fullName) {
      if (!fullName) return '';
      const normalized = fullName.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
      const lowercased = normalized.toLowerCase();
      const simplified = lowercased.replace(/\s+/g, '_');
      return simplified;
    }

    async function lookupAndReplaceUserName(input, simplifiedName, originalName) {
      try {
        const db = window.db;
        if (!db) {
          console.warn('[Dashboard] Firestore not initialized');
          return null;
        }

        const { collection, getDocs } = await import("https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js");
        const namesCollectionRef = collection(db, 'usrlookup', 'names', simplifiedName);
        const userDocs = await getDocs(namesCollectionRef);

        if (!userDocs.empty) {
          const userDoc = userDocs.docs[0];
          const userData = userDoc.data();
          const userId = userDoc.id;
          const fullName = userData.fullName || originalName || input.value;

          const fullValue = input.value;
          const lastCommaIndex = fullValue.lastIndexOf(',');
          if (lastCommaIndex >= 0) {
            input.value = fullValue.slice(0, lastCommaIndex + 1) + ' ' + fullName;
          } else {
            input.value = fullName;
          }

          // We should ideally store the userId somewhere, but for calendar assignment we might just store the names string?
          // Or do we need user IDs? Class registration uses user IDs.
          // For calendar assignment, we probably just need the names string or IDs if backend supports it.
          // 'student_group' logic in backend?
          // The current requirement says "group selection input (with search logic identical to the "Add students")"
          // Class registration creates a class with users.
          // THIS feature assigns a teacher (or two) to a lesson. And "student group".
          // Does "Student Group" mean a list of students? Or a predefined group?
          // "Student selection feature". "Search logic identical to Add students".
          // Likely we just want the list of names/IDs stringified or array.

          return { userId, fullName };
        } else {
          return null;
        }
      } catch (error) {
        console.error('[Dashboard] Error looking up user name:', error);
        return null;
      }
    }

    function setupUserSearchLogic(input, ghostElement) {
      if (!input || !ghostElement) return;
      loadUserSuggestions();

      let lastCommaSpaceDeleted = false;

      function updateUserGhost() {
        if (!input || !ghostElement) return;
        const fullValue = input.value;
        const lastCommaIndex = fullValue.lastIndexOf(',');
        const searchValue = lastCommaIndex >= 0 ? fullValue.slice(lastCommaIndex + 1).trim() : fullValue.trim();
        const suggestion = findUserSuggestion(searchValue);
        applyGhostToElement(ghostElement, fullValue, searchValue, suggestion?.display, input);
      }

      input.addEventListener('input', updateUserGhost);
      input.addEventListener('focus', updateUserGhost);
      input.addEventListener('blur', () => {
        if (ghostElement) {
          ghostElement.textContent = '';
          ghostElement.classList.remove('is-visible');
        }
      });

      input.addEventListener('keydown', async (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          const fullValue = input.value;
          const lastCommaIndex = fullValue.lastIndexOf(',');
          const searchValue = lastCommaIndex >= 0 ? fullValue.slice(lastCommaIndex + 1).trim() : fullValue.trim();

          if (searchValue) {
            const simplifiedName = simplifyName(searchValue);
            await lookupAndReplaceUserName(input, simplifiedName, searchValue);
          }
        }
      });

      input.addEventListener('keydown', async (event) => {
        if (event.key === 'Tab' && !event.shiftKey) {
          const fullValue = input.value;
          const lastCommaIndex = fullValue.lastIndexOf(',');
          const searchValue = lastCommaIndex >= 0 ? fullValue.slice(lastCommaIndex + 1).trim() : fullValue.trim();
          const suggestion = findUserSuggestion(searchValue);
          if (suggestion && suggestion.display) {
            event.preventDefault();
            const simplifiedName = simplifyName(searchValue);
            const result = await lookupAndReplaceUserName(input, simplifiedName, searchValue);
            if (result && result.fullName) {
              updateUserGhost();
            } else {
              const newName = suggestion.display;
              if (lastCommaIndex >= 0) {
                const beforeComma = fullValue.slice(0, lastCommaIndex + 1).trim();
                input.value = `${beforeComma} ${newName}`;
              } else {
                input.value = newName;
              }
              updateUserGhost();
            }
          }
        } else if (event.key === ' ' && !lastCommaSpaceDeleted) {
          const fullValue = input.value;
          const cursorPos = input.selectionStart || 0;
          if (cursorPos > 0 && fullValue.slice(cursorPos - 1, cursorPos + 1) === ', ') {
            lastCommaSpaceDeleted = true;
          }
        } else if (event.key === 'Backspace') {
          const fullValue = input.value;
          const cursorPos = input.selectionStart || 0;
          if (cursorPos > 0 && fullValue.slice(cursorPos - 2, cursorPos) === ', ') {
            lastCommaSpaceDeleted = true;
          }
        }
      });
    }

    async function checkSessionAndUpdateBlur() {
      const scrollArea = document.querySelector('.main-scroll-area');
      if (!scrollArea) return;
      try {
        let retries = 0;
        while ((!window.firebaseApp || !window.functions) && retries < 50) {
          await new Promise(resolve => setTimeout(resolve, 100));
          retries++;
        }
        if (!window.firebaseApp || !window.functions) {
          scrollArea.classList.add('session-inactive');
          return;
        }
        const { getAuth } = await import("https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js");
        const auth = getAuth(window.firebaseApp);
        await new Promise(resolve => {
          if (auth.currentUser) resolve();
          else { const u = auth.onAuthStateChanged(() => { u(); resolve(); }); }
        });
        if (!auth.currentUser) {
          scrollArea.classList.add('session-inactive');
          return;
        }
        const { httpsCallable } = await import("https://www.gstatic.com/firebasejs/11.10.0/firebase-functions.js");
        const checkSession = httpsCallable(window.functions, 'staffSessionCheck');
        const result = await checkSession();
        if (result.data.active) scrollArea.classList.remove('session-inactive');
        else scrollArea.classList.add('session-inactive');
      } catch (error) {
        scrollArea.classList.add('session-inactive');
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      checkSessionAndUpdateBlur();
      setInterval(checkSessionAndUpdateBlur, 5000);
    });
  </script>
</body>

</html>