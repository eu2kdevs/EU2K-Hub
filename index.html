<!DOCTYPE html>
<html lang="hu">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title data-translate="pages.index.title" data-translate-fallback="EU2K Hub">EU2K Hub</title>
  <link rel="stylesheet" href="home.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap');

    body,
    * {
      font-family: "Roboto", sans-serif;
      font-optical-sizing: auto;
      font-weight: 400;
      font-style: normal;
      font-variation-settings: "wdth" 100;
    }
  </style>
  <script type="importmap">
    {
      "imports": {
        "@material/web/": "https://esm.run/@material/web/"
      }
    }
  </script>
  <script type="text/javascript">
    (function (c, l, a, r, i, t, y) {
      c[a] = c[a] || function () { (c[a].q = c[a].q || []).push(arguments) };
      t = l.createElement(r); t.async = 1; t.src = "https://www.clarity.ms/tag/" + i;
      y = l.getElementsByTagName(r)[0]; y.parentNode.insertBefore(t, y);
    })(window, document, "clarity", "script", "s6n7qpfkv4");
  </script>
  <script type="importmap">
  {
    "imports": {
      "@material/web/": "https://esm.run/@material/web/"
    }
  }
</script>
  <script type="module">
    import '@material/web/all.js';
    import { styles as typescaleStyles } from '@material/web/typography/md-typescale-styles.js';

    document.adoptedStyleSheets.push(typescaleStyles.styleSheet);
  </script>
  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-analytics.js";
    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries

    // Your web app's Firebase configuration
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
      apiKey: "AIzaSyBRRVx6BtQtCDKjFYA8yh9qYrcUONmkkwI",
      authDomain: "eu2k-hub.firebaseapp.com",
      projectId: "eu2k-hub",
      storageBucket: "eu2k-hub.firebasestorage.app",
      messagingSenderId: "560244867055",
      appId: "1:560244867055:web:3cd51b85baead94989001a",
      measurementId: "G-2JDPR089WD"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);

    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

    const db = getFirestore(app);

    // Make db globally available for the new things popup
    window.db = db;

    async function loadNews() {
      const hirekRef = collection(db, 'homePageData', 'news', 'hirek');
      const snapshot = await getDocs(hirekRef);
      let news = [];
      snapshot.forEach(doc => {
        news.push({ id: parseInt(doc.id), data: doc.data() });
      });
      news.sort((a, b) => b.id - a.id);
      const cards = document.querySelectorAll('.news-card');
      news.slice(0, cards.length).forEach((item, index) => {
        const card = cards[index];
        const rect = card.querySelector('.red-rect');
        rect.style.backgroundImage = `url(${item.data.image})`;
        rect.style.backgroundSize = 'cover';
        rect.style.backgroundPosition = 'center';
        rect.style.backgroundColor = 'transparent';
        const titleSpan = card.querySelector('.news-label > span:first-child');
        titleSpan.textContent = item.data.title;
        const descSpan = card.querySelector('.news-label > span.desc');
        let desc = item.data.desc.substring(0, 60);
        if (item.data.desc.length > 60) desc += '...';
        descSpan.textContent = desc;
        card.addEventListener('click', () => {
          window.location.href = item.data.link;
        });
        card.style.cursor = 'pointer';
      });
    }

    async function loadEvents() {
      const eventsRef = collection(db, 'homePageData', 'events', 'esemenyek');
      const snapshot = await getDocs(eventsRef);
      let events = [];
      snapshot.forEach(doc => {
        events.push({ id: parseInt(doc.id), data: doc.data() });
      });
      events.sort((a, b) => b.id - a.id);
      const containers = document.querySelectorAll('.event-container');
      events.slice(0, containers.length).forEach((item, index) => {
        const container = containers[index];
        const card = container.querySelector('.red-card');
        if (card) {
          card.style.backgroundImage = `url(${item.data.image})`;
          card.style.backgroundSize = 'cover';
          card.style.backgroundPosition = 'center';
          card.style.backgroundColor = 'transparent';
        }

        // Only update text elements if they exist (for cards with labels)
        const titleSpan = container.querySelector('.event-label-text > span:first-child');
        if (titleSpan) {
          titleSpan.textContent = item.data.title;
        }

        const descSpan = container.querySelector('.event-label-text > span.desc');
        if (descSpan) {
          let desc = item.data.description.substring(0, 120);
          if (item.data.description.length > 120) desc += '...';
          descSpan.textContent = desc;
        }

        const placeSpan = container.querySelector('.event-label-text > span.place');
        if (placeSpan && item.data.place) {
          placeSpan.textContent = item.data.place;
        }

        // Handle arrow button based on link availability
        const arrowContainer = container.querySelector('.arrow-container');
        if (arrowContainer) {
          if (item.data.link && item.data.link.trim() !== '') {
            // Enable arrow button and add click handler
            arrowContainer.style.opacity = '1';
            arrowContainer.style.cursor = 'pointer';
            arrowContainer.style.filter = 'none';
            arrowContainer.onclick = function (e) {
              e.stopPropagation();
              let url = item.data.link.trim();
              // Check if URL starts with http:// or https://, if not add https://
              if (!url.startsWith('http://') && !url.startsWith('https://')) {
                url = 'https://' + url;
              }
              window.open(url, '_blank');
            };
          } else {
            // Disable arrow button
            arrowContainer.style.opacity = '0.3';
            arrowContainer.style.cursor = 'not-allowed';
            arrowContainer.style.filter = 'grayscale(100%)';
            arrowContainer.onclick = function (e) {
              e.stopPropagation();
            };
          }
        }

        // Remove the old click handler from container since we now use arrow button
      });
    }

    window.addEventListener('DOMContentLoaded', () => {
      loadNews();
      loadEvents();
    });
  </script>
</head>

<body>
  <div class="app-bg">
    <aside class="sidebar">
      <nav class="nav-menu">
        <a class="nav-item active" href="index.html">
          <div class="nav-icon-container">
            <img src="/EU2K-Hub/assets/home_icon.svg" class="nav-icon" alt="Otthon">
          </div>
          <span data-translate="navigation.home">Otthon</span>
        </a>
        <a class="nav-item" href="qr-code.html">
          <div class="nav-icon-container">
            <img src="/EU2K-Hub/assets/qr_code_icon.svg" class="nav-icon" alt="QR-Kód">
          </div>
          <span data-translate="navigation.qr" data-translate-fallback="QR-Kód">QR-Kód</span>
        </a>
        <a class="nav-item" href="youhub.html">
          <div class="nav-icon-container">
            <img src="/EU2K-Hub/assets/youhub_icon.svg" class="nav-icon" alt="YouHub">
          </div>
          <span data-translate="navigation.youhub">YouHub</span>
        </a>
        <a class="nav-item" href="courses.html">
          <div class="nav-icon-container">
            <img src="/EU2K-Hub/assets/courses_icon.svg" class="nav-icon" alt="Kurzusok">
          </div>
          <span data-translate="navigation.courses">Kurzusok</span>
        </a>
      </nav>
    </aside>
    <main class="main-area">
      <div class="main-content">
        <header class="header">
          <div class="welcome-container">
            <img src="/EU2K-Hub/assets/welcome_hand_icon.svg" class="welcome-icon" alt="Welcome">
            <h1 class="welcome-text" data-translate="pages.index.welcome" data-translate-fallback="Üdvözöllek a Hub-ban!">Üdvözöllek a Hub-ban!</h1>
          </div>
          <div class="header-icons">
            <a href="/EU2K-Hub/system/account.html" class="header-icon-link">
              <img src="/EU2K-Hub/assets/account_icon.svg" class="header-icon" alt="Account">
            </a>
            <a href="/EU2K-Hub/settings/settings.html" class="header-icon-link">
              <img src="/EU2K-Hub/assets/settings_icon.svg" class="header-icon" alt="Settings">
            </a>
          </div>
        </header>
        <section class="events-section">
          <div class="section-title">
            <span data-translate="pages.index.upcoming_events" data-translate-fallback="Közelgő Események">Közelgő Események</span>
            <img src="/EU2K-Hub/assets/arrow_forward.svg" class="arrow-icon" alt="Tovább">
          </div>
          <div class="event-frame">
            <div class="top-cards-row">
              <div class="event-container">
                <div class="red-card large"></div>
                <div class="event-label">
                  <div class="event-label-text">
                    <span>Esemény Neve</span>
                    <span class="desc">Esemény leírása</span>
                    <span class="place">Esemény Helye</span>
                  </div>
                  <div class="arrow-container">
                    <img src="/EU2K-Hub/assets/arrow_forward.svg" class="arrow-icon" alt="Tovább">
                  </div>
                </div>
              </div>
              <div class="event-container">
                <div class="red-card large"></div>
                <div class="event-label">
                  <div class="event-label-text">
                    <span>Esemény neve</span>
                    <span class="desc">Esemény leírása</span>
                    <span class="place">Esemény Helye</span>
                  </div>
                  <div class="arrow-container">
                    <img src="/EU2K-Hub/assets/arrow_forward.svg" class="arrow-icon" alt="Tovább">
                  </div>
                </div>
              </div>
              <div class="event-container">
                <div class="red-card medium"></div>
              </div>
              <div class="event-container">
                <div class="red-card small"></div>
              </div>
            </div>
          </div>
        </section>
        <section class="news-section">
          <div class="section-title">
            <span data-translate="pages.index.news" data-translate-fallback="Hírek">Hírek</span>
            <img src="/EU2K-Hub/assets/arrow_forward.svg" class="arrow-icon" alt="Tovább">
          </div>
          <div class="bottom-cards-row">
            <div class="news-card">
              <div class="red-rect"></div>
              <div class="news-label"><span>Title</span><span class="desc">Description</span></div>
            </div>
            <div class="news-card">
              <div class="red-rect"></div>
              <div class="news-label"><span>Title</span><span class="desc">Description</span></div>
            </div>
            <div class="news-card">
              <div class="red-rect"></div>
              <div class="news-label"><span>Title</span><span class="desc">Description</span></div>
            </div>
            <div class="news-card">
              <div class="red-rect"></div>
              <div class="news-label"><span>Title</span><span class="desc">Description</span></div>
            </div>
            <div class="news-card">
              <div class="red-rect"></div>
              <div class="news-label"><span>Title</span><span class="desc">Description</span></div>
            </div>
            <div class="news-card">
              <div class="red-rect"></div>
              <div class="news-label"><span>Title</span><span class="desc">Description</span></div>
            </div>
          </div>
        </section>
      </div>
    </main>
  </div>
  <div id="event-mask"></div>

  <!-- Új dolgok Popup -->
  <div id="newThingsPopup" class="new-things-overlay" style="display: none;">
    <div class="new-things-container">
      <div class="new-things-close-btn" onclick="closeNewThingsPopup()">
        <img src="/EU2K-Hub/assets/close.svg" alt="Bezárás">
      </div>
      <div class="new-things-content">
        <div class="new-things-header">
          <img src="/EU2K-Hub/assets/sparkles.svg" class="new-things-icon-top" alt="Új dolgok">
        </div>
        <h2 class="new-things-title" data-translate="pages.index.new_things_title">New things in the Hub</h2>
        <p class="new-things-subtitle" id="newThingsSubtitle">EU2K Hub 0.2abc - Zárt Béta</p>
        <div class="new-things-image-container">
          <img src="/EU2K-Hub/assets/placeholder_img.svg" class="new-things-image" alt="Új dolgok">
        </div>
        <div class="new-things-list">
          <!-- A lista dinamikusan lesz feltöltve JavaScript által -->
        </div>
        <div class="new-things-footer">
          <a href="https://eu2kdevs.hu" target="_blank" class="new-things-link" data-translate="pages.index.more_info_link">
            Továbbiak az <b>eu2kdevs.hu</b> oldalon.
          </a>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Új dolgok popup kezelése
    let newThingsData = null;

    // Popup megnyitása
    function showNewThingsPopup() {
      const popup = document.getElementById('newThingsPopup');
      if (popup) {
        popup.style.display = 'flex';
      }
    }

    // Popup bezárása
    function closeNewThingsPopup() {
      const popup = document.getElementById('newThingsPopup');
      if (popup) {
        popup.style.display = 'none';
      }
    }

    // Popup bezárása overlay-re kattintáskor
    document.addEventListener('DOMContentLoaded', () => {
      const popup = document.getElementById('newThingsPopup');
      if (popup) {
        popup.addEventListener('click', (e) => {
          if (e.target === popup) {
            closeNewThingsPopup();
          }
        });
      }
    });

    // Firebase adatok lekérése és popup megjelenítése
    async function checkAndShowNewThings() {
      try {
        // Firestore v9 függvények importálása
        const { collection, getDocs, query, orderBy, limit } = await import("https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js");

        // Jelenlegi idő lekérése (egyszerűsített verzió)
        const now = new Date();
        const currentTime = now.getTime();

        // Updates kollekció lekérdezése
        const updatesRef = collection(db, 'homePageData', 'new-things', 'updates');
        const q = query(updatesRef, orderBy('publish_date', 'desc'), limit(10));
        const snapshot = await getDocs(q);

        let latestUpdate = null;
        let latestTimestamp = 0;
        let latestUpdateId = null;

        snapshot.forEach(doc => {
          const data = doc.data();
          const publishDate = data.publish_date;
          
          if (publishDate) {
            const timestamp = publishDate.toDate ? publishDate.toDate().getTime() : publishDate;
            
            // Ellenőrizzük, hogy a timestamp nem jövőbeli-e (1 óra tolerancia)
            const oneHourInMs = 60 * 60 * 1000;
            if (timestamp <= currentTime + oneHourInMs && timestamp > latestTimestamp) {
              latestTimestamp = timestamp;
              latestUpdate = {...data, document_id: doc.id}; // Add document ID to data
              latestUpdateId = doc.id;
            }
          }
        });

        if (latestUpdate) {
          const lastShownUpdateId = localStorage.getItem('lastShownNewThingsUpdateId');
          
          if (lastShownUpdateId !== latestUpdateId) {
            // Pre-translate content
            const translations = {};
            for (const lang of ['en', 'hu']) {
              translations[lang] = {
                state: await translateWithAI(latestUpdate.state, lang),
                new_thing1: await translateWithAI(latestUpdate.new_thing1, lang),
                new_thing2: await translateWithAI(latestUpdate.new_thing2, lang),
              };
            }
            latestUpdate.translations = translations;
            newThingsData = latestUpdate;
            
            updatePopupContent(newThingsData);
            showNewThingsPopup();
            
            localStorage.setItem('lastShownNewThingsUpdateId', latestUpdateId);
          }
        }

      } catch (error) {
        console.error('Hiba az új dolgok lekérdezésekor:', error);
      }
    }

    // Popup tartalom frissítése
    function updatePopupContent(data) {
      if (!data) return;
      const targetLanguage = window.translationManager.currentLanguage;
      const translatedData = data.translations[targetLanguage];

      const subtitle = document.getElementById('newThingsSubtitle');
      if (subtitle) {
        const docName = data.document_name || data.document_id || '0.2abc';
        subtitle.textContent = `EU2K Hub ${docName} - ${translatedData.state}`;
      }

      const newThingsList = document.querySelector('.new-things-list');
      if (newThingsList) {
        newThingsList.innerHTML = '';
        const ul = document.createElement('ul');
        ul.style.margin = '0';
        ul.style.paddingLeft = '20px';
        ul.style.listStyleType = 'disc';
        
        if (translatedData.new_thing1) {
          const li1 = document.createElement('li');
          li1.textContent = translatedData.new_thing1;
          li1.style.color = '#C2C3C2';
          li1.style.marginBottom = '8px';
          li1.style.lineHeight = '1.5';
          ul.appendChild(li1);
        }
        
        if (translatedData.new_thing2) {
          const li2 = document.createElement('li');
          li2.textContent = translatedData.new_thing2;
          li2.style.color = '#C2C3C2';
          li2.style.marginBottom = '8px';
          li2.style.lineHeight = '1.5';
          ul.appendChild(li2);
        }
        
        newThingsList.appendChild(ul);
      }
      
      window.translationManager.applyTranslations();
    }

    // Oldal betöltésekor csekkolás
    window.addEventListener('DOMContentLoaded', () => {
      // Késleltetett csekkolás, hogy a Firebase betöltődjön
      setTimeout(checkAndShowNewThings, 1000);
    });

    // Debug függvény a localStorage reset-hez és popup újra megjelenítéséhez
    // Használat a konzolban: resetNewThingsPopup()
    window.resetNewThingsPopup = function() {
      console.log('🔄 Resetting new things popup tracking...');
      
      // Töröljük a localStorage-ból az utoljára megjelenített update ID-t
      localStorage.removeItem('lastShownNewThingsUpdateId');
      console.log('✅ Cleared lastShownNewThingsUpdateId from localStorage');
      
      // Újra futtatjuk a checkAndShowNewThings függvényt
      console.log('🔍 Checking for new updates...');
      checkAndShowNewThings().then(() => {
        console.log('✨ Check complete! If there are updates, the popup should appear.');
      }).catch(error => {
        console.error('❌ Error during check:', error);
      });
    };

    // Debug függvény az összes new things adat törléséhez
    // Használat a konzolban: clearAllNewThingsData()
    window.clearAllNewThingsData = function() {
      console.log('🗑️ Clearing all new things data...');
      
      // Töröljük az összes kapcsolódó localStorage elemet
      const keysToRemove = ['lastShownNewThingsUpdateId', 'lastNewThingsCheck'];
      keysToRemove.forEach(key => {
        if (localStorage.getItem(key)) {
          localStorage.removeItem(key);
          console.log(`✅ Removed ${key}`);
        }
      });
      
      console.log('✨ All new things data cleared!');
    };

    // Debug függvény az aktuális állapot megjelenítéséhez
    // Használat a konzolban: showNewThingsStatus()
    window.showNewThingsStatus = function() {
      console.log('📊 Current New Things Status:');
      console.log('Last shown update ID:', localStorage.getItem('lastShownNewThingsUpdateId') || 'None');
      console.log('Last check date:', localStorage.getItem('lastNewThingsCheck') || 'None');
      console.log('Current new things data:', newThingsData || 'No data loaded');
    };
  </script>

  <script src="/EU2K-Hub/assets/js/permissions.js"></script>
  <script src="/EU2K-Hub/assets/js/translations.js"></script>
</body>

</html>