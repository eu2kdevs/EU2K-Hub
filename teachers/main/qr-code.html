<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QR-Kód</title>
  <link rel="stylesheet" href="qrcode.css">
  <script type="importmap">
    {
      "imports": {
        "@material/web/": "https://esm.run/@material/web/"
      }
    }
  </script>
  <script type="module">
    import '@material/web/all.js';
    import {styles as typescaleStyles} from '@material/web/typography/md-typescale-styles.js';

    document.adoptedStyleSheets.push(typescaleStyles.styleSheet);
  </script>
  <script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>
  <script src="/EU2K-Hub/assets/js/welcome-screen.js"></script>
</head>
<body>
  <div class="app-bg">
    <aside class="sidebar">
      <nav class="nav-menu">
        <a class="nav-item" href="/main/index.html">
          <div class="nav-icon-container">
            <img src="/assets/home_icon.svg" class="nav-icon" alt="Otthon">
          </div>
          <span>Otthon</span>
        </a>
        <a class="nav-item active" href="/main/qr-code.html">
          <div class="nav-icon-container">
            <img src="/assets/qr_code_icon.svg" class="nav-icon" alt="QR-Kód">
          </div>
          <span>QR-Kód</span>
        </a>
        <a class="nav-item" href="/main/youhub.html">
          <div class="nav-icon-container">
            <img src="/assets/youhub_icon.svg" class="nav-icon" alt="YouHub">
          </div>
          <span>YouHub</span>
        </a>
        <a class="nav-item" href="/main/courses.html">
          <div class="nav-icon-container">
            <img src="/assets/courses_icon.svg" class="nav-icon" alt="Kurzusok">
          </div>
          <span>Kurzusok</span>
        </a>
      </nav>
    </aside>
    <main class="main-area">
      <div class="main-content">
        <header class="header">
          <div class="welcome-container">
            <img src="/assets/qr_code_icon.svg" class="welcome-icon" alt="QR-Kód">
            <h1 class="welcome-text">QR-Kód Scanner</h1>
          </div>
          <div class="header-icons">
            <a href="/system/account.html" class="header-icon-link">
              <img src="/assets/account_icon.svg" class="header-icon" alt="Account">
            </a>
            <a href="/settings/settings.html" class="header-icon-link">
              <img src="/assets/settings_icon.svg" class="header-icon" alt="Settings">
            </a>
          </div>
        </header>

        <!-- Permission Popup -->
        <div id="permission-popup" class="permission-popup" style="display: none;">
          <div class="popup-content">
            <div class="popup-header">
              <img src="/assets/camera_icon.svg" class="popup-icon" alt="Kamera">
              <h2>Kamera engedély szükséges</h2>
            </div>
            <p>A QR-kód beolvasásához engedélyezned kell a kamera használatát.</p>
            <div class="popup-buttons">
              <md-outlined-button id="deny-permission">Elutasítás</md-outlined-button>
              <md-filled-button id="allow-permission">Engedélyezés</md-filled-button>
            </div>
          </div>
        </div>

        <!-- Blocked Camera View -->
        <div id="blocked-camera" class="blocked-camera" style="display: none;">
          <div class="blocked-content">
            <img src="/assets/camera_blocked.svg" class="blocked-icon" alt="Kamera blokkolva">
            <h2>Kamera hozzáférés blokkolva</h2>
            <p>A QR-kód beolvasásához engedélyezd a kamera használatát a böngésző beállításaiban.</p>
            <md-filled-button id="retry-camera">Újrapróbálás</md-filled-button>
          </div>
        </div>

        <!-- QR Scanner Section -->
        <section id="qr-scanner-section" class="qr-scanner-section">
          <div class="scanner-container">
            <div class="camera-view">
              <video id="qr-video" autoplay muted playsinline></video>
              <div class="scanner-overlay">
                <div class="scanner-frame"></div>
              </div>
            </div>
            <div class="scanner-controls">
              <md-filled-button id="start-scan">Szkennelés indítása</md-filled-button>
              <md-outlined-button id="stop-scan" style="display: none;">Szkennelés leállítása</md-outlined-button>
            </div>
          </div>
          
          <div class="scan-result" id="scan-result" style="display: none;">
            <h3>Beolvasott QR-kód:</h3>
            <div class="result-content" id="result-content"></div>
            <md-filled-button id="scan-again">Újra szkennelés</md-filled-button>
          </div>
        </section>
      </div>
    </main>
  </div>

  <script>
    class QRScanner {
      constructor() {
        this.video = document.getElementById('qr-video');
        this.canvas = document.createElement('canvas');
        this.context = this.canvas.getContext('2d');
        this.stream = null;
        this.scanning = false;
        this.animationId = null;
        
        this.initializeElements();
        this.bindEvents();
        this.checkInitialPermission();
      }

      initializeElements() {
        this.permissionPopup = document.getElementById('permission-popup');
        this.blockedCamera = document.getElementById('blocked-camera');
        this.scannerSection = document.getElementById('qr-scanner-section');
        this.startBtn = document.getElementById('start-scan');
        this.stopBtn = document.getElementById('stop-scan');
        this.scanResult = document.getElementById('scan-result');
        this.resultContent = document.getElementById('result-content');
        this.scanAgainBtn = document.getElementById('scan-again');
        this.allowBtn = document.getElementById('allow-permission');
        this.denyBtn = document.getElementById('deny-permission');
        this.retryBtn = document.getElementById('retry-camera');
      }

      bindEvents() {
        this.startBtn.addEventListener('click', () => this.requestPermission());
        this.stopBtn.addEventListener('click', () => this.stopScanning());
        this.scanAgainBtn.addEventListener('click', () => this.resetScanner());
        this.allowBtn.addEventListener('click', () => this.handlePermissionAllow());
        this.denyBtn.addEventListener('click', () => this.handlePermissionDeny());
        this.retryBtn.addEventListener('click', () => this.requestPermission());
      }

      async checkInitialPermission() {
        try {
          const permission = await navigator.permissions.query({ name: 'camera' });
          if (permission.state === 'denied') {
            this.showBlockedCamera();
          } else {
            this.showScannerSection();
          }
        } catch (error) {
          console.log('Permission API not supported');
          this.showScannerSection();
        }
      }

      showPermissionPopup() {
        this.permissionPopup.style.display = 'flex';
        this.scannerSection.style.display = 'none';
        this.blockedCamera.style.display = 'none';
      }

      showBlockedCamera() {
        this.blockedCamera.style.display = 'flex';
        this.permissionPopup.style.display = 'none';
        this.scannerSection.style.display = 'none';
      }

      showScannerSection() {
        this.scannerSection.style.display = 'block';
        this.permissionPopup.style.display = 'none';
        this.blockedCamera.style.display = 'none';
      }

      async requestPermission() {
        this.showPermissionPopup();
      }

      async handlePermissionAllow() {
        try {
          this.stream = await navigator.mediaDevices.getUserMedia({ 
            video: { 
              facingMode: 'environment',
              width: { ideal: 1280 },
              height: { ideal: 720 }
            } 
          });
          
          this.video.srcObject = this.stream;
          this.showScannerSection();
          this.startScanning();
        } catch (error) {
          console.error('Camera access denied:', error);
          this.showBlockedCamera();
        }
      }

      handlePermissionDeny() {
        this.showBlockedCamera();
      }

      startScanning() {
        if (!this.stream) return;
        
        this.scanning = true;
        this.startBtn.style.display = 'none';
        this.stopBtn.style.display = 'inline-flex';
        this.scanResult.style.display = 'none';
        
        this.video.addEventListener('loadedmetadata', () => {
          this.canvas.width = this.video.videoWidth;
          this.canvas.height = this.video.videoHeight;
          this.scan();
        });
      }

      stopScanning() {
        this.scanning = false;
        this.startBtn.style.display = 'inline-flex';
        this.stopBtn.style.display = 'none';
        
        if (this.animationId) {
          cancelAnimationFrame(this.animationId);
        }
        
        if (this.stream) {
          this.stream.getTracks().forEach(track => track.stop());
          this.stream = null;
        }
      }

      scan() {
        if (!this.scanning) return;
        
        if (this.video.readyState === this.video.HAVE_ENOUGH_DATA) {
          this.context.drawImage(this.video, 0, 0, this.canvas.width, this.canvas.height);
          const imageData = this.context.getImageData(0, 0, this.canvas.width, this.canvas.height);
          const code = jsQR(imageData.data, imageData.width, imageData.height);
          
          if (code) {
            this.handleQRCodeDetected(code.data);
            return;
          }
        }
        
        this.animationId = requestAnimationFrame(() => this.scan());
      }

      handleQRCodeDetected(data) {
        this.stopScanning();
        this.resultContent.textContent = data;
        this.scanResult.style.display = 'block';
        
        // Vibrate if supported
        if (navigator.vibrate) {
          navigator.vibrate(200);
        }
      }

      resetScanner() {
        this.scanResult.style.display = 'none';
        this.startBtn.style.display = 'inline-flex';
        this.stopBtn.style.display = 'none';
      }
    }

    // Initialize QR Scanner when DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
      new QRScanner();
    });
  </script>
</body>
</html>